<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="theme-color" content="#080808">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="mobile-web-app-capable" content="yes">
<title>NicheForge v3 — AI Web Studio</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Syne:wght@400;500;600;700;800&family=Inter:wght@300;400;500;600;700&family=Syne+Mono&family=Bebas+Neue&family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&family=Manrope:wght@300;400;500;600;700;800&family=Oswald:wght@300;400;500;600;700&family=Nunito:wght@300;400;500;600;700;800&family=Rajdhani:wght@300;400;500;600;700&family=Exo+2:wght@300;400;500;600;700;800&family=Playfair+Display:wght@400;500;600;700;800&family=Lato:wght@300;400;700&family=Cormorant+Garamond:wght@300;400;500;600;700&family=Jost:wght@300;400;500;600;700&family=Space+Grotesk:wght@300;400;500;600;700&family=DM+Sans:wght@300;400;500;600;700&family=Outfit:wght@300;400;500;600;700;800&family=Raleway:wght@300;400;500;600;700;800&family=Orbitron:wght@400;500;600;700;800;900&family=Audiowide&family=Oxanium:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
<style>
  :root {
    --bg: #080810;
    --surface: #0d0d18;
    --surface2: #12121f;
    --border: #1e1e30;
    --accent: #00d4ff;
    --accent-glow: rgba(0,212,255,0.15);
    --accent2: #b44fff;
    --accent2-glow: rgba(180,79,255,0.15);
    --accent3: #ff5580;
    --grad-btn: linear-gradient(135deg, #8b5cf6, #ec4899);
    --grad-btn-green: linear-gradient(135deg, #00e676, #00bcd4);
    --grad-text: linear-gradient(90deg, #00d4ff, #b44fff);
    --gold: #f5c542;
    --text: #ffffff;
    --muted: #8888aa;
    --card: #0d0d18;
  }

  * { margin: 0; padding: 0; box-sizing: border-box; }

  body {
    background: var(--bg);
    color: var(--text);
    font-family: 'Inter', sans-serif;
    min-height: 100vh;
    overflow-x: hidden;
    font-size: 14px;
    line-height: 1.5;
  }

  /* Noise texture overlay */
  body::before {
    content: '';
    position: fixed;
    inset: 0;
    background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 256 256' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noise'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noise)' opacity='0.03'/%3E%3C/svg%3E");
    pointer-events: none;
    z-index: 1000;
    opacity: 0.4;
  }

  /* Ambient glow */
  body::after {
    content: '';
    position: fixed;
    top: -200px;
    left: -200px;
    width: 600px;
    height: 600px;
    background: radial-gradient(circle, rgba(0,212,255,0.04) 0%, transparent 70%);
    pointer-events: none;
    z-index: 0;
  }

  /* ===== SIDEBAR ===== */
  .sidebar {
    position: fixed;
    left: 0; top: 0; bottom: 0;
    width: 216px;
    background: var(--surface);
    border-right: 1px solid var(--border);
    display: flex;
    flex-direction: column;
    z-index: 100;
  }

  .logo {
    padding: 24px 20px 18px;
    border-bottom: 1px solid var(--border);
  }

  .logo-mark {
    font-family: 'Syne', sans-serif;
    font-weight: 900;
    font-size: 18px;
    letter-spacing: -0.5px;
    color: var(--text);
    display: flex;
    align-items: center;
    gap: 8px;
  }

  .logo-mark .logo-icon {
    width: 24px; height: 24px;
    background: var(--grad-btn);
    border-radius: 6px;
    display: flex; align-items: center; justify-content: center;
    flex-shrink: 0;
  }

  .logo-mark span { color: var(--accent); }

  .logo-sub {
    font-size: 10px;
    color: var(--muted);
    letter-spacing: 1.5px;
    text-transform: uppercase;
    margin-top: 4px;
    padding-left: 32px;
  }

  .nav {
    padding: 12px 10px;
    flex: 1;
    overflow-y: auto;
  }

  .nav-section {
    font-size: 9px;
    letter-spacing: 1.5px;
    text-transform: uppercase;
    color: #333;
    padding: 12px 10px 5px;
    margin-top: 4px;
    font-weight: 700;
  }

  .nav-item {
    display: flex;
    align-items: center;
    gap: 9px;
    padding: 8px 10px;
    border-radius: 6px;
    cursor: pointer;
    transition: all 0.12s;
    font-size: 13px;
    color: var(--muted);
    font-weight: 500;
    border: 1px solid transparent;
  }

  .nav-item:hover { background: var(--surface2); color: #ccc; }

  .nav-item.active {
    background: rgba(0,212,255,0.06);
    color: var(--accent);
    border-color: rgba(0,212,255,0.12);
  }

  .nav-icon {
    width: 16px; height: 16px;
    display: flex; align-items: center; justify-content: center;
    flex-shrink: 0;
    opacity: 0.7;
  }
  .nav-item.active .nav-icon { opacity: 1; }
  .nav-icon svg { width: 15px; height: 15px; }

  .nav-badge {
    margin-left: auto;
    background: var(--grad-btn);
    color: #fff;
    font-size: 9px;
    font-weight: 800;
    padding: 1px 6px;
    border-radius: 20px;
    line-height: 1.6;
  }

  .sidebar-footer {
    padding: 14px 16px;
    border-top: 1px solid var(--border);
  }

  .status-dot {
    display: flex;
    align-items: center;
    gap: 8px;
    font-size: 11px;
    color: var(--muted);
  }

  .dot {
    width: 6px; height: 6px;
    border-radius: 50%;
    background: var(--accent);
    box-shadow: 0 0 6px var(--accent);
    animation: pulse 2s infinite;
  }

  @keyframes pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.4; }
  }

  /* ===== MAIN ===== */
  .main {
    margin-left: 216px;
    min-height: 100vh;
    position: relative;
  }

  /* ===== TOPBAR ===== */
  .topbar {
    padding: 14px 32px;
    border-bottom: 1px solid var(--border);
    display: flex;
    align-items: center;
    justify-content: space-between;
    background: rgba(8,8,8,0.95);
    backdrop-filter: blur(12px);
    position: sticky;
    top: 0;
    z-index: 50;
  }

  .page-title {
    font-family: 'Syne', sans-serif;
    font-size: 15px;
    font-weight: 700;
    letter-spacing: -0.2px;
  }

  .topbar-actions {
    display: flex;
    align-items: center;
    gap: 12px;
  }

  .btn {
    display: inline-flex;
    align-items: center;
    gap: 7px;
    padding: 8px 16px;
    border-radius: 7px;
    font-size: 12.5px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.15s;
    border: none;
    font-family: 'Inter', sans-serif;
    letter-spacing: 0.01em;
  }

  .btn-ghost {
    background: transparent;
    border: 1px solid var(--border);
    color: var(--muted);
  }
  .btn-ghost:hover { border-color: rgba(255,255,255,0.15); color: var(--text); }

  .btn-primary {
    background: var(--grad-btn);
    color: #fff;
    font-weight: 700;
  }
  .btn-primary:hover { background: #1aff8e; box-shadow: 0 0 20px rgba(0,212,255,0.25); }

  .btn-accent2 {
    background: rgba(180,79,255,0.12);
    border: 1px solid rgba(180,79,255,0.25);
    color: var(--accent2);
  }
  .btn-accent2:hover { background: rgba(180,79,255,0.2); }

  /* ===== CONTENT ===== */
  .content { padding: 28px 32px; }

  /* ===== PANELS ===== */
  .panel { display: none; }
  .panel.active { display: block; animation: fadeIn 0.18s ease; }
  @keyframes fadeIn { from { opacity: 0; transform: translateY(6px); } to { opacity: 1; transform: translateY(0); } }

  /* ===== DASHBOARD PANEL ===== */
  .stats-row {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 12px;
    margin-bottom: 24px;
  }

  .stat-card {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 10px;
    padding: 18px 20px;
    position: relative;
    overflow: hidden;
    transition: border-color 0.15s;
  }
  .stat-card:hover { border-color: #2a2a2a; }

  .stat-card::before {
    content: '';
    position: absolute;
    top: 0; left: 0; right: 0;
    height: 1.5px;
  }

  .stat-card:nth-child(1)::before { background: var(--accent); }
  .stat-card:nth-child(2)::before { background: var(--accent2); }
  .stat-card:nth-child(3)::before { background: #f59e0b; }
  .stat-card:nth-child(4)::before { background: var(--accent3); }

  .stat-label {
    font-size: 10.5px;
    color: var(--muted);
    text-transform: uppercase;
    letter-spacing: 0.8px;
    margin-bottom: 10px;
    font-weight: 600;
  }

  .stat-value {
    font-family: 'Syne', sans-serif;
    font-size: 26px;
    font-weight: 900;
    line-height: 1;
    letter-spacing: -0.5px;
  }

  .stat-sub {
    font-size: 10.5px;
    color: var(--muted);
    margin-top: 6px;
  }

  .stat-sub.up { color: var(--accent); }

  .grid-2 {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 16px;
    margin-bottom: 24px;
  }

  .grid-3 {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 12px;
  }

  .card {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 10px;
    padding: 20px;
  }

  .card-title {
    font-family: 'Syne', sans-serif;
    font-size: 13px;
    font-weight: 700;
    margin-bottom: 14px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    color: var(--text);
    letter-spacing: -0.1px;
  }

  .card-title a {
    font-family: 'Inter', sans-serif;
    font-size: 11px;
    color: var(--muted);
    text-decoration: none;
    font-weight: 500;
    cursor: pointer;
  }
  .card-title a:hover { color: var(--accent); }

  /* Site list */
  .site-item {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 9px 0;
    border-bottom: 1px solid var(--border);
  }
  .site-item:last-child { border-bottom: none; }

  .site-favicon {
    width: 32px; height: 32px;
    border-radius: 7px;
    display: flex; align-items: center; justify-content: center;
    font-size: 14px;
    flex-shrink: 0;
    border: 1px solid var(--border);
  }

  .site-info { flex: 1; min-width: 0; }
  .site-name { font-size: 12.5px; font-weight: 600; margin-bottom: 1px; }
  .site-url { font-size: 11px; color: var(--muted); }

  .site-badge {
    font-size: 10px;
    padding: 2px 8px;
    border-radius: 20px;
    font-weight: 700;
    letter-spacing: 0.3px;
  }

  .badge-live { background: rgba(0,212,255,0.08); color: var(--accent); border: 1px solid rgba(0,212,255,0.15); }
  .badge-draft { background: rgba(245,158,11,0.08); color: #f59e0b; border: 1px solid rgba(245,158,11,0.15); }
  .badge-building { background: rgba(180,79,255,0.08); color: var(--accent2); border: 1px solid rgba(180,79,255,0.15); }

  /* Activity feed */
  .activity-item {
    display: flex;
    gap: 10px;
    padding: 7px 0;
    border-bottom: 1px solid var(--border);
  }
  .activity-item:last-child { border-bottom: none; }

  .activity-icon {
    width: 26px; height: 26px;
    border-radius: 7px;
    display: flex; align-items: center; justify-content: center;
    font-size: 11px;
    flex-shrink: 0;
    margin-top: 1px;
    border: 1px solid var(--border);
  }

  .activity-text { font-size: 12px; line-height: 1.5; color: #ccc; }
  .activity-time { font-size: 10.5px; color: var(--muted); margin-top: 2px; }

  /* Quick action cards */
  .quick-card {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 10px;
    padding: 18px;
    cursor: pointer;
    transition: all 0.15s;
    text-align: left;
    display: flex;
    gap: 14px;
    align-items: flex-start;
  }
  .quick-card:hover { border-color: #2a2a2a; background: #111; }

  .quick-icon {
    width: 34px; height: 34px;
    border-radius: 8px;
    background: var(--surface2);
    border: 1px solid var(--border);
    display: flex; align-items: center; justify-content: center;
    flex-shrink: 0;
    color: var(--accent);
  }
  .quick-icon svg { width: 16px; height: 16px; }
  .quick-title { font-family: 'Syne', sans-serif; font-size: 13px; font-weight: 700; margin-bottom: 3px; }
  .quick-desc { font-size: 11px; color: var(--muted); line-height: 1.4; }

  /* ===== CREATE SITE PANEL ===== */
  .wizard-steps {
    display: flex;
    align-items: center;
    gap: 0;
    margin-bottom: 36px;
  }

  .step {
    display: flex;
    align-items: center;
    gap: 10px;
    font-size: 13px;
    color: var(--muted);
  }

  .step-num {
    width: 28px; height: 28px;
    border-radius: 50%;
    border: 1.5px solid var(--border);
    display: flex; align-items: center; justify-content: center;
    font-size: 12px;
    font-weight: 600;
  }

  .step.active .step-num { border-color: var(--accent); color: var(--accent); background: rgba(0,212,255,0.08); }
  .step.active { color: var(--text); }
  .step.done .step-num { background: var(--accent); border-color: var(--accent); color: #000; }
  .step.done { color: var(--muted); }

  .step-line { width: 40px; height: 1px; background: var(--border); margin: 0 4px; }

  .form-section {
    background: var(--card);
    border: 1px solid var(--border);
    border-radius: 10px;
    padding: 28px;
    margin-bottom: 20px;
  }

  .form-section-title {
    font-family: 'Syne', sans-serif;
    font-size: 15px;
    font-weight: 700;
    margin-bottom: 20px;
    padding-bottom: 14px;
    border-bottom: 1px solid var(--border);
    display: flex;
    align-items: center;
    gap: 10px;
  }

  .form-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 16px;
  }

  .form-group { margin-bottom: 14px; }
  .form-group.full { grid-column: 1 / -1; }

  label {
    display: block;
    font-size: 11px;
    color: var(--muted);
    margin-bottom: 5px;
    letter-spacing: 0.3px;
    font-weight: 600;
    text-transform: uppercase;
  }

  input, select, textarea {
    width: 100%;
    background: #111;
    border: 1px solid var(--border);
    color: var(--text);
    padding: 9px 12px;
    border-radius: 7px;
    font-size: 13px;
    font-family: 'Inter', sans-serif;
    transition: border-color 0.15s;
    outline: none;
  }

  input:focus, select:focus, textarea:focus {
    border-color: rgba(0,212,255,0.4);
    background: #111;
  }

  textarea { resize: vertical; min-height: 80px; }
  select option { background: #111; }

  .site-type-grid {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 12px;
    margin-bottom: 20px;
  }

  .type-card {
    background: var(--surface2);
    border: 1.5px solid var(--border);
    border-radius: 10px;
    padding: 16px 14px;
    cursor: pointer;
    transition: all 0.15s;
    text-align: center;
  }

  .type-card:hover { border-color: rgba(0,212,255,0.4); }
  .type-card.selected { border-color: var(--accent); background: rgba(0,212,255,0.05); }

  .type-icon {
    width: 40px; height: 40px;
    border-radius: 9px;
    background: var(--surface2);
    border: 1px solid var(--border);
    display: flex; align-items: center; justify-content: center;
    margin-bottom: 10px;
    color: var(--muted);
    transition: all 0.15s;
  }
  .type-card.selected .type-icon { background: rgba(0,212,255,0.08); border-color: rgba(0,212,255,0.2); color: var(--accent); }
  .type-name { font-size: 12.5px; font-weight: 600; margin-bottom: 3px; }
  .type-desc { font-size: 11px; color: var(--muted); }

  .toggle-row {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 12px 0;
    border-bottom: 1px solid rgba(30,30,46,0.5);
  }
  .toggle-row:last-child { border-bottom: none; }

  .toggle-label { font-size: 13px; }
  .toggle-desc { font-size: 11px; color: var(--muted); margin-top: 2px; }

  .toggle {
    width: 40px; height: 22px;
    background: var(--border);
    border-radius: 20px;
    position: relative;
    cursor: pointer;
    transition: background 0.2s;
    flex-shrink: 0;
  }

  .toggle.on { background: var(--accent); }

  .toggle::after {
    content: '';
    position: absolute;
    top: 3px; left: 3px;
    width: 16px; height: 16px;
    background: white;
    border-radius: 50%;
    transition: transform 0.2s;
  }

  .toggle.on::after { transform: translateX(18px); }

  /* ===== SEO GENERATOR ===== */
  .seo-input-area {
    background: var(--card);
    border: 1px solid var(--border);
    border-radius: 10px;
    padding: 24px;
    margin-bottom: 20px;
  }

  .seo-output {
    background: var(--surface2);
    border: 1px solid var(--border);
    border-radius: 10px;
    padding: 20px;
    font-family: 'Courier New', monospace;
    font-size: 12px;
    line-height: 1.7;
    color: #7ec8a0;
    white-space: pre-wrap;
    max-height: 300px;
    overflow-y: auto;
    display: none;
  }

  .seo-output.visible { display: block; }

  /* ===== NICHE DISCOVERY ===== */
  .niche-grid {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 16px;
    margin-top: 20px;
  }

  .niche-card {
    background: var(--card);
    border: 1px solid var(--border);
    border-radius: 10px;
    padding: 20px;
    cursor: pointer;
    transition: all 0.2s;
    position: relative;
    overflow: hidden;
  }

  .niche-card::before {
    content: '';
    position: absolute;
    top: 0; left: 0; right: 0;
    height: 3px;
  }

  .niche-card:nth-child(1)::before { background: linear-gradient(90deg, var(--accent), #00b8ff); }
  .niche-card:nth-child(2)::before { background: linear-gradient(90deg, var(--accent2), #ff6b6b); }
  .niche-card:nth-child(3)::before { background: linear-gradient(90deg, #ffd93d, var(--accent)); }
  .niche-card:nth-child(4)::before { background: linear-gradient(90deg, var(--accent3), var(--accent2)); }
  .niche-card:nth-child(5)::before { background: linear-gradient(90deg, #00b8ff, var(--accent2)); }
  .niche-card:nth-child(6)::before { background: linear-gradient(90deg, #ffd93d, var(--accent3)); }

  .niche-card:hover { border-color: rgba(0,212,255,0.3); transform: translateY(-3px); box-shadow: 0 12px 40px rgba(0,0,0,0.3); }

  .niche-header {
    display: flex;
    align-items: flex-start;
    justify-content: space-between;
    margin-bottom: 12px;
  }

  .niche-icon {
    width: 36px; height: 36px;
    border-radius: 8px;
    display: flex; align-items: center; justify-content: center;
    font-size: 18px;
    flex-shrink: 0;
  }

  .rpm-badge {
    font-size: 11px;
    font-weight: 700;
    padding: 3px 8px;
    border-radius: 6px;
    background: rgba(0,212,255,0.1);
    color: var(--accent);
    border: 1px solid rgba(0,212,255,0.2);
  }

  .niche-name {
    font-family: 'Syne', sans-serif;
    font-size: 15px;
    font-weight: 700;
    margin-bottom: 6px;
  }

  .niche-desc { font-size: 12px; color: var(--muted); line-height: 1.5; margin-bottom: 14px; }

  .niche-meta {
    display: flex;
    gap: 12px;
  }

  .meta-item { font-size: 11px; color: var(--muted); display: flex; align-items: center; gap: 4px; }
  .meta-dot { width: 5px; height: 5px; border-radius: 50%; flex-shrink: 0; }
  .dot-easy { background: var(--accent); }
  .dot-med { background: #ffd93d; }
  .dot-hard { background: var(--accent3); }

  /* ===== DEPLOY PANEL ===== */
  .deploy-status {
    background: var(--card);
    border: 1px solid var(--border);
    border-radius: 10px;
    padding: 24px;
    margin-bottom: 20px;
  }

  .deploy-step {
    display: flex;
    align-items: center;
    gap: 16px;
    padding: 12px 0;
    border-bottom: 1px solid rgba(30,30,46,0.5);
  }
  .deploy-step:last-child { border-bottom: none; }

  .deploy-step-icon {
    width: 34px; height: 34px;
    border-radius: 50%;
    display: flex; align-items: center; justify-content: center;
    font-size: 14px;
    flex-shrink: 0;
  }

  .step-pending { background: var(--surface2); border: 1px solid var(--border); color: var(--muted); }
  .step-done2 { background: rgba(0,212,255,0.1); border: 1px solid rgba(0,212,255,0.2); color: var(--accent); }
  .step-active { background: rgba(180,79,255,0.1); border: 1px solid rgba(180,79,255,0.2); color: var(--accent2); }

  .deploy-step-info { flex: 1; }
  .deploy-step-name { font-size: 13px; font-weight: 500; margin-bottom: 2px; }
  .deploy-step-desc { font-size: 11px; color: var(--muted); }

  .deploy-step-time { font-size: 11px; color: var(--muted); }

  .progress-bar-wrap {
    background: var(--border);
    border-radius: 4px;
    height: 4px;
    margin: 16px 0;
    overflow: hidden;
  }

  .progress-bar {
    height: 100%;
    background: linear-gradient(90deg, var(--accent), #00b8ff);
    border-radius: 4px;
    transition: width 0.5s ease;
  }

  /* ===== PAGE GENERATOR ===== */
  .template-grid {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 12px;
    margin-bottom: 20px;
  }

  .template-card {
    background: var(--surface2);
    border: 1.5px solid var(--border);
    border-radius: 10px;
    padding: 0;
    cursor: pointer;
    transition: all 0.15s;
    overflow: hidden;
  }

  .template-card:hover, .template-card.selected { border-color: var(--accent); }

  .template-preview {
    height: 80px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 28px;
  }

  .t1 { background: linear-gradient(135deg, #050a14, #0d2035); }
  .t2 { background: linear-gradient(135deg, #0a0518, #1a0d3a); }
  .t3 { background: linear-gradient(135deg, #050d18, #0a1a2a); }
  .t4 { background: linear-gradient(135deg, #100520, #200a35); }

  .template-name {
    padding: 8px 12px;
    font-size: 11.5px;
    font-weight: 600;
    border-top: 1px solid var(--border);
  }

  /* ===== SPINNER ===== */
  @keyframes spin { to { transform: rotate(360deg); } }
  .spinner {
    width: 16px; height: 16px;
    border: 2px solid rgba(0,212,255,0.2);
    border-top-color: var(--accent);
    border-radius: 50%;
    animation: spin 0.7s linear infinite;
    display: inline-block;
  }

  /* ===== SCROLLBAR ===== */
  ::-webkit-scrollbar { width: 5px; }
  ::-webkit-scrollbar-track { background: transparent; }
  ::-webkit-scrollbar-thumb { background: var(--border); border-radius: 10px; }

  /* ===== DEPLOY PANEL ===== */
  .platform-tab {
    display: flex;
    align-items: center;
    gap: 12px;
    background: var(--card);
    border: 1.5px solid var(--border);
    border-radius: 10px;
    padding: 14px 18px;
    cursor: pointer;
    transition: all 0.15s;
    flex: 1;
    min-width: 160px;
  }
  .platform-tab:hover { border-color: rgba(0,212,255,0.3); }
  .platform-tab.active { border-color: var(--accent); background: rgba(0,212,255,0.05); }
  .ptab-icon { font-size: 22px; width: 32px; text-align: center; }
  .ptab-name { font-size: 13px; font-weight: 600; }
  .ptab-sub { font-size: 11px; color: var(--muted); margin-top: 2px; }

  .deploy-prog-step {
    display: flex;
    align-items: center;
    gap: 14px;
    padding: 10px 0;
    border-bottom: 1px solid rgba(30,30,46,0.4);
    transition: opacity 0.3s;
  }
  .deploy-prog-step:last-child { border-bottom: none; }

  @media (max-width: 768px) {
    .deploy-main-grid { grid-template-columns: 1fr !important; }
    .setup-steps-grid { grid-template-columns: 1fr !important; }
    .platform-tab { min-width: 100%; }
  }
  .seo-tab {
    flex: 1;
    padding: 7px 10px;
    border-radius: 7px;
    border: none;
    background: transparent;
    color: var(--muted);
    font-family: 'Inter', sans-serif;
    font-size: 12px;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.15s;
    white-space: nowrap;
  }
  .seo-tab:hover { color: var(--text); }
  .seo-tab.active { background: var(--card); color: var(--accent); border: 1px solid var(--border); }

  /* ===== SEO SCORE CARDS ===== */
  .seo-score-card {
    background: var(--card);
    border: 1px solid var(--border);
    border-radius: 10px;
    padding: 14px;
    text-align: center;
  }
  .seo-score-num {
    font-family: 'Syne', sans-serif;
    font-size: 26px;
    font-weight: 800;
    line-height: 1;
    margin-bottom: 4px;
  }
  .seo-score-label { font-size: 10px; color: var(--muted); text-transform: uppercase; letter-spacing: 1px; }

  @media (max-width: 768px) {
    #seo-scores-row { grid-template-columns: 1fr 1fr !important; }
    #seo-gen-steps-row { gap: 8px; }
    .seo-tab { font-size: 10px; padding: 6px 6px; }
    #seo-tabs { overflow-x: auto; }
  }

  /* ===== CODE INJECTOR ===== */
  .injector-card { transition: border-color 0.2s; }
  .injector-card.inj-active { border-color: rgba(0,212,255,0.25); }

  .inj-code-block {
    background: #0a0d12;
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 12px 14px;
    font-family: 'Courier New', monospace;
    font-size: 10.5px;
    line-height: 1.7;
    color: #a8d8a8;
    white-space: pre-wrap;
    word-break: break-all;
  }

  .inj-status-pill {
    font-size: 10px;
    font-weight: 700;
    padding: 3px 10px;
    border-radius: 20px;
    background: rgba(136,150,176,0.1);
    color: var(--muted);
    border: 1px solid rgba(136,150,176,0.15);
    white-space: nowrap;
  }
  .inj-status-pill.active   { background: rgba(0,212,255,0.1);  color: var(--accent); border-color: rgba(0,212,255,0.2); }
  .inj-status-pill.error    { background: rgba(255,107,107,0.1); color: var(--accent3); border-color: rgba(255,107,107,0.2); }

  /* Toggle switch */
  .inj-toggle { position:relative; display:inline-block; width:40px; height:22px; flex-shrink:0; }
  .inj-toggle input { opacity:0; width:0; height:0; }
  .inj-slider {
    position:absolute; cursor:pointer; inset:0;
    background: var(--surface2);
    border: 1px solid var(--border);
    border-radius:22px; transition:.2s;
  }
  .inj-slider:before {
    position:absolute; content:'';
    width:16px; height:16px; left:2px; bottom:2px;
    background: var(--muted);
    border-radius:50%; transition:.2s;
  }
  .inj-toggle input:checked + .inj-slider { background:rgba(0,212,255,0.15); border-color:var(--accent); }
  .inj-toggle input:checked + .inj-slider:before { transform:translateX(18px); background:var(--accent); }

  @media (max-width:768px) {
    .inj-code-grid  { grid-template-columns:1fr !important; }
    .inj-form-grid  { grid-template-columns:1fr !important; }
  }

  /* ===== CRM BOOKINGS ===== */
  .status-badge {
    display: inline-flex; align-items: center; gap: 4px;
    padding: 3px 9px; border-radius: 20px; font-size: 10px; font-weight: 700;
    text-transform: uppercase; letter-spacing: 0.5px;
  }
  .status-pending   { background:rgba(255,211,61,0.1); color:#ffd93d; border:1px solid rgba(255,211,61,0.2); }
  .status-confirmed { background:rgba(0,212,255,0.1);  color:var(--accent); border:1px solid rgba(0,212,255,0.2); }
  .status-in-progress { background:rgba(180,79,255,0.1); color:var(--accent2); border:1px solid rgba(180,79,255,0.2); }
  .status-completed { background:rgba(0,184,255,0.1);  color:#7dd3fc; border:1px solid rgba(0,184,255,0.2); }
  .status-cancelled { background:rgba(255,107,107,0.1); color:var(--accent3); border:1px solid rgba(255,107,107,0.2); }

  #booking-modal, #booking-detail-modal { display:none; }
  #booking-modal.open, #booking-detail-modal.open { display:flex; }

  .crm-row-actions { display:flex; gap:6px; }

  @media (max-width:768px) {
    #crm-stats-row { grid-template-columns: 1fr 1fr !important; }
    .crm-row-actions { flex-direction:column; }
  }
  @keyframes pulse-load { 0%,100%{opacity:.4} 50%{opacity:.8} }
  @keyframes countUp { from{opacity:0;transform:translateY(8px)} to{opacity:1;transform:translateY(0)} }
  .stat-value.loaded { animation:countUp 0.4s ease; }
  .spark-bar { display:inline-block;border-radius:2px 2px 0 0;background:var(--accent);opacity:.55;margin-right:2px;vertical-align:bottom;transition:height .5s ease; }
  .health-item { display:flex;align-items:center;gap:12px;padding:10px 12px;background:var(--surface2);border-radius:8px;border:1px solid var(--border); }
  .health-score { font-family:'Syne',sans-serif;font-size:18px;font-weight:800;min-width:36px;text-align:center; }
  .health-bar-wrap { flex:1;height:4px;background:var(--border);border-radius:4px;overflow:hidden; }
  .health-bar { height:100%;border-radius:4px;transition:width 1s ease; }
  .insight-item { display:flex;gap:12px;padding:12px;background:var(--surface2);border-radius:8px;border-left:3px solid var(--accent);animation:fadeIn .3s ease both; }
  .insight-icon { font-size:18px;flex-shrink:0; }
  .insight-text { font-size:12.5px;line-height:1.5; }
  .insight-action { display:inline-block;margin-top:6px;font-size:11px;color:var(--accent);cursor:pointer;font-weight:600; }

  .mob-topbar {
    display: none;
    position: fixed;
    top: 0; left: 0; right: 0;
    height: 56px;
    background: var(--surface);
    border-bottom: 1px solid var(--border);
    align-items: center;
    justify-content: space-between;
    padding: 0 16px;
    z-index: 200;
  }
  .mob-logo { font-family: 'Syne', sans-serif; font-weight: 800; font-size: 18px; }
  .mob-logo span { color: var(--accent); }
  .mob-hamburger {
    width: 36px; height: 36px;
    background: var(--surface2);
    border: 1px solid var(--border);
    border-radius: 8px;
    display: flex; align-items: center; justify-content: center;
    cursor: pointer; flex-direction: column; gap: 4px; padding: 8px;
  }
  .mob-hamburger span { display: block; width: 18px; height: 2px; background: var(--text); border-radius: 2px; transition: all 0.2s; }
  .sidebar-overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.6); z-index: 149; }
  .sidebar-overlay.visible { display: block; }

  /* ===== RESPONSIVE ===== */
  @media (max-width: 768px) {
    /* Mobile topbar */
    .mob-topbar { display: flex; }

    /* Sidebar slides in OVER the content as a true drawer */
    .sidebar {
      transform: translateX(-260px);
      transition: transform 0.28s cubic-bezier(0.4,0,0.2,1);
      width: 260px;
      top: 0;
      bottom: 0;
      z-index: 500;
      position: fixed;
    }
    .sidebar.open { transform: translateX(0); }

    /* Overlay covers EVERYTHING below sidebar */
    .sidebar-overlay { z-index: 499; }

    /* Main takes full width, shifts down for mob topbar */
    .main { margin-left: 0 !important; padding-top: 56px; width: 100%; }

    /* Hide desktop topbar */
    .topbar { display: none !important; }

    /* Content padding */
    .content { padding: 14px; }

    /* Grids */
    .stats-row { grid-template-columns: 1fr 1fr; gap: 10px; }
    .grid-2, .grid-3 { grid-template-columns: 1fr; }
    .form-grid { grid-template-columns: 1fr; }
    .niche-grid { grid-template-columns: 1fr; }
    .site-type-grid { grid-template-columns: 1fr 1fr; }
    .template-grid { grid-template-columns: 1fr 1fr; }

    /* Typography */
    .stat-value { font-size: 22px; }
    .card-title { font-size: 13px; }

    /* Wizard steps scroll horizontally */
    .wizard-steps { overflow-x: auto; padding-bottom: 4px; white-space: nowrap; flex-wrap: nowrap; }
    .step { font-size: 11px; }
    .step-line { width: 16px; }

    /* Deploy */
    .deploy-step-time { display: none; }

    /* Forms */
    .form-section { padding: 14px; }

    /* Niche search row stacks */
    .niche-search-row { flex-direction: column !important; align-items: stretch !important; }
    .niche-search-row > * { width: 100% !important; }

    /* Keyword table - hide less important cols */
    .kw-table { font-size: 11px; }
    .kw-table th:nth-child(5), .kw-table td:nth-child(5) { display: none; }

    /* Site items */
    .site-item { flex-wrap: wrap; gap: 8px; }

    /* Niche modal full screen on mobile */
    #niche-modal { padding: 0; align-items: flex-end; }
    #niche-modal > div { max-width: 100%; border-radius: 20px 20px 0 0; max-height: 92vh; }

    /* KW output stacks */
    #kw-output-header { flex-direction: column; align-items: flex-start !important; gap: 10px; }
    #kw-output-header > div:last-child { width: 100%; }
    #kw-output-header > div:last-child .btn { flex: 1; }

    /* Page gen output */
    .pg-action-row { flex-direction: column; }
    .pg-action-row .btn { width: 100%; justify-content: center; }
  }

  @media (max-width: 420px) {
    .stats-row { gap: 8px; }
    .stat-value { font-size: 19px; }
    .stat-label { font-size: 10px; }
    .site-type-grid { grid-template-columns: 1fr; }
    .btn { font-size: 12px; padding: 8px 12px; }
    .content { padding: 10px; }
    .niche-card { padding: 14px; }
    .rpm-badge { font-size: 10px; }
  }

  /* ===== ALERTS ===== */
  .alert {
    padding: 12px 16px;
    border-radius: 8px;
    font-size: 13px;
    margin-bottom: 16px;
    display: flex;
    align-items: center;
    gap: 10px;
  }
  .alert-info { background: rgba(0,184,255,0.08); border: 1px solid rgba(0,184,255,0.2); color: #7dd3fc; }
  .alert-success { background: rgba(0,212,255,0.08); border: 1px solid rgba(0,212,255,0.2); color: var(--accent); }

  /* ===== KEYWORD TABLE ===== */
  .kw-table { width: 100%; border-collapse: collapse; font-size: 13px; }
  .kw-table th { text-align: left; padding: 8px 12px; font-size: 10px; letter-spacing: 1px; text-transform: uppercase; color: var(--muted); border-bottom: 1px solid var(--border); }
  .kw-table td { padding: 9px 12px; border-bottom: 1px solid rgba(30,30,46,0.5); }
  .kw-table tr:last-child td { border-bottom: none; }
  .kw-table tr:hover td { background: rgba(255,255,255,0.02); }

  .diff-easy { color: var(--accent); font-size: 11px; font-weight: 600; }
  .diff-med { color: #ffd93d; font-size: 11px; font-weight: 600; }
  .diff-hard { color: var(--accent3); font-size: 11px; font-weight: 600; }

  .tag {
    display: inline-flex;
    align-items: center;
    gap: 4px;
    font-size: 10px;
    padding: 2px 7px;
    border-radius: 4px;
    font-weight: 600;
  }

  .tag-info { background: rgba(0,184,255,0.1); color: #7dd3fc; }
  .tag-how { background: rgba(180,79,255,0.1); color: var(--accent2); }
  .tag-local { background: rgba(0,212,255,0.1); color: var(--accent); }
  .tag-review { background: rgba(255,211,61,0.1); color: #ffd93d; }

  /* Content Calendar */
  .cal-day {
    min-height:80px;border-right:1px solid var(--border);border-bottom:1px solid var(--border);
    padding:6px;cursor:pointer;transition:background 0.1s;position:relative;
  }
  .cal-day:hover { background:var(--surface2); }
  .cal-day.today { background:rgba(0,212,255,0.04); }
  .cal-day.other-month { opacity:0.35; }
  .cal-day-num { font-size:11px;font-weight:700;color:var(--muted);margin-bottom:4px; }
  .cal-day.today .cal-day-num { color:var(--accent); }
  .cal-post-dot {
    font-size:10px;font-weight:600;padding:2px 6px;border-radius:4px;margin-bottom:2px;
    white-space:nowrap;overflow:hidden;text-overflow:ellipsis;cursor:pointer;
  }
  .cal-post-dot.planned { background:rgba(180,79,255,0.15);color:var(--accent2); }
  .cal-post-dot.draft { background:rgba(245,197,66,0.15);color:var(--gold); }
  .cal-post-dot.published { background:rgba(0,212,255,0.15);color:var(--accent); }
  .cal-post-row {
    display:flex;align-items:center;gap:10px;padding:10px 14px;
    background:var(--surface2);border-radius:8px;border:1px solid var(--border);
    transition:border-color 0.15s;cursor:pointer;
  }
  .cal-post-row:hover { border-color:rgba(255,255,255,0.15); }

  /* Landing Page Type Cards */
  .lp-type-card {
    padding:12px 14px;background:var(--surface2);border:1px solid var(--border);
    border-radius:10px;cursor:pointer;transition:all 0.15s;
  }
  .lp-type-card:hover { border-color:rgba(255,255,255,0.2); }
  .lp-type-card.selected { border-color:rgba(0,212,255,0.4);background:rgba(0,212,255,0.05); }

  /* Blog Writer */
  .blog-step {
    font-size:11px;font-weight:600;letter-spacing:0.5px;
    padding:5px 12px;border-radius:100px;
    background:var(--surface2);color:var(--muted);
    border:1px solid var(--border);transition:all 0.3s ease;
  }
  .blog-step.active { background:rgba(0,212,255,0.1);color:var(--accent);border-color:rgba(0,212,255,0.3); }
  .blog-step.done { background:rgba(0,212,255,0.15);color:var(--accent);border-color:rgba(0,212,255,0.4); }

  .blog-tab {
    padding:6px 14px;border-radius:6px;font-size:12px;font-weight:600;
    border:none;background:transparent;color:var(--muted);cursor:pointer;transition:all 0.2s;
  }
  .blog-tab.active { background:var(--accent);color:#000; }
  .blog-tab:hover:not(.active) { color:var(--text); }

  #blog-article-preview h1 { font-family:'Syne',sans-serif;font-size:22px;font-weight:800;margin-bottom:12px;color:var(--text); }
  #blog-article-preview h2 { font-family:'Syne',sans-serif;font-size:17px;font-weight:700;margin:20px 0 8px;color:var(--text); }
  #blog-article-preview h3 { font-size:14px;font-weight:600;margin:16px 0 6px;color:var(--text); }
  #blog-article-preview p { margin-bottom:12px;color:#ccc; }
  #blog-article-preview ul,#blog-article-preview ol { padding-left:20px;margin-bottom:12px;color:#ccc; }
  #blog-article-preview li { margin-bottom:6px; }
  #blog-article-preview .faq-block { background:var(--surface2);border-radius:8px;padding:14px;margin-bottom:8px;border-left:3px solid var(--accent); }
  #blog-article-preview .cta-block { background:rgba(0,212,255,0.07);border:1px solid rgba(0,212,255,0.2);border-radius:10px;padding:20px;margin-top:24px;text-align:center; }


  /* ============================================================
     DESIGN UPGRADE — Premium UI inspired by reference video
     Glassmorphism + animated gradient mesh + micro-interactions
  ============================================================ */

  /* Animated gradient mesh background */
  @keyframes meshMove1 {
    0%, 100% { transform: translate(0, 0) scale(1); }
    33% { transform: translate(30px, -20px) scale(1.05); }
    66% { transform: translate(-20px, 30px) scale(0.95); }
  }
  @keyframes meshMove2 {
    0%, 100% { transform: translate(0, 0) scale(1); }
    50% { transform: translate(-40px, 20px) scale(1.08); }
  }
  @keyframes meshMove3 {
    0%, 100% { transform: translate(0, 0); }
    40% { transform: translate(20px, -30px); }
    80% { transform: translate(-10px, 10px); }
  }

  .mesh-bg {
    position: fixed;
    inset: 0;
    pointer-events: none;
    z-index: 0;
    overflow: hidden;
  }
  .mesh-blob {
    position: absolute;
    border-radius: 50%;
    filter: blur(80px);
    opacity: 0.06;
  }
  .mesh-blob-1 {
    width: 500px; height: 500px;
    background: radial-gradient(circle, var(--accent), transparent 70%);
    top: -100px; left: -100px;
    animation: meshMove1 18s ease-in-out infinite;
  }
  .mesh-blob-2 {
    width: 400px; height: 400px;
    background: radial-gradient(circle, var(--accent2), transparent 70%);
    bottom: 10%; right: -80px;
    animation: meshMove2 22s ease-in-out infinite;
  }
  .mesh-blob-3 {
    width: 300px; height: 300px;
    background: radial-gradient(circle, #00b8ff, transparent 70%);
    top: 50%; left: 50%;
    animation: meshMove3 28s ease-in-out infinite;
  }

  /* Enhanced sidebar with glass effect */
  .sidebar {
    background: rgba(9, 9, 9, 0.92) !important;
    backdrop-filter: blur(20px) saturate(1.5);
    -webkit-backdrop-filter: blur(20px) saturate(1.5);
    border-right: 1px solid rgba(255,255,255,0.06) !important;
    box-shadow: 4px 0 40px rgba(0,0,0,0.4);
  }

  /* Logo glow */
  .logo-icon {
    box-shadow: 0 0 16px rgba(0,212,255,0.4), 0 0 32px rgba(0,212,255,0.1);
    transition: box-shadow 0.3s ease;
  }
  .logo-icon:hover {
    box-shadow: 0 0 24px rgba(0,212,255,0.6), 0 0 48px rgba(0,212,255,0.2);
  }

  /* Nav item premium hover */
  .nav-item {
    position: relative;
    overflow: hidden;
  }
  .nav-item::before {
    content: '';
    position: absolute;
    left: 0; top: 50%;
    transform: translateY(-50%) scaleY(0);
    width: 2.5px;
    height: 60%;
    background: var(--accent);
    border-radius: 0 2px 2px 0;
    transition: transform 0.2s cubic-bezier(0.34,1.56,0.64,1);
  }
  .nav-item.active::before { transform: translateY(-50%) scaleY(1); }
  .nav-item:hover::before { transform: translateY(-50%) scaleY(0.5); opacity: 0.5; }

  /* Active nav glow */
  .nav-item.active {
    background: rgba(0,212,255,0.07) !important;
    box-shadow: inset 0 0 20px rgba(0,212,255,0.04);
  }

  /* Enhanced topbar */
  .topbar {
    background: rgba(8,8,8,0.85) !important;
    backdrop-filter: blur(20px) saturate(1.5) !important;
    -webkit-backdrop-filter: blur(20px) saturate(1.5) !important;
    border-bottom: 1px solid rgba(255,255,255,0.05) !important;
    box-shadow: 0 1px 0 rgba(255,255,255,0.03), 0 4px 20px rgba(0,0,0,0.3);
  }

  /* Premium button effects */
  .btn-primary {
    position: relative;
    overflow: hidden;
    box-shadow: 0 0 0 rgba(0,212,255,0);
    transition: all 0.2s ease !important;
  }
  .btn-primary::after {
    content: '';
    position: absolute;
    inset: 0;
    background: linear-gradient(135deg, rgba(255,255,255,0.15) 0%, transparent 60%);
    pointer-events: none;
  }
  .btn-primary:hover {
    background: #1aff8e !important;
    box-shadow: 0 0 24px rgba(0,212,255,0.4), 0 4px 16px rgba(0,212,255,0.2) !important;
    transform: translateY(-1px);
  }
  .btn-primary:active { transform: translateY(0); }

  .btn-ghost:hover {
    background: rgba(255,255,255,0.04) !important;
    border-color: rgba(255,255,255,0.12) !important;
  }

  /* Enhanced stat cards */
  .stat-card {
    position: relative;
    transition: all 0.2s ease !important;
    background: rgba(15,15,15,0.9) !important;
    backdrop-filter: blur(10px);
  }
  .stat-card:hover {
    transform: translateY(-2px);
    border-color: rgba(255,255,255,0.08) !important;
    box-shadow: 0 8px 32px rgba(0,0,0,0.3);
  }

  /* Card hover lift */
  .card {
    transition: border-color 0.2s ease, box-shadow 0.2s ease;
    background: rgba(15,15,15,0.9) !important;
    backdrop-filter: blur(8px);
  }
  .card:hover {
    border-color: rgba(255,255,255,0.07) !important;
    box-shadow: 0 4px 24px rgba(0,0,0,0.2);
  }

  /* Quick card premium */
  .quick-card {
    background: rgba(15,15,15,0.9) !important;
    backdrop-filter: blur(8px);
    transition: all 0.2s cubic-bezier(0.34,1.2,0.64,1) !important;
  }
  .quick-card:hover {
    transform: translateY(-3px);
    border-color: rgba(0,212,255,0.2) !important;
    box-shadow: 0 8px 32px rgba(0,0,0,0.3), 0 0 0 1px rgba(0,212,255,0.08);
  }
  .quick-icon {
    background: rgba(0,212,255,0.08) !important;
    border-color: rgba(0,212,255,0.15) !important;
    transition: all 0.2s ease;
  }
  .quick-card:hover .quick-icon {
    background: rgba(0,212,255,0.15) !important;
    box-shadow: 0 0 16px rgba(0,212,255,0.2);
  }

  /* Glowing pulse dot */
  .dot {
    box-shadow: 0 0 8px var(--accent), 0 0 16px rgba(0,212,255,0.3) !important;
  }

  /* Form section premium */
  .form-section {
    background: rgba(15,15,15,0.9) !important;
    backdrop-filter: blur(8px);
    transition: border-color 0.2s ease;
  }
  .form-section:focus-within {
    border-color: rgba(0,212,255,0.2) !important;
  }

  /* Input focus glow */
  input:focus, textarea:focus, select:focus {
    outline: none;
    border-color: rgba(0,212,255,0.4) !important;
    box-shadow: 0 0 0 3px rgba(0,212,255,0.08), 0 0 12px rgba(0,212,255,0.08) !important;
    background: rgba(0,212,255,0.02) !important;
  }

  /* Page fade-in animation */
  @keyframes pageEntry {
    from { opacity: 0; transform: translateY(12px); }
    to { opacity: 1; transform: translateY(0); }
  }
  .panel.active {
    animation: pageEntry 0.22s cubic-bezier(0.34,1.2,0.64,1) both !important;
  }

  /* Activity icon hover */
  .activity-icon {
    transition: transform 0.15s ease, box-shadow 0.15s ease;
  }
  .activity-item:hover .activity-icon {
    transform: scale(1.1);
  }

  /* Niche badge glow */
  .nav-badge {
    box-shadow: 0 0 8px rgba(0,212,255,0.4);
    animation: pulse 2.5s ease-in-out infinite;
  }

  /* Platform tab */
  .platform-tab {
    backdrop-filter: blur(8px);
    transition: all 0.2s cubic-bezier(0.34,1.2,0.64,1) !important;
  }
  .platform-tab:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 20px rgba(0,0,0,0.2);
  }
  .platform-tab.active {
    box-shadow: 0 0 20px rgba(0,212,255,0.12);
  }

  /* Template card hover */
  .template-card {
    transition: all 0.2s cubic-bezier(0.34,1.2,0.64,1) !important;
  }
  .template-card:hover {
    transform: translateY(-3px);
    box-shadow: 0 8px 24px rgba(0,0,0,0.3), 0 0 0 1.5px var(--accent);
  }

  /* Gradient border on active elements */
  .template-card.selected {
    box-shadow: 0 0 0 1.5px var(--accent), 0 0 20px rgba(0,212,255,0.15) !important;
  }

  /* Enhanced progress bar */
  .progress-bar {
    background: linear-gradient(90deg, #00d4ff, #b44fff, #ec4899, #00d4ff) !important;
    background-size: 200% auto !important;
    animation: gradientFlow 2s linear infinite !important;
    box-shadow: 0 0 8px rgba(0,212,255,0.4);
  }
  @keyframes gradientFlow {
    0% { background-position: 0% center; }
    100% { background-position: 200% center; }
  }

  /* Status badges glow on hover */
  .badge-live {
    transition: box-shadow 0.2s ease;
  }
  .badge-live:hover {
    box-shadow: 0 0 12px rgba(0,212,255,0.3);
  }

  /* Welcome heading shimmer */
  #dash-greeting {
    background: linear-gradient(90deg, #ffffff 0%, #00d4ff 40%, #b44fff 70%, #ffffff 100%);
    background-size: 200% auto;
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
    animation: textShimmer 4s linear infinite;
  }
  @keyframes textShimmer {
    0% { background-position: 0% center; }
    100% { background-position: 200% center; }
  }

  /* Scrollbar refined */
  ::-webkit-scrollbar { width: 4px !important; }
  ::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.08) !important; }
  ::-webkit-scrollbar-thumb:hover { background: rgba(255,255,255,0.14) !important; }

  /* Site favicon glow on hover */
  .site-favicon {
    transition: transform 0.15s ease, box-shadow 0.15s ease;
  }
  .site-item:hover .site-favicon {
    transform: scale(1.08);
  }

  /* Mobile topbar glass */
  .mob-topbar {
    background: rgba(9,9,9,0.9) !important;
    backdrop-filter: blur(20px) !important;
    -webkit-backdrop-filter: blur(20px) !important;
    border-bottom: 1px solid rgba(255,255,255,0.05) !important;
  }

  /* Spinner accent */
  .spinner {
    border-color: rgba(0,212,255,0.15) !important;
    border-top-color: var(--accent) !important;
    box-shadow: 0 0 8px rgba(0,212,255,0.2);
  }

  /* Type card selection glow */
  .type-card.selected, .site-type-card.selected, .lp-type-card.selected {
    box-shadow: 0 0 20px rgba(0,212,255,0.15) !important;
  }

  /* Import site banner gradient shimmer */
  @keyframes bannerShimmer {
    0%, 100% { opacity: 0.8; }
    50% { opacity: 1; }
  }

  /* Insight items slide in */
  .insight-item {
    animation: fadeIn 0.4s ease both !important;
    transition: transform 0.2s ease, box-shadow 0.2s ease;
  }
  .insight-item:hover {
    transform: translateX(3px);
    box-shadow: 0 2px 12px rgba(0,0,0,0.2);
  }

  /* ---- Theme Store Cards (website builder) ---- */
  .theme-card {
    background: rgba(15,15,15,0.95);
    border: 1px solid var(--border);
    border-radius: 14px;
    overflow: hidden;
    cursor: pointer;
    transition: all 0.25s cubic-bezier(0.34,1.2,0.64,1);
    position: relative;
  }
  .theme-card:hover {
    transform: translateY(-6px);
    border-color: var(--accent);
    box-shadow: 0 16px 48px rgba(0,0,0,0.5), 0 0 0 1px rgba(0,212,255,0.2), 0 0 32px rgba(0,212,255,0.06);
  }
  .theme-preview {
    height: 180px;
    position: relative;
    overflow: hidden;
  }
  .theme-preview::after {
    content: '';
    position: absolute;
    inset: 0;
    background: linear-gradient(to bottom, transparent 60%, rgba(9,9,9,0.9));
  }
  .theme-overlay-btn {
    position: absolute;
    bottom: 12px;
    left: 50%;
    transform: translateX(-50%) translateY(8px);
    opacity: 0;
    transition: all 0.2s ease;
    z-index: 2;
    white-space: nowrap;
  }
  .theme-card:hover .theme-overlay-btn {
    opacity: 1;
    transform: translateX(-50%) translateY(0);
  }
  .theme-info {
    padding: 14px 16px;
  }
  .theme-name {
    font-family: 'Syne', sans-serif;
    font-size: 14px;
    font-weight: 700;
    margin-bottom: 4px;
    letter-spacing: -0.2px;
  }
  .theme-category {
    font-size: 10.5px;
    color: var(--muted);
    text-transform: uppercase;
    letter-spacing: 1px;
    font-weight: 600;
  }
  .theme-tags {
    display: flex;
    gap: 6px;
    margin-top: 10px;
    flex-wrap: wrap;
  }
  .theme-tag {
    font-size: 9.5px;
    padding: 2px 8px;
    border-radius: 20px;
    font-weight: 700;
    letter-spacing: 0.3px;
    background: rgba(255,255,255,0.05);
    color: var(--muted);
    border: 1px solid rgba(255,255,255,0.06);
  }
  .theme-tag.accent { background: rgba(0,212,255,0.08); color: var(--accent); border-color: rgba(0,212,255,0.15); }
  .theme-tag.purple { background: rgba(180,79,255,0.08); color: var(--accent2); border-color: rgba(180,79,255,0.15); }

  /* Theme grid */
  .theme-grid {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 16px;
    margin-bottom: 24px;
  }
  @media (max-width: 1100px) { .theme-grid { grid-template-columns: repeat(2, 1fr); } }
  @media (max-width: 768px) { .theme-grid { grid-template-columns: 1fr; } }

  /* Theme filter pills */
  .filter-pill {
    padding: 6px 14px;
    border-radius: 100px;
    font-size: 11.5px;
    font-weight: 600;
    border: 1px solid var(--border);
    background: transparent;
    color: var(--muted);
    cursor: pointer;
    transition: all 0.15s ease;
    font-family: 'Inter', sans-serif;
  }
  .filter-pill:hover { border-color: rgba(255,255,255,0.12); color: var(--text); }
  .filter-pill.active {
    background: rgba(0,212,255,0.08);
    border-color: rgba(0,212,255,0.3);
    color: var(--accent);
    box-shadow: 0 0 12px rgba(0,212,255,0.1);
  }
</style>
</head>
<body>

<!-- ANIMATED MESH BACKGROUND -->
<div class="mesh-bg">
  <div class="mesh-blob mesh-blob-1"></div>
  <div class="mesh-blob mesh-blob-2"></div>
  <div class="mesh-blob mesh-blob-3"></div>
</div>

<!-- MOBILE TOPBAR -->
<div class="mob-topbar">
  <div class="mob-logo" style="display:flex;align-items:center;gap:8px">
    <div style="width:22px;height:22px;background:var(--accent);border-radius:5px;display:flex;align-items:center;justify-content:center"><svg width="12" height="12" viewBox="0 0 24 24" fill="#000" stroke="none"><path d="M13 2L3 14h9l-1 8 10-12h-9l1-8z"/></svg></div>
    Niche<span>Forge</span>
  </div>
  <div class="mob-hamburger" onclick="toggleSidebar()">
    <span></span><span></span><span></span>
  </div>
</div>
<div class="sidebar-overlay" id="sidebar-overlay" onclick="toggleSidebar()"></div>

<!-- SIDEBAR -->
<aside class="sidebar" id="sidebar">
  <div class="logo">
    <div class="logo-mark">
      <div class="logo-icon"><svg width="14" height="14" viewBox="0 0 24 24" fill="#000" stroke="none"><path d="M13 2L3 14h9l-1 8 10-12h-9l1-8z"/></svg></div>
      Niche<span>Forge</span>
    </div>
    <div class="logo-sub" style="font-family:'Inter',sans-serif;font-size:9px;letter-spacing:2px;color:var(--muted);text-transform:uppercase;margin-top:4px;padding-left:32px">AI Web Studio</div>
  </div>

  <nav class="nav">
    <div class="nav-section">Main</div>
    <div class="nav-item active" onclick="showPanel('dashboard', this)">
      <span class="nav-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/><rect x="14" y="14" width="7" height="7"/></svg></span> Dashboard
    </div>
    <div class="nav-item" onclick="showPanel('create', this)">
      <span class="nav-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="16"/><line x1="8" y1="12" x2="16" y2="12"/></svg></span> Create Site
    </div>
    <div class="nav-item" onclick="showPanel('pages', this)">
      <span class="nav-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><polyline points="10 9 9 9 8 9"/></svg></span> Page Generator
    </div>

    <div class="nav-section">Tools</div>
    <div class="nav-item" onclick="showPanel('niche', this)">
      <span class="nav-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg></span> Niche Discovery
      <span class="nav-badge">6</span>
    </div>
    <div class="nav-item" onclick="showPanel('seo', this)">
      <span class="nav-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/></svg></span> SEO Generator
    </div>
    <div class="nav-item" onclick="showPanel('keywords', this)">
      <span class="nav-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20.59 13.41l-7.17 7.17a2 2 0 0 1-2.83 0L2 12V2h10l8.59 8.59a2 2 0 0 1 0 2.82z"/><line x1="7" y1="7" x2="7.01" y2="7"/></svg></span> Keywords
    </div>
    <div class="nav-item" onclick="showPanel('blog', this)">
      <span class="nav-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 20h9"/><path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4L16.5 3.5z"/></svg></span> Blog Writer
    </div>
    <div class="nav-item" onclick="showPanel('calendar', this)">
      <span class="nav-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="4" width="18" height="18" rx="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/><line x1="8" y1="14" x2="8.01" y2="14"/><line x1="12" y1="14" x2="12.01" y2="14"/><line x1="16" y1="14" x2="16.01" y2="14"/></svg></span> Content Calendar
    </div>
    <div class="nav-item" onclick="showPanel('landing', this)">
      <span class="nav-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="2" y="3" width="20" height="14" rx="2"/><path d="M8 21h8M12 17v4"/></svg></span> Landing Pages
    </div>

    <div class="nav-section">Deploy</div>
    <div class="nav-item" id="nav-themes" onclick="showPanel('themes', this)">
      <span class="nav-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/></svg></span> Theme Store
      <span class="nav-badge" style="background:var(--accent2);color:#fff">New</span>
    </div>
    <div class="nav-item" id="nav-builder" onclick="showPanel('builder', this)">
      <span class="nav-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="18" height="18" rx="2"/><path d="M3 9h18M9 21V9"/></svg></span> AI Builder
      <span class="nav-badge" style="background:linear-gradient(135deg,#ff6b35,#ffd93d);color:#000;font-weight:800">PRO</span>
    </div>
    <div class="nav-item" id="nav-design" onclick="showPanel('design', this)">
      <span class="nav-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="13.5" cy="6.5" r="2.5"/><circle cx="6.5" cy="13.5" r="2.5"/><circle cx="13.5" cy="17.5" r="2.5"/><path d="M13.5 9v5.5M6.5 16v-2.5M13.5 4V2M6.5 11V9"/></svg></span> Design Studio
      <span class="nav-badge" style="background:linear-gradient(135deg,#00d4ff,#b44fff);color:#fff">✦</span>
    </div>
    <div class="nav-item" onclick="showPanel('deploy', this)">
      <span class="nav-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg></span> Deploy
    </div>
    <div class="nav-item" onclick="showPanel('sites', this)">
      <span class="nav-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><line x1="2" y1="12" x2="22" y2="12"/><path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"/></svg></span> My Sites
    </div>
    <div class="nav-item" id="nav-import" onclick="showPanel('import', this)">
      <span class="nav-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg></span> Import Site
    </div>

    <div class="nav-section">CRM</div>
    <div class="nav-item" id="nav-bookings" onclick="showPanel('bookings', this)">
      <span class="nav-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg></span> Bookings
      <span class="nav-badge" id="bookings-badge" style="display:none">0</span>
    </div>

    <div class="nav-section">System</div>
    <div class="nav-item" id="nav-injector" onclick="showPanel('injector', this)">
      <span class="nav-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="16 18 22 12 16 6"/><polyline points="8 6 2 12 8 18"/></svg></span> Code Injector
    </div>
    <div class="nav-item" id="nav-marketing" onclick="showPanel('marketing', this)" style="position:relative">
      <span class="nav-icon">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 12h-4l-3 9L9 3l-3 9H2"/></svg>
      </span> Marketing OS
      <span style="position:absolute;right:10px;top:50%;transform:translateY(-50%);font-size:8px;font-weight:800;padding:2px 6px;border-radius:10px;background:linear-gradient(135deg,var(--accent),var(--accent2));color:#fff;letter-spacing:0.5px">LIVE</span>
    </div>
    <div class="nav-item" id="nav-settings" onclick="showPanel('settings', this)">
      <span class="nav-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="3"/><path d="M19.07 4.93a10 10 0 0 1 0 14.14M16.24 7.76a6 6 0 0 1 0 8.49M4.93 4.93a10 10 0 0 0 0 14.14M7.76 7.76a6 6 0 0 0 0 8.49"/></svg></span> Settings
    </div>
  </nav>

  <div class="sidebar-footer">
    <div class="status-dot">
      <div class="dot"></div>
      System Ready
    </div>
  </div>
</aside>

<!-- MAIN -->
<main class="main">

  <!-- TOPBAR -->
  <div class="topbar">
    <div class="page-title" id="page-title">Dashboard</div>
    <div class="topbar-actions">
      <button class="btn btn-ghost" onclick="showPanel('settings',document.querySelector('#nav-settings'))" style="display:flex;align-items:center;gap:6px">
        <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="3"/><path d="M19.07 4.93a10 10 0 0 1 0 14.14M16.24 7.76a6 6 0 0 1 0 8.49M4.93 4.93a10 10 0 0 0 0 14.14M7.76 7.76a6 6 0 0 0 0 8.49"/></svg>
        Settings
      </button>
      <button class="btn btn-accent2" onclick="showPanel('niche')" style="display:flex;align-items:center;gap:6px">
        <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>
        Find Niches
      </button>
      <button class="btn btn-primary" onclick="showPanel('create')" style="display:flex;align-items:center;gap:6px">
        <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
        New Site
      </button>
    </div>
  </div>

  <!-- CONTENT -->
  <div class="content">

    <!-- ===== DASHBOARD ===== -->
    <div class="panel active" id="panel-dashboard">

      <!-- Welcome bar -->
      <div style="display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:12px;margin-bottom:24px">
        <div>
          <div class="hero-heading" style="font-size:clamp(20px,3vw,28px)" id="dash-greeting">Good morning</div>
          <div style="color:var(--muted);font-size:13px;margin-top:3px" id="dash-date"></div>
        </div>
        <div style="display:flex;gap:8px;flex-wrap:wrap">
          <button class="btn btn-ghost" onclick="refreshDashboard()"><svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polyline points="1 4 1 10 7 10"/><path d="M3.51 15a9 9 0 1 0 .49-3.95"/></svg> Refresh</button>
          <button class="btn btn-accent2" onclick="showPanel('niche')"><svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg> Find Niches</button>
          <button class="btn btn-primary" onclick="showPanel('create')"><svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="16"/><line x1="8" y1="12" x2="16" y2="12"/></svg> New Site</button>
        </div>
      </div>

      <!-- Live stat cards -->
      <div class="stats-row" style="margin-bottom:20px">
        <div class="stat-card" style="cursor:pointer" onclick="showPanel('sites')">
          <div class="stat-label">Total Sites</div>
          <div class="stat-value" id="ds-sites">—</div>
          <div class="stat-sub" id="ds-sites-sub">Loading...</div>
          <div style="margin-top:10px;height:30px" id="ds-sites-spark"></div>
        </div>
        <div class="stat-card" style="cursor:pointer" onclick="showPanel('pages')">
          <div class="stat-label">Pages Generated</div>
          <div class="stat-value" id="ds-pages">—</div>
          <div class="stat-sub" id="ds-pages-sub">Loading...</div>
          <div style="margin-top:10px;height:30px" id="ds-pages-spark"></div>
        </div>
        <div class="stat-card" style="cursor:pointer" onclick="showPanel('keywords')">
          <div class="stat-label">Keywords Tracked</div>
          <div class="stat-value" id="ds-kw">—</div>
          <div class="stat-sub" id="ds-kw-sub">Loading...</div>
          <div style="margin-top:10px;height:30px" id="ds-kw-spark"></div>
        </div>
        <div class="stat-card" style="cursor:pointer" onclick="showPanel('deploy')">
          <div class="stat-label">Deployments</div>
          <div class="stat-value" id="ds-deploys">—</div>
          <div class="stat-sub" id="ds-deploys-sub">Loading...</div>
          <div style="margin-top:10px;height:30px" id="ds-deploys-spark"></div>
        </div>
      </div>

      <!-- AI Site Health + Sites row -->
      <div class="grid-2" style="margin-bottom:20px">

        <!-- Site health -->
        <div class="card">
          <div class="card-title" style="margin-bottom:16px"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="var(--accent)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="margin-right:6px"><path d="M22 12h-4l-3 9L9 3l-3 9H2"/></svg>Site Health Monitor
            <span id="health-loading" style="font-size:11px;color:var(--muted);font-family:'Inter',sans-serif;font-weight:400">Scanning...</span>
          </div>
          <div id="health-list" style="display:flex;flex-direction:column;gap:10px">
            <!-- rendered by JS -->
          </div>
          <div id="health-tip" style="display:none;margin-top:14px;padding:12px;background:rgba(0,212,255,0.05);border:1px solid rgba(0,212,255,0.12);border-radius:8px;font-size:12px;color:var(--muted);line-height:1.6"></div>
        </div>

        <!-- Sites + Activity -->
        <div style="display:flex;flex-direction:column;gap:16px">
          <div class="card">
            <div class="card-title">My Sites <a onclick="showPanel('sites')">View all →</a></div>
            <div id="dash-sites-list">
              <div class="site-item">
                <div class="site-favicon" style="background:rgba(0,212,255,0.07);border:1px solid rgba(0,212,255,0.12);color:var(--accent)">
                  <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"><path d="M14.7 6.3a1 1 0 0 0 0 1.4l1.6 1.6a1 1 0 0 0 1.4 0l3.77-3.77a6 6 0 0 1-7.94 7.94l-6.91 6.91a2.12 2.12 0 0 1-3-3l6.91-6.91a6 6 0 0 1 7.94-7.94l-3.76 3.76z"/></svg>
                </div>
                <div class="site-info"><div class="site-name">Home Repair Pro</div><div class="site-url">homerepairpro.com</div></div>
                <span class="site-badge badge-live"><span style="display:inline-block;width:5px;height:5px;background:var(--accent);border-radius:50%;margin-right:4px"></span>Live</span>
              </div>
              <div class="site-item">
                <div class="site-favicon" style="background:rgba(180,79,255,0.07);border:1px solid rgba(180,79,255,0.12);color:var(--accent2)">
                  <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"><path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"/><path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"/></svg>
                </div>
                <div class="site-info"><div class="site-name">DIY Repair Hub</div><div class="site-url">diyrepairhub.com</div></div>
                <span class="site-badge badge-live"><span style="display:inline-block;width:5px;height:5px;background:var(--accent);border-radius:50%;margin-right:4px"></span>Live</span>
              </div>
              <div class="site-item">
                <div class="site-favicon" style="background:rgba(100,180,255,0.07);border:1px solid rgba(100,180,255,0.12);color:#7dd3fc">
                  <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"><path d="M8 2h8"/><path d="M9 2v2.789a4 4 0 0 1-.672 2.219l-.656.984A4 4 0 0 0 7 10.212V20a2 2 0 0 0 2 2h6a2 2 0 0 0 2-2v-9.789a4 4 0 0 0-.672-2.219l-.656-.984A4 4 0 0 1 15 4.788V2"/><path d="M7 15a6.472 6.472 0 0 1 5 0 6.47 6.47 0 0 0 5 0"/></svg>
                </div>
                <div class="site-info"><div class="site-name">AC Repair Guide</div><div class="site-url">acrepairguide.net</div></div>
                <span class="site-badge badge-building">Building</span>
              </div>
            </div>
          </div>

          <div class="card">
            <div class="card-title">Recent Activity</div>
            <div id="dash-activity-list">
              <div class="activity-item">
                <div class="activity-icon" style="background:rgba(0,212,255,0.08);border:1px solid rgba(0,212,255,0.12);border-radius:7px;color:var(--accent)">
                  <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><polyline points="20 6 9 17 4 12"/></svg>
                </div>
                <div><div class="activity-text">SEO package generated for <strong>AC Repair Guide</strong></div><div class="activity-time">2 min ago</div></div>
              </div>
              <div class="activity-item">
                <div class="activity-icon" style="background:rgba(180,79,255,0.08);border:1px solid rgba(180,79,255,0.12);border-radius:7px;color:var(--accent2)">
                  <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>
                </div>
                <div><div class="activity-text">Deployed <strong>DIY Repair Hub</strong> to Cloudflare</div><div class="activity-time">1 hour ago</div></div>
              </div>
              <div class="activity-item">
                <div class="activity-icon" style="background:rgba(245,158,11,0.08);border:1px solid rgba(245,158,11,0.12);border-radius:7px;color:#f59e0b">
                  <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>
                </div>
                <div><div class="activity-text">Niche scan found <strong>6 opportunities</strong></div><div class="activity-time">3 hours ago</div></div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Import site banner -->
      <div style="background:linear-gradient(135deg,rgba(180,79,255,0.08),rgba(0,212,255,0.05));border:1px solid rgba(180,79,255,0.2);border-radius:14px;padding:20px 24px;margin-bottom:20px;display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:14px">
        <div style="display:flex;align-items:center;gap:14px">
          <div style="width:44px;height:44px;border-radius:10px;background:rgba(180,79,255,0.08);border:1px solid rgba(180,79,255,0.15);display:flex;align-items:center;justify-content:center;color:var(--accent2);flex-shrink:0">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
          </div>
          <div>
            <div style="font-family:'Syne',sans-serif;font-size:16px;font-weight:700;letter-spacing:0.5px;text-transform:uppercase;margin-bottom:3px">Import Your Hostinger Sites</div>
            <div style="font-size:12px;color:var(--muted)">Paste your existing HTML — NicheForge preserves your GA4, AdSense codes & SEO, then modernises the design</div>
          </div>
        </div>
        <button class="btn btn-accent2" onclick="showPanel('import',document.querySelector('#nav-import'))" style="display:flex;align-items:center;gap:6px">
          <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
          Import Site
        </button>
      </div>

      <!-- AI Insights panel -->
      <div class="card" style="margin-bottom:20px">
        <div class="card-title" style="margin-bottom:14px"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="var(--accent2)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="margin-right:6px"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></svg>AI Daily Insights
          <span id="insights-loading" style="font-size:11px;color:var(--muted);font-family:'Inter',sans-serif;font-weight:400">Generating...</span>
        </div>
        <div id="insights-list" style="display:flex;flex-direction:column;gap:8px">
          <div style="height:60px;background:var(--surface2);border-radius:8px;animation:pulse-load 1.5s infinite"></div>
          <div style="height:60px;background:var(--surface2);border-radius:8px;animation:pulse-load 1.5s infinite 0.2s"></div>
          <div style="height:60px;background:var(--surface2);border-radius:8px;animation:pulse-load 1.5s infinite 0.4s"></div>
        </div>
      </div>

      <!-- Quick actions -->
      <div class="section-label" style="margin-bottom:12px">Quick Actions</div>
      <div class="grid-3" style="margin-bottom:4px">
        <div class="quick-card" onclick="showPanel('create')">
          <div class="quick-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="16"/><line x1="8" y1="12" x2="16" y2="12"/></svg></div>
          <div><div class="quick-title">New Site</div><div class="quick-desc">Launch a niche, DIY or local service site</div></div>
        </div>
        <div class="quick-card" onclick="showPanel('pages')">
          <div class="quick-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/></svg></div>
          <div><div class="quick-title">Generate Page</div><div class="quick-desc">Full SEO page — ready to upload in seconds</div></div>
        </div>
        <div class="quick-card" onclick="showPanel('import',document.querySelector('#nav-import'))">
          <div class="quick-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg></div>
          <div><div class="quick-title">Import Site</div><div class="quick-desc">Clone your Hostinger site, keep all your codes</div></div>
        </div>
        <div class="quick-card" onclick="showPanel('seo')">
          <div class="quick-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/></svg></div>
          <div><div class="quick-title">SEO Package</div><div class="quick-desc">Generate complete meta, OG, schema in one click</div></div>
        </div>
        <div class="quick-card" onclick="showPanel('niche')">
          <div class="quick-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg></div>
          <div><div class="quick-title">Find Niches</div><div class="quick-desc">AI scans for profitable low-competition niches</div></div>
        </div>
        <div class="quick-card" onclick="showPanel('deploy')">
          <div class="quick-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg></div>
          <div><div class="quick-title">Deploy</div><div class="quick-desc">Push to Cloudflare Pages, live in seconds</div></div>
        </div>
      </div>
    </div>

    <!-- ===== CREATE SITE ===== -->
    <div class="panel" id="panel-create">

      <div class="wizard-steps">
        <div class="step active" id="wstep1"><div class="step-num">1</div> Site Type</div>
        <div class="step-line"></div>
        <div class="step" id="wstep2"><div class="step-num">2</div> Details</div>
        <div class="step-line"></div>
        <div class="step" id="wstep3"><div class="step-num">3</div> SEO Config</div>
        <div class="step-line"></div>
        <div class="step" id="wstep4"><div class="step-num">4</div> Generate</div>
      </div>

      <div class="form-section" id="ws-step1">
        <div class="form-section-title">Choose Site Type</div>
        <div class="site-type-grid">
          <div class="type-card selected" onclick="selectType(this)">
            <div class="type-icon"><svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"><rect x="2" y="3" width="20" height="14" rx="2"/><line x1="8" y1="21" x2="16" y2="21"/><line x1="12" y1="17" x2="12" y2="21"/></svg></div>
            <div class="type-name">AdSense Niche Blog</div>
            <div class="type-desc">Info content, high RPM keywords, ad-optimized layout</div>
          </div>
          <div class="type-card" onclick="selectType(this)">
            <div class="type-icon"><svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"><path d="M14.7 6.3a1 1 0 0 0 0 1.4l1.6 1.6a1 1 0 0 0 1.4 0l3.77-3.77a6 6 0 0 1-7.94 7.94l-6.91 6.91a2.12 2.12 0 0 1-3-3l6.91-6.91a6 6 0 0 1 7.94-7.94l-3.76 3.76z"/></svg></div>
            <div class="type-name">DIY & How-To</div>
            <div class="type-desc">Step-by-step guides, tutorials, repair walkthroughs</div>
          </div>
          <div class="type-card" onclick="selectType(this)">
            <div class="type-icon"><svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"/><circle cx="12" cy="10" r="3"/></svg></div>
            <div class="type-name">Local Service</div>
            <div class="type-desc">City-targeted service pages, lead forms, local SEO</div>
          </div>
        </div>

        <div class="form-grid">
          <div class="form-group">
            <label>Site Name</label>
            <input type="text" placeholder="e.g. AC Repair Guide">
          </div>
          <div class="form-group">
            <label>Domain</label>
            <input type="text" placeholder="e.g. acrepairguide.com">
          </div>
          <div class="form-group">
            <label>Primary Niche</label>
            <input type="text" placeholder="e.g. HVAC, plumbing, roofing...">
          </div>
          <div class="form-group">
            <label>Target Location (optional)</label>
            <input type="text" placeholder="e.g. Dubai, UAE or leave blank">
          </div>
        </div>

        <button class="btn btn-primary" onclick="nextStep(2)">Continue <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="5" y1="12" x2="19" y2="12"/><polyline points="12 5 19 12 12 19"/></svg></button>
      </div>

      <div class="form-section" id="ws-step2" style="display:none">
        <div class="form-section-title">Site Details & Content</div>
        <div class="form-grid">
          <div class="form-group full">
            <label>Site Description (used for meta and content tone)</label>
            <textarea placeholder="Describe what this site is about, who it's for, and what problems it solves..."></textarea>
          </div>
          <div class="form-group">
            <label>Monetization</label>
            <select>
              <option>Google AdSense</option>
              <option>Affiliate + AdSense</option>
              <option>Lead Generation</option>
              <option>Service Sales</option>
            </select>
          </div>
          <div class="form-group">
            <label>Pages to Generate</label>
            <select>
              <option>5 pages (starter)</option>
              <option>10 pages (standard)</option>
              <option>20 pages (full site)</option>
              <option>Custom</option>
            </select>
          </div>
          <div class="form-group">
            <label>Content Language</label>
            <select>
              <option>English (US)</option>
              <option>English (UK)</option>
              <option>Arabic</option>
            </select>
          </div>
          <div class="form-group">
            <label>Design Theme</label>
            <select>
              <option>Modern Dark</option>
              <option>Clean Light</option>
              <option>Bold Magazine</option>
              <option>Minimal Pro</option>
            </select>
          </div>
        </div>

        <div style="margin-bottom:20px">
          <div style="font-size:13px;font-weight:600;margin-bottom:12px;color:var(--muted)">Auto-enable Features</div>
          <div class="toggle-row">
            <div><div class="toggle-label">Auto SEO Tags</div><div class="toggle-desc">Title, meta, Open Graph, canonical on every page</div></div>
            <div class="toggle on" onclick="this.classList.toggle('on')"></div>
          </div>
          <div class="toggle-row">
            <div><div class="toggle-label">Schema Markup</div><div class="toggle-desc">Article, HowTo, FAQ, LocalBusiness JSON-LD</div></div>
            <div class="toggle on" onclick="this.classList.toggle('on')"></div>
          </div>
          <div class="toggle-row">
            <div><div class="toggle-label">Auto Sitemap + robots.txt</div><div class="toggle-desc">Generated and updated on every build</div></div>
            <div class="toggle on" onclick="this.classList.toggle('on')"></div>
          </div>
          <div class="toggle-row">
            <div><div class="toggle-label">Unsplash Images</div><div class="toggle-desc">Pull relevant free stock photos automatically</div></div>
            <div class="toggle on" onclick="this.classList.toggle('on')"></div>
          </div>
          <div class="toggle-row">
            <div><div class="toggle-label">AI Image Prompts</div><div class="toggle-desc">Generate prompts for Ideogram / Leonardo AI</div></div>
            <div class="toggle" onclick="this.classList.toggle('on')"></div>
          </div>
          <div class="toggle-row">
            <div><div class="toggle-label">Google Analytics 4</div><div class="toggle-desc">Auto-inject GA4 tracking on all pages</div></div>
            <div class="toggle" onclick="this.classList.toggle('on')"></div>
          </div>
        </div>

        <div style="display:flex;gap:10px">
          <button class="btn btn-ghost" onclick="nextStep(1)"><svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="19" y1="12" x2="5" y2="12"/><polyline points="12 19 5 12 12 5"/></svg> Back</button>
          <button class="btn btn-primary" onclick="nextStep(3)">Continue <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="5" y1="12" x2="19" y2="12"/><polyline points="12 5 19 12 12 19"/></svg></button>
        </div>
      </div>

      <div class="form-section" id="ws-step3" style="display:none">
        <div class="form-section-title">SEO Configuration</div>
        <div class="form-grid">
          <div class="form-group">
            <label>Primary Keyword</label>
            <input type="text" placeholder="e.g. AC repair Dubai">
          </div>
          <div class="form-group">
            <label>Secondary Keywords (comma separated)</label>
            <input type="text" placeholder="e.g. air conditioning service, HVAC repair">
          </div>
          <div class="form-group full">
            <label>Target Audience</label>
            <input type="text" placeholder="e.g. homeowners in Dubai looking for affordable AC repair">
          </div>
          <div class="form-group">
            <label>Keyword Intent</label>
            <select>
              <option>Informational (How-to, What is)</option>
              <option>Commercial (Best, Reviews)</option>
              <option>Transactional (Buy, Hire, Book)</option>
              <option>Local (Near me, City name)</option>
            </select>
          </div>
          <div class="form-group">
            <label>Internal Linking Strategy</label>
            <select>
              <option>Hub & Spoke (Pillar + Clusters)</option>
              <option>Linear (Blog chain)</option>
              <option>Flat (All pages equal)</option>
            </select>
          </div>
        </div>
        <div style="display:flex;gap:10px">
          <button class="btn btn-ghost" onclick="nextStep(2)"><svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="19" y1="12" x2="5" y2="12"/><polyline points="12 19 5 12 12 5"/></svg> Back</button>
          <button class="btn btn-primary" onclick="nextStep(4)">Generate Site <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="5" y1="12" x2="19" y2="12"/><polyline points="12 5 19 12 12 19"/></svg></button>
        </div>
      </div>

      <div class="form-section" id="ws-step4" style="display:none">
        <div class="form-section-title">Generating Your Site</div>
        <div class="alert alert-info">NicheForge is building your site. All pages, SEO tags, schema markup, and content are being created automatically.</div>

        <div class="deploy-step">
          <div class="deploy-step-icon step-done2">✓</div>
          <div class="deploy-step-info">
            <div class="deploy-step-name">Site configuration saved</div>
            <div class="deploy-step-desc">Type, niche, monetization strategy locked</div>
          </div>
          <div class="deploy-step-time">Done</div>
        </div>
        <div class="deploy-step">
          <div class="deploy-step-icon step-done2">✓</div>
          <div class="deploy-step-info">
            <div class="deploy-step-name">Page map created</div>
            <div class="deploy-step-desc">10 pages planned with keyword assignments</div>
          </div>
          <div class="deploy-step-time">Done</div>
        </div>
        <div class="deploy-step">
          <div class="deploy-step-icon step-active"><div class="spinner"></div></div>
          <div class="deploy-step-info">
            <div class="deploy-step-name">Generating HTML pages...</div>
            <div class="deploy-step-desc">Content + SEO tags + schema markup</div>
          </div>
          <div class="deploy-step-time">Running</div>
        </div>
        <div class="deploy-step">
          <div class="deploy-step-icon step-pending">4</div>
          <div class="deploy-step-info">
            <div class="deploy-step-name">Fetch images from Unsplash</div>
            <div class="deploy-step-desc">Optimized WebP images per section</div>
          </div>
          <div class="deploy-step-time">Waiting</div>
        </div>
        <div class="deploy-step">
          <div class="deploy-step-icon step-pending">5</div>
          <div class="deploy-step-info">
            <div class="deploy-step-name">Build sitemap.xml + robots.txt</div>
            <div class="deploy-step-desc">Fully formed, ready to submit to Google</div>
          </div>
          <div class="deploy-step-time">Waiting</div>
        </div>
        <div class="deploy-step">
          <div class="deploy-step-icon step-pending">6</div>
          <div class="deploy-step-info">
            <div class="deploy-step-name">Push to GitHub & deploy to Cloudflare</div>
            <div class="deploy-step-desc">Site goes live on your domain</div>
          </div>
          <div class="deploy-step-time">Waiting</div>
        </div>

        <div class="progress-bar-wrap" style="margin-top:20px">
          <div class="progress-bar" id="build-progress" style="width:35%"></div>
        </div>
        <div style="font-size:12px;color:var(--muted);text-align:center">35% complete — Generating pages...</div>
      </div>
    </div>

    <!-- ===== PAGE GENERATOR ===== -->
    <div class="panel" id="panel-pages">

      <!-- INPUT FORM -->
      <div id="pg-form-area">
        <div class="form-section">
          <div class="form-section-title">Page Generator — AI Powered</div>
          <div class="form-grid" style="margin-bottom:20px">
            <div class="form-group">
              <label>Site Name</label>
              <input type="text" id="pg-site" placeholder="e.g. AC Repair Guide" value="AC Repair Guide">
            </div>
            <div class="form-group">
              <label>Page Type</label>
              <select id="pg-type">
                <option value="service">Service Page</option>
                <option value="blog">Blog Post / Article</option>
                <option value="howto">How-To Guide</option>
                <option value="local">City / Location Page</option>
                <option value="home">Homepage</option>
              </select>
            </div>
            <div class="form-group">
              <label>Target Keyword</label>
              <input type="text" id="pg-keyword" placeholder="e.g. AC repair cost Dubai">
            </div>
            <div class="form-group">
              <label>Location (optional)</label>
              <input type="text" id="pg-location" placeholder="e.g. Dubai, UAE">
            </div>
            <div class="form-group">
              <label>Site URL</label>
              <input type="text" id="pg-siteurl" placeholder="e.g. https://acrepairguide.com">
            </div>
            <div class="form-group">
              <label>Color Theme</label>
              <select id="pg-theme">
                <option value="dark">Modern Dark</option>
                <option value="light">Clean Light</option>
                <option value="blue">Bold Blue</option>
                <option value="green">Fresh Green</option>
              </select>
            </div>
            <div class="form-group full">
              <label>Page Brief — describe sections, tone, what to include</label>
              <textarea id="pg-brief" rows="3" placeholder="e.g. Service page for homeowners, include pricing table, FAQ with 4 questions, trust signals, and a contact CTA at the bottom..."></textarea>
            </div>
          </div>

          <div style="margin-bottom:20px">
            <div style="font-size:12px;font-weight:600;margin-bottom:10px;color:var(--muted)">Template Style</div>
            <div class="template-grid">
              <div class="template-card selected" onclick="selectTemplate(this,'article')">
                <div class="template-preview t1" style="display:flex;align-items:center;justify-content:center"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8"><rect x="2" y="3" width="20" height="14" rx="2"/><line x1="8" y1="21" x2="16" y2="21"/></svg></div>
                <div class="template-name">Article Pro</div>
              </div>
              <div class="template-card" onclick="selectTemplate(this,'howto')">
                <div class="template-preview t2" style="display:flex;align-items:center;justify-content:center"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8"><path d="M14.7 6.3a1 1 0 0 0 0 1.4l1.6 1.6a1 1 0 0 0 1.4 0l3.77-3.77a6 6 0 0 1-7.94 7.94l-6.91 6.91a2.12 2.12 0 0 1-3-3l6.91-6.91a6 6 0 0 1 7.94-7.94l-3.76 3.76z"/></svg></div>
                <div class="template-name">How-To Guide</div>
              </div>
              <div class="template-card" onclick="selectTemplate(this,'local')">
                <div class="template-preview t3" style="display:flex;align-items:center;justify-content:center"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"/><circle cx="12" cy="10" r="3"/></svg></div>
                <div class="template-name">Local Service</div>
              </div>
              <div class="template-card" onclick="selectTemplate(this,'review')">
                <div class="template-preview t4" style="display:flex;align-items:center;justify-content:center"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/></svg></div>
                <div class="template-name">Review Page</div>
              </div>
            </div>
          </div>

          <!-- Toggles -->
          <div style="background:var(--surface2);border:1px solid var(--border);border-radius:10px;padding:16px;margin-bottom:20px">
            <div style="font-size:12px;font-weight:600;color:var(--muted);margin-bottom:12px;text-transform:uppercase;letter-spacing:1px">Auto-include</div>
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:0">
              <div class="toggle-row" style="padding:8px 0">
                <div class="toggle-label" style="font-size:12px">Full SEO Meta Tags</div>
                <div class="toggle on" id="tog-seo" onclick="this.classList.toggle('on')"></div>
              </div>
              <div class="toggle-row" style="padding:8px 0;border-bottom:none">
                <div class="toggle-label" style="font-size:12px">Schema JSON-LD</div>
                <div class="toggle on" id="tog-schema" onclick="this.classList.toggle('on')"></div>
              </div>
              <div class="toggle-row" style="padding:8px 0;border-bottom:none">
                <div class="toggle-label" style="font-size:12px">FAQ Section</div>
                <div class="toggle on" id="tog-faq" onclick="this.classList.toggle('on')"></div>
              </div>
              <div class="toggle-row" style="padding:8px 0;border-bottom:none">
                <div class="toggle-label" style="font-size:12px">CTA / Contact Form</div>
                <div class="toggle on" id="tog-cta" onclick="this.classList.toggle('on')"></div>
              </div>
            </div>
          </div>

          <button class="btn btn-primary" id="pg-generate-btn" onclick="runPageGenerator()" style="font-size:14px;padding:12px 28px">Generate Full Page</button>
        </div>
      </div>

      <!-- GENERATING STATE -->
      <div id="pg-generating" style="display:none">
        <div class="form-section">
          <div class="form-section-title">Generating Your Page...</div>
          <div id="pg-gen-steps">
            <div class="deploy-step" id="gstep-1">
              <div class="deploy-step-icon step-active"><div class="spinner"></div></div>
              <div class="deploy-step-info"><div class="deploy-step-name">Building page structure & content</div><div class="deploy-step-desc">AI writing sections, headings, body copy...</div></div>
            </div>
            <div class="deploy-step" id="gstep-2" style="opacity:0.4">
              <div class="deploy-step-icon step-pending">2</div>
              <div class="deploy-step-info"><div class="deploy-step-name">Generating SEO tags + schema markup</div><div class="deploy-step-desc">Meta, Open Graph, JSON-LD, canonical</div></div>
            </div>
            <div class="deploy-step" id="gstep-3" style="opacity:0.4">
              <div class="deploy-step-icon step-pending">3</div>
              <div class="deploy-step-info"><div class="deploy-step-name">Applying design & layout</div><div class="deploy-step-desc">Modern responsive HTML/CSS</div></div>
            </div>
            <div class="deploy-step" id="gstep-4" style="opacity:0.4">
              <div class="deploy-step-icon step-pending">4</div>
              <div class="deploy-step-info"><div class="deploy-step-name">Finalising output file</div><div class="deploy-step-desc">Ready to copy or download</div></div>
            </div>
          </div>
          <div class="progress-bar-wrap" style="margin-top:20px"><div class="progress-bar" id="pg-progress" style="width:5%"></div></div>
          <div id="pg-progress-label" style="font-size:12px;color:var(--muted);text-align:center;margin-top:6px">Starting...</div>
        </div>
      </div>

      <!-- OUTPUT -->
      <div id="pg-output-area" style="display:none">
        <div class="form-section" style="margin-bottom:16px">
          <div style="display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:12px">
            <div>
              <div class="form-section-title" style="margin-bottom:4px;border:none;padding:0">Page Generated</div>
              <div style="font-size:12px;color:var(--muted)" id="pg-filename-label">—</div>
            </div>
            <div style="display:flex;gap:10px;flex-wrap:wrap">
              <button class="btn btn-ghost" onclick="pgCopyCode()"><svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2"/><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/></svg> Copy HTML</button>
              <button class="btn btn-ghost" onclick="pgDownload()"><svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg> Download</button>
              <button class="btn btn-accent2" onclick="pgTogglePreview()"><svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg> Toggle Preview</button>
              <button class="btn btn-primary" onclick="pgReset()"><svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="16"/><line x1="8" y1="12" x2="16" y2="12"/></svg> Generate Another</button>
            </div>
          </div>
        </div>

        <!-- Preview iframe -->
        <div id="pg-preview-wrap" style="display:none;margin-bottom:16px;border:1px solid var(--border);border-radius:12px;overflow:hidden">
          <div style="background:var(--surface);padding:8px 16px;border-bottom:1px solid var(--border);font-size:12px;color:var(--muted);display:flex;align-items:center;gap:8px">
            <span style="color:var(--accent)">●</span><span style="color:#ffd93d">●</span><span style="color:var(--accent3)">●</span>
            <span style="margin-left:8px" id="pg-preview-url">preview</span>
          </div>
          <iframe id="pg-preview-frame" style="width:100%;height:600px;border:none;background:#fff"></iframe>
        </div>

        <!-- Code view -->
        <div class="card">
          <div class="card-title">Generated HTML Code <span style="font-family:'DM Sans';font-size:11px;font-weight:400;color:var(--muted)" id="pg-char-count"></span></div>
          <div id="pg-code-display" style="background:var(--surface2);border:1px solid var(--border);border-radius:8px;padding:16px;font-family:'Courier New',monospace;font-size:11px;line-height:1.6;color:#a8d8a8;max-height:400px;overflow-y:auto;white-space:pre-wrap;word-break:break-all"></div>
        </div>
      </div>

      <!-- Error state -->
      <div id="pg-error" style="display:none">
        <div class="form-section">
          <div class="alert" style="background:rgba(255,107,107,0.08);border-color:rgba(255,107,107,0.2);color:var(--accent3)" id="pg-error-msg"></div>
          <button class="btn btn-ghost" onclick="pgReset()"><svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="19" y1="12" x2="5" y2="12"/><polyline points="12 19 5 12 12 5"/></svg> Try Again</button>
        </div>
      </div>
    </div>

    <!-- ===== NICHE DISCOVERY ===== -->
    <div class="panel" id="panel-niche">

      <!-- Search controls -->
      <div class="card" style="margin-bottom:20px">
        <div class="card-title">AI Niche Discovery Engine</div>
        <div style="display:flex;gap:12px;align-items:flex-end;flex-wrap:wrap" class="niche-search-row">
          <div style="flex:1;min-width:180px">
            <label style="margin-bottom:6px;display:block;font-size:12px;color:var(--muted)">Seed Topic</label>
            <input type="text" id="niche-seed" placeholder="e.g. home repair, plumbing..." value="home repair">
          </div>
          <div style="min-width:130px">
            <label style="margin-bottom:6px;display:block;font-size:12px;color:var(--muted)">Min AdSense RPM</label>
            <select id="niche-rpm" style="width:100%">
              <option value="5">$5+ RPM</option>
              <option value="8" selected>$8+ RPM</option>
              <option value="12">$12+ RPM</option>
            </select>
          </div>
          <div style="min-width:130px">
            <label style="margin-bottom:6px;display:block;font-size:12px;color:var(--muted)">Competition</label>
            <select id="niche-comp" style="width:100%">
              <option value="any">Any</option>
              <option value="low" selected>Low only</option>
              <option value="low-med">Low–Medium</option>
            </select>
          </div>
          <button class="btn btn-primary" id="niche-scan-btn" onclick="runNicheScan()" style="white-space:nowrap">Scan Niches</button>
        </div>
      </div>

      <!-- Loading state -->
      <div id="niche-loading" style="display:none">
        <div class="card" style="text-align:center;padding:40px">
          <div style="width:52px;height:52px;background:rgba(0,212,255,0.06);border:1px solid rgba(0,212,255,0.12);border-radius:12px;display:flex;align-items:center;justify-content:center;margin:0 auto 16px;color:var(--accent)"><svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg></div>
          <div style="font-family:'Syne',sans-serif;font-size:16px;font-weight:700;margin-bottom:8px">Scanning for Niches...</div>
          <div style="color:var(--muted);font-size:13px;margin-bottom:20px">AI is analysing search trends, RPM data, and competition levels</div>
          <div class="progress-bar-wrap" style="max-width:300px;margin:0 auto">
            <div class="progress-bar" id="niche-progress" style="width:10%"></div>
          </div>
          <div id="niche-progress-label" style="font-size:11px;color:var(--muted);margin-top:8px">Initialising scan...</div>
        </div>
      </div>

      <!-- Results header -->
      <div id="niche-results-header" style="display:none;margin-bottom:16px;display:none">
        <div style="font-family:'Syne',sans-serif;font-size:14px;font-weight:700" id="niche-results-title">Results</div>
      </div>

      <!-- Results grid -->
      <div class="niche-grid" id="niche-results-grid">
        <!-- Default pre-loaded cards -->
        <div class="niche-card">
          <div class="niche-header"><div class="niche-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="2" x2="12" y2="22"/><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/></svg></div><div class="rpm-badge">$12 RPM</div></div>
          <div class="niche-name">HVAC Repair & Maintenance</div>
          <div class="niche-desc">Air conditioning, heating systems, duct cleaning. High seasonal search volume, strong local intent.</div>
          <div class="niche-meta">
            <div class="meta-item"><div class="meta-dot dot-easy"></div> Low competition</div>
            <div class="meta-item">84K/mo</div>
          </div>
          <div style="margin-top:12px;display:flex;gap:8px">
            <button class="btn btn-ghost" style="flex:1;font-size:11px;padding:6px" onclick="buildNiche('HVAC Repair')">Build Site <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="5" y1="12" x2="19" y2="12"/><polyline points="12 5 19 12 12 19"/></svg></button>
            <button class="btn btn-ghost" style="font-size:11px;padding:6px 10px" onclick="getNicheKeywords('HVAC Repair')">Keywords</button>
          </div>
        </div>
        <div class="niche-card">
          <div class="niche-header"><div class="niche-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="16 18 22 12 16 6"/><polyline points="8 6 2 12 8 18"/></svg></div><div class="rpm-badge">$10 RPM</div></div>
          <div class="niche-name">Electrical Home Repairs</div>
          <div class="niche-desc">Wiring fixes, outlet replacements, breaker panels. High trust-value content, strong ad CPCs.</div>
          <div class="niche-meta">
            <div class="meta-item"><div class="meta-dot dot-med"></div> Medium competition</div>
            <div class="meta-item">61K/mo</div>
          </div>
          <div style="margin-top:12px;display:flex;gap:8px">
            <button class="btn btn-ghost" style="flex:1;font-size:11px;padding:6px" onclick="buildNiche('Electrical Home Repairs')">Build Site <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="5" y1="12" x2="19" y2="12"/><polyline points="12 5 19 12 12 19"/></svg></button>
            <button class="btn btn-ghost" style="font-size:11px;padding:6px 10px" onclick="getNicheKeywords('Electrical Home Repairs')">Keywords</button>
          </div>
        </div>
        <div class="niche-card">
          <div class="niche-header"><div class="niche-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 12l8-8 8 8"/><path d="M4 20h16"/><path d="M9 20V9"/><path d="M15 20V9"/></svg></div><div class="rpm-badge">$9 RPM</div></div>
          <div class="niche-name">Plumbing DIY Guides</div>
          <div class="niche-desc">Leaky pipes, clogged drains, water heater repair. Evergreen content with year-round demand.</div>
          <div class="niche-meta">
            <div class="meta-item"><div class="meta-dot dot-easy"></div> Low competition</div>
            <div class="meta-item">112K/mo</div>
          </div>
          <div style="margin-top:12px;display:flex;gap:8px">
            <button class="btn btn-ghost" style="flex:1;font-size:11px;padding:6px" onclick="buildNiche('Plumbing DIY')">Build Site <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="5" y1="12" x2="19" y2="12"/><polyline points="12 5 19 12 12 19"/></svg></button>
            <button class="btn btn-ghost" style="font-size:11px;padding:6px 10px" onclick="getNicheKeywords('Plumbing DIY')">Keywords</button>
          </div>
        </div>
        <div class="niche-card">
          <div class="niche-header"><div class="niche-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg></div><div class="rpm-badge">$14 RPM</div></div>
          <div class="niche-name">Roof Repair & Inspection</div>
          <div class="niche-desc">Leak detection, shingle replacement, flat roof repair. Very high CPC niche, limited DIY blogs.</div>
          <div class="niche-meta">
            <div class="meta-item"><div class="meta-dot dot-easy"></div> Low competition</div>
            <div class="meta-item">43K/mo</div>
          </div>
          <div style="margin-top:12px;display:flex;gap:8px">
            <button class="btn btn-ghost" style="flex:1;font-size:11px;padding:6px" onclick="buildNiche('Roof Repair')">Build Site <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="5" y1="12" x2="19" y2="12"/><polyline points="12 5 19 12 12 19"/></svg></button>
            <button class="btn btn-ghost" style="font-size:11px;padding:6px 10px" onclick="getNicheKeywords('Roof Repair')">Keywords</button>
          </div>
        </div>
        <div class="niche-card">
          <div class="niche-header"><div class="niche-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="2" y="3" width="20" height="18" rx="2"/><line x1="12" y1="3" x2="12" y2="21"/><line x1="2" y1="12" x2="22" y2="12"/></svg></div><div class="rpm-badge">$8 RPM</div></div>
          <div class="niche-name">Window & Door Repairs</div>
          <div class="niche-desc">Sealing, frame repair, glass replacement. Underserved content gap, easy to rank quickly.</div>
          <div class="niche-meta">
            <div class="meta-item"><div class="meta-dot dot-easy"></div> Low competition</div>
            <div class="meta-item">38K/mo</div>
          </div>
          <div style="margin-top:12px;display:flex;gap:8px">
            <button class="btn btn-ghost" style="flex:1;font-size:11px;padding:6px" onclick="buildNiche('Window Door Repairs')">Build Site <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="5" y1="12" x2="19" y2="12"/><polyline points="12 5 19 12 12 19"/></svg></button>
            <button class="btn btn-ghost" style="font-size:11px;padding:6px 10px" onclick="getNicheKeywords('Window Door Repairs')">Keywords</button>
          </div>
        </div>
        <div class="niche-card">
          <div class="niche-header"><div class="niche-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14.7 6.3a1 1 0 0 0 0 1.4l1.6 1.6a1 1 0 0 0 1.4 0l3.77-3.77a6 6 0 0 1-7.94 7.94l-6.91 6.91a2.12 2.12 0 0 1-3-3l6.91-6.91a6 6 0 0 1 7.94-7.94l-3.76 3.76z"/></svg></div><div class="rpm-badge">$11 RPM</div></div>
          <div class="niche-name">Appliance Repair Guides</div>
          <div class="niche-desc">Washing machines, dryers, fridges, dishwashers. Massive search volume, very loyal readers.</div>
          <div class="niche-meta">
            <div class="meta-item"><div class="meta-dot dot-med"></div> Medium competition</div>
            <div class="meta-item">196K/mo</div>
          </div>
          <div style="margin-top:12px;display:flex;gap:8px">
            <button class="btn btn-ghost" style="flex:1;font-size:11px;padding:6px" onclick="buildNiche('Appliance Repair')">Build Site <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="5" y1="12" x2="19" y2="12"/><polyline points="12 5 19 12 12 19"/></svg></button>
            <button class="btn btn-ghost" style="font-size:11px;padding:6px 10px" onclick="getNicheKeywords('Appliance Repair')">Keywords</button>
          </div>
        </div>
      </div>

      <!-- Niche detail modal -->
      <div id="niche-modal" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,0.7);z-index:300;align-items:center;justify-content:center;padding:20px">
        <div style="background:var(--surface);border:1px solid var(--border);border-radius:16px;max-width:560px;width:100%;max-height:80vh;overflow-y:auto;padding:28px;position:relative">
          <button onclick="closeNicheModal()" style="position:absolute;top:16px;right:16px;background:var(--surface2);border:1px solid var(--border);color:var(--muted);width:28px;height:28px;border-radius:50%;cursor:pointer;font-size:14px;display:flex;align-items:center;justify-content:center">✕</button>
          <div id="niche-modal-content"></div>
        </div>
      </div>
    </div>

    <!-- ===== SEO GENERATOR ===== -->
    <div class="panel" id="panel-seo">

      <!-- Input Form -->
      <div id="seo-form-area">
        <div class="form-section">
          <div class="form-section-title">AI SEO Generator</div>

          <div class="form-grid" style="margin-bottom:20px">
            <div class="form-group">
              <label>Page Topic / Title Idea</label>
              <input type="text" id="seo-title" placeholder="e.g. AC Repair Cost in Dubai 2025">
            </div>
            <div class="form-group">
              <label>Primary Keyword</label>
              <input type="text" id="seo-keyword" placeholder="e.g. AC repair Dubai cost">
            </div>
            <div class="form-group">
              <label>Page Type</label>
              <select id="seo-type">
                <option value="service">Service Page</option>
                <option value="blog">Blog Article</option>
                <option value="howto">How-To Guide</option>
                <option value="local">Local / City Page</option>
                <option value="home">Homepage</option>
                <option value="review">Review / Comparison</option>
              </select>
            </div>
            <div class="form-group">
              <label>Schema Markup Type</label>
              <select id="seo-schema">
                <option value="Article">Article</option>
                <option value="HowTo">HowTo</option>
                <option value="FAQPage">FAQPage</option>
                <option value="LocalBusiness">LocalBusiness</option>
                <option value="Service">Service</option>
                <option value="Review">Review</option>
              </select>
            </div>
            <div class="form-group">
              <label>Full Page URL</label>
              <input type="text" id="seo-url" placeholder="e.g. https://acrepairguide.com/ac-repair-cost-dubai">
            </div>
            <div class="form-group">
              <label>Site / Brand Name</label>
              <input type="text" id="seo-brand" placeholder="e.g. AC Repair Guide">
            </div>
            <div class="form-group full">
              <label>What is this page about? (optional — more detail = better output)</label>
              <textarea id="seo-brief" rows="2" placeholder="e.g. A guide for Dubai homeowners explaining AC repair costs, what affects pricing, and how to find trusted technicians..."></textarea>
            </div>
          </div>

          <!-- What to generate -->
          <div style="background:var(--surface2);border:1px solid var(--border);border-radius:10px;padding:16px;margin-bottom:20px">
            <div style="font-size:11px;font-weight:600;color:var(--muted);margin-bottom:12px;text-transform:uppercase;letter-spacing:1px">Generate</div>
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:0">
              <div class="toggle-row" style="padding:8px 0">
                <div class="toggle-label" style="font-size:12px">Meta Title & Description</div>
                <div class="toggle on" id="stog-meta" onclick="this.classList.toggle('on')"></div>
              </div>
              <div class="toggle-row" style="padding:8px 0;border-bottom:none">
                <div class="toggle-label" style="font-size:12px">Open Graph Tags</div>
                <div class="toggle on" id="stog-og" onclick="this.classList.toggle('on')"></div>
              </div>
              <div class="toggle-row" style="padding:8px 0;border-bottom:none">
                <div class="toggle-label" style="font-size:12px">Schema JSON-LD</div>
                <div class="toggle on" id="stog-schema" onclick="this.classList.toggle('on')"></div>
              </div>
              <div class="toggle-row" style="padding:8px 0;border-bottom:none">
                <div class="toggle-label" style="font-size:12px">Twitter Card</div>
                <div class="toggle on" id="stog-twitter" onclick="this.classList.toggle('on')"></div>
              </div>
              <div class="toggle-row" style="padding:8px 0;border-bottom:none">
                <div class="toggle-label" style="font-size:12px">Robots & Canonical</div>
                <div class="toggle on" id="stog-robots" onclick="this.classList.toggle('on')"></div>
              </div>
              <div class="toggle-row" style="padding:8px 0;border-bottom:none">
                <div class="toggle-label" style="font-size:12px">5 LSI / Related Keywords</div>
                <div class="toggle on" id="stog-lsi" onclick="this.classList.toggle('on')"></div>
              </div>
            </div>
          </div>

          <button class="btn btn-primary" onclick="runSeoGenerator()" style="font-size:14px;padding:12px 28px">Generate SEO Package</button>
        </div>
      </div>

      <!-- Generating state -->
      <div id="seo-generating" style="display:none">
        <div class="form-section" style="text-align:center;padding:40px">
          <div style="width:56px;height:56px;background:rgba(0,212,255,0.06);border:1px solid rgba(0,212,255,0.12);border-radius:14px;display:flex;align-items:center;justify-content:center;margin:0 auto 18px;color:var(--accent)"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"><polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/></svg></div>
          <div style="font-family:'Syne',sans-serif;font-size:16px;font-weight:700;margin-bottom:8px">AI Writing Your SEO Package...</div>
          <div style="color:var(--muted);font-size:13px;margin-bottom:24px" id="seo-gen-label">Crafting optimised meta tags...</div>
          <div class="progress-bar-wrap" style="max-width:340px;margin:0 auto 8px">
            <div class="progress-bar" id="seo-gen-progress" style="width:5%"></div>
          </div>
          <div id="seo-gen-steps-row" style="display:flex;justify-content:center;gap:20px;margin-top:16px;flex-wrap:wrap">
            <div class="seo-step-pill" id="spill-1" style="font-size:11px;padding:4px 12px;border-radius:20px;background:rgba(0,212,255,0.1);border:1px solid rgba(0,212,255,0.2);color:var(--accent)">✦ Meta Tags</div>
            <div class="seo-step-pill" id="spill-2" style="font-size:11px;padding:4px 12px;border-radius:20px;background:var(--surface2);border:1px solid var(--border);color:var(--muted)">Open Graph</div>
            <div class="seo-step-pill" id="spill-3" style="font-size:11px;padding:4px 12px;border-radius:20px;background:var(--surface2);border:1px solid var(--border);color:var(--muted)">Schema</div>
            <div class="seo-step-pill" id="spill-4" style="font-size:11px;padding:4px 12px;border-radius:20px;background:var(--surface2);border:1px solid var(--border);color:var(--muted)">Keywords</div>
          </div>
        </div>
      </div>

      <!-- Output -->
      <div id="seo-output-area" style="display:none">

        <!-- Score card -->
        <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:12px;margin-bottom:20px" id="seo-scores-row">
          <!-- filled by JS -->
        </div>

        <!-- Action bar -->
        <div class="form-section" style="margin-bottom:16px;padding:16px 20px">
          <div style="display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:12px">
            <div>
              <div style="font-family:'Syne',sans-serif;font-size:14px;font-weight:700">✓ SEO Package Ready</div>
              <div style="font-size:12px;color:var(--muted);margin-top:2px" id="seo-out-subtitle">—</div>
            </div>
            <div style="display:flex;gap:8px;flex-wrap:wrap">
              <button class="btn btn-ghost" onclick="seoCopyAll()">Copy All</button>
              <button class="btn btn-ghost" onclick="seoDownload()"><svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg> Download .txt</button>
              <button class="btn btn-primary" onclick="seoReset()">Generate New</button>
            </div>
          </div>
        </div>

        <!-- Tabbed output sections -->
        <div style="display:flex;gap:4px;margin-bottom:16px;background:var(--surface2);padding:4px;border-radius:10px;border:1px solid var(--border)" id="seo-tabs">
          <button class="seo-tab active" onclick="seoTab('meta',this)">Meta Tags</button>
          <button class="seo-tab" onclick="seoTab('og',this)">Open Graph</button>
          <button class="seo-tab" onclick="seoTab('schema',this)">Schema</button>
          <button class="seo-tab" onclick="seoTab('keywords',this)">Keywords</button>
          <button class="seo-tab" onclick="seoTab('full',this)">Full Code</button>
        </div>

        <div class="card">
          <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:12px">
            <div class="card-title" style="margin-bottom:0" id="seo-tab-title">Meta Tags</div>
            <button class="btn btn-ghost" style="font-size:11px;padding:5px 10px" onclick="seoCopySection()">Copy</button>
          </div>
          <div id="seo-tab-content" style="background:var(--surface2);border:1px solid var(--border);border-radius:8px;padding:16px;font-family:'Courier New',monospace;font-size:11.5px;line-height:1.8;color:#a8d8a8;max-height:420px;overflow-y:auto;white-space:pre-wrap;word-break:break-word"></div>
        </div>

        <!-- LSI keywords visual display -->
        <div class="card" style="margin-top:16px" id="seo-lsi-card">
          <div class="card-title" style="margin-bottom:14px">Related & LSI Keywords</div>
          <div id="seo-lsi-tags" style="display:flex;flex-wrap:wrap;gap:8px"></div>
          <div style="margin-top:14px;padding-top:14px;border-top:1px solid var(--border)">
            <div style="font-size:11px;color:var(--muted);margin-bottom:8px;text-transform:uppercase;letter-spacing:1px">Usage Tip</div>
            <div style="font-size:12px;color:var(--muted);line-height:1.6" id="seo-lsi-tip"></div>
          </div>
        </div>

        <!-- Checklist -->
        <div class="card" style="margin-top:16px">
          <div class="card-title" style="margin-bottom:14px">SEO Checklist</div>
          <div id="seo-checklist" style="display:flex;flex-direction:column;gap:8px"></div>
        </div>
      </div>

      <!-- Error -->
      <div id="seo-error" style="display:none">
        <div class="form-section">
          <div class="alert" style="background:rgba(255,107,107,0.08);border-color:rgba(255,107,107,0.2);color:var(--accent3)" id="seo-error-msg"></div>
          <button class="btn btn-ghost" onclick="seoReset()"><svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="19" y1="12" x2="5" y2="12"/><polyline points="12 19 5 12 12 5"/></svg> Try Again</button>
        </div>
      </div>
    </div>

    <!-- ===== KEYWORDS ===== -->
    <div class="panel" id="panel-keywords">

      <!-- Search bar -->
      <div class="card" style="margin-bottom:20px">
        <div class="card-title">AI Keyword Research</div>
        <div style="display:flex;gap:12px;align-items:flex-end;flex-wrap:wrap">
          <div style="flex:1;min-width:160px">
            <label style="margin-bottom:6px;display:block;font-size:12px;color:var(--muted)">Seed Keyword</label>
            <input type="text" id="kw-seed" placeholder="e.g. AC repair, roof leak, plumbing...">
          </div>
          <div style="min-width:130px">
            <label style="margin-bottom:6px;display:block;font-size:12px;color:var(--muted)">Location</label>
            <input type="text" id="kw-location" placeholder="e.g. Dubai, USA" style="width:100%">
          </div>
          <div style="min-width:120px">
            <label style="margin-bottom:6px;display:block;font-size:12px;color:var(--muted)">Intent Focus</label>
            <select id="kw-intent" style="width:100%">
              <option value="all">All Intents</option>
              <option value="info">Informational</option>
              <option value="how">How-To</option>
              <option value="local">Local / Near Me</option>
              <option value="commercial">Commercial</option>
            </select>
          </div>
          <div style="min-width:120px">
            <label style="margin-bottom:6px;display:block;font-size:12px;color:var(--muted)">Count</label>
            <select id="kw-count" style="width:100%">
              <option value="10">10 keywords</option>
              <option value="20" selected>20 keywords</option>
              <option value="30">30 keywords</option>
            </select>
          </div>
          <button class="btn btn-primary" id="kw-run-btn" onclick="runKeywordResearch()" style="white-space:nowrap">Find Keywords</button>
        </div>
      </div>

      <!-- Loading -->
      <div id="kw-loading" style="display:none">
        <div class="card" style="text-align:center;padding:36px">
          <div style="width:52px;height:52px;background:rgba(255,255,255,0.03);border:1px solid var(--border);border-radius:12px;display:flex;align-items:center;justify-content:center;margin:0 auto 14px;color:var(--muted)"><svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"><path d="M20.59 13.41l-7.17 7.17a2 2 0 0 1-2.83 0L2 12V2h10l8.59 8.59a2 2 0 0 1 0 2.82z"/><line x1="7" y1="7" x2="7.01" y2="7"/></svg></div>
          <div style="font-family:'Syne',sans-serif;font-size:15px;font-weight:700;margin-bottom:6px">Researching Keywords...</div>
          <div style="color:var(--muted);font-size:12px;margin-bottom:16px">AI is finding high-value, rankable keywords for your niche</div>
          <div class="progress-bar-wrap" style="max-width:280px;margin:0 auto">
            <div class="progress-bar" id="kw-progress-bar" style="width:8%"></div>
          </div>
          <div id="kw-progress-label" style="font-size:11px;color:var(--muted);margin-top:8px">Starting...</div>
        </div>
      </div>

      <!-- Default placeholder state -->
      <div id="kw-placeholder" class="card" style="text-align:center;padding:48px;color:var(--muted)">
        <div style="width:56px;height:56px;background:rgba(255,255,255,0.03);border:1px solid var(--border);border-radius:14px;display:flex;align-items:center;justify-content:center;margin:0 auto 16px;color:var(--muted)"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"><path d="M20.59 13.41l-7.17 7.17a2 2 0 0 1-2.83 0L2 12V2h10l8.59 8.59a2 2 0 0 1 0 2.82z"/><line x1="7" y1="7" x2="7.01" y2="7"/></svg></div>
        <div style="font-size:14px;font-weight:600;margin-bottom:6px;color:var(--text)">Enter a keyword to get started</div>
        <div style="font-size:13px">AI will return 10–30 targetable keywords with volume, difficulty, intent, and CPC estimates</div>
      </div>

      <!-- Results -->
      <div id="kw-output" style="display:none">

        <!-- Summary bar -->
        <div id="kw-output-header" style="display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:12px;margin-bottom:16px">
          <div>
            <div style="font-family:'Syne',sans-serif;font-size:14px;font-weight:700" id="kw-results-title">Keywords</div>
            <div style="font-size:12px;color:var(--muted);margin-top:2px" id="kw-results-sub"></div>
          </div>
          <div style="display:flex;gap:8px;flex-wrap:wrap">
            <button class="btn btn-ghost" style="font-size:12px" onclick="kwCopyAll()">Copy All</button>
            <button class="btn btn-ghost" style="font-size:12px" onclick="kwDownloadCSV()"><svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg> CSV</button>
            <button class="btn btn-accent2" style="font-size:12px" onclick="kwSendToPageGen()"><svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="5" y1="12" x2="19" y2="12"/><polyline points="12 5 19 12 12 19"/></svg> Page Generator</button>
          </div>
        </div>

        <!-- Stats row -->
        <div id="kw-stats-row" style="display:grid;grid-template-columns:repeat(4,1fr);gap:12px;margin-bottom:20px"></div>

        <!-- Filters -->
        <div style="display:flex;gap:8px;flex-wrap:wrap;margin-bottom:14px" id="kw-filter-btns">
          <button class="btn btn-ghost kw-filter active-filter" data-filter="all" onclick="kwFilter(this,'all')" style="font-size:11px;padding:5px 12px">All</button>
          <button class="btn btn-ghost kw-filter" data-filter="Informational" onclick="kwFilter(this,'Informational')" style="font-size:11px;padding:5px 12px">Info</button>
          <button class="btn btn-ghost kw-filter" data-filter="How-To" onclick="kwFilter(this,'How-To')" style="font-size:11px;padding:5px 12px">How-To</button>
          <button class="btn btn-ghost kw-filter" data-filter="Local" onclick="kwFilter(this,'Local')" style="font-size:11px;padding:5px 12px">Local</button>
          <button class="btn btn-ghost kw-filter" data-filter="Commercial" onclick="kwFilter(this,'Commercial')" style="font-size:11px;padding:5px 12px"><svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="1" x2="12" y2="23"/><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/></svg> Commercial</button>
          <button class="btn btn-ghost kw-filter" data-filter="Low" onclick="kwFilter(this,'Low')" style="font-size:11px;padding:5px 12px"><svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"/></svg> Easy Wins</button>
        </div>

        <!-- Table -->
        <div class="card" style="padding:0;overflow:hidden">
          <div style="overflow-x:auto">
            <table class="kw-table" id="kw-table">
              <thead>
                <tr>
                  <th style="padding-left:16px">Keyword</th>
                  <th>Volume</th>
                  <th>Difficulty</th>
                  <th>Intent</th>
                  <th>CPC</th>
                  <th>Action</th>
                </tr>
              </thead>
              <tbody id="kw-tbody"></tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- Error -->
      <div id="kw-error" style="display:none">
        <div class="alert" style="background:rgba(255,107,107,0.08);border-color:rgba(255,107,107,0.2);color:var(--accent3)" id="kw-error-msg"></div>
        <button class="btn btn-ghost" onclick="document.getElementById('kw-error').style.display='none'">Dismiss</button>
      </div>
    </div>

    <!-- ===== DEPLOY ===== -->
    <div class="panel" id="panel-deploy">

      <!-- Platform selector tabs -->
      <div style="display:flex;gap:10px;margin-bottom:24px;flex-wrap:wrap">
        <div class="platform-tab active" id="ptab-cloudflare" onclick="selectPlatform('cloudflare')">
          <div class="ptab-icon"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 10h-1.26A8 8 0 1 0 9 20h9a5 5 0 0 0 0-10z"/></svg></div>
          <div>
            <div class="ptab-name">Cloudflare Pages</div>
            <div class="ptab-sub">Recommended · Free · Fastest CDN</div>
          </div>
        </div>
        <div class="platform-tab" id="ptab-vercel" onclick="selectPlatform('vercel')">
          <div class="ptab-icon">▲</div>
          <div>
            <div class="ptab-name">Vercel</div>
            <div class="ptab-sub">Free · Great DX</div>
          </div>
        </div>
        <div class="platform-tab" id="ptab-netlify" onclick="selectPlatform('netlify')">
          <div class="ptab-icon">◆</div>
          <div>
            <div class="ptab-name">Netlify</div>
            <div class="ptab-sub">Free · Simple drag & drop</div>
          </div>
        </div>
      </div>

      <!-- Main deploy grid -->
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:20px;margin-bottom:20px" class="deploy-main-grid">

        <!-- Left: Setup guide -->
        <div class="card" id="deploy-guide-card">
          <div class="card-title" id="deploy-guide-title">☁ Cloudflare Pages — Setup Guide</div>

          <div id="deploy-steps-guide">
            <!-- Steps rendered by JS -->
          </div>
        </div>

        <!-- Right: Deploy form -->
        <div style="display:flex;flex-direction:column;gap:16px">

          <!-- Config form -->
          <div class="card">
            <div class="card-title">Deploy Configuration</div>
            <div class="form-group">
              <label>Site Name</label>
              <input type="text" id="dep-sitename" placeholder="e.g. AC Repair Guide">
            </div>
            <div class="form-group">
              <label>GitHub Username</label>
              <input type="text" id="dep-ghuser" placeholder="e.g. yourname">
            </div>
            <div class="form-group">
              <label>Repository Name</label>
              <input type="text" id="dep-repo" placeholder="e.g. ac-repair-guide">
            </div>
            <div class="form-group">
              <label>Your Domain (optional)</label>
              <input type="text" id="dep-domain" placeholder="e.g. acrepairguide.com" oninput="updateDnsPreview()">
            </div>
            <button class="btn btn-primary" style="width:100%;margin-top:4px" onclick="runDeploySimulation()">Deploy <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="5" y1="12" x2="19" y2="12"/><polyline points="12 5 19 12 12 19"/></svg></button>
          </div>

          <!-- DNS instructions -->
          <div class="card" id="dns-card">
            <div class="card-title" style="margin-bottom:14px">DNS Records to Add</div>
            <div style="font-size:12px;color:var(--muted);margin-bottom:12px">Add these in your domain registrar (Hostinger / GoDaddy / Namecheap):</div>
            <div style="background:var(--surface2);border:1px solid var(--border);border-radius:8px;padding:14px;font-family:'Courier New',monospace;font-size:12px" id="dns-preview">
              <div style="display:grid;grid-template-columns:60px 60px 1fr;gap:6px 12px">
                <span style="color:var(--muted);font-size:10px;text-transform:uppercase">Type</span>
                <span style="color:var(--muted);font-size:10px;text-transform:uppercase">Name</span>
                <span style="color:var(--muted);font-size:10px;text-transform:uppercase">Value</span>
                <span style="color:var(--accent)">CNAME</span><span>www</span><span id="dns-val-1" style="color:#7dd3fc">pages.cloudflare.com</span>
                <span style="color:var(--accent)">CNAME</span><span>@</span><span id="dns-val-2" style="color:#7dd3fc">pages.cloudflare.com</span>
              </div>
            </div>
            <div style="display:flex;gap:8px;margin-top:12px">
              <button class="btn btn-ghost" style="flex:1;font-size:12px" onclick="copyDns()">Copy DNS</button>
              <button class="btn btn-ghost" style="flex:1;font-size:12px" id="dns-verify-btn" onclick="verifyDns()">✓ Verify DNS</button>
            </div>
            <div id="dns-verify-result" style="display:none;margin-top:10px;font-size:12px;padding:8px 12px;border-radius:6px"></div>
          </div>
        </div>
      </div>

      <!-- Deploy progress panel -->
      <div class="card" id="deploy-progress-card" style="display:none;margin-bottom:20px">
        <div class="card-title" style="margin-bottom:20px" id="deploy-prog-title">Deploying...</div>
        <div id="deploy-prog-steps" style="display:flex;flex-direction:column;gap:4px"></div>
        <div class="progress-bar-wrap" style="margin-top:20px">
          <div class="progress-bar" id="deploy-prog-bar" style="width:0%"></div>
        </div>
        <div style="font-size:12px;color:var(--muted);text-align:center;margin-top:6px" id="deploy-prog-label">Preparing...</div>
      </div>

      <!-- Deploy success -->
      <div class="card" id="deploy-success-card" style="display:none;margin-bottom:20px">
        <div style="text-align:center;padding:16px 0">
          <div style="margin-bottom:12px"><svg width="44" height="44" viewBox="0 0 24 24" fill="none" stroke="var(--accent)" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><polyline points="22 4 12 14.01 9 11.01"/><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/></svg></div>
          <div style="font-family:'Syne',sans-serif;font-size:20px;font-weight:800;margin-bottom:6px">Site is Live!</div>
          <div style="color:var(--muted);font-size:13px;margin-bottom:20px" id="deploy-success-url"></div>
          <div class="alert alert-success" style="margin-bottom:20px;text-align:left" id="deploy-success-msg"></div>
          <div style="display:flex;gap:10px;justify-content:center;flex-wrap:wrap">
            <button class="btn btn-ghost" onclick="window.open('https://'+document.getElementById('dep-domain').value,'_blank')"><svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><line x1="2" y1="12" x2="22" y2="12"/><path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"/></svg> Visit Site</button>
            <button class="btn btn-ghost" onclick="resetDeploy()">Deploy Another</button>
            <button class="btn btn-primary" onclick="showPanel('pages')">Generate More Pages</button>
          </div>
        </div>
      </div>

      <!-- Deploy history -->
      <div class="card">
        <div class="card-title" style="margin-bottom:16px"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="margin-right:6px"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>Deploy History</div>
        <div id="deploy-history-list">
          <div class="deploy-step" style="padding:12px 0">
            <div class="deploy-step-icon step-done2">✓</div>
            <div class="deploy-step-info">
              <div class="deploy-step-name">DIY Repair Hub <span style="font-size:10px;background:rgba(0,212,255,0.1);color:var(--accent);padding:2px 7px;border-radius:10px;margin-left:6px">Live</span></div>
              <div class="deploy-step-desc">diyrepairhub.com · Cloudflare Pages · 14 pages</div>
            </div>
            <div class="deploy-step-time">2h ago</div>
          </div>
          <div class="deploy-step" style="padding:12px 0">
            <div class="deploy-step-icon step-done2">✓</div>
            <div class="deploy-step-info">
              <div class="deploy-step-name">Home Repair Pro <span style="font-size:10px;background:rgba(0,212,255,0.1);color:var(--accent);padding:2px 7px;border-radius:10px;margin-left:6px">Live</span></div>
              <div class="deploy-step-desc">homerepairpro.com · Cloudflare Pages · 18 pages</div>
            </div>
            <div class="deploy-step-time">Yesterday</div>
          </div>
        </div>
      </div>

      <!-- Setup guide section -->
      <div class="card" style="margin-top:20px">
        <div class="card-title" style="margin-bottom:16px"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="margin-right:6px"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></svg>One-Time Setup — How to Connect GitHub + Cloudflare</div>
        <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:12px" class="setup-steps-grid">
          <div style="background:var(--surface2);border:1px solid var(--border);border-radius:10px;padding:16px">
            <div style="font-family:'Syne',sans-serif;font-size:28px;font-weight:800;color:var(--accent);margin-bottom:8px">01</div>
            <div style="font-size:13px;font-weight:600;margin-bottom:6px">Create GitHub Account</div>
            <div style="font-size:12px;color:var(--muted);line-height:1.5">Go to github.com → Sign up free → Confirm your email. This stores all your site code.</div>
            <a href="https://github.com" target="_blank" style="display:inline-block;margin-top:10px;font-size:11px;color:var(--accent);text-decoration:none">→ github.com</a>
          </div>
          <div style="background:var(--surface2);border:1px solid var(--border);border-radius:10px;padding:16px">
            <div style="font-family:'Syne',sans-serif;font-size:28px;font-weight:800;color:var(--accent2);margin-bottom:8px">02</div>
            <div style="font-size:13px;font-weight:600;margin-bottom:6px">Create a Repository</div>
            <div style="font-size:12px;color:var(--muted);line-height:1.5">In GitHub click + → New Repository → name it after your site → set to Public → Create.</div>
            <div style="margin-top:10px;background:var(--bg);border-radius:6px;padding:8px;font-family:'Courier New',monospace;font-size:10px;color:var(--accent)">github.com/you/site-name</div>
          </div>
          <div style="background:var(--surface2);border:1px solid var(--border);border-radius:10px;padding:16px">
            <div style="font-family:'Syne',sans-serif;font-size:28px;font-weight:800;color:var(--accent3);margin-bottom:8px">03</div>
            <div style="font-size:13px;font-weight:600;margin-bottom:6px">Upload Your HTML Files</div>
            <div style="font-size:12px;color:var(--muted);line-height:1.5">Open the repo → click Add file → Upload files → drag your NicheForge pages → Commit.</div>
            <div style="margin-top:10px;font-size:11px;color:var(--muted)">index.html, page.html, etc.</div>
          </div>
          <div style="background:var(--surface2);border:1px solid var(--border);border-radius:10px;padding:16px">
            <div style="font-family:'Syne',sans-serif;font-size:28px;font-weight:800;color:#ffd93d;margin-bottom:8px">04</div>
            <div style="font-size:13px;font-weight:600;margin-bottom:6px">Sign Up to Cloudflare</div>
            <div style="font-size:12px;color:var(--muted);line-height:1.5">Go to pages.cloudflare.com → Create account free → Go to Pages → Create a project.</div>
            <a href="https://pages.cloudflare.com" target="_blank" style="display:inline-block;margin-top:10px;font-size:11px;color:var(--accent);text-decoration:none">→ pages.cloudflare.com</a>
          </div>
          <div style="background:var(--surface2);border:1px solid var(--border);border-radius:10px;padding:16px">
            <div style="font-family:'Syne',sans-serif;font-size:28px;font-weight:800;color:var(--accent);margin-bottom:8px">05</div>
            <div style="font-size:13px;font-weight:600;margin-bottom:6px">Connect to GitHub</div>
            <div style="font-size:12px;color:var(--muted);line-height:1.5">Connect GitHub account → Select your repo → Framework: None → Build output: / → Deploy.</div>
            <div style="margin-top:10px;font-size:11px;color:var(--accent)">Auto-deploys on every upload ✓</div>
          </div>
          <div style="background:var(--surface2);border:1px solid var(--border);border-radius:10px;padding:16px">
            <div style="font-family:'Syne',sans-serif;font-size:28px;font-weight:800;color:var(--accent2);margin-bottom:8px">06</div>
            <div style="font-size:13px;font-weight:600;margin-bottom:6px">Add Your Domain</div>
            <div style="font-size:12px;color:var(--muted);line-height:1.5">In Cloudflare Pages → Custom domains → Add domain → Copy DNS records → Paste in Hostinger DNS.</div>
            <div style="margin-top:10px;font-size:11px;color:var(--accent)">SSL auto-provisioned free ✓</div>
          </div>
        </div>

        <div class="alert alert-success" style="margin-top:16px;margin-bottom:0">
          ✓ After first-time setup, adding new pages is just: Generate page in NicheForge → Upload to GitHub → Cloudflare deploys automatically. That's it.
        </div>
      </div>

    </div>

    <!-- ===== MY SITES ===== -->
    <div class="panel" id="panel-sites">

      <!-- Header -->
      <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:20px;flex-wrap:wrap;gap:12px">
        <div>
          <div style="font-family:'Syne',sans-serif;font-size:20px;font-weight:800;letter-spacing:-0.3px">My Sites</div>
          <div style="font-size:12px;color:var(--muted);margin-top:2px">3 sites · 2 live · 1 building</div>
        </div>
        <button class="btn btn-primary" onclick="showPanel('create')">
          <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
          New Site
        </button>
      </div>

      <!-- Sites list -->
      <div style="display:flex;flex-direction:column;gap:10px">

        <!-- Site 1 -->
        <div style="background:var(--surface);border:1px solid var(--border);border-radius:10px;padding:16px 18px;display:flex;align-items:center;gap:14px;flex-wrap:wrap;transition:border-color 0.15s" onmouseover="this.style.borderColor='#2a2a2a'" onmouseout="this.style.borderColor='var(--border)'">
          <div style="width:44px;height:44px;border-radius:10px;background:rgba(0,212,255,0.08);border:1px solid rgba(0,212,255,0.12);display:flex;align-items:center;justify-content:center;flex-shrink:0;color:var(--accent)">
            <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"><path d="M14.7 6.3a1 1 0 0 0 0 1.4l1.6 1.6a1 1 0 0 0 1.4 0l3.77-3.77a6 6 0 0 1-7.94 7.94l-6.91 6.91a2.12 2.12 0 0 1-3-3l6.91-6.91a6 6 0 0 1 7.94-7.94l-3.76 3.76z"/></svg>
          </div>
          <div style="flex:1;min-width:0">
            <div style="font-family:'Syne',sans-serif;font-size:14px;font-weight:800;margin-bottom:2px">Home Repair Pro</div>
            <div style="font-size:11px;color:var(--muted)">homerepairpro.com &nbsp;·&nbsp; Local Service &nbsp;·&nbsp; 18 pages</div>
          </div>
          <div style="display:flex;align-items:center;gap:7px;flex-wrap:wrap">
            <span class="site-badge badge-live">
              <span style="display:inline-block;width:5px;height:5px;background:var(--accent);border-radius:50%;margin-right:4px;animation:pulse 2s infinite"></span>Live
            </span>
            <button class="btn btn-ghost" style="padding:5px 12px;font-size:11px;display:flex;align-items:center;gap:5px">
              <svg width="11" height="11" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>
              Manage
            </button>
            <button class="btn btn-ghost" style="padding:5px 12px;font-size:11px;display:flex;align-items:center;gap:5px" onclick="showPanel('pages')">
              <svg width="11" height="11" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
              Add Pages
            </button>
          </div>
        </div>

        <!-- Site 2 -->
        <div style="background:var(--surface);border:1px solid var(--border);border-radius:10px;padding:16px 18px;display:flex;align-items:center;gap:14px;flex-wrap:wrap;transition:border-color 0.15s" onmouseover="this.style.borderColor='#2a2a2a'" onmouseout="this.style.borderColor='var(--border)'">
          <div style="width:44px;height:44px;border-radius:10px;background:rgba(180,79,255,0.08);border:1px solid rgba(180,79,255,0.12);display:flex;align-items:center;justify-content:center;flex-shrink:0;color:var(--accent2)">
            <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"><path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"/><path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"/></svg>
          </div>
          <div style="flex:1;min-width:0">
            <div style="font-family:'Syne',sans-serif;font-size:14px;font-weight:800;margin-bottom:2px">DIY Repair Hub</div>
            <div style="font-size:11px;color:var(--muted)">diyrepairhub.com &nbsp;·&nbsp; DIY Blog &nbsp;·&nbsp; 14 pages &nbsp;·&nbsp; AdSense</div>
          </div>
          <div style="display:flex;align-items:center;gap:7px;flex-wrap:wrap">
            <span class="site-badge badge-live">
              <span style="display:inline-block;width:5px;height:5px;background:var(--accent);border-radius:50%;margin-right:4px;animation:pulse 2s infinite"></span>Live
            </span>
            <button class="btn btn-ghost" style="padding:5px 12px;font-size:11px;display:flex;align-items:center;gap:5px">
              <svg width="11" height="11" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>
              Manage
            </button>
            <button class="btn btn-ghost" style="padding:5px 12px;font-size:11px;display:flex;align-items:center;gap:5px" onclick="showPanel('pages')">
              <svg width="11" height="11" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
              Add Pages
            </button>
          </div>
        </div>

        <!-- Site 3 -->
        <div style="background:var(--surface);border:1px solid var(--border);border-radius:10px;padding:16px 18px;display:flex;align-items:center;gap:14px;flex-wrap:wrap;transition:border-color 0.15s" onmouseover="this.style.borderColor='#2a2a2a'" onmouseout="this.style.borderColor='var(--border)'">
          <div style="width:44px;height:44px;border-radius:10px;background:rgba(100,180,255,0.07);border:1px solid rgba(100,180,255,0.12);display:flex;align-items:center;justify-content:center;flex-shrink:0;color:#7dd3fc">
            <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"><path d="M8 2h8"/><path d="M9 2v2.789a4 4 0 0 1-.672 2.219l-.656.984A4 4 0 0 0 7 10.212V20a2 2 0 0 0 2 2h6a2 2 0 0 0 2-2v-9.789a4 4 0 0 0-.672-2.219l-.656-.984A4 4 0 0 1 15 4.788V2"/><path d="M7 15a6.472 6.472 0 0 1 5 0 6.47 6.47 0 0 0 5 0"/></svg>
          </div>
          <div style="flex:1;min-width:0">
            <div style="font-family:'Syne',sans-serif;font-size:14px;font-weight:800;margin-bottom:2px">AC Repair Guide</div>
            <div style="font-size:11px;color:var(--muted)">acrepairguide.net &nbsp;·&nbsp; AdSense Niche &nbsp;·&nbsp; 10 pages &nbsp;·&nbsp; Building</div>
          </div>
          <div style="display:flex;align-items:center;gap:7px;flex-wrap:wrap">
            <span class="site-badge badge-building">Building</span>
            <button class="btn btn-primary" style="padding:5px 14px;font-size:11px;display:flex;align-items:center;gap:5px;font-weight:700" onclick="showPanel('deploy')">
              Deploy
              <svg width="11" height="11" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><line x1="5" y1="12" x2="19" y2="12"/><polyline points="12 5 19 12 12 19"/></svg>
            </button>
          </div>
        </div>

      </div>

      <!-- Stats row -->
      <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin-top:16px">
        <div style="background:var(--surface);border:1px solid var(--border);border-radius:10px;padding:14px 16px">
          <div style="font-size:10px;color:var(--muted);text-transform:uppercase;letter-spacing:0.8px;font-weight:700;margin-bottom:6px">Total Pages</div>
          <div style="font-family:'Syne',sans-serif;font-size:22px;font-weight:900">42</div>
          <div style="font-size:10px;color:var(--accent);margin-top:3px">↑ 4 this week</div>
        </div>
        <div style="background:var(--surface);border:1px solid var(--border);border-radius:10px;padding:14px 16px">
          <div style="font-size:10px;color:var(--muted);text-transform:uppercase;letter-spacing:0.8px;font-weight:700;margin-bottom:6px">Live Sites</div>
          <div style="font-family:'Syne',sans-serif;font-size:22px;font-weight:900">2</div>
          <div style="font-size:10px;color:var(--muted);margin-top:3px">1 deploying</div>
        </div>
        <div style="background:var(--surface);border:1px solid var(--border);border-radius:10px;padding:14px 16px">
          <div style="font-size:10px;color:var(--muted);text-transform:uppercase;letter-spacing:0.8px;font-weight:700;margin-bottom:6px">With AdSense</div>
          <div style="font-family:'Syne',sans-serif;font-size:22px;font-weight:900">2</div>
          <div style="font-size:10px;color:var(--muted);margin-top:3px">Monetised</div>
        </div>
      </div>

    </div>

    <!-- ===== IMPORT SITE ===== -->
    <div class="panel" id="panel-import">

      <div class="form-section" style="margin-bottom:20px">
        <div class="form-section-title">Import Your Existing Site</div>
        <div class="alert alert-info" style="margin-bottom:20px">Your GA4 tracking ID, AdSense publisher code, existing meta tags, and SEO structure will all be detected and preserved automatically.</div>

        <div class="form-grid" style="margin-bottom:20px">
          <div class="form-group">
            <label>Site Name</label>
            <input type="text" id="imp-name" placeholder="e.g. Home Repair Pro">
          </div>
          <div class="form-group">
            <label>Your Domain</label>
            <input type="text" id="imp-domain" placeholder="e.g. homerepairpro.com">
          </div>
          <div class="form-group">
            <label>New Design Theme</label>
            <select id="imp-theme">
              <option value="dark">Modern Dark</option>
              <option value="light">Clean Light</option>
              <option value="blue">Bold Blue</option>
              <option value="green">Fresh Green</option>
            </select>
          </div>
          <div class="form-group">
            <label>What to preserve</label>
            <select id="imp-preserve">
              <option value="all">Everything (GA4 + AdSense + SEO + Structure)</option>
              <option value="codes">Tracking codes only (GA4 + AdSense)</option>
              <option value="seo">SEO tags only</option>
            </select>
          </div>
          <div class="form-group full">
            <label>Paste your existing HTML page here</label>
            <textarea id="imp-html" rows="10" placeholder="Paste the full HTML source of your existing page here. Get it from Hostinger hPanel → File Manager → right-click your page → View/Edit..."></textarea>
          </div>
        </div>

        <div style="background:var(--surface2);border:1px solid var(--border);border-radius:10px;padding:16px;margin-bottom:20px">
          <div style="font-size:11px;font-weight:600;color:var(--muted);text-transform:uppercase;letter-spacing:1px;margin-bottom:12px">NicheForge will automatically</div>
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px">
            <div style="font-size:12px;display:flex;gap:8px;align-items:flex-start"><span style="color:var(--accent)">✓</span> Detect & keep your GA4 tracking code</div>
            <div style="font-size:12px;display:flex;gap:8px;align-items:flex-start"><span style="color:var(--accent)">✓</span> Detect & keep your AdSense publisher ID</div>
            <div style="font-size:12px;display:flex;gap:8px;align-items:flex-start"><span style="color:var(--accent)">✓</span> Preserve all existing meta & SEO tags</div>
            <div style="font-size:12px;display:flex;gap:8px;align-items:flex-start"><span style="color:var(--accent)">✓</span> Keep your page structure & content</div>
            <div style="font-size:12px;display:flex;gap:8px;align-items:flex-start"><span style="color:var(--accent)">✓</span> Apply modern design & mobile layout</div>
            <div style="font-size:12px;display:flex;gap:8px;align-items:flex-start"><span style="color:var(--accent)">✓</span> Improve page speed & Core Web Vitals</div>
          </div>
        </div>

        <button class="btn btn-primary" onclick="runSiteImport()" style="font-size:14px;padding:12px 28px">Import & Modernise</button>
      </div>

      <!-- Import progress -->
      <div id="imp-generating" style="display:none">
        <div class="form-section" style="text-align:center;padding:40px">
          <div style="width:56px;height:56px;background:rgba(180,79,255,0.06);border:1px solid rgba(180,79,255,0.12);border-radius:14px;display:flex;align-items:center;justify-content:center;margin:0 auto 18px;color:var(--accent2)"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg></div>
          <div style="font-family:'Syne',sans-serif;font-size:16px;font-weight:700;margin-bottom:8px">Importing & Rebuilding...</div>
          <div style="color:var(--muted);font-size:13px;margin-bottom:24px" id="imp-label">Scanning your HTML for codes...</div>
          <div class="progress-bar-wrap" style="max-width:340px;margin:0 auto">
            <div class="progress-bar" id="imp-progress" style="width:5%"></div>
          </div>
          <div id="imp-detected" style="display:none;margin-top:20px;text-align:left;max-width:340px;margin-left:auto;margin-right:auto">
            <!-- detected codes shown here -->
          </div>
        </div>
      </div>

      <!-- Import output -->
      <div id="imp-output" style="display:none">
        <div class="form-section" style="margin-bottom:16px">
          <div style="display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:12px">
            <div>
              <div style="font-family:'Syne',sans-serif;font-size:14px;font-weight:700">✓ Site Imported & Modernised</div>
              <div style="font-size:12px;color:var(--muted);margin-top:2px" id="imp-summary">—</div>
            </div>
            <div style="display:flex;gap:8px;flex-wrap:wrap">
              <button class="btn btn-ghost" onclick="impCopy()">Copy HTML</button>
              <button class="btn btn-ghost" onclick="impDownload()"><svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg> Download</button>
              <button class="btn btn-accent2" onclick="impPreview()"><svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg> Preview</button>
              <button class="btn btn-primary" onclick="impReset()">Import Another</button>
            </div>
          </div>
        </div>

        <!-- Preserved codes badge strip -->
        <div id="imp-codes-strip" style="display:flex;flex-wrap:wrap;gap:8px;margin-bottom:16px"></div>

        <!-- Preview -->
        <div id="imp-preview-wrap" style="display:none;margin-bottom:16px;border:1px solid var(--border);border-radius:12px;overflow:hidden">
          <div style="background:var(--surface);padding:8px 16px;border-bottom:1px solid var(--border);font-size:12px;color:var(--muted);display:flex;gap:8px;align-items:center">
            <span style="color:var(--accent)">●</span><span style="color:#ffd93d">●</span><span style="color:var(--accent3)">●</span>
            <span style="margin-left:8px" id="imp-preview-url">preview</span>
          </div>
          <iframe id="imp-preview-frame" style="width:100%;height:560px;border:none;background:#fff"></iframe>
        </div>

        <div class="card">
          <div class="card-title">Rebuilt HTML</div>
          <div id="imp-code-display" style="background:var(--surface2);border:1px solid var(--border);border-radius:8px;padding:16px;font-family:'Courier New',monospace;font-size:11px;line-height:1.6;color:#a8d8a8;max-height:380px;overflow-y:auto;white-space:pre-wrap;word-break:break-all"></div>
        </div>
      </div>

      <!-- Error -->
      <div id="imp-error" style="display:none">
        <div class="form-section">
          <div class="alert" style="background:rgba(255,107,107,0.08);border-color:rgba(255,107,107,0.2);color:var(--accent3)" id="imp-error-msg"></div>
          <button class="btn btn-ghost" onclick="impReset()"><svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="19" y1="12" x2="5" y2="12"/><polyline points="12 19 5 12 12 5"/></svg> Try Again</button>
        </div>
      </div>

      <!-- How to get HTML from Hostinger guide -->
      <div class="card" style="margin-top:20px">
        <div class="card-title" style="margin-bottom:14px">📘 How to get your HTML from Hostinger</div>
        <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:12px" class="setup-steps-grid">
          <div style="background:var(--surface2);border:1px solid var(--border);border-radius:10px;padding:14px">
            <div style="font-family:'Syne',sans-serif;font-size:22px;font-weight:800;color:var(--accent);margin-bottom:6px">01</div>
            <div style="font-size:12px;font-weight:600;margin-bottom:4px">Open hPanel</div>
            <div style="font-size:11px;color:var(--muted);line-height:1.5">Log in to Hostinger → Go to hPanel → Click File Manager</div>
          </div>
          <div style="background:var(--surface2);border:1px solid var(--border);border-radius:10px;padding:14px">
            <div style="font-family:'Syne',sans-serif;font-size:22px;font-weight:800;color:var(--accent2);margin-bottom:6px">02</div>
            <div style="font-size:12px;font-weight:600;margin-bottom:4px">Find your page</div>
            <div style="font-size:11px;color:var(--muted);line-height:1.5">Navigate to public_html → find your .html file → right-click → Edit</div>
          </div>
          <div style="background:var(--surface2);border:1px solid var(--border);border-radius:10px;padding:14px">
            <div style="font-family:'Syne',sans-serif;font-size:22px;font-weight:800;color:var(--accent3);margin-bottom:6px">03</div>
            <div style="font-size:12px;font-weight:600;margin-bottom:4px">Copy all & paste</div>
            <div style="font-size:11px;color:var(--muted);line-height:1.5">Select all (Ctrl+A) → Copy → Paste into the box above → Import</div>
          </div>
        </div>
      </div>
    </div>

    <!-- ===== CONTENT CALENDAR ===== -->
    <div class="panel" id="panel-calendar">
      <div style="font-family:'Syne',sans-serif;font-size:20px;font-weight:800;margin-bottom:6px">Content Calendar</div>
      <div style="font-size:13px;color:var(--muted);margin-bottom:24px">Plan posts by month across all your sites — AI-generated or manual</div>

      <!-- Toolbar -->
      <div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap;margin-bottom:20px">
        <div style="display:flex;align-items:center;gap:6px;background:var(--surface);border:1px solid var(--border);border-radius:8px;padding:4px">
          <button class="btn btn-ghost" onclick="calNav(-1)" style="padding:6px 10px;border:none">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><line x1="19" y1="12" x2="5" y2="12"/><polyline points="12 19 5 12 12 5"/></svg>
          </button>
          <span id="cal-month-label" style="font-family:'Syne',sans-serif;font-weight:700;font-size:14px;min-width:130px;text-align:center">March 2025</span>
          <button class="btn btn-ghost" onclick="calNav(1)" style="padding:6px 10px;border:none">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><line x1="5" y1="12" x2="19" y2="12"/><polyline points="12 5 19 12 12 19"/></svg>
          </button>
        </div>
        <select id="cal-site-filter" onchange="renderCalendar()" style="font-size:12px;padding:6px 10px;background:var(--surface);border:1px solid var(--border);border-radius:7px;color:var(--text)">
          <option value="all">All Sites</option>
          <option>FixMyHive Doha</option>
          <option>Home Repair Pro</option>
          <option>DIY Repair Hub</option>
          <option>AC Repair Guide</option>
        </select>
        <button class="btn btn-accent2" onclick="generateCalendarAI()" id="cal-ai-btn" style="display:flex;align-items:center;gap:7px">
          <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></svg>
          AI Fill Month
        </button>
        <button class="btn btn-primary" onclick="openNewPostModal()" style="display:flex;align-items:center;gap:7px">
          <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="16"/><line x1="8" y1="12" x2="16" y2="12"/></svg>
          Add Post
        </button>
        <button class="btn btn-ghost" onclick="exportCalendarCSV()" style="margin-left:auto;display:flex;align-items:center;gap:7px">
          <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
          Export CSV
        </button>
      </div>

      <!-- Monthly stats strip -->
      <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:10px;margin-bottom:20px">
        <div class="stat-card" style="padding:14px 16px">
          <div style="font-size:11px;color:var(--muted);text-transform:uppercase;letter-spacing:0.8px;margin-bottom:6px">Planned</div>
          <div id="cal-stat-planned" style="font-family:'Syne',sans-serif;font-size:22px;font-weight:800">0</div>
        </div>
        <div class="stat-card" style="padding:14px 16px">
          <div style="font-size:11px;color:var(--muted);text-transform:uppercase;letter-spacing:0.8px;margin-bottom:6px">Published</div>
          <div id="cal-stat-published" style="font-family:'Syne',sans-serif;font-size:22px;font-weight:800;color:var(--accent)">0</div>
        </div>
        <div class="stat-card" style="padding:14px 16px">
          <div style="font-size:11px;color:var(--muted);text-transform:uppercase;letter-spacing:0.8px;margin-bottom:6px">In Draft</div>
          <div id="cal-stat-draft" style="font-family:'Syne',sans-serif;font-size:22px;font-weight:800;color:var(--gold)">0</div>
        </div>
        <div class="stat-card" style="padding:14px 16px">
          <div style="font-size:11px;color:var(--muted);text-transform:uppercase;letter-spacing:0.8px;margin-bottom:6px">Sites Active</div>
          <div id="cal-stat-sites" style="font-family:'Syne',sans-serif;font-size:22px;font-weight:800;color:var(--accent2)">4</div>
        </div>
      </div>

      <!-- Calendar grid -->
      <div class="card" style="padding:0;overflow:hidden;margin-bottom:20px">
        <!-- Day headers -->
        <div style="display:grid;grid-template-columns:repeat(7,1fr);background:var(--surface2);border-bottom:1px solid var(--border)">
          <div style="padding:10px;text-align:center;font-size:11px;font-weight:700;color:var(--muted);letter-spacing:0.8px">MON</div>
          <div style="padding:10px;text-align:center;font-size:11px;font-weight:700;color:var(--muted);letter-spacing:0.8px">TUE</div>
          <div style="padding:10px;text-align:center;font-size:11px;font-weight:700;color:var(--muted);letter-spacing:0.8px">WED</div>
          <div style="padding:10px;text-align:center;font-size:11px;font-weight:700;color:var(--muted);letter-spacing:0.8px">THU</div>
          <div style="padding:10px;text-align:center;font-size:11px;font-weight:700;color:var(--muted);letter-spacing:0.8px">FRI</div>
          <div style="padding:10px;text-align:center;font-size:11px;font-weight:700;color:var(--muted);letter-spacing:0.8px">SAT</div>
          <div style="padding:10px;text-align:center;font-size:11px;font-weight:700;color:var(--muted);letter-spacing:0.8px">SUN</div>
        </div>
        <!-- Calendar days rendered by JS -->
        <div id="cal-grid" style="display:grid;grid-template-columns:repeat(7,1fr)"></div>
      </div>

      <!-- Post list for month -->
      <div class="card">
        <div class="card-title" style="margin-bottom:16px">
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="margin-right:6px"><line x1="8" y1="6" x2="21" y2="6"/><line x1="8" y1="12" x2="21" y2="12"/><line x1="8" y1="18" x2="21" y2="18"/><line x1="3" y1="6" x2="3.01" y2="6"/><line x1="3" y1="12" x2="3.01" y2="12"/><line x1="3" y1="18" x2="3.01" y2="18"/></svg>
          All Posts This Month
        </div>
        <div id="cal-post-list" style="display:flex;flex-direction:column;gap:8px">
          <div style="color:var(--muted);font-size:13px;text-align:center;padding:24px">No posts scheduled. Click "Add Post" or use "AI Fill Month" to populate.</div>
        </div>
      </div>

      <!-- New Post Modal -->
      <div id="cal-modal" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,0.7);z-index:1000;align-items:center;justify-content:center">
        <div style="background:var(--surface);border:1px solid var(--border);border-radius:14px;padding:24px;width:480px;max-width:90vw;position:relative">
          <button onclick="closePostModal()" style="position:absolute;top:14px;right:14px;background:var(--surface2);border:1px solid var(--border);color:var(--muted);width:28px;height:28px;border-radius:50%;cursor:pointer;display:flex;align-items:center;justify-content:center">
            <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
          </button>
          <div style="font-family:'Syne',sans-serif;font-size:16px;font-weight:800;margin-bottom:18px" id="cal-modal-title">Add Post</div>
          <div class="form-grid" style="gap:12px">
            <div class="form-group">
              <label>Post Title / Topic</label>
              <input type="text" id="cal-post-title" placeholder="e.g. How to clean AC filters at home">
            </div>
            <div class="form-group">
              <label>Site</label>
              <select id="cal-post-site">
                <option>FixMyHive Doha</option>
                <option>Home Repair Pro</option>
                <option>DIY Repair Hub</option>
                <option>AC Repair Guide</option>
              </select>
            </div>
            <div class="form-group">
              <label>Date</label>
              <input type="date" id="cal-post-date">
            </div>
            <div class="form-group">
              <label>Status</label>
              <select id="cal-post-status">
                <option value="planned">Planned</option>
                <option value="draft">Draft</option>
                <option value="published">Published</option>
              </select>
            </div>
            <div class="form-group">
              <label>Type</label>
              <select id="cal-post-type">
                <option value="how-to">How-To</option>
                <option value="listicle">Listicle</option>
                <option value="info">Informational</option>
                <option value="local">Local Service</option>
                <option value="review">Review</option>
              </select>
            </div>
            <div class="form-group">
              <label>Target Keyword</label>
              <input type="text" id="cal-post-keyword" placeholder="e.g. AC filter cleaning">
            </div>
          </div>
          <div style="display:flex;gap:8px;margin-top:16px">
            <button class="btn btn-primary" style="flex:1" onclick="saveCalPost()">Save Post</button>
            <button class="btn btn-accent2" onclick="writePostNow()" style="flex:1;display:flex;align-items:center;justify-content:center;gap:7px">
              <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M12 20h9"/><path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4L16.5 3.5z"/></svg>
              Write Now
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- ===== LANDING PAGE GENERATOR ===== -->
    <div class="panel" id="panel-landing">
      <div style="font-family:'Syne',sans-serif;font-size:20px;font-weight:800;margin-bottom:6px">Landing Page Generator</div>
      <div style="font-size:13px;color:var(--muted);margin-bottom:24px">Generate high-converting squeeze pages, coming soon pages, service pages and lead capture pages</div>

      <!-- Form -->
      <div id="lp-form" class="card" style="margin-bottom:20px">

        <!-- Page type selector -->
        <div style="margin-bottom:20px">
          <div style="font-size:12px;font-weight:600;text-transform:uppercase;letter-spacing:0.8px;color:var(--muted);margin-bottom:12px">Page Type</div>
          <div style="display:grid;grid-template-columns:repeat(2,1fr);gap:8px" id="lp-type-grid">
            <div class="lp-type-card selected" data-type="squeeze" onclick="selectLpType(this,'squeeze')">
              <div style="display:flex;align-items:center;gap:10px">
                <div style="width:32px;height:32px;background:rgba(0,212,255,0.1);border-radius:8px;display:flex;align-items:center;justify-content:center;flex-shrink:0">
                  <svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="var(--accent)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07A19.5 19.5 0 0 1 4.64 13a19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 3.55 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"/></svg>
                </div>
                <div><div style="font-size:13px;font-weight:700">Lead Capture</div><div style="font-size:11px;color:var(--muted)">Collect leads with a form</div></div>
              </div>
            </div>
            <div class="lp-type-card" data-type="coming-soon" onclick="selectLpType(this,'coming-soon')">
              <div style="display:flex;align-items:center;gap:10px">
                <div style="width:32px;height:32px;background:rgba(180,79,255,0.1);border-radius:8px;display:flex;align-items:center;justify-content:center;flex-shrink:0">
                  <svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="var(--accent2)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>
                </div>
                <div><div style="font-size:13px;font-weight:700">Coming Soon</div><div style="font-size:11px;color:var(--muted)">Launch countdown page</div></div>
              </div>
            </div>
            <div class="lp-type-card" data-type="service" onclick="selectLpType(this,'service')">
              <div style="display:flex;align-items:center;gap:10px">
                <div style="width:32px;height:32px;background:rgba(245,197,66,0.1);border-radius:8px;display:flex;align-items:center;justify-content:center;flex-shrink:0">
                  <svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="var(--gold)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14.7 6.3a1 1 0 0 0 0 1.4l1.6 1.6a1 1 0 0 0 1.4 0l3.77-3.77a6 6 0 0 1-7.94 7.94l-6.91 6.91a2.12 2.12 0 0 1-3-3l6.91-6.91a6 6 0 0 1 7.94-7.94l-3.76 3.76z"/></svg>
                </div>
                <div><div style="font-size:13px;font-weight:700">Service Page</div><div style="font-size:11px;color:var(--muted)">Local service landing page</div></div>
              </div>
            </div>
            <div class="lp-type-card" data-type="adsense" onclick="selectLpType(this,'adsense')">
              <div style="display:flex;align-items:center;gap:10px">
                <div style="width:32px;height:32px;background:rgba(255,85,85,0.1);border-radius:8px;display:flex;align-items:center;justify-content:center;flex-shrink:0">
                  <svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="var(--accent3)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="1" x2="12" y2="23"/><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/></svg>
                </div>
                <div><div style="font-size:13px;font-weight:700">AdSense Niche</div><div style="font-size:11px;color:var(--muted)">High-RPM content page</div></div>
              </div>
            </div>
          </div>
        </div>

        <!-- Fields -->
        <div class="form-grid" style="gap:14px;margin-bottom:16px">
          <div class="form-group">
            <label>Headline / Main Hook</label>
            <input type="text" id="lp-headline" placeholder="e.g. Fast AC Repair in Doha — Same Day Service">
          </div>
          <div class="form-group">
            <label>Business / Brand Name</label>
            <input type="text" id="lp-brand" placeholder="e.g. FixMyHive">
          </div>
          <div class="form-group">
            <label>Primary Keyword</label>
            <input type="text" id="lp-keyword" placeholder="e.g. AC repair Doha">
          </div>
          <div class="form-group">
            <label>Location (optional)</label>
            <input type="text" id="lp-location" placeholder="e.g. Doha, Qatar">
          </div>
          <div class="form-group">
            <label>Phone / WhatsApp</label>
            <input type="text" id="lp-phone" placeholder="e.g. +974 7783 9040">
          </div>
          <div class="form-group">
            <label>Accent Colour</label>
            <input type="color" id="lp-color" value="#00d4ff" style="height:40px;padding:4px 8px">
          </div>
        </div>

        <div class="form-group" style="margin-bottom:16px">
          <label>Key Benefits / Selling Points (one per line)</label>
          <textarea id="lp-benefits" rows="3" placeholder="Same-day service&#10;Certified technicians&#10;All brands serviced&#10;Free diagnosis"></textarea>
        </div>

        <!-- Toggles -->
        <div style="display:flex;flex-wrap:wrap;gap:12px;margin-bottom:16px">
          <label style="display:flex;align-items:center;gap:6px;font-size:12px;cursor:pointer"><input type="checkbox" id="lp-form" checked> Lead capture form</label>
          <label style="display:flex;align-items:center;gap:6px;font-size:12px;cursor:pointer"><input type="checkbox" id="lp-cta" checked> Floating CTA button</label>
          <label style="display:flex;align-items:center;gap:6px;font-size:12px;cursor:pointer"><input type="checkbox" id="lp-social" checked> Social proof / reviews</label>
          <label style="display:flex;align-items:center;gap:6px;font-size:12px;cursor:pointer"><input type="checkbox" id="lp-faq"> FAQ section</label>
          <label style="display:flex;align-items:center;gap:6px;font-size:12px;cursor:pointer"><input type="checkbox" id="lp-schema" checked> Schema markup</label>
          <label style="display:flex;align-items:center;gap:6px;font-size:12px;cursor:pointer"><input type="checkbox" id="lp-wa"> WhatsApp button</label>
        </div>

        <button class="btn btn-primary" id="lp-gen-btn" onclick="generateLandingPage()" style="display:flex;align-items:center;gap:8px;font-size:14px;padding:12px 24px">
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><rect x="2" y="3" width="20" height="14" rx="2"/><path d="M8 21h8M12 17v4"/></svg>
          Generate Landing Page
        </button>
      </div>

      <!-- Progress -->
      <div id="lp-progress" class="card" style="display:none;margin-bottom:20px;padding:32px;text-align:center">
        <div style="font-size:13px;font-weight:600;margin-bottom:16px" id="lp-progress-label">Designing your page...</div>
        <div style="background:var(--surface2);border-radius:100px;height:6px;overflow:hidden;margin-bottom:20px">
          <div id="lp-progress-bar" style="height:100%;background:var(--accent2);border-radius:100px;width:0%;transition:width 0.6s ease"></div>
        </div>
        <div style="display:flex;justify-content:center;gap:8px;flex-wrap:wrap">
          <div class="blog-step" id="lpstep-design">Design</div>
          <div class="blog-step" id="lpstep-copy">Copy</div>
          <div class="blog-step" id="lpstep-seo">SEO</div>
          <div class="blog-step" id="lpstep-code">HTML</div>
          <div class="blog-step" id="lpstep-done">Done</div>
        </div>
      </div>

      <!-- Output -->
      <div id="lp-output" style="display:none">
        <div class="card" style="margin-bottom:16px;display:flex;gap:10px;flex-wrap:wrap;align-items:center">
          <div style="display:flex;gap:8px;align-items:center">
            <div id="lp-type-badge" style="font-size:10px;font-weight:700;letter-spacing:0.8px;padding:3px 10px;border-radius:20px;background:rgba(0,212,255,0.1);color:var(--accent)">LEAD CAPTURE</div>
          </div>
          <div style="margin-left:auto;display:flex;gap:8px;flex-wrap:wrap">
            <button class="btn btn-ghost" style="font-size:12px" onclick="copyLpHtml()"><svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2"/><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/></svg> Copy HTML</button>
            <button class="btn btn-accent2" style="font-size:12px" onclick="toggleLpPreview()"><svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg> Toggle Preview</button>
            <button class="btn btn-primary" style="font-size:12px" onclick="downloadLp()"><svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg> Download .html</button>
          </div>
        </div>

        <!-- Preview iframe -->
        <div id="lp-preview-wrap" style="display:none;margin-bottom:16px">
          <div style="background:var(--surface2);border-radius:8px;padding:4px">
            <div style="display:flex;gap:6px;padding:8px 12px;border-bottom:1px solid var(--border);margin-bottom:0">
              <span style="width:10px;height:10px;border-radius:50%;background:var(--accent3);display:inline-block"></span>
              <span style="width:10px;height:10px;border-radius:50%;background:var(--gold);display:inline-block"></span>
              <span style="width:10px;height:10px;border-radius:50%;background:var(--accent);display:inline-block"></span>
            </div>
            <iframe id="lp-iframe" style="width:100%;height:600px;border:none;border-radius:0 0 6px 6px;background:#fff"></iframe>
          </div>
        </div>

        <!-- Source code -->
        <div class="card">
          <pre id="lp-html-source" style="background:var(--surface2);border-radius:8px;padding:16px;font-size:11px;font-family:'Courier New',monospace;overflow-x:auto;white-space:pre-wrap;line-height:1.6;color:#a8d8a8;max-height:400px;overflow-y:auto"></pre>
        </div>

        <button class="btn btn-ghost" style="margin-top:16px;font-size:12px" onclick="resetLandingPage()">
          <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" style="margin-right:6px"><polyline points="1 4 1 10 7 10"/><path d="M3.51 15a9 9 0 1 0 .49-3.95"/></svg>
          Generate Another
        </button>
      </div>
    </div>

    <!-- ===== BLOG WRITER ===== -->
    <div class="panel" id="panel-blog">
      <div style="font-family:'Syne',sans-serif;font-size:20px;font-weight:800;margin-bottom:6px">Blog Post Writer</div>
      <div style="font-size:13px;color:var(--muted);margin-bottom:24px">Full AI-written articles — SEO optimised, ready to publish</div>

      <!-- Input form -->
      <div id="blog-form" class="card" style="margin-bottom:20px">
        <div class="form-grid" style="grid-template-columns:1fr 1fr;gap:16px;margin-bottom:16px">
          <div class="form-group">
            <label>Primary Keyword / Topic</label>
            <input type="text" id="blog-keyword" placeholder="e.g. how to fix a leaking AC unit">
          </div>
          <div class="form-group">
            <label>Article Type</label>
            <select id="blog-type">
              <option value="how-to">How-To Guide</option>
              <option value="listicle">Listicle (Top 10 / Best...)</option>
              <option value="informational">Informational / Explainer</option>
              <option value="comparison">Comparison / vs Article</option>
              <option value="review">Product / Service Review</option>
              <option value="local">Local Service Page</option>
              <option value="news">News / Update</option>
            </select>
          </div>
          <div class="form-group">
            <label>Target Audience</label>
            <input type="text" id="blog-audience" placeholder="e.g. homeowners in Doha, DIY beginners">
          </div>
          <div class="form-group">
            <label>Site / Brand</label>
            <input type="text" id="blog-brand" placeholder="e.g. FixMyHive">
          </div>
          <div class="form-group">
            <label>Word Count Target</label>
            <select id="blog-length">
              <option value="800">Short — ~800 words</option>
              <option value="1200" selected>Medium — ~1200 words</option>
              <option value="2000">Long — ~2000 words</option>
              <option value="3000">Pillar — ~3000 words</option>
            </select>
          </div>
          <div class="form-group">
            <label>Tone</label>
            <select id="blog-tone">
              <option value="helpful">Helpful & Friendly</option>
              <option value="professional">Professional & Expert</option>
              <option value="casual">Casual & Conversational</option>
              <option value="urgent">Urgent / Problem-Solving</option>
            </select>
          </div>
        </div>

        <!-- Toggles row -->
        <div style="display:flex;flex-wrap:wrap;gap:10px;margin-bottom:16px">
          <label style="display:flex;align-items:center;gap:6px;font-size:12px;cursor:pointer"><input type="checkbox" id="blog-faq" checked> Include FAQ section</label>
          <label style="display:flex;align-items:center;gap:6px;font-size:12px;cursor:pointer"><input type="checkbox" id="blog-cta" checked> Add CTA at end</label>
          <label style="display:flex;align-items:center;gap:6px;font-size:12px;cursor:pointer"><input type="checkbox" id="blog-meta" checked> Generate meta tags</label>
          <label style="display:flex;align-items:center;gap:6px;font-size:12px;cursor:pointer"><input type="checkbox" id="blog-outline"> Generate outline first</label>
          <label style="display:flex;align-items:center;gap:6px;font-size:12px;cursor:pointer"><input type="checkbox" id="blog-schema" checked> Article schema JSON-LD</label>
        </div>

        <div class="form-group" style="margin-bottom:16px">
          <label>Additional Notes (optional)</label>
          <textarea id="blog-notes" rows="2" placeholder="e.g. mention brand warranties, avoid mentioning competitor X, include local references to Pearl Qatar"></textarea>
        </div>

        <button class="btn btn-primary" id="blog-gen-btn" onclick="generateBlogPost()" style="display:flex;align-items:center;gap:8px">
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M12 20h9"/><path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4L16.5 3.5z"/></svg>
          Generate Article
        </button>
      </div>

      <!-- Progress -->
      <div id="blog-progress" class="card" style="display:none;margin-bottom:20px;text-align:center;padding:32px">
        <div style="font-size:13px;font-weight:600;margin-bottom:16px" id="blog-progress-label">Writing your article...</div>
        <div style="background:var(--surface2);border-radius:100px;height:6px;overflow:hidden;margin-bottom:20px">
          <div id="blog-progress-bar" style="height:100%;background:var(--accent);border-radius:100px;width:0%;transition:width 0.6s ease"></div>
        </div>
        <div style="display:flex;justify-content:center;gap:8px;flex-wrap:wrap" id="blog-steps">
          <div class="blog-step" id="bstep-outline">Outline</div>
          <div class="blog-step" id="bstep-content">Content</div>
          <div class="blog-step" id="bstep-seo">SEO & Meta</div>
          <div class="blog-step" id="bstep-schema">Schema</div>
          <div class="blog-step" id="bstep-done">Complete</div>
        </div>
      </div>

      <!-- Output -->
      <div id="blog-output" style="display:none">
        <!-- Stats bar -->
        <div class="card" style="margin-bottom:16px;display:flex;gap:24px;flex-wrap:wrap">
          <div style="text-align:center"><div id="blog-stat-words" style="font-size:22px;font-weight:800;font-family:'Syne',sans-serif;color:var(--accent)">—</div><div style="font-size:11px;color:var(--muted)">Words</div></div>
          <div style="text-align:center"><div id="blog-stat-sections" style="font-size:22px;font-weight:800;font-family:'Syne',sans-serif;color:var(--accent2)">—</div><div style="font-size:11px;color:var(--muted)">Sections</div></div>
          <div style="text-align:center"><div id="blog-stat-faqs" style="font-size:22px;font-weight:800;font-family:'Syne',sans-serif;color:var(--gold)">—</div><div style="font-size:11px;color:var(--muted)">FAQs</div></div>
          <div style="text-align:center"><div id="blog-stat-readtime" style="font-size:22px;font-weight:800;font-family:'Syne',sans-serif;color:var(--text)">—</div><div style="font-size:11px;color:var(--muted)">Min Read</div></div>
          <div style="margin-left:auto;display:flex;gap:8px;align-items:center">
            <button class="btn btn-ghost" style="font-size:12px" onclick="copyBlogContent('html')">Copy HTML</button>
            <button class="btn btn-ghost" style="font-size:12px" onclick="copyBlogContent('text')">Copy Text</button>
            <button class="btn btn-primary" style="font-size:12px" onclick="downloadBlogPost()">Download .html</button>
          </div>
        </div>

        <!-- Tabs -->
        <div style="display:flex;gap:2px;background:var(--surface2);border-radius:8px;padding:4px;margin-bottom:16px;width:fit-content">
          <button class="blog-tab active" id="btab-preview" onclick="switchBlogTab('preview')">Preview</button>
          <button class="blog-tab" id="btab-html" onclick="switchBlogTab('html')">HTML Source</button>
          <button class="blog-tab" id="btab-meta" onclick="switchBlogTab('meta')">Meta Tags</button>
          <button class="blog-tab" id="btab-schema" onclick="switchBlogTab('schema')">Schema</button>
        </div>

        <div class="card" style="min-height:300px">
          <!-- Preview tab -->
          <div id="blog-pane-preview">
            <div id="blog-article-preview" style="line-height:1.8;font-size:14px;max-width:720px"></div>
          </div>
          <!-- HTML source tab -->
          <div id="blog-pane-html" style="display:none">
            <pre id="blog-html-source" style="background:var(--surface2);border-radius:8px;padding:16px;font-size:11px;font-family:'Courier New',monospace;overflow-x:auto;white-space:pre-wrap;line-height:1.6;color:#a8d8a8"></pre>
          </div>
          <!-- Meta tab -->
          <div id="blog-pane-meta" style="display:none">
            <pre id="blog-meta-source" style="background:var(--surface2);border-radius:8px;padding:16px;font-size:11px;font-family:'Courier New',monospace;overflow-x:auto;white-space:pre-wrap;line-height:1.6;color:#8ab4f8"></pre>
          </div>
          <!-- Schema tab -->
          <div id="blog-pane-schema" style="display:none">
            <pre id="blog-schema-source" style="background:var(--surface2);border-radius:8px;padding:16px;font-size:11px;font-family:'Courier New',monospace;overflow-x:auto;white-space:pre-wrap;line-height:1.6;color:#f5c542"></pre>
          </div>
        </div>

        <button class="btn btn-ghost" style="margin-top:16px;font-size:12px" onclick="resetBlogWriter()">
          <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" style="margin-right:6px"><polyline points="1 4 1 10 7 10"/><path d="M3.51 15a9 9 0 1 0 .49-3.95"/></svg>
          Write Another Post
        </button>
      </div>
    </div>

    <!-- ===== BOOKINGS CRM ===== -->
    <div class="panel" id="panel-bookings">

      <!-- Header bar -->
      <div style="display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:12px;margin-bottom:24px">
        <div>
          <div style="font-family:'Syne',sans-serif;font-size:20px;font-weight:800">Bookings & Appointments</div>
          <div style="color:var(--muted);font-size:13px;margin-top:3px">All customer bookings across your sites — saved locally in your browser</div>
        </div>
        <button class="btn btn-primary" onclick="openBookingModal()">+ New Booking</button>
      </div>

      <!-- Stats row -->
      <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:12px;margin-bottom:24px" id="crm-stats-row">
        <div class="stat-card"><div class="stat-label">Total Bookings</div><div class="stat-value" id="crm-stat-total">0</div><div class="stat-sub">All time</div></div>
        <div class="stat-card"><div class="stat-label">New / Pending</div><div class="stat-value" id="crm-stat-pending" style="color:var(--gold)">0</div><div class="stat-sub">Awaiting confirmation</div></div>
        <div class="stat-card"><div class="stat-label">Confirmed</div><div class="stat-value" id="crm-stat-confirmed" style="color:var(--accent)">0</div><div class="stat-sub">Scheduled</div></div>
        <div class="stat-card"><div class="stat-label">Completed</div><div class="stat-value" id="crm-stat-done" style="color:var(--accent2)">0</div><div class="stat-sub">Repairs done</div></div>
      </div>

      <!-- Filter + search bar -->
      <div style="display:flex;gap:10px;flex-wrap:wrap;margin-bottom:16px;align-items:center">
        <input type="text" id="crm-search" placeholder="Search name, phone, appliance..." style="flex:1;min-width:200px" oninput="renderBookings()">
        <select id="crm-filter-status" onchange="renderBookings()" style="width:140px">
          <option value="all">All Status</option>
          <option value="pending">Pending</option>
          <option value="confirmed">Confirmed</option>
          <option value="in-progress">In Progress</option>
          <option value="completed">Completed</option>
          <option value="cancelled">Cancelled</option>
        </select>
        <select id="crm-filter-site" onchange="renderBookings()" style="width:160px">
          <option value="all">All Sites</option>
          <option value="FixMyHive Doha">FixMyHive Doha</option>
          <option value="Home Repair Pro">Home Repair Pro</option>
          <option value="DIY Repair Hub">DIY Repair Hub</option>
        </select>
        <button class="btn btn-ghost" style="font-size:12px" onclick="exportBookingsCSV()">⬇ Export CSV</button>
      </div>

      <!-- Bookings table -->
      <div class="card" style="padding:0;overflow:hidden">
        <div style="overflow-x:auto">
          <table class="kw-table" id="crm-table">
            <thead>
              <tr>
                <th style="padding-left:16px">Customer</th>
                <th>Appliance</th>
                <th>Date & Time</th>
                <th>Site</th>
                <th>Status</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="crm-tbody">
              <tr><td colspan="6" style="text-align:center;padding:40px;color:var(--muted)">No bookings yet. Click "+ New Booking" to add your first one.</td></tr>
            </tbody>
          </table>
        </div>
      </div>

      <!-- Booking modal -->
      <div id="booking-modal" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,0.75);z-index:400;align-items:center;justify-content:center;padding:20px">
        <div style="background:var(--surface);border:1px solid var(--border);border-radius:16px;max-width:540px;width:100%;max-height:90vh;overflow-y:auto;padding:28px;position:relative">
          <button onclick="closeBookingModal()" style="position:absolute;top:16px;right:16px;background:var(--surface2);border:1px solid var(--border);color:var(--muted);width:28px;height:28px;border-radius:50%;cursor:pointer;font-size:14px;display:flex;align-items:center;justify-content:center;line-height:1">✕</button>

          <div style="font-family:'Syne',sans-serif;font-size:16px;font-weight:800;margin-bottom:20px" id="booking-modal-title">New Booking</div>

          <div class="form-grid">
            <div class="form-group">
              <label>Customer Name *</label>
              <input type="text" id="bk-name" placeholder="e.g. Ahmed Al-Mansoori">
            </div>
            <div class="form-group">
              <label>Phone Number *</label>
              <input type="text" id="bk-phone" placeholder="e.g. +974 5555 1234">
            </div>
            <div class="form-group">
              <label>Email</label>
              <input type="email" id="bk-email" placeholder="customer@email.com">
            </div>
            <div class="form-group">
              <label>Appliance Type *</label>
              <select id="bk-appliance">
                <option value="">Select appliance...</option>
                <option>Washing Machine</option>
                <option>Refrigerator / Freezer</option>
                <option>Dishwasher</option>
                <option>Oven / Range</option>
                <option>Dryer</option>
                <option>Air Conditioner</option>
                <option>Microwave</option>
                <option>Coffee Machine</option>
                <option>Other</option>
              </select>
            </div>
            <div class="form-group">
              <label>Brand / Model</label>
              <input type="text" id="bk-brand" placeholder="e.g. Bosch WAX32E41GB">
            </div>
            <div class="form-group">
              <label>Site / Source</label>
              <select id="bk-site">
                <option>FixMyHive Doha</option>
                <option>Home Repair Pro</option>
                <option>DIY Repair Hub</option>
                <option>Walk-in / Phone</option>
              </select>
            </div>
            <div class="form-group">
              <label>Preferred Date *</label>
              <input type="date" id="bk-date">
            </div>
            <div class="form-group">
              <label>Preferred Time</label>
              <select id="bk-time">
                <option>08:00 – 10:00</option>
                <option>10:00 – 12:00</option>
                <option>12:00 – 14:00</option>
                <option>14:00 – 16:00</option>
                <option>16:00 – 18:00</option>
                <option>18:00 – 20:00</option>
              </select>
            </div>
            <div class="form-group">
              <label>Address / Area</label>
              <input type="text" id="bk-address" placeholder="e.g. The Pearl, Tower B">
            </div>
            <div class="form-group">
              <label>Status</label>
              <select id="bk-status">
                <option value="pending">Pending</option>
                <option value="confirmed">Confirmed</option>
                <option value="in-progress">In Progress</option>
                <option value="completed">Completed</option>
                <option value="cancelled">Cancelled</option>
              </select>
            </div>
            <div class="form-group full">
              <label>Issue Description</label>
              <textarea id="bk-notes" rows="3" placeholder="Describe the problem — what's the fault, any error codes, how long has it been broken..."></textarea>
            </div>
          </div>

          <div style="display:flex;gap:10px;margin-top:4px">
            <button class="btn btn-ghost" onclick="closeBookingModal()" style="flex:1">Cancel</button>
            <button class="btn btn-primary" onclick="saveBooking()" style="flex:2" id="bk-save-btn">Save Booking</button>
          </div>
        </div>
      </div>

      <!-- Booking detail modal -->
      <div id="booking-detail-modal" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,0.75);z-index:400;align-items:center;justify-content:center;padding:20px">
        <div style="background:var(--surface);border:1px solid var(--border);border-radius:16px;max-width:500px;width:100%;max-height:90vh;overflow-y:auto;padding:28px;position:relative">
          <button onclick="document.getElementById('booking-detail-modal').style.display='none'" style="position:absolute;top:16px;right:16px;background:var(--surface2);border:1px solid var(--border);color:var(--muted);width:28px;height:28px;border-radius:50%;cursor:pointer;font-size:14px;display:flex;align-items:center;justify-content:center;line-height:1">✕</button>
          <div id="booking-detail-content"></div>
        </div>
      </div>
    </div>

    <!-- ===== CODE INJECTOR ===== -->
    <div class="panel" id="panel-injector">

      <div style="display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:12px;margin-bottom:8px">
        <div>
          <div style="font-family:'Syne',sans-serif;font-size:20px;font-weight:800">Code Injector</div>
          <div style="color:var(--muted);font-size:13px;margin-top:3px">Paste your tracking codes once — auto-injected into every page NicheForge generates</div>
        </div>
        <div style="display:flex;gap:8px;flex-wrap:wrap">
          <button class="btn btn-ghost" onclick="testAllInjectors()">🧪 Test All</button>
          <button class="btn btn-primary" onclick="saveAllInjectors()">💾 Save All</button>
        </div>
      </div>

      <!-- Status bar -->
      <div id="injector-status-bar" style="display:flex;gap:10px;flex-wrap:wrap;margin-bottom:24px;padding:14px;background:var(--surface);border:1px solid var(--border);border-radius:10px">
        <!-- rendered by JS -->
      </div>

      <!-- GTM -->
      <div class="card injector-card" id="inj-card-gtm" style="margin-bottom:16px">
        <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:14px;flex-wrap:wrap;gap:10px">
          <div style="display:flex;align-items:center;gap:12px">
            <div style="width:40px;height:40px;background:rgba(0,184,255,0.1);border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:20px">🏷</div>
            <div>
              <div style="font-size:14px;font-weight:700">Google Tag Manager</div>
              <div style="font-size:11px;color:var(--muted)">Injects GTM snippet into &lt;head&gt; and &lt;body&gt; of every page</div>
            </div>
          </div>
          <div style="display:flex;align-items:center;gap:10px">
            <div class="inj-status-pill" id="inj-status-gtm">Not set</div>
            <label class="inj-toggle">
              <input type="checkbox" id="inj-enable-gtm" onchange="saveAllInjectors()">
              <span class="inj-slider"></span>
            </label>
          </div>
        </div>

        <div class="form-group" style="margin-bottom:12px">
          <label>GTM Container ID</label>
          <input type="text" id="inj-gtm-id" placeholder="GTM-XXXXXXX" oninput="validateGTM()" style="font-family:'Courier New',monospace">
          <div style="font-size:11px;color:var(--muted);margin-top:4px">Found in your GTM account under Admin → Container Settings</div>
        </div>

        <div id="inj-gtm-preview" style="display:none">
          <div style="font-size:11px;font-weight:600;color:var(--muted);text-transform:uppercase;letter-spacing:1px;margin-bottom:8px">Code that will be injected:</div>
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px" class="inj-code-grid">
            <div>
              <div style="font-size:10px;color:var(--accent);margin-bottom:4px">→ &lt;head&gt; (before &lt;/head&gt;)</div>
              <div class="inj-code-block" id="inj-gtm-head-code"></div>
            </div>
            <div>
              <div style="font-size:10px;color:var(--accent2);margin-bottom:4px">→ &lt;body&gt; (after &lt;body&gt;)</div>
              <div class="inj-code-block" id="inj-gtm-body-code"></div>
            </div>
          </div>
        </div>
      </div>

      <!-- GA4 -->
      <div class="card injector-card" id="inj-card-ga4" style="margin-bottom:16px">
        <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:14px;flex-wrap:wrap;gap:10px">
          <div style="display:flex;align-items:center;gap:12px">
            <div style="width:40px;height:40px;background:rgba(255,211,61,0.1);border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:20px">📊</div>
            <div>
              <div style="font-size:14px;font-weight:700">Google Analytics 4</div>
              <div style="font-size:11px;color:var(--muted)">Injects GA4 gtag.js snippet into &lt;head&gt; of every page</div>
            </div>
          </div>
          <div style="display:flex;align-items:center;gap:10px">
            <div class="inj-status-pill" id="inj-status-ga4">Not set</div>
            <label class="inj-toggle">
              <input type="checkbox" id="inj-enable-ga4" onchange="saveAllInjectors()">
              <span class="inj-slider"></span>
            </label>
          </div>
        </div>

        <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px" class="inj-form-grid">
          <div class="form-group" style="margin-bottom:0">
            <label>Measurement ID</label>
            <input type="text" id="inj-ga4-id" placeholder="G-XXXXXXXXXX" oninput="validateGA4()" style="font-family:'Courier New',monospace">
            <div style="font-size:11px;color:var(--muted);margin-top:4px">GA4 → Admin → Data Streams → Web stream → Measurement ID</div>
          </div>
          <div class="form-group" style="margin-bottom:0">
            <label>Additional config (optional)</label>
            <input type="text" id="inj-ga4-config" placeholder="e.g. send_page_view: false" style="font-family:'Courier New',monospace">
            <div style="font-size:11px;color:var(--muted);margin-top:4px">Extra gtag config params, comma separated</div>
          </div>
        </div>

        <div id="inj-ga4-preview" style="display:none;margin-top:12px">
          <div style="font-size:11px;font-weight:600;color:var(--muted);text-transform:uppercase;letter-spacing:1px;margin-bottom:8px">Code that will be injected into &lt;head&gt;:</div>
          <div class="inj-code-block" id="inj-ga4-code"></div>
        </div>
      </div>

      <!-- AdSense -->
      <div class="card injector-card" id="inj-card-adsense" style="margin-bottom:16px">
        <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:14px;flex-wrap:wrap;gap:10px">
          <div style="display:flex;align-items:center;gap:12px">
            <div style="width:40px;height:40px;background:rgba(0,212,255,0.1);border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:20px">💰</div>
            <div>
              <div style="font-size:14px;font-weight:700">Google AdSense</div>
              <div style="font-size:11px;color:var(--muted)">Injects AdSense auto-ads script + optional manual ad units</div>
            </div>
          </div>
          <div style="display:flex;align-items:center;gap:10px">
            <div class="inj-status-pill" id="inj-status-adsense">Not set</div>
            <label class="inj-toggle">
              <input type="checkbox" id="inj-enable-adsense" onchange="saveAllInjectors()">
              <span class="inj-slider"></span>
            </label>
          </div>
        </div>

        <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px" class="inj-form-grid">
          <div class="form-group" style="margin-bottom:12px">
            <label>Publisher ID</label>
            <input type="text" id="inj-ads-pub" placeholder="ca-pub-XXXXXXXXXXXXXXXX" oninput="validateAdSense()" style="font-family:'Courier New',monospace">
            <div style="font-size:11px;color:var(--muted);margin-top:4px">AdSense → Account → Account information → Publisher ID</div>
          </div>
          <div class="form-group" style="margin-bottom:12px">
            <label>Ad Mode</label>
            <select id="inj-ads-mode" onchange="saveAllInjectors()">
              <option value="auto">Auto Ads (recommended — Google places ads automatically)</option>
              <option value="manual">Manual Units Only (you control placement)</option>
              <option value="both">Both Auto Ads + Manual Units</option>
            </select>
          </div>
        </div>

        <!-- Manual ad units -->
        <div id="inj-manual-units" style="display:none">
          <div style="font-size:12px;font-weight:600;margin-bottom:10px">Manual Ad Unit Slots</div>
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:12px" class="inj-form-grid">
            <div class="form-group" style="margin-bottom:0">
              <label>Header Ad Slot ID</label>
              <input type="text" id="inj-ads-header-slot" placeholder="1234567890" style="font-family:'Courier New',monospace">
            </div>
            <div class="form-group" style="margin-bottom:0">
              <label>In-Content Ad Slot ID</label>
              <input type="text" id="inj-ads-incontent-slot" placeholder="0987654321" style="font-family:'Courier New',monospace">
            </div>
            <div class="form-group" style="margin-bottom:0">
              <label>Sidebar Ad Slot ID</label>
              <input type="text" id="inj-ads-sidebar-slot" placeholder="1122334455" style="font-family:'Courier New',monospace">
            </div>
            <div class="form-group" style="margin-bottom:0">
              <label>Footer Ad Slot ID</label>
              <input type="text" id="inj-ads-footer-slot" placeholder="5544332211" style="font-family:'Courier New',monospace">
            </div>
          </div>
        </div>

        <div id="inj-adsense-preview" style="display:none">
          <div style="font-size:11px;font-weight:600;color:var(--muted);text-transform:uppercase;letter-spacing:1px;margin-bottom:8px">Code that will be injected into &lt;head&gt;:</div>
          <div class="inj-code-block" id="inj-adsense-code"></div>
        </div>
      </div>

      <!-- Custom head / body -->
      <div class="card injector-card" id="inj-card-custom" style="margin-bottom:16px">
        <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:14px;flex-wrap:wrap;gap:10px">
          <div style="display:flex;align-items:center;gap:12px">
            <div style="width:40px;height:40px;background:rgba(180,79,255,0.1);border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:20px">🧩</div>
            <div>
              <div style="font-size:14px;font-weight:700">Custom Code</div>
              <div style="font-size:11px;color:var(--muted)">Any other scripts — Facebook Pixel, Hotjar, Clarity, Crisp chat, custom CSS…</div>
            </div>
          </div>
          <div style="display:flex;align-items:center;gap:10px">
            <div class="inj-status-pill" id="inj-status-custom">Not set</div>
            <label class="inj-toggle">
              <input type="checkbox" id="inj-enable-custom" onchange="saveAllInjectors()">
              <span class="inj-slider"></span>
            </label>
          </div>
        </div>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px" class="inj-form-grid">
          <div class="form-group" style="margin-bottom:0">
            <label>Custom &lt;head&gt; code</label>
            <textarea id="inj-custom-head" rows="5" placeholder="<!-- Paste any code that goes inside <head> -->" style="font-family:'Courier New',monospace;font-size:11px" oninput="validateCustom()"></textarea>
            <div style="font-size:11px;color:var(--muted);margin-top:4px">Meta tags, link tags, scripts, CSS variables…</div>
          </div>
          <div class="form-group" style="margin-bottom:0">
            <label>Custom &lt;body&gt; code</label>
            <textarea id="inj-custom-body" rows="5" placeholder="<!-- Paste any code that goes after <body> opens -->" style="font-family:'Courier New',monospace;font-size:11px" oninput="validateCustom()"></textarea>
            <div style="font-size:11px;color:var(--muted);margin-top:4px">Noscript tags, chat widgets, popups…</div>
          </div>
        </div>
      </div>

      <!-- Test output -->
      <div class="card" style="margin-bottom:16px;display:none" id="inj-test-card">
        <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:14px">
          <div style="font-size:14px;font-weight:700">🧪 Injection Preview — What gets added to your pages</div>
          <div style="display:flex;gap:8px">
            <button class="btn btn-ghost" style="font-size:12px" onclick="copyInjectedHead()">Copy &lt;head&gt;</button>
            <button class="btn btn-ghost" style="font-size:12px" onclick="copyInjectedBody()">Copy &lt;body&gt;</button>
          </div>
        </div>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px" class="inj-code-grid">
          <div>
            <div style="font-size:11px;color:var(--accent);margin-bottom:6px;font-weight:600">Injected into &lt;head&gt;</div>
            <div class="inj-code-block" id="inj-test-head" style="max-height:300px;overflow-y:auto"></div>
          </div>
          <div>
            <div style="font-size:11px;color:var(--accent2);margin-bottom:6px;font-weight:600">Injected after &lt;body&gt;</div>
            <div class="inj-code-block" id="inj-test-body" style="max-height:300px;overflow-y:auto"></div>
          </div>
        </div>
      </div>

      <!-- How it works -->
      <div class="card">
        <div class="card-title" style="margin-bottom:14px">📘 How It Works</div>
        <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:12px" class="setup-steps-grid">
          <div style="background:var(--surface2);border:1px solid var(--border);border-radius:10px;padding:16px">
            <div style="font-family:'Syne',sans-serif;font-size:24px;font-weight:800;color:var(--accent);margin-bottom:8px">01</div>
            <div style="font-size:13px;font-weight:600;margin-bottom:4px">Paste your codes here</div>
            <div style="font-size:12px;color:var(--muted);line-height:1.5">Enter your GTM container ID, GA4 measurement ID, AdSense publisher ID. Toggle each one on.</div>
          </div>
          <div style="background:var(--surface2);border:1px solid var(--border);border-radius:10px;padding:16px">
            <div style="font-family:'Syne',sans-serif;font-size:24px;font-weight:800;color:var(--accent2);margin-bottom:8px">02</div>
            <div style="font-size:13px;font-weight:600;margin-bottom:4px">Generate pages as normal</div>
            <div style="font-size:12px;color:var(--muted);line-height:1.5">Every page the Page Generator or Import tool creates will automatically have all active codes injected.</div>
          </div>
          <div style="background:var(--surface2);border:1px solid var(--border);border-radius:10px;padding:16px">
            <div style="font-family:'Syne',sans-serif;font-size:24px;font-weight:800;color:var(--accent3);margin-bottom:8px">03</div>
            <div style="font-size:13px;font-weight:600;margin-bottom:4px">Inject into existing pages</div>
            <div style="font-size:12px;color:var(--muted);line-height:1.5">Use Import Site → paste your page → NicheForge rebuilds it with all your codes already inside. Ready to upload.</div>
          </div>
        </div>
        <div class="alert alert-success" style="margin-top:16px;margin-bottom:0">
          ✓ GTM is the recommended setup — once GTM is injected, you manage GA4, AdSense, and everything else from inside GTM without ever touching your HTML again.
        </div>
      </div>

    </div>

    <!-- ===== SETTINGS ===== -->
    <div class="panel" id="panel-settings">

      <div style="font-family:'Syne',sans-serif;font-size:20px;font-weight:800;margin-bottom:24px">Settings</div>

      <!-- ── Supabase Connection ── -->
      <div class="card" style="margin-bottom:14px;border:1px solid rgba(62,207,142,0.25);background:rgba(62,207,142,0.03)">
        <div style="display:flex;align-items:center;gap:10px;margin-bottom:12px">
          <div style="width:32px;height:32px;background:rgba(62,207,142,0.15);border-radius:8px;display:flex;align-items:center;justify-content:center;flex-shrink:0;font-size:18px">🗄️</div>
          <div style="flex:1">
            <div style="font-weight:700;font-size:13px">Supabase Database</div>
            <div style="font-size:11px;color:var(--muted)">Visitor tracking · Content queue · Decision log · All Marketing OS data</div>
          </div>
          <div id="supabase-badge" style="font-size:10px;font-weight:700;padding:3px 9px;border-radius:20px;background:rgba(255,85,85,0.12);color:var(--accent3)">NOT SET</div>
        </div>
        <div style="display:flex;flex-direction:column;gap:8px">
          <input type="text" id="set-supabase-url" placeholder="https://wlsshfdwxjxodjmcvwlj.supabase.co" style="font-family:'Courier New',monospace;font-size:11px" oninput="saveSupabaseConfig()">
          <input type="password" id="set-supabase-key" placeholder="eyJ... (anon public key)" style="font-family:'Courier New',monospace;font-size:11px" oninput="saveSupabaseConfig()">
        </div>
        <div id="supabase-test-result" style="font-size:11px;margin-top:8px;display:none"></div>
        <button class="btn btn-ghost" onclick="testSupabaseConnection()" style="margin-top:10px;font-size:12px;width:100%">🔌 Test Connection</button>
      </div>

      <!-- ── Railway Backend ── -->
      <div class="card" style="margin-bottom:14px;border:1px solid rgba(180,79,255,0.2);background:rgba(180,79,255,0.02)">
        <div style="display:flex;align-items:center;gap:10px;margin-bottom:12px">
          <div style="width:32px;height:32px;background:rgba(180,79,255,0.12);border-radius:8px;display:flex;align-items:center;justify-content:center;flex-shrink:0;font-size:18px">🚂</div>
          <div style="flex:1">
            <div style="font-weight:700;font-size:13px">Railway Backend</div>
            <div style="font-size:11px;color:var(--muted)">Intent scoring · Scheduled jobs · GSC sync · Trend detection · Decision engine</div>
          </div>
          <div id="railway-badge" style="font-size:10px;font-weight:700;padding:3px 9px;border-radius:20px;background:rgba(255,85,85,0.12);color:var(--accent3)">NOT SET</div>
        </div>
        <input type="text" id="set-railway-url" placeholder="https://nicheforge-production.up.railway.app" style="font-family:'Courier New',monospace;font-size:11px;width:100%" oninput="saveRailwayUrl()">
        <div id="railway-test-result" style="font-size:11px;margin-top:8px;display:none"></div>
        <button class="btn btn-ghost" onclick="testRailwayConnection()" style="margin-top:10px;font-size:12px;width:100%">🔌 Test Backend</button>
      </div>

      <!-- ── API Keys Section ── -->
      <div style="font-size:11px;font-weight:700;text-transform:uppercase;letter-spacing:2px;color:var(--muted);margin-bottom:12px">API Keys</div>

      <!-- Gemini Key -->
      <div class="card" style="margin-bottom:14px;border:1px solid rgba(0,212,255,0.2);background:rgba(0,212,255,0.02)">
        <div style="display:flex;align-items:center;gap:10px;margin-bottom:12px">
          <div style="width:32px;height:32px;background:rgba(0,212,255,0.12);border-radius:8px;display:flex;align-items:center;justify-content:center;flex-shrink:0;font-size:16px">🔵</div>
          <div style="flex:1">
            <div style="font-weight:700;font-size:13px">Google Gemini API Key</div>
            <div style="font-size:11px;color:var(--muted)">Blog writer, SEO tools, keyword research — <strong style="color:#00e676">FREE</strong> tier 1,500/day</div>
          </div>
          <div id="apikey-status-badge" style="font-size:10px;font-weight:700;padding:3px 9px;border-radius:20px;background:rgba(255,85,85,0.12);color:var(--accent3)">NOT SET</div>
        </div>
        <div style="display:flex;gap:8px;align-items:center">
          <input type="password" id="set-apikey" placeholder="AIza..." oninput="saveApiKey()" style="flex:1;font-family:'Courier New',monospace;font-size:12px">
          <button class="btn btn-ghost" onclick="toggleApiKeyVisibility()" id="apikey-eye-btn" style="flex-shrink:0;padding:8px 10px">
            <svg id="eye-icon" width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg>
          </button>
          <button class="btn btn-ghost" onclick="testApiKey()" style="flex-shrink:0;font-size:12px">Test</button>
        </div>
        <div id="apikey-test-result" style="font-size:11px;margin-top:8px;display:none"></div>
        <div style="font-size:11px;color:var(--muted);margin-top:8px">Get free key → <a href="https://aistudio.google.com/app/apikey" target="_blank" style="color:var(--accent)">aistudio.google.com/app/apikey</a></div>
      </div>

      <!-- Claude Key -->
      <div class="card" style="margin-bottom:14px;border:1px solid rgba(180,79,255,0.2);background:rgba(180,79,255,0.02)">
        <div style="display:flex;align-items:center;gap:10px;margin-bottom:12px">
          <div style="width:32px;height:32px;background:rgba(180,79,255,0.12);border-radius:8px;display:flex;align-items:center;justify-content:center;flex-shrink:0;font-size:16px">🟣</div>
          <div style="flex:1">
            <div style="font-weight:700;font-size:13px">Anthropic Claude API Key</div>
            <div style="font-size:11px;color:var(--muted)">AI Builder (Prompt/URL/Template) — best site quality · ~$0.005/site</div>
          </div>
          <div id="claude-key-badge" style="font-size:10px;font-weight:700;padding:3px 9px;border-radius:20px;background:rgba(255,85,85,0.12);color:var(--accent3)">NOT SET</div>
        </div>
        <div style="display:flex;gap:8px;align-items:center">
          <input type="password" id="set-claude-key" placeholder="sk-ant-api03-..." style="flex:1;font-family:'Courier New',monospace;font-size:12px" oninput="saveClaudeKey()">
          <button class="btn btn-ghost" onclick="toggleClaudeKeyVisibility()" style="flex-shrink:0;padding:8px 10px">
            <svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg>
          </button>
        </div>
        <div style="font-size:11px;color:var(--muted);margin-top:8px">Get key → <a href="https://console.anthropic.com/settings/keys" target="_blank" style="color:var(--accent2)">console.anthropic.com/settings/keys</a> · Starts with sk-ant-</div>
      </div>

      <!-- OpenAI Key -->
      <div class="card" style="margin-bottom:20px;border:1px solid rgba(0,212,255,0.12);background:rgba(16,163,127,0.02)">
        <div style="display:flex;align-items:center;gap:10px;margin-bottom:12px">
          <div style="width:32px;height:32px;background:rgba(16,163,127,0.12);border-radius:8px;display:flex;align-items:center;justify-content:center;flex-shrink:0;font-size:16px">🟢</div>
          <div style="flex:1">
            <div style="font-weight:700;font-size:13px">OpenAI API Key</div>
            <div style="font-size:11px;color:var(--muted)">Image-to-Site (GPT-4o Vision) + AI Image Generator fallback</div>
          </div>
          <div id="openai-key-badge" style="font-size:10px;font-weight:700;padding:3px 9px;border-radius:20px;background:rgba(255,85,85,0.12);color:var(--accent3)">NOT SET</div>
        </div>
        <div style="display:flex;gap:8px;align-items:center">
          <input type="password" id="set-openai-key" placeholder="sk-..." style="flex:1;font-family:'Courier New',monospace;font-size:12px" oninput="saveOpenAIKeyFromSettings()">
          <button class="btn btn-ghost" onclick="toggleOpenAIKeyVisibility()" style="flex-shrink:0;padding:8px 10px">
            <svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg>
          </button>
        </div>
        <div style="font-size:11px;color:var(--muted);margin-top:8px">Get key → <a href="https://platform.openai.com/api-keys" target="_blank" style="color:#10a37f">platform.openai.com/api-keys</a> · Starts with sk-</div>
      </div>

      <!-- Global Logo -->
      <div class="card" style="margin-bottom:20px">
        <div class="card-title" style="margin-bottom:4px">Global Logo</div>
        <div style="font-size:12px;color:var(--muted);margin-bottom:20px">Uploaded once — auto-injected into every page NicheForge generates</div>

        <div style="display:grid;grid-template-columns:1fr 1fr;gap:20px;align-items:start">
          <div>
            <div style="font-size:12px;font-weight:600;margin-bottom:10px">Upload SVG or image</div>
            <label for="logo-file-upload" style="display:flex;flex-direction:column;align-items:center;justify-content:center;gap:10px;border:2px dashed var(--border);border-radius:12px;padding:28px;cursor:pointer;transition:border-color 0.2s;background:var(--surface2)" onmouseover="this.style.borderColor='rgba(0,212,255,0.4)'" onmouseout="this.style.borderColor='var(--border)'">
              <div style="width:52px;height:52px;background:rgba(255,255,255,0.03);border:1px solid var(--border);border-radius:12px;display:flex;align-items:center;justify-content:center;margin:0 auto 14px;color:var(--muted)"><svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"><path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"/></svg></div>
              <span style="font-size:13px;color:var(--muted)">Click to upload logo</span>
              <span style="font-size:11px;color:var(--muted)">SVG, PNG, JPG, WebP</span>
            </label>
            <input type="file" id="logo-file-upload" accept=".svg,.png,.jpg,.jpeg,.webp" style="display:none" onchange="handleLogoUpload(this,'global')">

            <div style="margin-top:12px">
              <div style="font-size:12px;font-weight:600;margin-bottom:6px">Or paste SVG code / URL</div>
              <textarea id="logo-code-input" rows="3" placeholder="Paste <svg>...</svg> code or https://your-logo-url.svg" style="font-size:11px;font-family:'Courier New',monospace"></textarea>
              <button class="btn btn-ghost" style="width:100%;margin-top:8px;font-size:12px" onclick="applyLogoFromCode()">Apply Logo Code</button>
            </div>
          </div>

          <div>
            <div style="font-size:12px;font-weight:600;margin-bottom:10px">Preview</div>
            <div id="global-logo-preview" style="background:var(--surface2);border:1px solid var(--border);border-radius:10px;padding:24px;min-height:120px;display:flex;align-items:center;justify-content:center">
              <div style="color:var(--muted);font-size:12px;text-align:center">No logo uploaded yet</div>
            </div>
            <div id="global-logo-actions" style="display:none;margin-top:10px;display:none;gap:8px">
              <button class="btn btn-ghost" style="flex:1;font-size:11px" onclick="copyLogoCode()">Copy Code</button>
              <button class="btn btn-ghost" style="flex:1;font-size:11px;color:var(--accent3)" onclick="clearGlobalLogo()">🗑 Remove</button>
            </div>
            <div id="global-logo-meta" style="font-size:11px;color:var(--muted);margin-top:8px"></div>
          </div>
        </div>
      </div>

      <!-- Per-site logos -->
      <div class="card" style="margin-bottom:20px">
        <div class="card-title" style="margin-bottom:4px">Per-Site Logo Override</div>
        <div style="font-size:12px;color:var(--muted);margin-bottom:20px">Override the global logo for a specific site. Leave blank to use the global default.</div>

        <div style="display:flex;flex-direction:column;gap:16px" id="site-logo-list">
          <!-- rendered by JS -->
        </div>
      </div>

      <!-- Brand Settings -->
      <div class="card" style="margin-bottom:20px">
        <div class="card-title" style="margin-bottom:16px">Default Brand Settings</div>
        <div class="form-grid">
          <div class="form-group">
            <label>Business Name</label>
            <input type="text" id="set-bizname" placeholder="e.g. FixMyHive" oninput="saveSettings()">
          </div>
          <div class="form-group">
            <label>Phone Number</label>
            <input type="text" id="set-phone" placeholder="e.g. +974 7783 9040" oninput="saveSettings()">
          </div>
          <div class="form-group">
            <label>WhatsApp Number</label>
            <input type="text" id="set-wa" placeholder="e.g. 97477839040 (no +)" oninput="saveSettings()">
          </div>
          <div class="form-group">
            <label>Email</label>
            <input type="text" id="set-email" placeholder="e.g. info@fixmyhive.com" oninput="saveSettings()">
          </div>
          <div class="form-group">
            <label>Default City / Location</label>
            <input type="text" id="set-city" placeholder="e.g. Doha, Qatar" oninput="saveSettings()">
          </div>
          <div class="form-group">
            <label>Google Analytics 4 ID</label>
            <input type="text" id="set-ga4" placeholder="e.g. G-XXXXXXXXXX" oninput="saveSettings()">
          </div>
          <div class="form-group">
            <label>AdSense Publisher ID</label>
            <input type="text" id="set-adsense" placeholder="e.g. ca-pub-XXXXXXXXXXXXXXXX" oninput="saveSettings()">
          </div>
          <div class="form-group">
            <label>Default Color Accent</label>
            <input type="color" id="set-color" value="#00e5a0" oninput="saveSettings()" style="height:40px;padding:4px 8px">
          </div>
        </div>
        <div style="font-size:11px;color:var(--accent);margin-top:4px">✓ Settings auto-save as you type — injected into every page NicheForge generates</div>
      </div>

      <!-- Booking embed code -->
      <div class="card">
        <div class="card-title" style="margin-bottom:4px">Booking Form Embed</div>
        <div style="font-size:12px;color:var(--muted);margin-bottom:16px">Paste this snippet into any page to embed a booking form that saves directly to your NicheForge CRM</div>
        <div style="background:var(--surface2);border:1px solid var(--border);border-radius:8px;padding:14px;font-family:'Courier New',monospace;font-size:11px;color:#a8d8a8;line-height:1.6;white-space:pre" id="booking-embed-code"></div>
        <button class="btn btn-ghost" style="margin-top:10px;font-size:12px" onclick="copyEmbedCode()">Copy Embed Code</button>
      </div>
    </div>


    <!-- ===== THEME STORE ===== -->
    <div class="panel" id="panel-themes">
      <!-- Header -->
      <div style="display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:12px;margin-bottom:24px">
        <div>
          <div class="section-label">Theme Store</div>
          <div class="hero-heading" style="font-size:clamp(24px,4vw,36px)">Choose Your <span class="highlight">Perfect Theme</span></div>
          <div style="color:var(--muted);font-size:13px;margin-top:6px;font-family:'Inter',sans-serif">Professional site themes — AI-powered, deploy-ready</div>
        </div>
        <div style="display:flex;gap:8px;flex-wrap:wrap">
          <input type="text" placeholder="Search themes…" style="background:var(--surface2);border:1px solid var(--border);border-radius:8px;padding:8px 14px;color:var(--text);font-family:'Inter',sans-serif;font-size:12.5px;width:200px" oninput="filterThemes(this.value)">
          <button class="btn btn-primary" onclick="showPanel('create',null)">
            <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
            Build Custom
          </button>
        </div>
      </div>

      <!-- Filter pills -->
      <div style="display:flex;gap:8px;flex-wrap:wrap;margin-bottom:20px" id="theme-filter-row">
        <button class="filter-pill active" data-filter="all" onclick="setThemeFilter('all', this)">All Themes</button>
        <button class="filter-pill" data-filter="local" onclick="setThemeFilter('local', this)">Local Service</button>
        <button class="filter-pill" data-filter="niche" onclick="setThemeFilter('niche', this)">Niche Blog</button>
        <button class="filter-pill" data-filter="ecommerce" onclick="setThemeFilter('ecommerce', this)">E-commerce</button>
        <button class="filter-pill" data-filter="saas" onclick="setThemeFilter('saas', this)">SaaS / Landing</button>
        <button class="filter-pill" data-filter="portfolio" onclick="setThemeFilter('portfolio', this)">Portfolio</button>
        <button class="filter-pill" data-filter="directory" onclick="setThemeFilter('directory', this)">Directory</button>
      </div>

      <!-- Stats row -->
      <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:12px;margin-bottom:24px">
        <div class="stat-card"><div class="stat-label" style="font-family:'Inter',sans-serif">Total Themes</div><div class="stat-value" style="color:var(--accent)">24</div><div class="stat-sub">Ready to deploy</div></div>
        <div class="stat-card"><div class="stat-label">AI-Generated</div><div class="stat-value" style="color:var(--accent2)">∞</div><div class="stat-sub">Custom on demand</div></div>
        <div class="stat-card"><div class="stat-label">Categories</div><div class="stat-value" style="color:#f59e0b">6</div><div class="stat-sub">Niches covered</div></div>
        <div class="stat-card"><div class="stat-label">Avg Build Time</div><div class="stat-value" style="color:#7dd3fc">~30s</div><div class="stat-sub">With AI generation</div></div>
      </div>

      <!-- Theme grid -->
      <div class="theme-grid" id="theme-grid">

        <div class="theme-card" data-category="local" data-name="Apex Local Service">
          <div class="theme-preview" style="background:linear-gradient(135deg,#0d1b2a 0%,#1a3a5c 60%,#0d2b1a 100%)">
            <div style="position:absolute;inset:0;display:flex;align-items:center;justify-content:center;flex-direction:column;gap:6px;padding:16px">
              <div class="theme-preview-title" style="letter-spacing:5px">APEX</div>
              <div class="theme-preview-divider"></div>
              <div class="theme-preview-sub">Local Service</div>
            </div>
            <button class="btn-cta-purple theme-overlay-btn" style="font-size:12px;padding:10px 20px" onclick="buildWithTheme('Apex Local Service','local')">Use This Theme</button>
          </div>
          <div class="theme-info">
            <div class="theme-name">Apex Local Service</div>
            <div class="theme-category">Local Business</div>
            <div class="theme-tags">
              <span class="theme-tag accent">SEO-Ready</span>
              <span class="theme-tag purple">AdSense</span>
              <span class="theme-tag">Bookings</span>
              <span class="theme-tag">Schema</span>
            </div>
          </div>
        </div>

        <div class="theme-card" data-category="niche" data-name="Forge Blog">
          <div class="theme-preview" style="background:linear-gradient(135deg,#1a0a2e 0%,#2d1b69 60%,#0a0a1a 100%)">
            <div style="position:absolute;inset:0;display:flex;align-items:center;justify-content:center;flex-direction:column;gap:6px;padding:16px">
              <div class="theme-preview-title" style="letter-spacing:6px">FORGE</div>
              <div class="theme-preview-divider" style="background:linear-gradient(90deg,var(--accent2),#ff6b9d)"></div>
              <div class="theme-preview-sub">Niche Blog · Dark</div>
            </div>
            <button class="btn-cta-purple theme-overlay-btn" style="font-size:12px;padding:10px 20px" onclick="buildWithTheme('Forge Blog','niche')">Use This Theme</button>
          </div>
          <div class="theme-info">
            <div class="theme-name">Forge Blog</div>
            <div class="theme-category">Niche Blog</div>
            <div class="theme-tags">
              <span class="theme-tag accent">SEO-Ready</span>
              <span class="theme-tag purple">AdSense</span>
              <span class="theme-tag">Featured Posts</span>
            </div>
          </div>
        </div>

        <div class="theme-card" data-category="local" data-name="TradesPro">
          <div class="theme-preview" style="background:linear-gradient(135deg,#0f2027 0%,#203a43 50%,#2c5364 100%)">
            <div style="position:absolute;inset:0;display:flex;align-items:center;justify-content:center;flex-direction:column;gap:6px;padding:16px">
              <div style="width:44px;height:44px;background:rgba(0,212,255,0.12);border:1px solid rgba(0,212,255,0.25);border-radius:50%;display:flex;align-items:center;justify-content:center;margin-bottom:10px">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="var(--accent)" stroke-width="2"><path d="M14.7 6.3a1 1 0 0 0 0 1.4l1.6 1.6a1 1 0 0 0 1.4 0l3.77-3.77a6 6 0 0 1-7.94 7.94l-6.91 6.91a2.12 2.12 0 0 1-3-3l6.91-6.91a6 6 0 0 1 7.94-7.94l-3.76 3.76z"/></svg>
              </div>
              <div class="theme-preview-title" style="font-size:28px;letter-spacing:3px">TradesPro</div>
              <div class="theme-preview-sub">Trades & Home Services</div>
            </div>
            <button class="btn-cta-purple theme-overlay-btn" style="font-size:12px;padding:10px 20px" onclick="buildWithTheme('TradesPro','local')">Use This Theme</button>
          </div>
          <div class="theme-info">
            <div class="theme-name">TradesPro</div>
            <div class="theme-category">Trades & Contractors</div>
            <div class="theme-tags">
              <span class="theme-tag accent">Local SEO</span>
              <span class="theme-tag">Reviews</span>
              <span class="theme-tag purple">CTA Optimised</span>
            </div>
          </div>
        </div>

        <div class="theme-card" data-category="ecommerce" data-name="Storefront X">
          <div class="theme-preview" style="background:linear-gradient(135deg,#1a0505 0%,#3d1a1a 50%,#2a0a2a 100%)">
            <div style="position:absolute;inset:0;display:flex;align-items:center;justify-content:center;flex-direction:column;gap:6px;padding:16px">
              <div class="theme-preview-title" style="letter-spacing:5px">STOREFRONT X</div>
              <div class="theme-preview-divider" style="background:linear-gradient(90deg,var(--accent3),#ff8c69)"></div>
              <div class="theme-preview-sub">E-Commerce</div>
            </div>
            <button class="btn-cta-purple theme-overlay-btn" style="font-size:12px;padding:10px 20px" onclick="buildWithTheme('Storefront X','ecommerce')">Use This Theme</button>
          </div>
          <div class="theme-info">
            <div class="theme-name">Storefront X</div>
            <div class="theme-category">E-commerce</div>
            <div class="theme-tags">
              <span class="theme-tag">Product Grid</span>
              <span class="theme-tag accent">Fast Load</span>
              <span class="theme-tag">Cart Ready</span>
            </div>
          </div>
        </div>

        <div class="theme-card" data-category="saas" data-name="LaunchPad SaaS">
          <div class="theme-preview" style="background:linear-gradient(135deg,#050a14 0%,#0d1f3c 50%,#122040 100%)">
            <div style="position:absolute;inset:0;display:flex;align-items:center;justify-content:center;flex-direction:column;gap:6px;padding:16px">
              <div style="display:flex;align-items:center;gap:8px;margin-bottom:4px">
                <div style="width:24px;height:24px;background:linear-gradient(135deg,var(--accent),var(--accent2));border-radius:6px"></div>
                <div style="font-family:'Syne',sans-serif;font-size:14px;font-weight:800;color:#fff">LaunchPad</div>
              </div>
              <div style="font-size:9px;color:rgba(255,255,255,0.4);text-transform:uppercase;letter-spacing:2px">SaaS Landing Page</div>
              <div style="width:80%;height:24px;background:linear-gradient(90deg,rgba(0,212,255,0.2),rgba(180,79,255,0.2));border-radius:6px;margin-top:6px;border:1px solid rgba(255,255,255,0.06)"></div>
            </div>
            <button class="btn-cta-purple theme-overlay-btn" style="font-size:12px;padding:10px 20px" onclick="buildWithTheme('LaunchPad SaaS','saas')">Use This Theme</button>
          </div>
          <div class="theme-info">
            <div class="theme-name">LaunchPad SaaS</div>
            <div class="theme-category">SaaS / Startup</div>
            <div class="theme-tags">
              <span class="theme-tag purple">Pricing Table</span>
              <span class="theme-tag accent">Conversion</span>
              <span class="theme-tag">Dark Mode</span>
            </div>
          </div>
        </div>

        <div class="theme-card" data-category="portfolio" data-name="Folio Minimal">
          <div class="theme-preview" style="background:linear-gradient(135deg,#0a0a0a 0%,#1a1a1a 100%)">
            <div style="position:absolute;inset:0;display:flex;align-items:center;justify-content:center;flex-direction:column;gap:8px;padding:16px">
              <div class="theme-preview-title" style="font-size:52px;letter-spacing:10px;color:rgba(255,255,255,0.85)">FOLIO</div>
              <div class="theme-preview-sub" style="letter-spacing:6px">Minimal Portfolio</div>
            </div>
            <button class="btn-cta-purple theme-overlay-btn" style="font-size:12px;padding:10px 20px" onclick="buildWithTheme('Folio Minimal','portfolio')">Use This Theme</button>
          </div>
          <div class="theme-info">
            <div class="theme-name">Folio Minimal</div>
            <div class="theme-category">Portfolio / Creative</div>
            <div class="theme-tags">
              <span class="theme-tag">Gallery</span>
              <span class="theme-tag">Contact Form</span>
              <span class="theme-tag accent">Ultra Clean</span>
            </div>
          </div>
        </div>

        <div class="theme-card" data-category="directory" data-name="DirectoryPro">
          <div class="theme-preview" style="background:linear-gradient(135deg,#0a1520 0%,#152030 50%,#1a2a10 100%)">
            <div style="position:absolute;inset:0;display:flex;align-items:center;justify-content:center;flex-direction:column;gap:6px;padding:16px">
              <div style="margin-bottom:10px;color:var(--accent)"><svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg></div>
              <div class="theme-preview-title" style="font-size:28px;letter-spacing:4px">DirectoryPro</div>
              <div class="theme-preview-sub">Business Directory</div>
            </div>
            <button class="btn-cta-purple theme-overlay-btn" style="font-size:12px;padding:10px 20px" onclick="buildWithTheme('DirectoryPro','directory')">Use This Theme</button>
          </div>
          <div class="theme-info">
            <div class="theme-name">DirectoryPro</div>
            <div class="theme-category">Business Directory</div>
            <div class="theme-tags">
              <span class="theme-tag accent">Local SEO</span>
              <span class="theme-tag">Search</span>
              <span class="theme-tag purple">Listings</span>
            </div>
          </div>
        </div>

        <div class="theme-card" data-category="niche" data-name="NicheMag">
          <div class="theme-preview" style="background:linear-gradient(135deg,#100a20 0%,#1e1040 100%)">
            <div style="position:absolute;inset:0;display:flex;align-items:center;justify-content:center;flex-direction:column;gap:6px;padding:16px">
              <div class="theme-preview-title" style="font-size:38px;letter-spacing:8px">NICHEMAG</div>
              <div class="theme-preview-divider" style="background:linear-gradient(90deg,var(--accent),var(--accent2));margin:8px auto"></div>
              <div class="theme-preview-sub" style="letter-spacing:4px">Magazine · Multi-Post</div>
            </div>
            <button class="btn-cta-purple theme-overlay-btn" style="font-size:12px;padding:10px 20px" onclick="buildWithTheme('NicheMag','niche')">Use This Theme</button>
          </div>
          <div class="theme-info">
            <div class="theme-name">NicheMag</div>
            <div class="theme-category">Magazine / Multi-post</div>
            <div class="theme-tags">
              <span class="theme-tag purple">Category Pages</span>
              <span class="theme-tag accent">AdSense</span>
              <span class="theme-tag">Newsletter</span>
            </div>
          </div>
        </div>

        <div class="theme-card" data-category="local" data-name="ServiceHub">
          <div class="theme-preview" style="background:linear-gradient(135deg,#0f1a10 0%,#1a3020 50%,#0a1510 100%)">
            <div style="position:absolute;inset:0;display:flex;align-items:center;justify-content:center;flex-direction:column;gap:6px;padding:16px">
              <div style="width:44px;height:44px;background:rgba(0,212,255,0.1);border:1px solid rgba(0,212,255,0.2);border-radius:10px;display:flex;align-items:center;justify-content:center;margin-bottom:10px">
                <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="var(--accent)" stroke-width="1.8"><rect x="2" y="3" width="20" height="14" rx="2"/><line x1="8" y1="21" x2="16" y2="21"/><line x1="12" y1="17" x2="12" y2="21"/></svg>
              </div>
              <div class="theme-preview-title" style="font-size:28px;letter-spacing:3px">ServiceHub</div>
              <div class="theme-preview-sub">Professional Services</div>
            </div>
            <button class="btn-cta-purple theme-overlay-btn" style="font-size:12px;padding:10px 20px" onclick="buildWithTheme('ServiceHub','local')">Use This Theme</button>
          </div>
          <div class="theme-info">
            <div class="theme-name">ServiceHub</div>
            <div class="theme-category">Professional Services</div>
            <div class="theme-tags">
              <span class="theme-tag accent">Testimonials</span>
              <span class="theme-tag">FAQ Schema</span>
              <span class="theme-tag purple">Contact</span>
            </div>
          </div>
        </div>

      </div><!-- /theme-grid -->

      <!-- CTA section -->
      <div style="background:linear-gradient(135deg,rgba(0,212,255,0.06),rgba(180,79,255,0.06));border:1px solid rgba(0,212,255,0.15);border-radius:14px;padding:28px;text-align:center">
        <div style="font-family:'Syne',sans-serif;font-size:18px;font-weight:800;margin-bottom:8px">Need a Custom Theme?</div>
        <div style="color:var(--muted);font-size:13px;margin-bottom:18px;max-width:400px;margin-left:auto;margin-right:auto">Describe your niche and NicheForge AI will generate a completely unique theme tailored to your exact requirements.</div>
        <button class="btn btn-primary" style="font-size:13px;padding:10px 24px" onclick="showPanel('create',null)">
          <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M13 2L3 14h9l-1 8 10-12h-9l1-8z"/></svg>
          Generate Custom Theme with AI
        </button>
      </div>

    </div><!-- /panel-themes -->
    <!-- ============================================================ -->
    <!-- AI BUILDER PANEL                                              -->
    <!-- ============================================================ -->
    <div class="panel" id="panel-builder">
      <!-- ══════════════════════════════════════════════════════════
           CINEMATIC HERO — Full-width mode selector
           ══════════════════════════════════════════════════════════ -->
      <div id="builder-hero" style="text-align:center;margin-bottom:36px">
        <div class="section-label" style="justify-content:center;margin-bottom:10px">AI Website Builder</div>
        <h1 style="font-family:var(--font-heading);font-size:clamp(28px,4vw,48px);font-weight:800;letter-spacing:-1px;margin-bottom:10px;line-height:1.1">
          Build Any Site.<br><span style="background:var(--grad-text);-webkit-background-clip:text;-webkit-text-fill-color:transparent">4 Powerful Ways.</span>
        </h1>
        <p style="color:var(--muted);font-size:14px;max-width:500px;margin:0 auto">Claude Sonnet · GPT-4o Vision · Pollinations AI · Zero coding required</p>
      </div>

      <!-- ── MODE CARDS (big clickable cards like app icons) ── -->
      <div id="builder-mode-cards" id="builder-mode-cards">

        <div class="bmode-card active" onclick="switchBuilderMode('prompt',this)" data-mode="prompt">
          <div class="bmode-card-icon">
            <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg>
          </div>
          <div class="bmode-card-label">From Prompt</div>
          <div class="bmode-card-sub">Describe it, AI builds it</div>
        </div>

        <div class="bmode-card" onclick="switchBuilderMode('url',this)" data-mode="url">
          <div class="bmode-card-icon" style="background:rgba(180,79,255,0.12);border-color:rgba(180,79,255,0.2);color:var(--accent2)">
            <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><circle cx="12" cy="12" r="10"/><line x1="2" y1="12" x2="22" y2="12"/><path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"/></svg>
          </div>
          <div class="bmode-card-label">From URL</div>
          <div class="bmode-card-sub">Clone &amp; redesign any site</div>
          <span class="bmode-badge" style="background:var(--accent2)">NEW</span>
        </div>

        <div class="bmode-card" onclick="switchBuilderMode('image',this)" data-mode="image">
          <div class="bmode-card-icon" style="background:rgba(255,85,128,0.12);border-color:rgba(255,85,128,0.2);color:var(--accent3)">
            <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><rect x="3" y="3" width="18" height="18" rx="2"/><circle cx="8.5" cy="8.5" r="1.5"/><polyline points="21 15 16 10 5 21"/></svg>
          </div>
          <div class="bmode-card-label">From Image</div>
          <div class="bmode-card-sub">Screenshot → live site</div>
          <span class="bmode-badge" style="background:var(--accent3)">GPT-4o</span>
        </div>

        <div class="bmode-card" onclick="switchBuilderMode('template',this)" data-mode="template">
          <div class="bmode-card-icon" style="background:rgba(245,197,66,0.12);border-color:rgba(245,197,66,0.2);color:var(--gold)">
            <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><rect x="3" y="3" width="18" height="18" rx="2"/><path d="M3 9h18M9 21V9"/></svg>
          </div>
          <div class="bmode-card-label">Template</div>
          <div class="bmode-card-sub">12 pro starting points</div>
        </div>

      </div>

      <!-- ══════════════════════════════════════════════════════════
           CINEMATIC INPUT ARENAS — one per mode
           ══════════════════════════════════════════════════════════ -->

      <!-- ── PROMPT ARENA ── -->
      <div id="arena-prompt" class="builder-arena" style="max-width:900px;margin:0 auto">
        <div class="arena-canvas" id="arena-canvas-prompt">
          <canvas class="arena-stars" id="stars-prompt"></canvas>
          <div class="arena-inner">
            <div class="arena-badge">PROMPT-TO-SITE</div>
            <div class="arena-title">What site do you need?</div>
            <div class="arena-subtitle">Describe your business in plain English — AI does the rest</div>

            <div style="width:100%;max-width:640px;margin:0 auto">
              <textarea id="b-prompt-main" class="arena-input" rows="3" placeholder="e.g. A premium plumbing service in Houston TX called Mike's Plumbing. We handle emergency repairs, water heaters and leak fixes. Serve homeowners 30-60."></textarea>

              <!-- Inline options row -->
              <div class="arena-options-row">
                <select class="arena-select" id="b-type">
                  <option>Local Service</option><option>Niche Blog</option><option>E-Commerce</option>
                  <option>SaaS / Startup</option><option>Portfolio</option><option>Restaurant</option>
                  <option>Real Estate</option><option>Medical / Clinic</option><option>Law Firm</option>
                  <option>Fitness / Gym</option><option>Education</option><option>Event / Wedding</option>
                  <option>Non-Profit</option><option>Landing Page</option>
                </select>
                <select class="arena-select" id="b-color">
                  <option value="professional dark">Dark Premium</option>
                  <option value="clean white minimal">Clean White</option>
                  <option value="bold vibrant">Bold Vibrant</option>
                  <option value="luxury gold black">Luxury Gold</option>
                  <option value="tech neon cyan">Tech Neon</option>
                  <option value="nature green">Nature Green</option>
                  <option value="rose pink feminine">Rose Pink</option>
                  <option value="corporate navy">Corporate Navy</option>
                </select>
                <select class="arena-select" id="b-lang">
                  <option value="English">🇬🇧 English</option><option value="Spanish">🇪🇸 Spanish</option>
                  <option value="French">🇫🇷 French</option><option value="German">🇩🇪 German</option>
                  <option value="Arabic">🇸🇦 Arabic</option><option value="Hindi">🇮🇳 Hindi</option>
                  <option value="Urdu">🇵🇰 Urdu</option><option value="Portuguese">🇧🇷 Portuguese</option>
                  <option value="Chinese">🇨🇳 Chinese</option><option value="Japanese">🇯🇵 Japanese</option>
                </select>
                <select class="arena-select" id="b-engine">
                  <option value="claude">Claude Sonnet 4.5</option>
                  <option value="openai">GPT-4o</option>
                  <option value="gemini">Gemini Flash (Free)</option>
                </select>
              </div>

              <!-- Section chips -->
              <div style="display:flex;flex-wrap:wrap;gap:6px;justify-content:center;margin-bottom:20px" id="b-sections">
                <label class="section-toggle"><input type="checkbox" value="hero" checked> Hero</label>
                <label class="section-toggle"><input type="checkbox" value="services" checked> Services</label>
                <label class="section-toggle"><input type="checkbox" value="about" checked> About</label>
                <label class="section-toggle"><input type="checkbox" value="testimonials" checked> Reviews</label>
                <label class="section-toggle"><input type="checkbox" value="pricing"> Pricing</label>
                <label class="section-toggle"><input type="checkbox" value="faq" checked> FAQ</label>
                <label class="section-toggle"><input type="checkbox" value="contact" checked> Contact</label>
                <label class="section-toggle"><input type="checkbox" value="gallery"> Gallery</label>
                <label class="section-toggle"><input type="checkbox" value="blog"> Blog</label>
                <label class="section-toggle"><input type="checkbox" value="team"> Team</label>
              </div>

              <button class="arena-generate-btn" onclick="runBuilder()" id="b-generate-btn">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/></svg>
                Generate Site with AI
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- ── URL ARENA ── -->
      <div id="arena-url" class="builder-arena" style="display:none;max-width:900px;margin:0 auto">
        <div class="arena-canvas" id="arena-canvas-url" style="background:linear-gradient(135deg,#0a0520 0%,#100a30 50%,#0a0a20 100%)">
          <canvas class="arena-stars" id="stars-url"></canvas>
          <div class="arena-inner">
            <div class="arena-badge" style="border-color:rgba(180,79,255,0.4);color:var(--accent2)">URL-TO-DESIGN</div>
            <div class="arena-title">Clone &amp; Redesign Any Website</div>
            <div class="arena-subtitle">Paste any URL — AI extracts content and rebuilds with a stunning new design</div>

            <div style="width:100%;max-width:600px;margin:0 auto">
              <div class="arena-url-input-wrap">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="var(--muted)" stroke-width="2" style="flex-shrink:0"><circle cx="12" cy="12" r="10"/><line x1="2" y1="12" x2="22" y2="12"/><path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"/></svg>
                <input type="url" id="b-url" class="arena-url-field" placeholder="Enter your website URL...">
                <button class="arena-url-btn" onclick="runBuilder()">Generate Site</button>
              </div>

              <div class="arena-options-row" style="margin-top:14px">
                <select class="arena-select" id="b-url-preserve" style="border-color:rgba(180,79,255,0.2)">
                  <option>Preserve all content</option>
                  <option>Content only (new layout)</option>
                  <option>Structure only</option>
                  <option>Brand only</option>
                </select>
                <select class="arena-select" id="b-url-style" style="border-color:rgba(180,79,255,0.2)">
                  <option>Modern Dark Premium</option>
                  <option>Clean White Minimal</option>
                  <option>Bold & Colorful</option>
                  <option>Corporate Pro</option>
                  <option>Luxury High-End</option>
                </select>
                <select class="arena-select" id="b-url-lang" style="border-color:rgba(180,79,255,0.2)">
                  <option>English</option><option>Spanish</option><option>French</option>
                  <option>Arabic</option><option>Urdu</option><option>Hindi</option>
                </select>
              </div>

              <div style="display:flex;gap:16px;justify-content:center;margin-top:20px;font-size:11px;color:rgba(180,79,255,0.6)">
                <span>✦ Fetches via CORS proxy</span>
                <span>✦ Preserves your content</span>
                <span>✦ Fresh modern design</span>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- ── IMAGE ARENA ── -->
      <div id="arena-image" class="builder-arena" style="display:none;max-width:900px;margin:0 auto">
        <div class="arena-canvas" style="background:linear-gradient(135deg,#1a0520 0%,#200a30 50%,#0a0520 100%)">
          <canvas class="arena-stars" id="stars-image"></canvas>
          <div class="arena-inner">
            <div class="arena-badge" style="border-color:rgba(255,85,128,0.4);color:var(--accent3)">SCREENSHOT-TO-SITE</div>
            <div class="arena-title">Convert Any Screenshot to a Site</div>
            <div class="arena-subtitle">GPT-4o Vision reads your screenshot — Claude builds the HTML</div>

            <div style="width:100%;max-width:600px;margin:0 auto">
              <!-- Drop zone -->
              <div id="b-img-drop" onclick="document.getElementById('b-img-input').click()"
                style="border:2px dashed rgba(255,85,128,0.3);border-radius:16px;padding:40px 20px;text-align:center;cursor:pointer;transition:all 0.25s;background:rgba(255,85,128,0.03);margin-bottom:14px"
                ondragover="event.preventDefault();this.style.borderColor='var(--accent3)'"
                ondrop="handleImgDrop(event)">
                <div style="font-size:48px;margin-bottom:10px;filter:drop-shadow(0 0 16px rgba(255,85,128,0.4))">📸</div>
                <div style="font-weight:700;font-size:15px;margin-bottom:4px">Drop your screenshot here</div>
                <div style="color:var(--muted);font-size:12px">or click to browse · PNG, JPG, WebP · Any size</div>
                <input type="file" id="b-img-input" accept="image/*" style="display:none" onchange="handleBuilderImage(this)">
              </div>

              <div id="b-img-preview" style="display:none;border-radius:12px;overflow:hidden;border:1px solid rgba(255,85,128,0.2);margin-bottom:14px">
                <img id="b-img-thumb" style="width:100%;max-height:180px;object-fit:cover">
                <div style="padding:8px 14px;display:flex;align-items:center;justify-content:space-between;background:rgba(255,85,128,0.05)">
                  <span id="b-img-name" style="font-size:12px;color:var(--muted)"></span>
                  <button onclick="clearBuilderImage()" style="background:none;border:none;color:var(--accent3);cursor:pointer;font-size:12px;font-family:var(--font-body)">✕ Remove</button>
                </div>
              </div>

              <div class="arena-options-row">
                <select class="arena-select" id="b-img-style" style="border-color:rgba(255,85,128,0.2)">
                  <option>Pixel-perfect recreation</option>
                  <option>Same layout, modern redesign</option>
                  <option>Same content, new design</option>
                </select>
                <input type="text" id="b-img-notes" class="arena-select" placeholder="Extra notes (optional)...">
              </div>

              <button class="arena-generate-btn" onclick="runBuilder()" style="background:linear-gradient(135deg,var(--accent3),#b44fff);box-shadow:0 0 30px rgba(255,85,128,0.25)">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/></svg>
                Convert Screenshot to Site
              </button>

              <div style="text-align:center;margin-top:10px;font-size:11px;color:rgba(255,85,128,0.5)">
                Powered by GPT-4o Vision + Claude Sonnet 4.5
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- ── TEMPLATE ARENA ── -->
      <div id="arena-template" class="builder-arena" style="display:none;max-width:900px;margin:0 auto">
        <div class="arena-canvas" style="background:linear-gradient(135deg,#1a1200 0%,#2d1e00 50%,#1a1000 100%)">
          <canvas class="arena-stars" id="stars-template"></canvas>
          <div class="arena-inner">
            <div class="arena-badge" style="border-color:rgba(245,197,66,0.4);color:var(--gold)">TEMPLATE-TO-SITE</div>
            <div class="arena-title">Start from a Pro Template</div>
            <div class="arena-subtitle">12 professionally designed starting points — AI personalises for your brand</div>

            <div style="width:100%;max-width:680px;margin:0 auto">
              <div id="template-grid" style="display:grid;grid-template-columns:repeat(4,1fr);gap:8px;margin-bottom:16px"></div>

              <div class="arena-options-row">
                <input type="text" id="b-tmpl-brand" class="arena-select" placeholder="Your brand name...">
                <select class="arena-select" id="b-tmpl-lang">
                  <option>English</option><option>Spanish</option><option>French</option>
                  <option>Arabic</option><option>Urdu</option><option>Hindi</option>
                </select>
              </div>

              <button class="arena-generate-btn" onclick="runBuilder()" style="background:linear-gradient(135deg,#f5c542,#ff9500);color:#000;box-shadow:0 0 30px rgba(245,197,66,0.25)">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/></svg>
                Build from Template
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- ══════════════════════════════════════════════════════════
           GENERATION STATE + LIVE PREVIEW (full-width)
           ══════════════════════════════════════════════════════════ -->
      <div id="builder-output" style="display:none;max-width:1200px;margin:24px auto 0">

        <!-- Progress bar (shows during generation) -->
        <div id="b-generating" style="display:none">
          <div style="background:var(--surface2);border:1px solid var(--border);border-radius:16px;padding:40px;text-align:center;margin-bottom:20px">
            <div style="position:relative;width:80px;height:80px;margin:0 auto 20px">
              <svg width="80" height="80" viewBox="0 0 80 80" style="animation:spin 2s linear infinite;position:absolute;top:0;left:0">
                <circle cx="40" cy="40" r="36" fill="none" stroke="var(--border)" stroke-width="4"/>
                <circle cx="40" cy="40" r="36" fill="none" stroke="url(#gen-grad)" stroke-width="4" stroke-linecap="round" stroke-dasharray="80 146"/>
                <defs><linearGradient id="gen-grad" x1="0%" y1="0%" x2="100%" y2="0%"><stop offset="0%" stop-color="var(--accent)"/><stop offset="100%" stop-color="var(--accent2)"/></linearGradient></defs>
              </svg>
              <div style="position:absolute;inset:0;display:flex;align-items:center;justify-content:center;font-size:28px">⚡</div>
            </div>
            <div style="font-family:var(--font-heading);font-size:22px;font-weight:800;margin-bottom:6px" id="b-gen-status">Building your site...</div>
            <div style="color:var(--muted);font-size:13px;margin-bottom:20px" id="b-gen-sub">Claude is writing your HTML, CSS and content</div>
            <div style="max-width:400px;margin:0 auto;height:6px;background:var(--border);border-radius:3px;overflow:hidden">
              <div id="b-gen-bar" style="height:100%;width:0%;background:linear-gradient(90deg,var(--accent),var(--accent2),var(--accent3));border-radius:3px;transition:width 0.6s ease"></div>
            </div>
          </div>
        </div>

        <!-- Live preview area -->
        <div id="b-preview-wrap" style="display:none">
          <!-- Toolbar -->
          <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:12px;flex-wrap:wrap;gap:10px">
            <div style="display:flex;align-items:center;gap:8px">
              <div style="width:10px;height:10px;border-radius:50%;background:#ff5f57"></div>
              <div style="width:10px;height:10px;border-radius:50%;background:#febc2e"></div>
              <div style="width:10px;height:10px;border-radius:50%;background:#28c840"></div>
              <div style="margin-left:8px;font-size:12px;color:var(--muted)">Live Preview</div>
            </div>
            <div style="display:flex;align-items:center;gap:6px;background:var(--surface2);border:1px solid var(--border);border-radius:8px;padding:4px 8px;flex:1;max-width:400px">
              <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="var(--muted)" stroke-width="2"><circle cx="12" cy="12" r="10"/></svg>
              <span id="b-preview-url" style="font-size:11px;color:var(--muted);flex:1">preview://generated-site.html</span>
            </div>
            <div style="display:flex;gap:6px">
              <button onclick="setPreviewSize('desktop',this)" class="preview-size-btn active">🖥</button>
              <button onclick="setPreviewSize('tablet',this)" class="preview-size-btn">⬜</button>
              <button onclick="setPreviewSize('mobile',this)" class="preview-size-btn">📲</button>
              <button onclick="downloadBuilderHTML()" class="btn btn-sm" id="b-download-btn">⬇ Download</button>
              <button onclick="copyBuilderHTML()" class="btn btn-sm" id="b-copy-btn">📋 Copy</button>
              <button onclick="clearBuilder()" class="btn btn-sm" style="color:var(--muted)" id="b-clear-btn">✕ New</button>
            </div>
          </div>

          <!-- Split: preview + chat editor -->
          <div style="display:grid;grid-template-columns:1fr 340px;gap:16px;align-items:start">

            <!-- iFrame -->
            <div style="border-radius:14px;overflow:hidden;border:1px solid var(--border);background:var(--surface2)">
              <iframe id="b-preview-frame" style="width:100%;height:680px;border:none;transition:all 0.3s ease" sandbox="allow-scripts allow-same-origin"></iframe>
            </div>

            <!-- AI Chat Editor sidebar -->
            <div style="display:flex;flex-direction:column;gap:12px">

              <div class="card" style="padding:18px">
                <div style="display:flex;align-items:center;gap:8px;margin-bottom:4px">
                  <div style="width:8px;height:8px;border-radius:50%;background:var(--accent);box-shadow:0 0 6px var(--accent);animation:pulse 2s infinite"></div>
                  <div class="card-title" style="margin:0">AI Chat Editor</div>
                </div>
                <div style="color:var(--muted);font-size:11px;margin-bottom:12px">Tell AI what to change — edits the site live</div>
                <div id="b-chat-history" style="max-height:260px;overflow-y:auto;display:flex;flex-direction:column;gap:8px;margin-bottom:10px;padding-right:4px"></div>
                <div style="display:flex;gap:6px">
                  <input type="text" class="form-input" id="b-chat-input" placeholder="e.g. Make hero dark blue..." style="flex:1;font-size:12px;padding:8px 12px">
                  <button onclick="runChatEdit()" class="btn btn-primary" style="padding:8px 12px;font-size:12px">↑</button>
                </div>
                <!-- Quick chips -->
                <div style="display:flex;flex-wrap:wrap;gap:5px;margin-top:8px">
                  <button class="chat-chip" onclick="quickEdit('Make the hero section taller with a bold headline')">Bigger hero</button>
                  <button class="chat-chip" onclick="quickEdit('Add a pricing section with 3 tiers')">Add pricing</button>
                  <button class="chat-chip" onclick="quickEdit('Add customer reviews section with 3 testimonials')">Add reviews</button>
                  <button class="chat-chip" onclick="quickEdit('Change to dark navy and gold color scheme')">Navy + gold</button>
                  <button class="chat-chip" onclick="quickEdit('Make all buttons rounded pill shape with gradient')">Pill buttons</button>
                  <button class="chat-chip" onclick="quickEdit('Add an FAQ section with 5 common questions')">Add FAQ</button>
                  <button class="chat-chip" onclick="quickEdit('Add Google Maps placeholder in contact section')">Add map</button>
                  <button class="chat-chip" onclick="quickEdit('Make the whole site lighter / white background')">Light mode</button>
                </div>
              </div>

              <!-- AI Image Generator mini -->
              <div class="card" style="padding:18px">
                <div class="card-title" style="margin-bottom:4px">🎨 AI Image Generator</div>
                <div style="color:var(--muted);font-size:11px;margin-bottom:12px">Free · No API key needed</div>
                <textarea class="form-input" id="img-gen-prompt" rows="2" placeholder="Hero image for plumbing business, professional, dark..." style="font-size:12px;margin-bottom:8px"></textarea>
                <div style="display:flex;gap:8px;margin-bottom:8px">
                  <select class="form-input" id="img-gen-style" style="font-size:11px;flex:1">
                    <option value="photorealistic">Photorealistic</option>
                    <option value="professional photography">Pro Photo</option>
                    <option value="3d render">3D Render</option>
                    <option value="cinematic">Cinematic</option>
                    <option value="digital art">Digital Art</option>
                    <option value="flat design">Flat Design</option>
                  </select>
                  <select class="form-input" id="img-gen-size" style="font-size:11px;flex:1">
                    <option value="1920x1080">1920×1080</option>
                    <option value="1200x630">1200×630</option>
                    <option value="800x600">800×600</option>
                    <option value="512x512">512×512</option>
                  </select>
                </div>
                <button class="btn btn-primary" onclick="generateAIImage()" id="img-gen-btn" style="width:100%;font-size:12px">✨ Generate Image</button>
                <div id="img-gen-result" style="display:none;margin-top:10px">
                  <img id="img-gen-out" style="width:100%;border-radius:8px;border:1px solid var(--border)" alt="Generated">
                  <div style="display:flex;gap:6px;margin-top:6px">
                    <a id="img-gen-dl" download="ai-image.png" class="btn btn-sm" style="flex:1;text-align:center;font-size:11px">⬇ Download</a>
                    <button onclick="copyImageUrl()" class="btn btn-sm" style="flex:1;font-size:11px">🔗 URL</button>
                  </div>
                </div>
              </div>

            </div><!-- /chat + image sidebar -->
          </div><!-- /split -->
        </div><!-- /b-preview-wrap -->

      </div><!-- /builder-output -->

    </div><!-- /panel-builder -->
    <!-- ============================================================ -->
    <!-- DESIGN STUDIO PANEL                                           -->
    <!-- ============================================================ -->
    <div class="panel" id="panel-design">
      <div style="max-width:1000px;margin:0 auto">

        <!-- Header -->
        <div style="margin-bottom:28px;display:flex;align-items:flex-start;justify-content:space-between;flex-wrap:wrap;gap:16px">
          <div>
            <div class="section-label">Design Studio</div>
            <div class="hero-heading" style="font-size:clamp(22px,3vw,32px)">Customise <span class="highlight">Everything</span></div>
            <div style="color:var(--muted);font-size:13px;margin-top:6px">Fonts · Colors · Backgrounds · Buttons · Cards · Icons</div>
          </div>
          <div style="display:flex;gap:10px">
            <button class="btn btn-sm" onclick="resetDesignToDefault()">↩ Reset Default</button>
            <button class="btn-cta-purple" onclick="saveDesignTheme()" style="padding:10px 20px;font-size:13px">💾 Save Theme</button>
          </div>
        </div>

        <!-- Live mini-preview strip -->
        <div class="card" id="ds-preview-strip" style="padding:20px;margin-bottom:24px">
          <div style="font-size:11px;color:var(--muted);text-transform:uppercase;letter-spacing:2px;margin-bottom:14px;font-weight:700">Live Preview</div>
          <div style="display:flex;gap:12px;flex-wrap:wrap;align-items:center">
            <button id="ds-prev-btn-primary" class="btn btn-primary" style="font-size:13px">Primary Button</button>
            <button id="ds-prev-btn-2" class="btn" style="font-size:13px;background:var(--accent2);color:#fff">Accent Button</button>
            <button id="ds-prev-btn-outline" class="btn" style="font-size:13px;background:transparent;border:1.5px solid var(--accent);color:var(--accent)">Outline Button</button>
            <div id="ds-prev-card" style="background:var(--card);border:1px solid var(--border);border-radius:var(--card-radius);padding:12px 16px;font-size:13px;font-family:var(--font-body)">
              <div style="font-family:var(--font-heading);font-weight:700;font-size:15px;margin-bottom:4px">Card Title</div>
              <div style="color:var(--muted);font-size:12px">Card body text with your selected font</div>
            </div>
            <div style="display:flex;gap:6px;align-items:center">
              <div id="ds-prev-c1" style="width:28px;height:28px;border-radius:50%;background:var(--accent);box-shadow:0 0 10px var(--accent)"></div>
              <div id="ds-prev-c2" style="width:28px;height:28px;border-radius:50%;background:var(--accent2);box-shadow:0 0 10px var(--accent2)"></div>
              <div id="ds-prev-c3" style="width:28px;height:28px;border-radius:50%;background:var(--accent3);box-shadow:0 0 10px var(--accent3)"></div>
            </div>
          </div>
        </div>

        <div style="display:grid;grid-template-columns:1fr 1fr;gap:20px">

          <!-- LEFT COL -->
          <div style="display:flex;flex-direction:column;gap:20px">

            <!-- FONTS -->
            <div class="card" style="padding:20px">
              <div class="card-title" style="margin-bottom:16px">Aa Fonts</div>

              <div style="margin-bottom:14px">
                <label class="form-label">Heading Font</label>
                <select class="form-input" id="ds-font-heading" onchange="applyDesignSetting()">
                  <option value="'Syne', sans-serif" selected>Syne — Geometric Bold (Current)</option>
                  <option value="'Bebas Neue', sans-serif">Bebas Neue — Ultra Condensed</option>
                  <option value="'Oswald', sans-serif">Oswald — Strong Condensed</option>
                  <option value="'Plus Jakarta Sans', sans-serif">Plus Jakarta Sans — Modern Clean</option>
                  <option value="'Rajdhani', sans-serif">Rajdhani — Futuristic Tech</option>
                  <option value="'Orbitron', sans-serif">Orbitron — Sci-Fi Display</option>
                  <option value="'Audiowide', sans-serif">Audiowide — Digital Tech</option>
                  <option value="'Oxanium', sans-serif">Oxanium — Cyber Edge</option>
                  <option value="'Playfair Display', serif">Playfair Display — Editorial Luxury</option>
                  <option value="'Cormorant Garamond', serif">Cormorant Garamond — Elegant Serif</option>
                  <option value="'Space Grotesk', sans-serif">Space Grotesk — SaaS Pro</option>
                  <option value="'Raleway', sans-serif">Raleway — Thin Elegant</option>
                  <option value="'Outfit', sans-serif">Outfit — Friendly Modern</option>
                </select>
                <div id="ds-font-h-preview" style="font-size:22px;font-weight:800;margin-top:8px;padding:10px;background:var(--surface2);border-radius:8px;font-family:'Syne',sans-serif">The Quick Brown Fox</div>
              </div>

              <div>
                <label class="form-label">Body Font</label>
                <select class="form-input" id="ds-font-body" onchange="applyDesignSetting()">
                  <option value="'Inter', sans-serif" selected>Inter — Readable SaaS (Current)</option>
                  <option value="'DM Sans', sans-serif">DM Sans — Friendly Clean</option>
                  <option value="'Manrope', sans-serif">Manrope — Geometric Body</option>
                  <option value="'Nunito', sans-serif">Nunito — Rounded Friendly</option>
                  <option value="'Outfit', sans-serif">Outfit — Modern Casual</option>
                  <option value="'Jost', sans-serif">Jost — Swiss Minimal</option>
                  <option value="'Lato', sans-serif">Lato — Classic Clean</option>
                  <option value="'Exo 2', sans-serif">Exo 2 — Tech Body</option>
                </select>
                <div id="ds-font-b-preview" style="font-size:13px;margin-top:8px;padding:10px;background:var(--surface2);border-radius:8px;line-height:1.7;font-family:'Inter',sans-serif;color:var(--muted)">The quick brown fox jumps over the lazy dog. This is how your body text will appear throughout the interface.</div>
              </div>
            </div>

            <!-- COLOR SCHEMES -->
            <div class="card" style="padding:20px">
              <div class="card-title" style="margin-bottom:6px">🎨 Color Schemes</div>
              <div style="color:var(--muted);font-size:11px;margin-bottom:16px">3-tone schemes · pick preset or build custom</div>

              <!-- Preset swatches -->
              <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:8px;margin-bottom:16px" id="ds-scheme-presets">
                <!-- Injected by JS -->
              </div>

              <!-- Custom 3-tone color pickers -->
              <div style="font-size:11px;color:var(--muted);text-transform:uppercase;letter-spacing:1.5px;font-weight:700;margin-bottom:10px">Custom Colors</div>
              <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px">
                <div>
                  <label class="form-label" style="font-size:10px">Primary</label>
                  <div style="display:flex;align-items:center;gap:6px">
                    <input type="color" id="ds-c1" value="#00d4ff" onchange="applyDesignSetting()" style="width:36px;height:36px;border:none;background:none;cursor:pointer;border-radius:6px">
                    <input type="text" id="ds-c1-hex" value="#00d4ff" class="form-input" style="font-size:11px;flex:1" oninput="syncColorFromHex('ds-c1','ds-c1-hex')">
                  </div>
                </div>
                <div>
                  <label class="form-label" style="font-size:10px">Secondary</label>
                  <div style="display:flex;align-items:center;gap:6px">
                    <input type="color" id="ds-c2" value="#b44fff" onchange="applyDesignSetting()" style="width:36px;height:36px;border:none;background:none;cursor:pointer;border-radius:6px">
                    <input type="text" id="ds-c2-hex" value="#b44fff" class="form-input" style="font-size:11px;flex:1" oninput="syncColorFromHex('ds-c2','ds-c2-hex')">
                  </div>
                </div>
                <div>
                  <label class="form-label" style="font-size:10px">Accent</label>
                  <div style="display:flex;align-items:center;gap:6px">
                    <input type="color" id="ds-c3" value="#ff5580" onchange="applyDesignSetting()" style="width:36px;height:36px;border:none;background:none;cursor:pointer;border-radius:6px">
                    <input type="text" id="ds-c3-hex" value="#ff5580" class="form-input" style="font-size:11px;flex:1" oninput="syncColorFromHex('ds-c3','ds-c3-hex')">
                  </div>
                </div>
              </div>

              <!-- Text colors -->
              <div style="font-size:11px;color:var(--muted);text-transform:uppercase;letter-spacing:1.5px;font-weight:700;margin:14px 0 10px">Text Colors</div>
              <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px">
                <div>
                  <label class="form-label" style="font-size:10px">Main Text</label>
                  <div style="display:flex;align-items:center;gap:6px">
                    <input type="color" id="ds-text" value="#ffffff" onchange="applyDesignSetting()" style="width:36px;height:36px;border:none;background:none;cursor:pointer;border-radius:6px">
                    <input type="text" id="ds-text-hex" value="#ffffff" class="form-input" style="font-size:11px;flex:1">
                  </div>
                </div>
                <div>
                  <label class="form-label" style="font-size:10px">Muted Text</label>
                  <div style="display:flex;align-items:center;gap:6px">
                    <input type="color" id="ds-muted" value="#9999bb" onchange="applyDesignSetting()" style="width:36px;height:36px;border:none;background:none;cursor:pointer;border-radius:6px">
                    <input type="text" id="ds-muted-hex" value="#9999bb" class="form-input" style="font-size:11px;flex:1">
                  </div>
                </div>
              </div>
            </div>

            <!-- BUTTONS & CARDS -->
            <div class="card" style="padding:20px">
              <div class="card-title" style="margin-bottom:16px">🔲 Buttons & Cards</div>

              <div style="margin-bottom:14px">
                <label class="form-label">Button Style</label>
                <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:6px" id="ds-btn-styles">
                  <button class="ds-option-btn active" onclick="setButtonStyle('gradient',this)">Gradient</button>
                  <button class="ds-option-btn" onclick="setButtonStyle('flat',this)">Flat</button>
                  <button class="ds-option-btn" onclick="setButtonStyle('outline',this)">Outline</button>
                  <button class="ds-option-btn" onclick="setButtonStyle('glow',this)">Neon Glow</button>
                  <button class="ds-option-btn" onclick="setButtonStyle('3d',this)">3D Press</button>
                  <button class="ds-option-btn" onclick="setButtonStyle('glass',this)">Glass</button>
                </div>
              </div>

              <div style="margin-bottom:14px">
                <label class="form-label">Border Radius</label>
                <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:6px">
                  <button class="ds-option-btn" onclick="setBorderRadius('4px',this)">Sharp</button>
                  <button class="ds-option-btn active" onclick="setBorderRadius('8px',this)">Rounded</button>
                  <button class="ds-option-btn" onclick="setBorderRadius('50px',this)">Pill</button>
                </div>
              </div>

              <div style="margin-bottom:14px">
                <label class="form-label">Card Style</label>
                <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:6px">
                  <button class="ds-option-btn active" onclick="setCardStyle('glass',this)">Glass</button>
                  <button class="ds-option-btn" onclick="setCardStyle('solid',this)">Solid</button>
                  <button class="ds-option-btn" onclick="setCardStyle('bordered',this)">Bordered</button>
                  <button class="ds-option-btn" onclick="setCardStyle('neumorphic',this)">Soft</button>
                  <button class="ds-option-btn" onclick="setCardStyle('neon',this)">Neon</button>
                  <button class="ds-option-btn" onclick="setCardStyle('flat',this)">Flat</button>
                </div>
              </div>

              <div>
                <label class="form-label">Glow Intensity</label>
                <input type="range" id="ds-glow" min="0" max="4" value="2" step="1" onchange="applyDesignSetting()" style="width:100%;accent-color:var(--accent)">
                <div style="display:flex;justify-content:space-between;font-size:10px;color:var(--muted);margin-top:2px">
                  <span>Off</span><span>Subtle</span><span>Medium</span><span>Strong</span><span>Intense</span>
                </div>
              </div>
            </div>

          </div><!-- /left col -->

          <!-- RIGHT COL -->
          <div style="display:flex;flex-direction:column;gap:20px">

            <!-- BACKGROUNDS -->
            <div class="card" style="padding:20px">
              <div class="card-title" style="margin-bottom:16px">🌌 Background</div>

              <!-- Type tabs -->
              <div style="display:flex;gap:6px;margin-bottom:16px">
                <button class="bg-type-btn active" onclick="setBgType('solid',this)">Solid</button>
                <button class="bg-type-btn" onclick="setBgType('gradient',this)">Gradient</button>
                <button class="bg-type-btn" onclick="setBgType('animated',this)">Animated</button>
                <button class="bg-type-btn" onclick="setBgType('3d',this)">3D</button>
              </div>

              <!-- SOLID -->
              <div id="bg-panel-solid">
                <label class="form-label">Background Color</label>
                <div style="display:flex;align-items:center;gap:8px">
                  <input type="color" id="ds-bg-solid" value="#080810" onchange="applyDesignSetting()" style="width:48px;height:48px;border:none;background:none;cursor:pointer;border-radius:8px">
                  <input type="text" id="ds-bg-solid-hex" value="#080810" class="form-input" style="font-size:12px" oninput="syncColorFromHex('ds-bg-solid','ds-bg-solid-hex')">
                </div>
                <div style="display:grid;grid-template-columns:repeat(6,1fr);gap:6px;margin-top:12px">
                  <div class="color-swatch" style="background:#080810" onclick="setBgSolid('#080810')" title="Void Black"></div>
                  <div class="color-swatch" style="background:#0a0a1a" onclick="setBgSolid('#0a0a1a')" title="Deep Navy"></div>
                  <div class="color-swatch" style="background:#0d1117" onclick="setBgSolid('#0d1117')" title="GitHub Dark"></div>
                  <div class="color-swatch" style="background:#111827" onclick="setBgSolid('#111827')" title="Slate Dark"></div>
                  <div class="color-swatch" style="background:#1a0a2e" onclick="setBgSolid('#1a0a2e')" title="Deep Purple"></div>
                  <div class="color-swatch" style="background:#0a1628" onclick="setBgSolid('#0a1628')" title="Ocean Dark"></div>
                  <div class="color-swatch" style="background:#ffffff" onclick="setBgSolid('#ffffff')" title="Pure White"></div>
                  <div class="color-swatch" style="background:#f8fafc" onclick="setBgSolid('#f8fafc')" title="Off White"></div>
                  <div class="color-swatch" style="background:#f1f5f9" onclick="setBgSolid('#f1f5f9')" title="Cool Gray"></div>
                  <div class="color-swatch" style="background:#fafaf8" onclick="setBgSolid('#fafaf8')" title="Warm White"></div>
                  <div class="color-swatch" style="background:#fff7ed" onclick="setBgSolid('#fff7ed')" title="Warm Cream"></div>
                  <div class="color-swatch" style="background:#0f172a" onclick="setBgSolid('#0f172a')" title="Slate Navy"></div>
                </div>
              </div>

              <!-- GRADIENT -->
              <div id="bg-panel-gradient" style="display:none">
                <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:10px">
                  <div>
                    <label class="form-label" style="font-size:10px">Color 1</label>
                    <input type="color" id="ds-bg-g1" value="#080810" onchange="applyDesignSetting()" style="width:100%;height:40px;border:none;background:none;cursor:pointer;border-radius:8px">
                  </div>
                  <div>
                    <label class="form-label" style="font-size:10px">Color 2</label>
                    <input type="color" id="ds-bg-g2" value="#1a0a2e" onchange="applyDesignSetting()" style="width:100%;height:40px;border:none;background:none;cursor:pointer;border-radius:6px">
                  </div>
                </div>
                <label class="form-label" style="font-size:10px">Direction</label>
                <select class="form-input" id="ds-bg-gdir" onchange="applyDesignSetting()" style="margin-bottom:10px">
                  <option value="135deg">↘ Diagonal</option>
                  <option value="180deg">↓ Top to Bottom</option>
                  <option value="90deg">→ Left to Right</option>
                  <option value="45deg">↗ Anti-diagonal</option>
                  <option value="radial">○ Radial Center</option>
                </select>
                <!-- Gradient presets -->
                <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:6px">
                  <div class="grad-preset" style="background:linear-gradient(135deg,#080810,#1a0a2e)" onclick="setGradientPreset('#080810','#1a0a2e','135deg')">Void</div>
                  <div class="grad-preset" style="background:linear-gradient(135deg,#0a1628,#001a3d)" onclick="setGradientPreset('#0a1628','#001a3d','135deg')">Ocean</div>
                  <div class="grad-preset" style="background:linear-gradient(135deg,#0d2818,#001a0a)" onclick="setGradientPreset('#0d2818','#001a0a','135deg')">Forest</div>
                  <div class="grad-preset" style="background:linear-gradient(135deg,#1a0a0a,#2d0a1a)" onclick="setGradientPreset('#1a0a0a','#2d0a1a','135deg')">Blood</div>
                  <div class="grad-preset" style="background:linear-gradient(135deg,#0f0f2e,#2a0a4e)" onclick="setGradientPreset('#0f0f2e','#2a0a4e','135deg')">Galaxy</div>
                  <div class="grad-preset" style="background:linear-gradient(135deg,#1a1200,#2d2200)" onclick="setGradientPreset('#1a1200','#2d2200','135deg')">Gold</div>
                </div>
              </div>

              <!-- ANIMATED -->
              <div id="bg-panel-animated" style="display:none">
                <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px" id="ds-anim-options">
                  <div class="anim-option active" onclick="setAnimBg('stars',this)">
                    <div style="font-size:24px;margin-bottom:4px">⭐</div>
                    <div style="font-size:11px;font-weight:600">Stars Falling</div>
                  </div>
                  <div class="anim-option" onclick="setAnimBg('matrix',this)">
                    <div style="font-size:24px;margin-bottom:4px">🟩</div>
                    <div style="font-size:11px;font-weight:600">Matrix Rain</div>
                  </div>
                  <div class="anim-option" onclick="setAnimBg('particles',this)">
                    <div style="font-size:24px;margin-bottom:4px">✨</div>
                    <div style="font-size:11px;font-weight:600">Particles</div>
                  </div>
                  <div class="anim-option" onclick="setAnimBg('aurora',this)">
                    <div style="font-size:24px;margin-bottom:4px">🌌</div>
                    <div style="font-size:11px;font-weight:600">Aurora</div>
                  </div>
                  <div class="anim-option" onclick="setAnimBg('waves',this)">
                    <div style="font-size:24px;margin-bottom:4px">🌊</div>
                    <div style="font-size:11px;font-weight:600">Waves</div>
                  </div>
                  <div class="anim-option" onclick="setAnimBg('clouds',this)">
                    <div style="font-size:24px;margin-bottom:4px">☁️</div>
                    <div style="font-size:11px;font-weight:600">Clouds</div>
                  </div>
                  <div class="anim-option" onclick="setAnimBg('lightning',this)">
                    <div style="font-size:24px;margin-bottom:4px">⚡</div>
                    <div style="font-size:11px;font-weight:600">Lightning</div>
                  </div>
                  <div class="anim-option" onclick="setAnimBg('bubbles',this)">
                    <div style="font-size:24px;margin-bottom:4px">🫧</div>
                    <div style="font-size:11px;font-weight:600">Bubbles</div>
                  </div>
                  <div class="anim-option" onclick="setAnimBg('snow',this)">
                    <div style="font-size:24px;margin-bottom:4px">❄️</div>
                    <div style="font-size:11px;font-weight:600">Snow</div>
                  </div>
                  <div class="anim-option" onclick="setAnimBg('fireflies',this)">
                    <div style="font-size:24px;margin-bottom:4px">🌟</div>
                    <div style="font-size:11px;font-weight:600">Fireflies</div>
                  </div>
                </div>
                <div style="margin-top:12px">
                  <label class="form-label" style="font-size:10px">Animation Speed</label>
                  <input type="range" id="ds-anim-speed" min="0.5" max="3" value="1" step="0.1" onchange="applyDesignSetting()" style="width:100%;accent-color:var(--accent)">
                  <div style="display:flex;justify-content:space-between;font-size:10px;color:var(--muted)"><span>Slow</span><span>Fast</span></div>
                </div>
                <div style="margin-top:10px">
                  <label class="form-label" style="font-size:10px">Particle Count</label>
                  <input type="range" id="ds-anim-count" min="20" max="300" value="100" step="10" onchange="applyDesignSetting()" style="width:100%;accent-color:var(--accent)">
                  <div style="display:flex;justify-content:space-between;font-size:10px;color:var(--muted)"><span>20</span><span>300</span></div>
                </div>
              </div>

              <!-- 3D -->
              <div id="bg-panel-3d" style="display:none">
                <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px">
                  <div class="anim-option" onclick="set3dBg('globe',this)">
                    <div style="font-size:24px;margin-bottom:4px">🌐</div>
                    <div style="font-size:11px;font-weight:600">3D Globe</div>
                  </div>
                  <div class="anim-option active" onclick="set3dBg('mesh',this)">
                    <div style="font-size:24px;margin-bottom:4px">🔷</div>
                    <div style="font-size:11px;font-weight:600">Mesh Grid</div>
                  </div>
                  <div class="anim-option" onclick="set3dBg('shapes',this)">
                    <div style="font-size:24px;margin-bottom:4px">🔮</div>
                    <div style="font-size:11px;font-weight:600">3D Shapes</div>
                  </div>
                  <div class="anim-option" onclick="set3dBg('vortex',this)">
                    <div style="font-size:24px;margin-bottom:4px">🌀</div>
                    <div style="font-size:11px;font-weight:600">Vortex</div>
                  </div>
                  <div class="anim-option" onclick="set3dBg('terrain',this)">
                    <div style="font-size:24px;margin-bottom:4px">⛰️</div>
                    <div style="font-size:11px;font-weight:600">3D Terrain</div>
                  </div>
                  <div class="anim-option" onclick="set3dBg('nebula',this)">
                    <div style="font-size:24px;margin-bottom:4px">🌌</div>
                    <div style="font-size:11px;font-weight:600">Nebula</div>
                  </div>
                </div>
              </div>

            </div><!-- /backgrounds card -->

            <!-- ICON PACK -->
            <div class="card" style="padding:20px">
              <div class="card-title" style="margin-bottom:16px">🔣 Icon Pack</div>
              <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px">
                <div class="ds-option-btn active" onclick="setIconPack('lucide',this)" style="padding:12px;text-align:center">
                  <div style="font-size:11px;font-weight:700">Lucide</div>
                  <div style="font-size:10px;color:var(--muted)">Clean lines (current)</div>
                </div>
                <div class="ds-option-btn" onclick="setIconPack('phosphor',this)" style="padding:12px;text-align:center">
                  <div style="font-size:11px;font-weight:700">Phosphor</div>
                  <div style="font-size:10px;color:var(--muted)">Rounded bold</div>
                </div>
                <div class="ds-option-btn" onclick="setIconPack('tabler',this)" style="padding:12px;text-align:center">
                  <div style="font-size:11px;font-weight:700">Tabler</div>
                  <div style="font-size:10px;color:var(--muted)">Sharp precise</div>
                </div>
                <div class="ds-option-btn" onclick="setIconPack('heroicons',this)" style="padding:12px;text-align:center">
                  <div style="font-size:11px;font-weight:700">Heroicons</div>
                  <div style="font-size:10px;color:var(--muted)">Minimal strokes</div>
                </div>
              </div>
            </div>

            <!-- SAVED THEMES -->
            <div class="card" style="padding:20px">
              <div class="card-title" style="margin-bottom:12px">📁 Saved Themes</div>
              <div id="ds-saved-themes" style="display:flex;flex-direction:column;gap:8px">
                <div style="color:var(--muted);font-size:12px;text-align:center;padding:16px">No saved themes yet. Customise above and click Save Theme.</div>
              </div>
            </div>

          </div><!-- /right col -->

        </div><!-- /grid -->
      </div>
    </div><!-- /panel-design -->


  </div>
</main>

  <!-- ============================================================ -->
  <!-- MARKETING OS PANEL                                            -->
  <!-- ============================================================ -->
  <div class="panel" id="panel-marketing">
    <div style="max-width:1100px;margin:0 auto">

      <!-- Header -->
      <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:28px;flex-wrap:wrap;gap:12px">
        <div>
          <div class="section-label">FixMyHive Intelligence Layer</div>
          <h1 style="font-family:var(--font-heading);font-size:clamp(22px,3vw,30px);font-weight:800;margin:4px 0">Marketing OS <span style="background:var(--grad-text);-webkit-background-clip:text;-webkit-text-fill-color:transparent">Live Dashboard</span></h1>
          <div style="font-size:12px;color:var(--muted)">Visitor Intelligence · Intent Scoring · Content Queue · Decision Log</div>
        </div>
        <div style="display:flex;gap:8px;flex-wrap:wrap">
          <div id="mos-db-status" style="display:flex;align-items:center;gap:6px;padding:6px 14px;border-radius:20px;background:rgba(255,85,85,0.1);border:1px solid rgba(255,85,85,0.2);font-size:11px;font-weight:700;color:var(--accent3)">
            <div style="width:7px;height:7px;border-radius:50%;background:var(--accent3)"></div>
            DB Not Connected
          </div>
          <div id="mos-backend-status" style="display:flex;align-items:center;gap:6px;padding:6px 14px;border-radius:20px;background:rgba(255,85,85,0.1);border:1px solid rgba(255,85,85,0.2);font-size:11px;font-weight:700;color:var(--accent3)">
            <div style="width:7px;height:7px;border-radius:50%;background:var(--accent3)"></div>
            Backend Offline
          </div>
          <button class="btn btn-primary" onclick="mosRefresh()" style="font-size:12px">↻ Refresh</button>
          <button class="btn" onclick="showPanel('settings',document.getElementById('nav-settings'))" style="font-size:12px">⚙ Settings</button>
        </div>
      </div>

      <!-- Live Stats Row -->
      <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:12px;margin-bottom:24px" id="mos-stats-grid">
        <div class="card" style="padding:16px;border-top:2px solid var(--accent)">
          <div style="font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:1px;color:var(--muted);margin-bottom:8px">Total Sessions</div>
          <div style="font-size:28px;font-weight:800;font-family:var(--font-heading)" id="mos-stat-sessions">—</div>
          <div style="font-size:11px;color:var(--muted);margin-top:4px">All tracked visits</div>
        </div>
        <div class="card" style="padding:16px;border-top:2px solid var(--accent2)">
          <div style="font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:1px;color:var(--muted);margin-bottom:8px">High Intent</div>
          <div style="font-size:28px;font-weight:800;font-family:var(--font-heading);color:var(--accent2)" id="mos-stat-highintent">—</div>
          <div style="font-size:11px;color:var(--muted);margin-top:4px">WhatsApp / Call clicks</div>
        </div>
        <div class="card" style="padding:16px;border-top:2px solid #f5c542">
          <div style="font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:1px;color:var(--muted);margin-bottom:8px">Content Queue</div>
          <div style="font-size:28px;font-weight:800;font-family:var(--font-heading);color:#f5c542" id="mos-stat-queue">—</div>
          <div style="font-size:11px;color:var(--muted);margin-top:4px">Pending articles</div>
        </div>
        <div class="card" style="padding:16px;border-top:2px solid var(--accent3)">
          <div style="font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:1px;color:var(--muted);margin-bottom:8px">Decisions Made</div>
          <div style="font-size:28px;font-weight:800;font-family:var(--font-heading);color:var(--accent3)" id="mos-stat-decisions">—</div>
          <div style="font-size:11px;color:var(--muted);margin-top:4px">Automated actions</div>
        </div>
      </div>

      <!-- Main Grid: Visitor Feed + Intent + Content Queue -->
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-bottom:16px">

        <!-- Live Visitor Feed -->
        <div class="card" style="padding:20px">
          <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:16px">
            <div class="card-title" style="margin:0;display:flex;align-items:center;gap:8px">
              <div style="width:8px;height:8px;border-radius:50%;background:#00e676;box-shadow:0 0 6px #00e676;animation:pulse 2s infinite"></div>
              Live Visitor Feed
            </div>
            <span style="font-size:10px;color:var(--muted)" id="mos-feed-count">0 sessions</span>
          </div>
          <div id="mos-visitor-feed" style="display:flex;flex-direction:column;gap:8px;max-height:320px;overflow-y:auto">
            <div style="text-align:center;padding:40px;color:var(--muted);font-size:12px">
              <div style="font-size:32px;margin-bottom:8px">📡</div>
              Connect database in Settings to see live visitors
            </div>
          </div>
        </div>

        <!-- Intent Score Leaderboard -->
        <div class="card" style="padding:20px">
          <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:16px">
            <div class="card-title" style="margin:0">🎯 Intent Scores</div>
            <span style="font-size:10px;color:var(--muted)">Last 24h</span>
          </div>
          <div id="mos-intent-list" style="display:flex;flex-direction:column;gap:8px;max-height:320px;overflow-y:auto">
            <div style="text-align:center;padding:40px;color:var(--muted);font-size:12px">
              <div style="font-size:32px;margin-bottom:8px">🎯</div>
              Intent scores appear as visitors engage
            </div>
          </div>
        </div>

      </div>

      <!-- Content Queue + Decision Log -->
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-bottom:16px">

        <!-- Content Queue -->
        <div class="card" style="padding:20px">
          <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:16px;flex-wrap:wrap;gap:8px">
            <div class="card-title" style="margin:0">📝 Content Queue</div>
            <div style="display:flex;gap:6px">
            <button class="btn btn-ghost" onclick="mosDetectTrend()" style="font-size:11px;padding:6px 12px">📡 Detect Trend</button>
            <button class="btn btn-primary" onclick="mosAddToQueue()" style="font-size:11px;padding:6px 12px">+ Add Opportunity</button>
          </div>
          </div>
          <div id="mos-content-queue" style="display:flex;flex-direction:column;gap:8px;max-height:300px;overflow-y:auto">
            <div style="text-align:center;padding:30px;color:var(--muted);font-size:12px">
              <div style="font-size:28px;margin-bottom:8px">📝</div>
              Content opportunities will appear here
            </div>
          </div>
        </div>

        <!-- Decision Log -->
        <div class="card" style="padding:20px">
          <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:16px">
            <div class="card-title" style="margin:0">📋 Decision Log</div>
            <span style="font-size:10px;color:var(--muted)">All automated actions</span>
          </div>
          <div id="mos-decision-log" style="display:flex;flex-direction:column;gap:8px;max-height:300px;overflow-y:auto">
            <div style="text-align:center;padding:30px;color:var(--muted);font-size:12px">
              <div style="font-size:28px;margin-bottom:8px">📋</div>
              Automated decisions logged here
            </div>
          </div>
        </div>

      </div>

      <!-- Tracking Script Generator -->
      <div class="card" style="padding:20px;margin-bottom:16px">
        <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:12px;flex-wrap:wrap;gap:8px">
          <div>
            <div class="card-title" style="margin-bottom:2px">📡 Visitor Tracking Script</div>
            <div style="font-size:11px;color:var(--muted)">Embed this in any website to track visitors into your Marketing OS</div>
          </div>
          <button class="btn btn-ghost" onclick="copyTrackingScript()" style="font-size:12px">📋 Copy Script</button>
        </div>
        <div style="background:#0a0a14;border:1px solid var(--border);border-radius:10px;padding:14px;font-family:'Courier New',monospace;font-size:10.5px;color:#a8d8a8;line-height:1.7;max-height:160px;overflow-y:auto;white-space:pre" id="mos-tracking-code"></div>
        <div style="font-size:11px;color:var(--muted);margin-top:8px">✦ Tracks: page visits · scroll depth · WhatsApp/call clicks · device · referrer · UTM params · repeat visits</div>
      </div>

      <!-- Quick Content Generator -->
      <div class="card" style="padding:20px">
        <div class="card-title" style="margin-bottom:4px">⚡ Quick Content Opportunity</div>
        <div style="font-size:11px;color:var(--muted);margin-bottom:16px">Manually add a keyword opportunity to your content queue</div>
        <div style="display:grid;grid-template-columns:1fr 1fr auto;gap:10px;align-items:end" id="mos-add-form" style="display:none">
          <div>
            <label style="font-size:11px;font-weight:600;color:var(--muted);display:block;margin-bottom:4px">KEYWORD / TOPIC</label>
            <input type="text" class="form-input" id="mos-kw-input" placeholder="e.g. dishwasher not draining" style="font-size:12px">
          </div>
          <div>
            <label style="font-size:11px;font-weight:600;color:var(--muted);display:block;margin-bottom:4px">MODE</label>
            <select class="form-input" id="mos-mode-input" style="font-size:12px">
              <option value="SEARCH_MODE">SEARCH_MODE — Troubleshooting / DIY</option>
              <option value="DISCOVER_MODE">DISCOVER_MODE — Awareness / Lifestyle</option>
            </select>
          </div>
          <button class="btn btn-primary" onclick="mosSubmitQueue()" style="font-size:12px;white-space:nowrap">Add to Queue</button>
        </div>
        <div id="mos-add-form" style="display:grid;grid-template-columns:1fr 1fr auto;gap:10px;align-items:end">
          <div>
            <label style="font-size:11px;font-weight:600;color:var(--muted);display:block;margin-bottom:4px">KEYWORD / TOPIC</label>
            <input type="text" class="form-input" id="mos-kw-input" placeholder="e.g. dishwasher not draining" style="font-size:12px">
          </div>
          <div>
            <label style="font-size:11px;font-weight:600;color:var(--muted);display:block;margin-bottom:4px">MODE</label>
            <select class="form-input" id="mos-mode-input" style="font-size:12px">
              <option value="SEARCH_MODE">SEARCH_MODE — Troubleshooting DIY</option>
              <option value="DISCOVER_MODE">DISCOVER_MODE — Awareness / Lifestyle</option>
            </select>
          </div>
          <button class="btn btn-primary" onclick="mosSubmitQueue()" style="font-size:12px;white-space:nowrap">Add to Queue</button>
        </div>
      </div>

    </div>
  </div><!-- /panel-marketing -->

<script>


  // ── Mobile sidebar ───────────────────────────────────────────
  function toggleSidebar() {
    const sb = document.getElementById('sidebar');
    const ov = document.getElementById('sidebar-overlay');
    sb.classList.toggle('open');
    ov.classList.toggle('visible');
    document.body.style.overflow = sb.classList.contains('open') ? 'hidden' : '';
  }

  // Auto-close sidebar on nav tap (mobile)
  document.addEventListener('DOMContentLoaded', () => {
    document.querySelectorAll('.nav-item').forEach(el => {
      el.addEventListener('click', () => {
        if (window.innerWidth <= 768) {
          document.getElementById('sidebar').classList.remove('open');
          document.getElementById('sidebar-overlay').classList.remove('visible');
          document.body.style.overflow = '';
        }
      });
    });
  });

  // ── Niche Discovery ──────────────────────────────────────────
  const NICHE_ICONS = ['🔧','🏠','🌿','💡','🚗','🍽️','💪','📚','🐾','🧹','🔥','❄️','🪴','🎨','🛁','⚡','🌊','🏗️'];

  function nicheProgressAnim(targetPct, label) {
    const bar = document.getElementById('niche-progress');
    const lbl = document.getElementById('niche-progress-label');
    if (bar) bar.style.width = targetPct + '%';
    if (lbl) lbl.textContent = label;
  }

  async function runNicheScan() {
    if (!requireApiKey('Niche Discovery')) return;
    const seed = document.getElementById('niche-seed').value.trim() || 'home repair';
    const minRpm = document.getElementById('niche-rpm').value;
    const comp = document.getElementById('niche-comp').value;
    const btn = document.getElementById('niche-scan-btn');

    // Show loading
    document.getElementById('niche-results-grid').style.display = 'none';
    document.getElementById('niche-loading').style.display = 'block';
    btn.disabled = true;
    btn.innerHTML = '<span class="spinner"></span> Scanning...';

    nicheProgressAnim(15, 'Analysing seed topic...');

    const prompt = `You are a niche market research expert specialising in AdSense monetised websites.

Given the seed topic: "${seed}"
Min AdSense RPM filter: $${minRpm}+
Competition filter: ${comp}

Find 6 profitable website niches that are adjacent to or related to "${seed}".

Respond ONLY with a valid JSON array. No explanation, no markdown, no code fences. Just the raw JSON array.

Each object must have exactly these fields:
{
  "icon": "single emoji",
  "name": "Niche Name (3-5 words)",
  "rpm": number (estimated AdSense RPM in USD, integer),
  "competition": "Low" or "Medium" or "High",
  "volume": "e.g. 45K",
  "description": "2 sentences. What the niche covers and why it's profitable.",
  "topKeywords": ["keyword 1", "keyword 2", "keyword 3"],
  "contentIdeas": ["idea 1", "idea 2", "idea 3"],
  "monetization": "One sentence on best monetization approach for this niche."
}

Make sure all 6 niches have rpm >= ${minRpm}.
${comp === 'low' ? 'All niches must have competition: "Low".' : comp === 'low-med' ? 'Niches must have competition "Low" or "Medium" only.' : ''}
Be specific and realistic. Use real market knowledge.`;

    try {
      nicheProgressAnim(35, 'AI scanning market data...');

      // Gemini free API call
      let _geminiRaw = await geminiCall(prompt, 1000);

      nicheProgressAnim(70, 'Processing results...');

      let raw = _geminiRaw;
      raw = raw.replace(/^```json\s*/i,'').replace(/^```\s*/,'').replace(/\s*```$/,'').trim();

      nicheProgressAnim(90, 'Building cards...');

      const niches = JSON.parse(raw);

      await new Promise(r => setTimeout(r, 400));

      nicheProgressAnim(100, 'Done!');
      await new Promise(r => setTimeout(r, 300));

      renderNicheCards(niches, seed);

    } catch (err) {
      console.error(err);
      document.getElementById('niche-loading').style.display = 'none';
      document.getElementById('niche-results-grid').style.display = 'grid';
      alert('Scan failed: ' + (err.message || 'Unknown error') + '. Showing default results.');
    } finally {
      btn.disabled = false;
      btn.innerHTML = 'Scan Niches';
    }
  }

  function renderNicheCards(niches, seed) {
    const grid = document.getElementById('niche-results-grid');
    grid.innerHTML = '';

    const gradients = [
      'linear-gradient(90deg,#00e5a0,#00b8ff)',
      'linear-gradient(90deg,#b44fff,#ff6b6b)',
      'linear-gradient(90deg,#ffd93d,#00e5a0)',
      'linear-gradient(90deg,#ff6b6b,#b44fff)',
      'linear-gradient(90deg,#00b8ff,#b44fff)',
      'linear-gradient(90deg,#ffd93d,#ff6b6b)'
    ];

    niches.forEach((n, i) => {
      const compClass = n.competition === 'Low' ? 'dot-easy' : n.competition === 'Medium' ? 'dot-med' : 'dot-hard';
      const card = document.createElement('div');
      card.className = 'niche-card';
      card.style.cssText = 'animation:fadeIn 0.3s ease both;animation-delay:' + (i*0.07) + 's';
      card.innerHTML = `
        <div style="position:absolute;top:0;left:0;right:0;height:3px;background:${gradients[i % gradients.length]};border-radius:12px 12px 0 0"></div>
        <div class="niche-header">
          <div class="niche-icon">${n.icon || NICHE_ICONS[i]}</div>
          <div class="rpm-badge">$${n.rpm} RPM</div>
        </div>
        <div class="niche-name">${n.name}</div>
        <div class="niche-desc">${n.description}</div>
        <div class="niche-meta">
          <div class="meta-item"><div class="meta-dot ${compClass}"></div> ${n.competition} competition</div>
          <div class="meta-item">${n.volume}/mo</div>
        </div>
        <div style="margin-top:12px;display:flex;gap:8px">
          <button class="btn btn-ghost" style="flex:1;font-size:11px;padding:6px" onclick="buildNiche('${n.name.replace(/'/g,"\\'")}')">Build Site <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="5" y1="12" x2="19" y2="12"/><polyline points="12 5 19 12 12 19"/></svg></button>
          <button class="btn btn-ghost" style="font-size:11px;padding:6px 10px" onclick='showNicheDetail(${JSON.stringify(JSON.stringify(n))})'>Details</button>
        </div>`;
      grid.appendChild(card);
    });

    document.getElementById('niche-loading').style.display = 'none';
    grid.style.display = 'grid';
  }

  function showNicheDetail(jsonStr) {
    const n = JSON.parse(jsonStr);
    const modal = document.getElementById('niche-modal');
    const content = document.getElementById('niche-modal-content');
    content.innerHTML = `
      <div style="display:flex;align-items:center;gap:12px;margin-bottom:20px">
        <div style="font-size:36px">${n.icon}</div>
        <div>
          <div style="font-family:'Syne',sans-serif;font-size:18px;font-weight:800">${n.name}</div>
          <div style="color:var(--muted);font-size:12px;margin-top:3px">$${n.rpm} RPM · ${n.competition} Competition · ${n.volume}/mo searches</div>
        </div>
      </div>
      <p style="font-size:13px;line-height:1.6;color:var(--text);margin-bottom:20px">${n.description}</p>
      <div style="margin-bottom:16px">
        <div style="font-size:11px;text-transform:uppercase;letter-spacing:1px;color:var(--muted);margin-bottom:8px">Top Keywords</div>
        <div style="display:flex;flex-wrap:wrap;gap:6px">${(n.topKeywords||[]).map(k=>`<span style="background:rgba(0,212,255,0.08);border:1px solid rgba(0,212,255,0.15);color:var(--accent);padding:4px 10px;border-radius:20px;font-size:12px">${k}</span>`).join('')}</div>
      </div>
      <div style="margin-bottom:16px">
        <div style="font-size:11px;text-transform:uppercase;letter-spacing:1px;color:var(--muted);margin-bottom:8px">Content Ideas</div>
        <div style="display:flex;flex-direction:column;gap:6px">${(n.contentIdeas||[]).map(c=>`<div style="font-size:13px;padding:8px 12px;background:var(--surface2);border-radius:6px;border-left:3px solid var(--accent2)">📝 ${c}</div>`).join('')}</div>
      </div>
      <div style="background:rgba(0,212,255,0.06);border:1px solid rgba(0,212,255,0.15);border-radius:8px;padding:14px;margin-bottom:20px">
        <div style="font-size:11px;text-transform:uppercase;letter-spacing:1px;color:var(--muted);margin-bottom:6px">Monetization Strategy</div>
        <div style="font-size:13px;line-height:1.5">💰 ${n.monetization}</div>
      </div>
      <button class="btn btn-primary" style="width:100%" onclick="buildNiche('${n.name.replace(/'/g,"\\'")}');closeNicheModal()">Start Building This Site</button>`;
    modal.style.display = 'flex';
  }

  function closeNicheModal() {
    document.getElementById('niche-modal').style.display = 'none';
  }

  function buildNiche(name) {
    // Pre-fill the Create Site wizard with this niche
    showPanel('create');
    setTimeout(() => {
      const nicheInput = document.querySelector('#ws-step1 input[placeholder*="Niche"]');
      if (nicheInput) nicheInput.value = name;
      const nameInput = document.querySelector('#ws-step1 input[placeholder*="Site Name"]');
      if (nameInput) nameInput.value = name + ' Guide';
    }, 100);
  }

  function getNicheKeywords(name) {
    showPanel('keywords');
    setTimeout(() => {
      const kw = document.querySelector('#panel-keywords input[type="text"]');
      if (kw) kw.value = name;
    }, 100);
  }
  const titles = {
    dashboard: 'Dashboard', create: 'Create New Site', pages: 'Page Generator',
    niche: 'Niche Discovery', seo: 'SEO Generator', keywords: 'Keyword Research',
    deploy: 'Deploy & Publish', sites: 'My Sites', themes: 'Theme Store', builder: 'AI Builder', design: 'Design Studio', marketing: '🧠 Marketing OS', import: 'Import Site', bookings: 'Bookings CRM', injector: 'Code Injector', settings: 'Settings', calendar: 'Content Calendar', landing: 'Landing Page Builder', blog: 'Blog Writer'
  };

  function showPanel(name, navEl) {
    document.querySelectorAll('.panel').forEach(p => p.classList.remove('active'));
    document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
    const panel = document.getElementById('panel-' + name);
    if (!panel) return;
    panel.classList.add('active');
    // Auto-find nav item by onclick attribute if not passed
    if (!navEl) {
      navEl = document.querySelector(`.nav-item[onclick*="''"]`);
    }
    if (navEl) navEl.classList.add('active');
    document.getElementById('page-title').textContent = titles[name] || name;
    // Close mobile sidebar on nav
    const sidebar = document.getElementById('sidebar');
    if (sidebar && window.innerWidth <= 768) {
      sidebar.classList.remove('open');
      const overlay = document.getElementById('sidebar-overlay');
      if (overlay) overlay.classList.remove('visible');
    }
  }

  function selectType(el) {
    document.querySelectorAll('.type-card').forEach(c => c.classList.remove('selected'));
    el.classList.add('selected');
  }

  let selectedTemplate = 'article';
  function selectTemplate(el, type) {
    document.querySelectorAll('.template-card').forEach(c => c.classList.remove('selected'));
    el.classList.add('selected');
    selectedTemplate = type;
  }

  let currentStep = 1;
  function nextStep(step) {
    document.querySelectorAll('[id^="ws-step"]').forEach(s => s.style.display = 'none');
    document.getElementById('ws-step' + step).style.display = 'block';
    for (let i = 1; i <= 4; i++) {
      const el = document.getElementById('wstep' + i);
      el.classList.remove('active', 'done');
      if (i < step) el.classList.add('done');
      if (i === step) el.classList.add('active');
    }
    currentStep = step;
    if (step === 4) animateProgress();
  }

  function animateProgress() {
    const bar = document.getElementById('build-progress');
    let w = 35;
    const iv = setInterval(() => {
      w += Math.random() * 3;
      if (w > 90) { w = 90; clearInterval(iv); }
      bar.style.width = w + '%';
    }, 800);
  }

  // ── SEO Generator ────────────────────────────────────────────
  let seoData = {};
  let seoTabSections = {};

  function seoShow(id) {
    ['seo-form-area','seo-generating','seo-output-area','seo-error'].forEach(i => {
      const el = document.getElementById(i);
      if (el) el.style.display = i === id ? 'block' : 'none';
    });
  }

  function seoProgressAnim(pct, label, activePill) {
    document.getElementById('seo-gen-progress').style.width = pct + '%';
    document.getElementById('seo-gen-label').textContent = label;
    ['spill-1','spill-2','spill-3','spill-4'].forEach((pid, idx) => {
      const el = document.getElementById(pid);
      if (!el) return;
      if (idx + 1 < activePill) {
        el.style.background = 'rgba(0,212,255,0.08)';
        el.style.borderColor = 'rgba(0,212,255,0.2)';
        el.style.color = 'var(--accent)';
        el.innerHTML = '✓ ' + el.innerHTML.replace('✓ ','').replace('✦ ','');
      } else if (idx + 1 === activePill) {
        el.style.background = 'rgba(0,212,255,0.1)';
        el.style.borderColor = 'rgba(0,212,255,0.2)';
        el.style.color = 'var(--accent)';
        el.innerHTML = '✦ ' + el.innerHTML.replace('✓ ','').replace('✦ ','');
      } else {
        el.style.background = 'var(--surface2)';
        el.style.borderColor = 'var(--border)';
        el.style.color = 'var(--muted)';
      }
    });
  }

  async function runSeoGenerator() {
    const title   = document.getElementById('seo-title').value.trim();
    const keyword = document.getElementById('seo-keyword').value.trim();
    const pageType= document.getElementById('seo-type').value;
    const schema  = document.getElementById('seo-schema').value;
    const url     = document.getElementById('seo-url').value.trim() || 'https://example.com/page';
    const brand   = document.getElementById('seo-brand').value.trim() || 'My Site';
    const brief   = document.getElementById('seo-brief').value.trim();

    const wantMeta    = document.getElementById('stog-meta').classList.contains('on');
    const wantOG      = document.getElementById('stog-og').classList.contains('on');
    const wantSchema  = document.getElementById('stog-schema').classList.contains('on');
    const wantTwitter = document.getElementById('stog-twitter').classList.contains('on');
    const wantRobots  = document.getElementById('stog-robots').classList.contains('on');
    const wantLSI     = document.getElementById('stog-lsi').classList.contains('on');

    if (!keyword && !title) { alert('Please enter at least a keyword or page topic.'); return; }

    seoShow('seo-generating');
    seoProgressAnim(10, 'Crafting optimised meta tags...', 1);

    const prompt = `You are an elite SEO specialist. Generate a complete, professional SEO package for this page.

PAGE DETAILS:
- Topic/Title: ${title || keyword}
- Primary Keyword: ${keyword || title}
- Page Type: ${pageType}
- Schema Type: ${schema}
- Full URL: ${url}
- Brand Name: ${brand}
- Brief: ${brief || 'A ' + pageType + ' page targeting "' + (keyword || title) + '"'}
- Today's Date: ${new Date().toISOString().split('T')[0]}

Respond ONLY with a valid JSON object. No explanation, no markdown, no code fences. Raw JSON only.

{
  "metaTitle": "optimised title tag 50-60 chars, keyword near start",
  "metaDescription": "compelling description 150-160 chars, includes keyword, has a call to action",
  "metaKeywords": "keyword1, keyword2, keyword3, keyword4, keyword5",
  "canonicalUrl": "${url}",
  "robotsTag": "index, follow",

  "ogTitle": "engaging OG title",
  "ogDescription": "OG description 100-120 chars",
  "ogType": "article or website",
  "ogImage": "${url}/og-image.jpg",

  "twitterCard": "summary_large_image",
  "twitterTitle": "twitter title",
  "twitterDescription": "twitter description under 120 chars",

  "schemaType": "${schema}",
  "schemaJson": { complete valid JSON-LD object for ${schema} schema with all important fields },

  "lsiKeywords": [
    {"keyword": "related keyword 1", "intent": "informational", "tip": "use in H2 heading"},
    {"keyword": "related keyword 2", "intent": "commercial", "tip": "use in intro paragraph"},
    {"keyword": "related keyword 3", "intent": "local", "tip": "use in FAQ section"},
    {"keyword": "related keyword 4", "intent": "transactional", "tip": "use in CTA section"},
    {"keyword": "related keyword 5", "intent": "informational", "tip": "use in meta description"}
  ],

  "scores": {
    "titleScore": number 0-100,
    "descScore": number 0-100,
    "keywordScore": number 0-100,
    "overallScore": number 0-100
  },

  "checklist": [
    {"item": "checklist item text", "passed": true or false},
    {"item": "...", "passed": true or false}
  ],

  "usageTip": "One practical paragraph on how to use these LSI keywords naturally in the content for maximum SEO benefit."
}

Make checklist have 6 items checking things like: keyword in title, description length, canonical set, schema included, OG tags present, keyword density guidance.
Make schemaJson a complete, valid, ready-to-use JSON-LD object.`;

    try {
      await new Promise(r => setTimeout(r, 400));
      seoProgressAnim(30, 'Building Open Graph & schema...', 2);

      // Gemini free API call
      let _geminiRaw = await geminiCall(prompt, 1000);

      seoProgressAnim(60, 'Processing schema markup...', 3);

      let raw = _geminiRaw;
      raw = raw.replace(/^```json\s*/i,'').replace(/^```\s*/,'').replace(/\s*```$/,'').trim();

      seoProgressAnim(85, 'Compiling LSI keywords...', 4);
      await new Promise(r => setTimeout(r, 500));

      seoData = JSON.parse(raw);
      seoProgressAnim(100, 'Done!', 5);
      await new Promise(r => setTimeout(r, 300));

      renderSeoOutput(seoData, keyword || title, brand);

    } catch(err) {
      console.error(err);
      seoShow('seo-error');
      document.getElementById('seo-error-msg').textContent = '⚠ ' + (err.message || 'Something went wrong. Please try again.');
    }
  }

  function renderSeoOutput(d, keyword, brand) {
    // Build tab sections
    const metaBlock = `<!-- ✦ NicheForge Meta Tags — ${keyword} -->
<title>${d.metaTitle}</title>
<meta name="description" content="${d.metaDescription}">
<meta name="keywords" content="${d.metaKeywords}">
<link rel="canonical" href="${d.canonicalUrl}">
<meta name="robots" content="${d.robotsTag}">`;

    const ogBlock = `<!-- Open Graph / Facebook -->
<meta property="og:type" content="${d.ogType}">
<meta property="og:url" content="${d.canonicalUrl}">
<meta property="og:title" content="${d.ogTitle}">
<meta property="og:description" content="${d.ogDescription}">
<meta property="og:image" content="${d.ogImage}">
<meta property="og:site_name" content="${brand}">

<!-- Twitter Card -->
<meta name="twitter:card" content="${d.twitterCard}">
<meta name="twitter:url" content="${d.canonicalUrl}">
<meta name="twitter:title" content="${d.twitterTitle}">
<meta name="twitter:description" content="${d.twitterDescription}">
<meta name="twitter:image" content="${d.ogImage}">`;

    const schemaBlock = `<!-- Schema Markup: ${d.schemaType} -->
<script type="application/ld+json">
${JSON.stringify(d.schemaJson, null, 2)}
<\/script>`;

    const keywordsBlock = (d.lsiKeywords || []).map(k =>
      `Keyword:  ${k.keyword}\nIntent:   ${k.intent}\nUsage:    ${k.tip}\n`
    ).join('\n');

    const fullBlock = [metaBlock, ogBlock, schemaBlock].join('\n\n');

    seoTabSections = { meta: metaBlock, og: ogBlock, schema: schemaBlock, keywords: keywordsBlock, full: fullBlock };

    // Scores row
    const scores = d.scores || { titleScore: 88, descScore: 92, keywordScore: 85, overallScore: 89 };
    const scoreColors = { 90: 'var(--accent)', 70: '#ffd93d', 0: 'var(--accent3)' };
    function scoreColor(n) { return n >= 90 ? 'var(--accent)' : n >= 70 ? '#ffd93d' : 'var(--accent3)'; }

    document.getElementById('seo-scores-row').innerHTML = [
      { label: 'Title Score', val: scores.titleScore },
      { label: 'Desc Score', val: scores.descScore },
      { label: 'Keyword Score', val: scores.keywordScore },
      { label: 'Overall SEO', val: scores.overallScore }
    ].map(s => `
      <div class="seo-score-card" style="border-top:2px solid ${scoreColor(s.val)}">
        <div class="seo-score-num" style="color:${scoreColor(s.val)}">${s.val}</div>
        <div class="seo-score-label">${s.label}</div>
      </div>`).join('');

    document.getElementById('seo-out-subtitle').textContent = `"${keyword}" — ${d.metaTitle.length} char title · ${d.metaDescription.length} char description`;

    // Show first tab
    document.getElementById('seo-tab-content').textContent = metaBlock;
    document.getElementById('seo-tab-title').textContent = 'Meta Tags';

    // LSI keywords
    const intentColors = { informational:'rgba(0,184,255,0.1);color:#7dd3fc', commercial:'rgba(180,79,255,0.1);color:var(--accent2)', local:'rgba(0,212,255,0.1);color:var(--accent)', transactional:'rgba(255,211,61,0.1);color:#ffd93d' };
    document.getElementById('seo-lsi-tags').innerHTML = (d.lsiKeywords || []).map(k => {
      const style = intentColors[k.intent] || 'rgba(255,107,107,0.1);color:var(--accent3)';
      return `<div style="background:${style.split(';')[0].replace('background:','')};border:1px solid ${style.split(';')[0].replace('background:','').replace('0.1','0.2')};${style.split(';')[1]};padding:6px 12px;border-radius:20px;font-size:12px;cursor:default" title="${k.tip}">
        ${k.keyword} <span style="opacity:0.6;font-size:10px">· ${k.intent}</span>
      </div>`;
    }).join('');
    document.getElementById('seo-lsi-tip').textContent = d.usageTip || '';

    // Checklist
    document.getElementById('seo-checklist').innerHTML = (d.checklist || []).map(c => `
      <div style="display:flex;align-items:center;gap:10px;padding:8px 12px;background:var(--surface2);border-radius:8px;border-left:3px solid ${c.passed ? 'var(--accent)' : 'var(--accent3)'}">
        <span style="font-size:14px">${c.passed ? '✅' : '⚠️'}</span>
        <span style="font-size:13px">${c.item}</span>
      </div>`).join('');

    seoShow('seo-output-area');
    // Reset tab state
    document.querySelectorAll('.seo-tab').forEach((t,i) => t.classList.toggle('active', i===0));
  }

  function seoTab(name, btn) {
    document.querySelectorAll('.seo-tab').forEach(t => t.classList.remove('active'));
    btn.classList.add('active');
    const titles = { meta:'Meta Tags', og:'Open Graph & Twitter', schema:'Schema JSON-LD', keywords:'LSI Keywords', full:'Full Code (Copy All)' };
    document.getElementById('seo-tab-title').textContent = titles[name] || name;
    document.getElementById('seo-tab-content').textContent = seoTabSections[name] || '';
    // Show/hide lsi card
    document.getElementById('seo-lsi-card').style.display = name === 'keywords' ? 'block' : 'none';
  }

  function seoCopySection() {
    const content = document.getElementById('seo-tab-content').textContent;
    navigator.clipboard.writeText(content).then(() => {
      const btn = event.target;
      const orig = btn.innerHTML;
      btn.innerHTML = '✓ Copied!';
      btn.style.color = 'var(--accent)';
      setTimeout(() => { btn.innerHTML = orig; btn.style.color = ''; }, 2000);
    });
  }

  function seoCopyAll() {
    const all = Object.values(seoTabSections).filter((_,i) => i < 3).join('\n\n');
    navigator.clipboard.writeText(all).then(() => {
      const btn = event.target;
      const orig = btn.innerHTML;
      btn.innerHTML = '✓ Copied!';
      btn.style.color = 'var(--accent)';
      setTimeout(() => { btn.innerHTML = orig; btn.style.color = ''; }, 2000);
    });
  }

  function seoDownload() {
    const keyword = document.getElementById('seo-keyword').value || 'seo-package';
    const slug = keyword.toLowerCase().replace(/\s+/g,'-').replace(/[^a-z0-9-]/g,'');
    const all = Object.values(seoTabSections).filter((_,i) => i < 3).join('\n\n<!-- ─────────────────────────────────── -->\n\n');
    const a = document.createElement('a');
    a.href = URL.createObjectURL(new Blob([all], { type: 'text/plain' }));
    a.download = slug + '-seo.txt';
    a.click();
  }

  function seoReset() {
    seoData = {}; seoTabSections = {};
    seoShow('seo-form-area');
    document.getElementById('seo-lsi-card').style.display = 'none';
    document.getElementById('seo-gen-progress').style.width = '5%';
  }

  // Init — hide lsi card on load
  window.addEventListener('DOMContentLoaded', () => {
    const lsi = document.getElementById('seo-lsi-card');
    if (lsi) lsi.style.display = 'none';
  });

  // ── Page Generator ───────────────────────────────────────────
  let generatedHTML = '';

  function pgShow(id) {
    ['pg-form-area','pg-generating','pg-output-area','pg-error'].forEach(i => {
      document.getElementById(i).style.display = i === id ? 'block' : 'none';
    });
  }

  function pgSetStep(n, state) {
    const el = document.getElementById('gstep-' + n);
    const icon = el.querySelector('.deploy-step-icon');
    el.style.opacity = '1';
    if (state === 'active') {
      icon.className = 'deploy-step-icon step-active';
      icon.innerHTML = '<div class="spinner"></div>';
    } else if (state === 'done') {
      icon.className = 'deploy-step-icon step-done2';
      icon.innerHTML = '✓';
    } else if (state === 'wait') {
      icon.className = 'deploy-step-icon step-pending';
      icon.innerHTML = n;
      el.style.opacity = '0.4';
    }
  }

  function pgProgress(pct, label) {
    document.getElementById('pg-progress').style.width = pct + '%';
    document.getElementById('pg-progress-label').textContent = label;
  }

  async function runPageGenerator() {
    const keyword  = document.getElementById('pg-keyword').value.trim();
    const pageType = document.getElementById('pg-type').value;
    const site     = document.getElementById('pg-site').value.trim() || 'My Site';
    const location = document.getElementById('pg-location').value.trim();
    const siteUrl  = document.getElementById('pg-siteurl').value.trim() || 'https://example.com';
    const brief    = document.getElementById('pg-brief').value.trim();
    const theme    = document.getElementById('pg-theme').value;
    const useSEO   = document.getElementById('tog-seo').classList.contains('on');
    const useSchema= document.getElementById('tog-schema').classList.contains('on');
    const useFAQ   = document.getElementById('tog-faq').classList.contains('on');
    const useCTA   = document.getElementById('tog-cta').classList.contains('on');

    if (!keyword) {
      alert('Please enter a target keyword first.');
      return;
    }

    pgShow('pg-generating');
    pgSetStep(1,'active'); pgSetStep(2,'wait'); pgSetStep(3,'wait'); pgSetStep(4,'wait');
    pgProgress(10, 'Sending to AI...');

    // Theme palettes
    const themes = {
      dark:  { bg:'#0d0d14', surface:'#13131e', text:'#e8e8f0', muted:'#888', accent:'#00e5a0', accent2:'#b44fff', header:'#0a0a0f' },
      light: { bg:'#f8f9fc', surface:'#ffffff', text:'#1a1a2e', muted:'#666', accent:'#0066cc', accent2:'#5c3dfa', header:'#ffffff' },
      blue:  { bg:'#050d1f', surface:'#0a1628', text:'#e0eeff', muted:'#7090b0', accent:'#4da6ff', accent2:'#a78bfa', header:'#030b18' },
      green: { bg:'#050f08', surface:'#0a1a0e', text:'#e0f0e4', muted:'#6a906e', accent:'#22c55e', accent2:'#84cc16', header:'#030a05' }
    };
    const t = themes[theme] || themes.dark;
    const slug = keyword.toLowerCase().replace(/\s+/g,'-').replace(/[^a-z0-9-]/g,'');
    const pageUrl = `${siteUrl.replace(/\/$/,'')}/${slug}`;
    const pageTypeLabel = { service:'Service Page', blog:'Blog Article', howto:'How-To Guide', local:'Location Page', home:'Homepage' }[pageType] || 'Page';
    const locationStr = location ? ` in ${location}` : '';
    const today = new Date().toISOString().split('T')[0];

    // Build the AI prompt
    const systemPrompt = `You are NicheForge, an expert web developer and SEO content writer. 
You produce complete, production-ready HTML pages with modern design, great content, and perfect SEO. 
Never use placeholder text. Write real, helpful, detailed content. 
Output ONLY the complete HTML document, nothing else — no explanation, no markdown fences.`;

    const userPrompt = `Create a complete, modern, fully designed HTML page for:

SITE: ${site}
PAGE TYPE: ${pageTypeLabel}
KEYWORD: ${keyword}${locationStr}
PAGE URL: ${pageUrl}
BRIEF: ${brief || `A high-quality ${pageTypeLabel.toLowerCase()} targeting "${keyword}"`}
TEMPLATE STYLE: ${selectedTemplate}
INCLUDE FAQ: ${useFAQ}
INCLUDE CTA/CONTACT FORM: ${useCTA}

DESIGN REQUIREMENTS:
- Color scheme: bg=${t.bg}, surface=${t.surface}, text=${t.text}, accent=${t.accent}
- Modern, professional, mobile-responsive layout
- Clean typography using Google Fonts (import in <head>)
- Smooth CSS animations on page load
- Hero section with gradient/overlay, headline using the keyword
- Clear sections with proper headings (H1, H2, H3 hierarchy)
- ${useFAQ ? 'FAQ section with 4–5 real questions and answers about the topic' : ''}
- ${useCTA ? 'Contact/CTA section with a styled form (name, phone, email, message) and submit button' : ''}
- Trust signals (icons, stats, or testimonial-style callouts)
- Footer with copyright and basic links
- NO Bootstrap, NO external CSS frameworks, pure CSS only
- All CSS inline in <style> tag in <head>
- Mobile hamburger menu (CSS only or minimal JS)

${useSEO ? `SEO META TAGS (include ALL of these in <head>):
- <title> tag containing the keyword naturally
- <meta name="description"> (150-160 chars, compelling, includes keyword)
- <meta name="keywords">
- <link rel="canonical" href="${pageUrl}">
- <meta name="robots" content="index, follow">
- Full Open Graph tags (og:title, og:description, og:url, og:image, og:type)
- Twitter Card tags` : ''}

${useSchema ? `SCHEMA MARKUP: Include appropriate JSON-LD in <script type="application/ld+json">
- Use ${pageType === 'local' ? 'LocalBusiness' : pageType === 'howto' ? 'HowTo' : pageType === 'blog' ? 'Article' : 'Service'} schema
- Include all relevant properties (name, description, url, datePublished: ${today})` : ''}

Write real, useful content — at least 600-800 words of body copy across all sections.
Make it look like a real professional website, not a template.`;

    try {
      pgProgress(20, 'AI writing content...');

      // Gemini: combine system + user prompt
      let _pgRaw = await geminiCall(systemPrompt + '\n\n' + userPrompt, 2000);

      pgSetStep(1,'done'); pgSetStep(2,'active');
      pgProgress(55, 'Processing SEO & schema...');

      const data = { _raw: _pgRaw };
      let html = data.content.map(b => b.text || '').join('');

      // Strip any accidental markdown fences
      html = html.replace(/^```html\s*/i,'').replace(/^```\s*/,'').replace(/\s*```$/,'').trim();

      pgSetStep(2,'done'); pgSetStep(3,'active');
      pgProgress(80, 'Applying final layout...');

      await new Promise(r => setTimeout(r, 600));

      pgSetStep(3,'done'); pgSetStep(4,'active');
      pgProgress(95, 'Finalising file...');

      await new Promise(r => setTimeout(r, 400));

      pgSetStep(4,'done');
      pgProgress(100, 'Done!');

      generatedHTML = html;

      await new Promise(r => setTimeout(r, 300));

      // Show output
      pgShow('pg-output-area');
      const fname = slug + '.html';
      document.getElementById('pg-filename-label').textContent = fname;
      document.getElementById('pg-preview-url').textContent = pageUrl;
      document.getElementById('pg-code-display').textContent = html;
      document.getElementById('pg-char-count').textContent = `${html.length.toLocaleString()} chars · ${Math.round(html.length/5)} words est.`;

    } catch (err) {
      pgShow('pg-error');
      document.getElementById('pg-error-msg').textContent = '⚠ ' + (err.message || 'Something went wrong. Please try again.');
      console.error(err);
    }
  }

  function pgTogglePreview() {
    const wrap = document.getElementById('pg-preview-wrap');
    const frame = document.getElementById('pg-preview-frame');
    if (wrap.style.display === 'none') {
      wrap.style.display = 'block';
      const blob = new Blob([generatedHTML], { type: 'text/html' });
      frame.src = URL.createObjectURL(blob);
    } else {
      wrap.style.display = 'none';
    }
  }

  function pgCopyCode() {
    if (!generatedHTML) return;
    navigator.clipboard.writeText(generatedHTML).then(() => {
      const btn = event.target;
      const orig = btn.innerHTML;
      btn.innerHTML = '✓ Copied!';
      btn.style.color = 'var(--accent)';
      setTimeout(() => { btn.innerHTML = orig; btn.style.color = ''; }, 2000);
    });
  }

  function pgDownload() {
    if (!generatedHTML) return;
    const slug = (document.getElementById('pg-keyword').value || 'page').toLowerCase().replace(/\s+/g,'-').replace(/[^a-z0-9-]/g,'');
    const a = document.createElement('a');
    a.href = URL.createObjectURL(new Blob([generatedHTML], { type: 'text/html' }));
    a.download = slug + '.html';
    a.click();
  }

  function pgReset() {
    generatedHTML = '';
    document.getElementById('pg-preview-wrap').style.display = 'none';
    pgShow('pg-form-area');
    for(let i=1;i<=4;i++) pgSetStep(i,'wait');
  }

  document.addEventListener('DOMContentLoaded', () => {
    document.querySelectorAll('.nav-item').forEach(el => {
      el.addEventListener('click', () => {
        if (window.innerWidth <= 768) {
          document.getElementById('sidebar').classList.remove('open');
          document.getElementById('sidebar-overlay').classList.remove('visible');
          document.body.style.overflow = '';
        }
      });
    });
  });

  // ── Keyword Research ─────────────────────────────────────────
  let kwData = [];

  function kwSetProgress(pct, label) {
    const b = document.getElementById('kw-progress-bar');
    const l = document.getElementById('kw-progress-label');
    if (b) b.style.width = pct + '%';
    if (l) l.textContent = label;
  }

  async function runKeywordResearch() {
    if (!requireApiKey('Keyword Research')) return;
    const seed     = document.getElementById('kw-seed').value.trim();
    const location = document.getElementById('kw-location').value.trim();
    const intent   = document.getElementById('kw-intent').value;
    const count    = document.getElementById('kw-count').value;
    const btn      = document.getElementById('kw-run-btn');

    if (!seed) { alert('Please enter a seed keyword.'); return; }

    document.getElementById('kw-placeholder').style.display = 'none';
    document.getElementById('kw-output').style.display = 'none';
    document.getElementById('kw-error').style.display = 'none';
    document.getElementById('kw-loading').style.display = 'block';
    btn.disabled = true;
    btn.innerHTML = '<span class="spinner"></span> Researching...';
    kwSetProgress(10, 'Sending to AI...');

    const locationNote = location ? ` targeting "${location}"` : '';
    const intentNote   = intent === 'all' ? 'all intents mixed' : intent;

    const prompt = `You are an expert SEO keyword researcher.

Seed keyword: "${seed}"${locationNote}
Intent focus: ${intentNote}
Count: ${count}

Return ONLY a valid JSON object. No markdown, no explanation, no code fences. Raw JSON only.

{
  "summary": {
    "totalVolume": "e.g. 245K",
    "avgDifficulty": "Easy|Medium|Hard",
    "avgCPC": "$X.XX",
    "easyWins": number
  },
  "keywords": [
    {
      "keyword": "exact keyword",
      "volume": "e.g. 8,100",
      "difficulty": "Easy"|"Medium"|"Hard",
      "intent": "Informational"|"How-To"|"Local"|"Commercial",
      "cpc": "$X.XX",
      "pageType": "Blog Article"|"How-To Guide"|"Service Page"|"Location Page"|"Review"
    }
  ]
}

Rules:
- Exactly ${count} keywords, all real and rankable
- Mix of long-tail, question, and comparison keywords
- Realistic difficulty distribution — not all Easy
- CPC reflects actual ad market value
- ${location ? `Include location-specific variants for "${location}"` : 'Include general and near-me variants'}
- Sort by opportunity: Easy first, then Medium, then Hard`;

    try {
      kwSetProgress(30, 'AI researching keywords...');
      // Gemini free API call
      let _geminiRaw = await geminiCall(prompt, 1000);
      kwSetProgress(70, 'Processing results...');
      if (!resp.ok) throw new Error('API error ' + resp.status);
      const data = await resp.json();
      let raw = data._raw || '';
      raw = raw.replace(/^```json\s*/i,'').replace(/^```/,'').replace(/```$/,'').trim();
      kwSetProgress(90, 'Building table...');
      const parsed = JSON.parse(raw);
      kwData = parsed.keywords || [];
      await new Promise(r => setTimeout(r, 300));
      kwSetProgress(100, 'Done!');
      await new Promise(r => setTimeout(r, 200));
      renderKwResults(parsed, seed, location);
    } catch (err) {
      console.error(err);
      document.getElementById('kw-loading').style.display = 'none';
      document.getElementById('kw-error').style.display = 'block';
      document.getElementById('kw-error-msg').textContent = '⚠ ' + (err.message || 'Research failed. Try again.');
    } finally {
      btn.disabled = false;
      btn.innerHTML = 'Find Keywords';
    }
  }

  function renderKwResults(parsed, seed, location) {
    const locationStr = location ? ` · ${location}` : '';
    document.getElementById('kw-results-title').textContent = `"${seed}" Keywords${locationStr}`;
    document.getElementById('kw-results-sub').textContent = `${kwData.length} keywords found`;

    const s = parsed.summary || {};
    const easyCount = s.easyWins !== undefined ? s.easyWins : kwData.filter(k=>k.difficulty==='Easy').length;
    const diffColor = s.avgDifficulty === 'Easy' ? 'var(--accent)' : s.avgDifficulty === 'Medium' ? '#ffd93d' : 'var(--accent3)';
    document.getElementById('kw-stats-row').innerHTML = [
      ['Total Vol.', s.totalVolume||'—', 'var(--accent)'],
      ['Avg Diff.', s.avgDifficulty||'—', diffColor],
      ['Avg CPC', s.avgCPC||'—', '#ffd93d'],
      ['Easy Wins', easyCount, 'var(--accent2)']
    ].map(([label,val,color]) => `
      <div style="background:var(--card);border:1px solid var(--border);border-radius:10px;padding:14px">
        <div style="font-size:10px;text-transform:uppercase;letter-spacing:1px;color:var(--muted);margin-bottom:6px">${label}</div>
        <div style="font-family:'Syne',sans-serif;font-size:22px;font-weight:800;color:${color}">${val}</div>
      </div>`).join('');

    // Reset active filter
    document.querySelectorAll('.kw-filter').forEach(b => b.classList.remove('active-filter'));
    const allBtn = document.querySelector('.kw-filter[data-filter="all"]');
    if (allBtn) allBtn.classList.add('active-filter');

    renderKwTable(kwData);
    document.getElementById('kw-loading').style.display = 'none';
    document.getElementById('kw-output').style.display = 'block';
  }

  function renderKwTable(rows) {
    const tbody = document.getElementById('kw-tbody');
    tbody.innerHTML = '';
    if (!rows.length) {
      tbody.innerHTML = '<tr><td colspan="6" style="text-align:center;padding:24px;color:var(--muted)">No keywords match this filter</td></tr>';
      return;
    }
    rows.forEach(k => {
      const diffClass = k.difficulty==='Easy' ? 'diff-easy' : k.difficulty==='Medium' ? 'diff-med' : 'diff-hard';
      const intentMap = { 'Informational':'tag-info','How-To':'tag-how','Local':'tag-local','Commercial':'tag-review' };
      const intentShort = { 'Informational':'Info','How-To':'How-To','Local':'Local','Commercial':'💰' }[k.intent] || k.intent;
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td style="padding-left:16px;font-weight:500">${k.keyword}</td>
        <td>${k.volume}</td>
        <td><span class="${diffClass}">${k.difficulty}</span></td>
        <td><span class="tag ${intentMap[k.intent]||'tag-info'}">${intentShort}</span></td>
        <td style="color:var(--muted)">${k.cpc}</td>
        <td><button class="btn btn-ghost" style="padding:4px 10px;font-size:11px"
          onclick="kwBuildPage('${k.keyword.replace(/'/g,"\\'")}','${(k.pageType||'Blog Article').replace(/'/g,"\\'")}')">Build Page</button></td>`;
      tbody.appendChild(tr);
    });
  }

  function kwFilter(btn, filter) {
    document.querySelectorAll('.kw-filter').forEach(b => b.classList.remove('active-filter'));
    btn.classList.add('active-filter');
    let filtered = kwData;
    if (filter === 'Low') filtered = kwData.filter(k => k.difficulty === 'Easy');
    else if (filter !== 'all') filtered = kwData.filter(k => k.intent === filter);
    renderKwTable(filtered);
  }

  function kwBuildPage(keyword, pageType) {
    showPanel('pages', document.querySelector('[onclick*="pages"]'));
    setTimeout(() => {
      const ki = document.getElementById('pg-keyword');
      if (ki) ki.value = keyword;
      const ts = document.getElementById('pg-type');
      if (ts) { const m={'Blog Article':'blog','How-To Guide':'howto','Service Page':'service','Location Page':'local'}; ts.value = m[pageType]||'blog'; }
    }, 150);
  }

  function kwCopyAll() {
    if (!kwData.length) return;
    const text = 'Keyword\tVolume\tDifficulty\tIntent\tCPC\n' + kwData.map(k=>`${k.keyword}\t${k.volume}\t${k.difficulty}\t${k.intent}\t${k.cpc}`).join('\n');
    navigator.clipboard.writeText(text).then(() => {
      const btn = event.target; const orig = btn.innerHTML;
      btn.innerHTML = '✓ Copied!'; setTimeout(() => btn.innerHTML = orig, 2000);
    });
  }

  function kwDownloadCSV() {
    if (!kwData.length) return;
    const seed = document.getElementById('kw-seed').value || 'keywords';
    const rows = [['Keyword','Volume','Difficulty','Intent','CPC','Page Type'], ...kwData.map(k=>[k.keyword,k.volume,k.difficulty,k.intent,k.cpc,k.pageType||''])];
    const csv = rows.map(r => r.map(c=>`"${c}"`).join(',')).join('\n');
    const a = document.createElement('a');
    a.href = URL.createObjectURL(new Blob([csv],{type:'text/csv'}));
    a.download = seed.replace(/\s+/g,'-')+'-keywords.csv';
    a.click();
  }

  function kwSendToPageGen() {
    if (kwData.length) kwBuildPage(kwData[0].keyword, kwData[0].pageType||'Blog Article');
  }

  // ── Deploy Panel ─────────────────────────────────────────────
  const platformConfigs = {
    cloudflare: {
      name: 'Cloudflare Pages',
      dnsValue: 'pages.cloudflare.com',
      steps: [
        { icon: '📁', title: 'Validating site files', desc: 'Checking HTML, assets, sitemap.xml, robots.txt' },
        { icon: '🐙', title: 'Pushing to GitHub', desc: 'Uploading files to your repository' },
        { icon: '☁', title: 'Cloudflare build triggered', desc: 'Cloudflare detects new commit and starts build' },
        { icon: '🌐', title: 'CDN propagation', desc: 'Distributing to 300+ global edge locations' },
        { icon: '🔒', title: 'SSL certificate provisioned', desc: 'HTTPS enabled automatically — free forever' },
        { icon: '🔗', title: 'Custom domain connected', desc: 'Your domain is now pointing to Cloudflare' },
      ],
      guideSteps: [
        { n:'1', title:'Go to Cloudflare Pages', body:'Visit <strong>pages.cloudflare.com</strong> → Log in or create a free account.' },
        { n:'2', title:'Create a new project', body:'Click <strong>Create a project</strong> → Connect to Git → Authorize GitHub.' },
        { n:'3', title:'Select your repository', body:'Choose your site repo → Framework preset: <strong>None</strong> → Build command: leave blank → Build output: <strong>/</strong>' },
        { n:'4', title:'Deploy', body:'Click <strong>Save and Deploy</strong>. Cloudflare builds and gives you a <em>*.pages.dev</em> URL instantly.' },
        { n:'5', title:'Add custom domain', body:'Go to Custom Domains → Add → enter your domain → add the DNS records shown here to your registrar.' },
      ]
    },
    vercel: {
      name: 'Vercel',
      dnsValue: 'cname.vercel-dns.com',
      steps: [
        { icon: '📁', title: 'Validating site files', desc: 'Checking HTML, assets, sitemap.xml, robots.txt' },
        { icon: '🐙', title: 'Pushing to GitHub', desc: 'Uploading files to your repository' },
        { icon: '▲', title: 'Vercel build triggered', desc: 'Vercel detects commit and deploys instantly' },
        { icon: '🌐', title: 'Edge network active', desc: 'Site live on Vercel global edge network' },
        { icon: '🔒', title: 'SSL certificate provisioned', desc: 'HTTPS auto-enabled via Let\'s Encrypt' },
        { icon: '🔗', title: 'Custom domain connected', desc: 'Domain pointing to Vercel servers' },
      ],
      guideSteps: [
        { n:'1', title:'Go to Vercel', body:'Visit <strong>vercel.com</strong> → Sign up free with your GitHub account.' },
        { n:'2', title:'Import project', body:'Click <strong>Add New → Project</strong> → Import your GitHub repository.' },
        { n:'3', title:'Configure', body:'Framework: <strong>Other</strong> → Root directory: <strong>/</strong> → Leave build settings blank → Deploy.' },
        { n:'4', title:'Add your domain', body:'Go to Project Settings → Domains → Add your custom domain.' },
        { n:'5', title:'Update DNS', body:'Add the CNAME record shown here at your domain registrar. SSL provisions automatically.' },
      ]
    },
    netlify: {
      name: 'Netlify',
      dnsValue: 'your-site.netlify.app',
      steps: [
        { icon: '📁', title: 'Validating site files', desc: 'Checking HTML, assets, sitemap.xml, robots.txt' },
        { icon: '⬆', title: 'Uploading to Netlify', desc: 'Files uploading via drag-and-drop or GitHub' },
        { icon: '◆', title: 'Netlify build complete', desc: 'Site is built and live on Netlify CDN' },
        { icon: '🌐', title: 'Global CDN active', desc: 'Site distributed to Netlify edge nodes' },
        { icon: '🔒', title: 'SSL auto-provisioned', desc: 'HTTPS live via Netlify automatic SSL' },
        { icon: '🔗', title: 'Custom domain live', desc: 'Your domain is now pointing to Netlify' },
      ],
      guideSteps: [
        { n:'1', title:'Go to Netlify', body:'Visit <strong>netlify.com</strong> → Sign up free (use GitHub login).' },
        { n:'2', title:'Deploy your site', body:'Option A: Drag your HTML folder into the Netlify dashboard. Option B: Connect GitHub repo.' },
        { n:'3', title:'Get your URL', body:'Netlify gives you a free <em>*.netlify.app</em> URL immediately.' },
        { n:'4', title:'Add custom domain', body:'Go to Site Settings → Domain management → Add custom domain.' },
        { n:'5', title:'Update DNS records', body:'Add the CNAME shown here to your domain registrar. SSL certificates auto-provision.' },
      ]
    }
  };

  let currentPlatform = 'cloudflare';

  function selectPlatform(platform) {
    currentPlatform = platform;
    document.querySelectorAll('.platform-tab').forEach(t => t.classList.remove('active'));
    document.getElementById('ptab-' + platform).classList.add('active');
    const cfg = platformConfigs[platform];
    // Update guide
    document.getElementById('deploy-guide-title').textContent = cfg.name + ' — Setup Guide';
    document.getElementById('deploy-steps-guide').innerHTML = cfg.guideSteps.map((s,i) => `
      <div style="display:flex;gap:12px;padding:10px 0;border-bottom:1px solid rgba(30,30,46,0.5)${i===cfg.guideSteps.length-1?';border:none':''}">
        <div style="width:24px;height:24px;border-radius:50%;background:rgba(0,212,255,0.1);border:1px solid rgba(0,212,255,0.2);color:var(--accent);font-size:11px;font-weight:700;display:flex;align-items:center;justify-content:center;flex-shrink:0;margin-top:1px">${s.n}</div>
        <div>
          <div style="font-size:13px;font-weight:600;margin-bottom:3px">${s.title}</div>
          <div style="font-size:12px;color:var(--muted);line-height:1.5">${s.body}</div>
        </div>
      </div>`).join('');
    // Update DNS
    const val = cfg.dnsValue;
    const el1 = document.getElementById('dns-val-1');
    const el2 = document.getElementById('dns-val-2');
    if (el1) el1.textContent = val;
    if (el2) el2.textContent = val;
  }

  // Init guide on load
  window.addEventListener('DOMContentLoaded', () => {
    selectPlatform('cloudflare');
    const lsi = document.getElementById('seo-lsi-card');
    if (lsi) lsi.style.display = 'none';
  });

  function updateDnsPreview() {
    const domain = document.getElementById('dep-domain').value.trim();
    if (domain && currentPlatform === 'netlify') {
      const slug = domain.replace(/\./g,'-');
      document.getElementById('dns-val-1').textContent = slug + '.netlify.app';
      document.getElementById('dns-val-2').textContent = slug + '.netlify.app';
    }
  }

  function copyDns() {
    const platform = platformConfigs[currentPlatform];
    const domain = document.getElementById('dep-domain').value || 'yourdomain.com';
    const text = `DNS Records for ${domain}\n\nType\tName\tValue\nCNAME\twww\t${platform.dnsValue}\nCNAME\t@\t${platform.dnsValue}`;
    navigator.clipboard.writeText(text).then(() => {
      const btn = event.target;
      const orig = btn.innerHTML;
      btn.innerHTML = '✓ Copied!';
      btn.style.color = 'var(--accent)';
      setTimeout(() => { btn.innerHTML = orig; btn.style.color = ''; }, 2000);
    });
  }

  function verifyDns() {
    const domain = document.getElementById('dep-domain').value.trim();
    const result = document.getElementById('dns-verify-result');
    const btn = document.getElementById('dns-verify-btn');
    if (!domain) { alert('Enter your domain first.'); return; }
    btn.innerHTML = '<span class="spinner"></span> Checking...';
    btn.disabled = true;
    setTimeout(() => {
      btn.innerHTML = '✓ Verify DNS';
      btn.disabled = false;
      result.style.display = 'block';
      // Simulate — in production you'd ping a real DNS check endpoint
      const connected = Math.random() > 0.4;
      result.style.background = connected ? 'rgba(0,212,255,0.08)' : 'rgba(255,211,61,0.08)';
      result.style.border = connected ? '1px solid rgba(0,212,255,0.2)' : '1px solid rgba(255,211,61,0.2)';
      result.style.color = connected ? 'var(--accent)' : '#ffd93d';
      result.textContent = connected
        ? `✓ ${domain} DNS is resolving correctly — your site should be live shortly.`
        : `⚠ ${domain} DNS not yet propagated. DNS changes can take up to 24h. Check again soon.`;
    }, 2200);
  }

  async function runDeploySimulation() {
    const siteName = document.getElementById('dep-sitename').value.trim() || 'My Site';
    const ghUser   = document.getElementById('dep-ghuser').value.trim();
    const repo     = document.getElementById('dep-repo').value.trim();
    const domain   = document.getElementById('dep-domain').value.trim();

    if (!ghUser || !repo) {
      alert('Please enter your GitHub username and repository name.');
      return;
    }

    const cfg = platformConfigs[currentPlatform];
    const progCard = document.getElementById('deploy-progress-card');
    const successCard = document.getElementById('deploy-success-card');

    successCard.style.display = 'none';
    progCard.style.display = 'block';
    document.getElementById('deploy-prog-title').textContent = `Deploying ${siteName} to ${cfg.name}...`;

    const stepsEl = document.getElementById('deploy-prog-steps');
    stepsEl.innerHTML = cfg.steps.map((s,i) => `
      <div class="deploy-prog-step" id="dpstep-${i}" style="opacity:${i===0?1:0.35}">
        <div class="deploy-step-icon ${i===0?'step-active':'step-pending'}" id="dpicon-${i}">${i===0?'<div class="spinner"></div>':i+1}</div>
        <div class="deploy-step-info">
          <div class="deploy-step-name">${s.icon} ${s.title}</div>
          <div class="deploy-step-desc">${s.desc}</div>
        </div>
        <div style="font-size:11px;color:var(--muted)" id="dptime-${i}">${i===0?'Running':'Waiting'}</div>
      </div>`).join('');

    const bar = document.getElementById('deploy-prog-bar');
    const label = document.getElementById('deploy-prog-label');
    const totalSteps = cfg.steps.length;
    const delays = [1200, 900, 1400, 1100, 900, 800];

    for (let i = 0; i < totalSteps; i++) {
      if (i > 0) {
        // Mark previous done
        const prevIcon = document.getElementById('dpicon-' + (i-1));
        const prevStep = document.getElementById('dpstep-' + (i-1));
        prevIcon.className = 'deploy-step-icon step-done2';
        prevIcon.innerHTML = '✓';
        document.getElementById('dptime-' + (i-1)).textContent = 'Done';
        document.getElementById('dptime-' + (i-1)).style.color = 'var(--accent)';
        // Activate current
        const curIcon = document.getElementById('dpicon-' + i);
        const curStep = document.getElementById('dpstep-' + i);
        curIcon.className = 'deploy-step-icon step-active';
        curIcon.innerHTML = '<div class="spinner"></div>';
        curStep.style.opacity = '1';
        document.getElementById('dptime-' + i).textContent = 'Running';
      }
      const pct = Math.round(((i + 0.5) / totalSteps) * 100);
      bar.style.width = pct + '%';
      label.textContent = cfg.steps[i].title + '...';
      await new Promise(r => setTimeout(r, delays[i] || 1000));
    }

    // Final done
    const lastIcon = document.getElementById('dpicon-' + (totalSteps - 1));
    lastIcon.className = 'deploy-step-icon step-done2';
    lastIcon.innerHTML = '✓';
    document.getElementById('dptime-' + (totalSteps - 1)).textContent = 'Done';
    document.getElementById('dptime-' + (totalSteps - 1)).style.color = 'var(--accent)';
    bar.style.width = '100%';
    label.textContent = 'Deployment complete!';

    await new Promise(r => setTimeout(r, 500));
    progCard.style.display = 'none';

    const liveUrl = domain ? domain : `${repo}.${currentPlatform === 'cloudflare' ? 'pages.dev' : currentPlatform === 'vercel' ? 'vercel.app' : 'netlify.app'}`;
    document.getElementById('deploy-success-url').textContent = 'https://' + liveUrl;
    document.getElementById('deploy-success-msg').textContent = `✓ ${siteName} is live on ${cfg.name} — SSL active, CDN enabled, globally distributed. ${domain ? 'Your custom domain is connected.' : 'Add a custom domain in the DNS section above.'}`;
    successCard.style.display = 'block';

    // Add to history
    const history = document.getElementById('deploy-history-list');
    const now = new Date();
    const timeStr = now.getHours() + ':' + String(now.getMinutes()).padStart(2,'0');
    const newEntry = document.createElement('div');
    newEntry.className = 'deploy-step';
    newEntry.style.cssText = 'padding:12px 0;animation:fadeIn 0.3s ease';
    newEntry.innerHTML = `
      <div class="deploy-step-icon step-done2">✓</div>
      <div class="deploy-step-info">
        <div class="deploy-step-name">${siteName} <span style="font-size:10px;background:rgba(0,212,255,0.1);color:var(--accent);padding:2px 7px;border-radius:10px;margin-left:6px">Live</span></div>
        <div class="deploy-step-desc">${liveUrl} · ${cfg.name}</div>
      </div>
      <div class="deploy-step-time">Just now</div>`;
    history.insertBefore(newEntry, history.firstChild);
  }

  function resetDeploy() {
    document.getElementById('deploy-success-card').style.display = 'none';
    document.getElementById('deploy-progress-card').style.display = 'none';
  }

  // ── Dashboard Live ───────────────────────────────────────────
  const dashState = {
    pagesGenerated: parseInt(localStorage.getItem('nf_pages')||'47'),
    keywords: parseInt(localStorage.getItem('nf_keywords')||'184'),
    deployments: parseInt(localStorage.getItem('nf_deploys')||'9'),
  };
  function saveDashState() {
    try { localStorage.setItem('nf_pages', dashState.pagesGenerated); } catch(e) {}
    localStorage.setItem('nf_keywords', dashState.keywords);
    try { localStorage.setItem('nf_deploys', dashState.deployments); } catch(e) {}
  }
  function animateCount(elId, target) {
    const el = document.getElementById(elId); if (!el) return;
    let c = 0; const step = Math.ceil(target/25);
    const iv = setInterval(() => { c = Math.min(c+step,target); el.textContent = c; if(c>=target){clearInterval(iv);el.classList.add('loaded');} }, 30);
  }
  function drawSparkline(id, data, color) {
    const el = document.getElementById(id); if (!el) return;
    const max = Math.max(...data);
    el.innerHTML = data.map(v=>`<span class="spark-bar" style="height:${Math.max(4,Math.round(v/max*28))}px;width:10px;background:${color}"></span>`).join('');
  }
  function setGreeting() {
    const h = new Date().getHours();
    const g = h<12?'Good morning':h<17?'Good afternoon':'Good evening';
    const el = document.getElementById('dash-greeting'); if(el) el.textContent = g;
    const d = document.getElementById('dash-date'); if(d) d.textContent = new Date().toLocaleDateString('en-GB',{weekday:'long',day:'numeric',month:'long',year:'numeric'});
  }
  function renderHealthList() {
    const sites = [
      {name:'Home Repair Pro',score:88,issues:'Mobile speed could improve',color:'#00e5a0'},
      {name:'DIY Repair Hub',score:94,issues:'All good — top performer',color:'#00e5a0'},
      {name:'AC Repair Guide',score:71,issues:'Missing schema on 3 pages',color:'#ffd93d'},
    ];
    const el = document.getElementById('health-list'); if(!el) return;
    el.innerHTML = sites.map(s=>`
      <div class="health-item">
        <div class="health-score" style="color:${s.color}">${s.score}</div>
        <div style="flex:1;min-width:0">
          <div style="font-size:12.5px;font-weight:600;margin-bottom:4px">${s.name}</div>
          <div class="health-bar-wrap"><div class="health-bar" style="width:0%;background:${s.color}" data-target="${s.score}"></div></div>
          <div style="font-size:11px;color:var(--muted);margin-top:4px">${s.issues}</div>
        </div>
      </div>`).join('');
    const hl = document.getElementById('health-loading'); if(hl) hl.style.display='none';
    setTimeout(() => document.querySelectorAll('.health-bar').forEach(b=>b.style.width=b.dataset.target+'%'), 300);
  }
  async function loadDashboardInsights() {
    const el = document.getElementById('insights-list');
    const ll = document.getElementById('insights-loading');
    if (!el) return;
    try {
      const _insightsPrompt = `Give 3 short actionable daily insights for a website operator running: home repair service site, DIY repair blog, AC repair niche site. Uses AdSense, focused on SEO. Today: ${new Date().toLocaleDateString()}.
Respond ONLY with JSON array, no markdown:
[{"icon":"emoji","title":"short title","insight":"1-2 sentences","action":"short CTA","panel":"pages or seo or keywords or niche or dashboard"}]`;
      let raw = await geminiCall(_insightsPrompt, 1000);
      raw = raw.replace(/^```json\s*/i,'').replace(/^```/,'').replace(/```$/,'').trim();
      const insights = JSON.parse(raw);
      if(ll) ll.style.display='none';
      el.innerHTML = insights.map((ins,i)=>`
        <div class="insight-item" style="animation-delay:${i*.1}s;border-left-color:${['var(--accent)','var(--accent2)','#ffd93d'][i]}">
          <div class="insight-icon">${ins.icon}</div>
          <div>
            <div style="font-size:12px;font-weight:700;margin-bottom:3px">${ins.title}</div>
            <div class="insight-text">${ins.insight}</div>
            <span class="insight-action" onclick="showPanel('${ins.panel||'dashboard'}',null)">→ ${ins.action}</span>
          </div>
        </div>`).join('');
    } catch(e) {
      if(ll) ll.style.display='none';
      if(el) el.innerHTML = `
        <div class="insight-item"><div class="insight-icon">💡</div><div class="insight-text">Add FAQ schema to your AC Repair Guide — earn rich snippets and boost CTR up to 30%.<span class="insight-action" onclick="showPanel('seo',null)">→ SEO Generator</span></div></div>
        <div class="insight-item" style="border-left-color:var(--accent2)"><div class="insight-icon">📈</div><div class="insight-text">Summer is peak season for AC repair searches. Build 3 city pages now to capture the traffic spike.<span class="insight-action" onclick="showPanel('pages',null)">→ Generate Pages</span></div></div>
        <div class="insight-item" style="border-left-color:#ffd93d"><div class="insight-icon">🔍</div><div class="insight-text">Appliance repair is an adjacent niche with 196K monthly searches and low competition — perfect for your next site.<span class="insight-action" onclick="showPanel('niche',null)">→ Find Niches</span></div></div>`;
    }
  }
  function refreshDashboard() {
    animateCount('ds-sites',3); animateCount('ds-pages',dashState.pagesGenerated);
    animateCount('ds-kw',dashState.keywords); animateCount('ds-deploys',dashState.deployments);
    ['ds-sites-sub','ds-pages-sub','ds-deploys-sub'].forEach(id=>{
      const el=document.getElementById(id); if(el){el.className='stat-sub up';}
    });
    document.getElementById('ds-sites-sub').textContent='↑ 1 this month';
    document.getElementById('ds-pages-sub').textContent='↑ 12 this week';
    document.getElementById('ds-kw-sub').textContent='Across all sites';
    document.getElementById('ds-deploys-sub').textContent='↑ 3 live today';
    drawSparkline('ds-sites-spark',[1,1,2,2,2,3,3],'var(--accent)');
    drawSparkline('ds-pages-spark',[18,22,29,33,38,44,47],'var(--accent2)');
    drawSparkline('ds-kw-spark',[90,110,130,150,165,178,184],'#ffd93d');
    drawSparkline('ds-deploys-spark',[2,3,4,5,6,8,9],'var(--accent3)');
    renderHealthList();
  }

  // ── Site Import ──────────────────────────────────────────────
  let importedHTML = '';
  function impShow(id) {
    ['imp-generating','imp-output','imp-error'].forEach(i=>{
      const el=document.getElementById(i); if(el) el.style.display=i===id?'block':'none';
    });
    const form=document.querySelector('#panel-import .form-section');
    if(form) form.style.display=(id==='imp-generating'||id==='imp-output')?'none':'block';
  }
  async function runSiteImport() {
    if (!requireApiKey('Site Import')) return;
    const html=document.getElementById('imp-html').value.trim();
    const name=document.getElementById('imp-name').value.trim()||'My Site';
    const domain=document.getElementById('imp-domain').value.trim()||'example.com';
    const theme=document.getElementById('imp-theme').value;
    const preserve=document.getElementById('imp-preserve').value;
    if(!html||html.length<100){alert('Please paste your existing HTML first.');return;}
    impShow('imp-generating');
    document.getElementById('imp-progress').style.width='10%';
    document.getElementById('imp-label').textContent='Scanning for GA4, AdSense, SEO codes...';
    const ga4=html.match(/G-[A-Z0-9]{8,12}/);
    const ads=html.match(/ca-pub-\d{16}/);
    const titleM=html.match(/<title[^>]*>([^<]+)<\/title>/i);
    const detected=[];
    if(ga4) detected.push({label:'GA4',val:ga4[0],icon:'📊',color:'var(--accent)'});
    if(ads) detected.push({label:'AdSense',val:ads[0],icon:'💰',color:'#ffd93d'});
    if(titleM) detected.push({label:'Title',val:titleM[1].substring(0,35)+'…',icon:'📝',color:'var(--accent2)'});
    const detEl=document.getElementById('imp-detected');
    if(detected.length&&detEl){
      detEl.style.display='block';
      detEl.innerHTML='<div style="font-size:11px;color:var(--muted);margin-bottom:8px;text-transform:uppercase;letter-spacing:1px">Detected & preserving:</div>'+
        detected.map(d=>`<div style="display:flex;align-items:center;gap:8px;padding:6px 10px;background:var(--card);border-radius:6px;margin-bottom:6px;font-size:12px">${d.icon} <span style="color:var(--muted)">${d.label}:</span> <span style="color:${d.color};font-family:'Courier New',monospace;font-size:11px">${d.val}</span></div>`).join('');
    }
    await new Promise(r=>setTimeout(r,900));
    document.getElementById('imp-progress').style.width='40%';
    document.getElementById('imp-label').textContent='AI rebuilding with modern design...';
    const themeMap={dark:{bg:'#0d0d14',text:'#e8e8f0',accent:'#00e5a0'},light:{bg:'#f8f9fc',text:'#1a1a2e',accent:'#0066cc'},blue:{bg:'#050d1f',text:'#e0eeff',accent:'#4da6ff'},green:{bg:'#050f08',text:'#e0f0e4',accent:'#22c55e'}};
    const t=themeMap[theme]||themeMap.dark;
    try {
      const _importPrompt = `Rebuild this website with a modern design. Preserve ALL tracking codes and SEO.

EXISTING HTML (first 3500 chars):
${html.substring(0,3500)}

Site: ${name} | Domain: ${domain} | Theme: bg=${t.bg}, text=${t.text}, accent=${t.accent}
Preserve: ${preserve}
${ga4?'KEEP GA4: '+ga4[0]:''}
${ads?'KEEP ADSENSE: '+ads[0]:''}

Rules: Keep all meta SEO tags. Keep all tracking scripts verbatim. Modernise layout, typography, mobile responsiveness. Use Google Fonts. Output ONLY the complete HTML, no markdown.`;
      let rebuilt = await geminiCall(_importPrompt, 4096);
      rebuilt = rebuilt.replace(/^```html\s*/i,'').replace(/^```/,'').replace(/```$/,'').trim();
      document.getElementById('imp-progress').style.width='85%';
      document.getElementById('imp-progress').style.width='100%';
      await new Promise(r=>setTimeout(r,300));
      importedHTML=rebuilt;
      impShow('imp-output');
      document.getElementById('imp-summary').textContent=`${name} — ${rebuilt.length.toLocaleString()} chars · ${detected.length} codes preserved`;
      document.getElementById('imp-preview-url').textContent='https://'+domain;
      const strip=document.getElementById('imp-codes-strip');
      strip.innerHTML=detected.length
        ? detected.map(d=>`<div style="display:inline-flex;align-items:center;gap:6px;background:rgba(0,212,255,0.07);border:1px solid rgba(0,212,255,0.15);border-radius:20px;padding:5px 12px;font-size:11px">${d.icon} <span style="color:var(--muted)">${d.label}</span> <span style="color:var(--accent);font-weight:600">Preserved ✓</span></div>`).join('')
        : '<div style="font-size:12px;color:var(--muted)">No GA4/AdSense codes detected — check your pasted HTML contains the full source</div>';
      document.getElementById('imp-code-display').textContent=rebuilt;
      dashState.pagesGenerated++; saveDashState();
    } catch(e) {
      impShow('imp-error');
      document.getElementById('imp-error-msg').textContent='⚠ '+(e.message||'Import failed. Try again.');
    }
  }
  function impPreview() {
    const w=document.getElementById('imp-preview-wrap'),f=document.getElementById('imp-preview-frame');
    if(w.style.display==='none'){w.style.display='block';f.src=URL.createObjectURL(new Blob([importedHTML],{type:'text/html'}));}
    else w.style.display='none';
  }
  function impCopy() {
    if(!importedHTML) return;
    navigator.clipboard.writeText(importedHTML).then(()=>{
      const b=event.target,o=b.innerHTML; b.innerHTML='✓ Copied!'; b.style.color='var(--accent)';
      setTimeout(()=>{b.innerHTML=o;b.style.color=''},2000);
    });
  }
  function impDownload() {
    if(!importedHTML) return;
    const n=(document.getElementById('imp-name').value||'site').toLowerCase().replace(/\s+/g,'-');
    const a=document.createElement('a'); a.href=URL.createObjectURL(new Blob([importedHTML],{type:'text/html'}));
    a.download=n+'-rebuilt.html'; a.click();
  }
  function impReset() {
    importedHTML='';
    document.getElementById('imp-html').value='';
    const pw=document.getElementById('imp-preview-wrap'); if(pw) pw.style.display='none';
    const det=document.getElementById('imp-detected'); if(det) det.style.display='none';
    const pb=document.getElementById('imp-progress'); if(pb) pb.style.width='5%';
    impShow('none');
    const form=document.querySelector('#panel-import .form-section'); if(form) form.style.display='block';
  }

  // ── Code Injector ─────────────────────────────────────────────
  let injectors = JSON.parse(localStorage.getItem('nf_injectors') || '{}');

  function saveAllInjectors() {
    injectors = {
      gtm: {
        enabled: document.getElementById('inj-enable-gtm')?.checked || false,
        id:      document.getElementById('inj-gtm-id')?.value.trim() || '',
      },
      ga4: {
        enabled: document.getElementById('inj-enable-ga4')?.checked || false,
        id:      document.getElementById('inj-ga4-id')?.value.trim() || '',
        config:  document.getElementById('inj-ga4-config')?.value.trim() || '',
      },
      adsense: {
        enabled:      document.getElementById('inj-enable-adsense')?.checked || false,
        pub:          document.getElementById('inj-ads-pub')?.value.trim() || '',
        mode:         document.getElementById('inj-ads-mode')?.value || 'auto',
        headerSlot:   document.getElementById('inj-ads-header-slot')?.value.trim() || '',
        incontentSlot:document.getElementById('inj-ads-incontent-slot')?.value.trim() || '',
        sidebarSlot:  document.getElementById('inj-ads-sidebar-slot')?.value.trim() || '',
        footerSlot:   document.getElementById('inj-ads-footer-slot')?.value.trim() || '',
      },
      custom: {
        enabled: document.getElementById('inj-enable-custom')?.checked || false,
        head:    document.getElementById('inj-custom-head')?.value || '',
        body:    document.getElementById('inj-custom-body')?.value || '',
      }
    };
    localStorage.setItem('nf_injectors', JSON.stringify(injectors));
    renderInjectorStatus();
    validateAll();
    // Show/hide manual ad units
    const mode = injectors.adsense?.mode;
    const manualEl = document.getElementById('inj-manual-units');
    if (manualEl) manualEl.style.display = (mode === 'manual' || mode === 'both') ? 'block' : 'none';
  }

  function loadInjectors() {
    if (!injectors || !Object.keys(injectors).length) return;
    const set = (id, val) => { const el = document.getElementById(id); if(el) el.value = val||''; };
    const check = (id, val) => { const el = document.getElementById(id); if(el) el.checked = !!val; };

    check('inj-enable-gtm',     injectors.gtm?.enabled);
    set  ('inj-gtm-id',         injectors.gtm?.id);
    check('inj-enable-ga4',     injectors.ga4?.enabled);
    set  ('inj-ga4-id',         injectors.ga4?.id);
    set  ('inj-ga4-config',     injectors.ga4?.config);
    check('inj-enable-adsense', injectors.adsense?.enabled);
    set  ('inj-ads-pub',        injectors.adsense?.pub);
    const modeEl = document.getElementById('inj-ads-mode');
    if (modeEl && injectors.adsense?.mode) modeEl.value = injectors.adsense.mode;
    set  ('inj-ads-header-slot',    injectors.adsense?.headerSlot);
    set  ('inj-ads-incontent-slot', injectors.adsense?.incontentSlot);
    set  ('inj-ads-sidebar-slot',   injectors.adsense?.sidebarSlot);
    set  ('inj-ads-footer-slot',    injectors.adsense?.footerSlot);
    check('inj-enable-custom',  injectors.custom?.enabled);
    set  ('inj-custom-head',    injectors.custom?.head);
    set  ('inj-custom-body',    injectors.custom?.body);

    const mode = injectors.adsense?.mode;
    const manualEl = document.getElementById('inj-manual-units');
    if (manualEl) manualEl.style.display = (mode === 'manual' || mode === 'both') ? 'block' : 'none';

    renderInjectorStatus();
    validateAll();
  }

  function renderInjectorStatus() {
    const bar = document.getElementById('injector-status-bar'); if (!bar) return;
    const items = [
      { key:'gtm',     label:'GTM',     data: injectors.gtm },
      { key:'ga4',     label:'GA4',     data: injectors.ga4 },
      { key:'adsense', label:'AdSense', data: injectors.adsense },
      { key:'custom',  label:'Custom',  data: injectors.custom },
    ];
    bar.innerHTML = items.map(item => {
      const hasId = item.key === 'adsense' ? !!item.data?.pub : item.key === 'custom' ? !!(item.data?.head||item.data?.body) : !!item.data?.id;
      const active = item.data?.enabled && hasId;
      const color  = active ? 'var(--accent)' : hasId ? '#ffd93d' : 'var(--muted)';
      const status = active ? '● Active' : hasId ? '○ Set but disabled' : '○ Not configured';
      return `<div style="display:flex;align-items:center;gap:7px;padding:6px 12px;background:${active?'rgba(0,212,255,0.06)':'var(--surface2)'};border:1px solid ${active?'rgba(0,212,255,0.15)':'var(--border)'};border-radius:8px;font-size:12px">
        <span style="color:${color};font-size:9px">●</span>
        <span style="font-weight:600">${item.label}</span>
        <span style="color:var(--muted);font-size:11px">${status}</span>
      </div>`;
    }).join('');
  }

  function setPillStatus(id, state, text) {
    const el = document.getElementById(id); if (!el) return;
    el.className = 'inj-status-pill' + (state === 'active' ? ' active' : state === 'error' ? ' error' : '');
    el.textContent = text;
  }

  function setCardActive(cardId, active) {
    const el = document.getElementById(cardId); if (!el) return;
    if (active) el.classList.add('inj-active'); else el.classList.remove('inj-active');
  }

  function validateGTM() {
    const id = document.getElementById('inj-gtm-id')?.value.trim();
    const valid = /^GTM-[A-Z0-9]{4,10}$/.test(id);
    const preview = document.getElementById('inj-gtm-preview');
    if (id && valid) {
      setPillStatus('inj-status-gtm', 'active', '✓ Valid');
      if (preview) {
        preview.style.display = 'block';
        const headCode = document.getElementById('inj-gtm-head-code');
        const bodyCode = document.getElementById('inj-gtm-body-code');
        if (headCode) headCode.textContent = `<!-- Google Tag Manager -->
<script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
})(window,document,'script','dataLayer','${id}');<\/script>
<!-- End Google Tag Manager -->`;
        if (bodyCode) bodyCode.textContent = `<!-- Google Tag Manager (noscript) -->
<noscript><iframe src="https://www.googletagmanager.com/ns.html?id=${id}"
height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
<!-- End Google Tag Manager (noscript) -->`;
      }
    } else if (id) {
      setPillStatus('inj-status-gtm', 'error', '✗ Invalid ID');
      if (preview) preview.style.display = 'none';
    } else {
      setPillStatus('inj-status-gtm', '', 'Not set');
      if (preview) preview.style.display = 'none';
    }
    saveAllInjectors();
  }

  function validateGA4() {
    const id = document.getElementById('inj-ga4-id')?.value.trim();
    const valid = /^G-[A-Z0-9]{8,12}$/.test(id);
    const preview = document.getElementById('inj-ga4-preview');
    if (id && valid) {
      setPillStatus('inj-status-ga4', 'active', '✓ Valid');
      if (preview) {
        preview.style.display = 'block';
        const el = document.getElementById('inj-ga4-code');
        const extra = document.getElementById('inj-ga4-config')?.value.trim();
        if (el) el.textContent = `<!-- Google Analytics 4 -->
<script async src="https://www.googletagmanager.com/gtag/js?id=${id}"><\/script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());
  gtag('config', '${id}'${extra ? ', {'+extra+'}' : ''});
<\/script>
<!-- End Google Analytics 4 -->`;
      }
    } else if (id) {
      setPillStatus('inj-status-ga4', 'error', '✗ Invalid ID');
      if (preview) preview.style.display = 'none';
    } else {
      setPillStatus('inj-status-ga4', '', 'Not set');
      if (preview) preview.style.display = 'none';
    }
    saveAllInjectors();
  }

  function validateAdSense() {
    const pub = document.getElementById('inj-ads-pub')?.value.trim();
    const valid = /^ca-pub-\d{16}$/.test(pub);
    const preview = document.getElementById('inj-adsense-preview');
    if (pub && valid) {
      setPillStatus('inj-status-adsense', 'active', '✓ Valid');
      if (preview) {
        preview.style.display = 'block';
        const el = document.getElementById('inj-adsense-code');
        if (el) el.textContent = `<!-- Google AdSense -->
<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=${pub}"
     crossorigin="anonymous"><\/script>
<!-- End Google AdSense -->`;
      }
    } else if (pub) {
      setPillStatus('inj-status-adsense', 'error', '✗ Invalid — should be ca-pub-XXXXXXXXXXXXXXXX');
      if (preview) preview.style.display = 'none';
    } else {
      setPillStatus('inj-status-adsense', '', 'Not set');
      if (preview) preview.style.display = 'none';
    }
    saveAllInjectors();
  }

  function validateCustom() {
    const head = document.getElementById('inj-custom-head')?.value.trim();
    const body = document.getElementById('inj-custom-body')?.value.trim();
    if (head || body) {
      setPillStatus('inj-status-custom', 'active', `✓ ${[head&&'head',body&&'body'].filter(Boolean).join(' + ')} code set`);
    } else {
      setPillStatus('inj-status-custom', '', 'Not set');
    }
    saveAllInjectors();
  }

  function validateAll() {
    validateGTM(); validateGA4(); validateAdSense(); validateCustom();
  }

  function testAllInjectors() {
    const card = document.getElementById('inj-test-card');
    if (!card) return;
    const { headCode, bodyCode } = buildInjectedCode();
    card.style.display = 'block';
    card.scrollIntoView({ behavior:'smooth', block:'nearest' });
    const headEl = document.getElementById('inj-test-head');
    const bodyEl = document.getElementById('inj-test-body');
    if (headEl) headEl.textContent = headCode || '(no head code active)';
    if (bodyEl) bodyEl.textContent = bodyCode || '(no body code active)';
  }

  // Core function — builds the combined head + body injection strings
  function buildInjectedCode() {
    const inj = JSON.parse(localStorage.getItem('nf_injectors') || '{}');
    let headCode = '';
    let bodyCode = '';

    // GTM
    if (inj.gtm?.enabled && inj.gtm?.id) {
      headCode += `\n<!-- Google Tag Manager -->\n<script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src='https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);})(window,document,'script','dataLayer','${inj.gtm.id}');<\/script>\n<!-- End Google Tag Manager -->\n`;
      bodyCode += `\n<!-- Google Tag Manager (noscript) -->\n<noscript><iframe src="https://www.googletagmanager.com/ns.html?id=${inj.gtm.id}" height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>\n<!-- End Google Tag Manager (noscript) -->\n`;
    }

    // GA4 (only if GTM not active — avoid double tracking)
    if (inj.ga4?.enabled && inj.ga4?.id && !inj.gtm?.enabled) {
      headCode += `\n<!-- Google Analytics 4 -->\n<script async src="https://www.googletagmanager.com/gtag/js?id=${inj.ga4.id}"><\/script>\n<script>\n  window.dataLayer = window.dataLayer || [];\n  function gtag(){dataLayer.push(arguments);}\n  gtag('js', new Date());\n  gtag('config', '${inj.ga4.id}');\n<\/script>\n<!-- End Google Analytics 4 -->\n`;
    } else if (inj.ga4?.enabled && inj.ga4?.id && inj.gtm?.enabled) {
      headCode += `\n<!-- GA4 note: Tracking via GTM (${inj.gtm.id}) — add GA4 tag inside GTM for cleaner setup -->\n`;
    }

    // AdSense
    if (inj.adsense?.enabled && inj.adsense?.pub) {
      headCode += `\n<!-- Google AdSense -->\n<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=${inj.adsense.pub}" crossorigin="anonymous"><\/script>\n<!-- End Google AdSense -->\n`;
    }

    // Custom
    if (inj.custom?.enabled) {
      if (inj.custom.head) headCode += `\n<!-- Custom head code -->\n${inj.custom.head}\n<!-- End custom head code -->\n`;
      if (inj.custom.body) bodyCode += `\n<!-- Custom body code -->\n${inj.custom.body}\n<!-- End custom body code -->\n`;
    }

    return { headCode: headCode.trim(), bodyCode: bodyCode.trim() };
  }

  // Expose for use by Page Generator and Import
  window.getNFHeadCode = () => buildInjectedCode().headCode;
  window.getNFBodyCode = () => buildInjectedCode().bodyCode;

  function copyInjectedHead() {
    const { headCode } = buildInjectedCode();
    navigator.clipboard.writeText(headCode).then(() => {
      const btn = event.target; const orig = btn.innerHTML;
      btn.innerHTML = '✓ Copied!'; btn.style.color='var(--accent)';
      setTimeout(()=>{ btn.innerHTML=orig; btn.style.color=''; },2000);
    });
  }

  function copyInjectedBody() {
    const { bodyCode } = buildInjectedCode();
    navigator.clipboard.writeText(bodyCode).then(() => {
      const btn = event.target; const orig = btn.innerHTML;
      btn.innerHTML = '✓ Copied!'; btn.style.color='var(--accent)';
      setTimeout(()=>{ btn.innerHTML=orig; btn.style.color=''; },2000);
    });
  }

  // Init injectors on load
  document.addEventListener('DOMContentLoaded', () => {
    titles['injector'] = 'Code Injector';
    setTimeout(loadInjectors, 150);
  });
  let bookings = JSON.parse(localStorage.getItem('nf_bookings') || '[]');
  let editingBookingId = null;

  function saveBookingsToStorage() {
    localStorage.setItem('nf_bookings', JSON.stringify(bookings));
    updateBookingsBadge();
    updateCrmStats();
  }

  function updateBookingsBadge() {
    const pending = bookings.filter(b => b.status === 'pending').length;
    const badge = document.getElementById('bookings-badge');
    if (badge) {
      badge.textContent = pending;
      badge.style.display = pending > 0 ? 'inline-flex' : 'none';
    }
  }

  function updateCrmStats() {
    const total     = bookings.length;
    const pending   = bookings.filter(b => b.status === 'pending').length;
    const confirmed = bookings.filter(b => b.status === 'confirmed').length;
    const done      = bookings.filter(b => b.status === 'completed').length;
    const setStat = (id, val) => { const el = document.getElementById(id); if(el) el.textContent = val; };
    setStat('crm-stat-total', total);
    setStat('crm-stat-pending', pending);
    setStat('crm-stat-confirmed', confirmed);
    setStat('crm-stat-done', done);
  }

  function openBookingModal(id = null) {
    editingBookingId = id;
    const modal = document.getElementById('booking-modal');
    const title = document.getElementById('booking-modal-title');
    // Set default date to tomorrow
    const tomorrow = new Date(); tomorrow.setDate(tomorrow.getDate() + 1);
    const dateStr = tomorrow.toISOString().split('T')[0];

    if (id) {
      const b = bookings.find(b => b.id === id);
      if (!b) return;
      title.textContent = 'Edit Booking';
      document.getElementById('bk-name').value     = b.name || '';
      document.getElementById('bk-phone').value    = b.phone || '';
      document.getElementById('bk-email').value    = b.email || '';
      document.getElementById('bk-appliance').value= b.appliance || '';
      document.getElementById('bk-brand').value    = b.brand || '';
      document.getElementById('bk-site').value     = b.site || '';
      document.getElementById('bk-date').value     = b.date || '';
      document.getElementById('bk-time').value     = b.time || '';
      document.getElementById('bk-address').value  = b.address || '';
      document.getElementById('bk-status').value   = b.status || 'pending';
      document.getElementById('bk-notes').value    = b.notes || '';
      document.getElementById('bk-save-btn').textContent = 'Update Booking';
    } else {
      title.textContent = 'New Booking';
      ['bk-name','bk-phone','bk-email','bk-brand','bk-address','bk-notes'].forEach(id => {
        const el = document.getElementById(id); if(el) el.value = '';
      });
      document.getElementById('bk-appliance').value = '';
      document.getElementById('bk-status').value    = 'pending';
      document.getElementById('bk-date').value      = dateStr;
      document.getElementById('bk-save-btn').textContent = 'Save Booking';
    }
    modal.classList.add('open');
    document.body.style.overflow = 'hidden';
  }

  function closeBookingModal() {
    document.getElementById('booking-modal').classList.remove('open');
    document.body.style.overflow = '';
    editingBookingId = null;
  }

  function saveBooking() {
    const name      = document.getElementById('bk-name').value.trim();
    const phone     = document.getElementById('bk-phone').value.trim();
    const appliance = document.getElementById('bk-appliance').value;
    const date      = document.getElementById('bk-date').value;
    if (!name || !phone || !appliance || !date) {
      alert('Please fill in Name, Phone, Appliance, and Date.'); return;
    }
    const booking = {
      id:        editingBookingId || 'bk_' + Date.now(),
      name, phone,
      email:     document.getElementById('bk-email').value.trim(),
      appliance,
      brand:     document.getElementById('bk-brand').value.trim(),
      site:      document.getElementById('bk-site').value,
      date,
      time:      document.getElementById('bk-time').value,
      address:   document.getElementById('bk-address').value.trim(),
      status:    document.getElementById('bk-status').value,
      notes:     document.getElementById('bk-notes').value.trim(),
      createdAt: editingBookingId ? (bookings.find(b=>b.id===editingBookingId)||{}).createdAt || new Date().toISOString() : new Date().toISOString(),
      updatedAt: new Date().toISOString(),
    };
    if (editingBookingId) {
      bookings = bookings.map(b => b.id === editingBookingId ? booking : b);
    } else {
      bookings.unshift(booking);
    }
    saveBookingsToStorage();
    renderBookings();
    closeBookingModal();
    // Flash success
    const btn = document.getElementById('bk-save-btn');
    if (btn) { btn.textContent = '✓ Saved!'; btn.style.background='var(--accent)'; setTimeout(()=>{ btn.textContent='Save Booking'; btn.style.background=''; },1500); }
  }

  function deleteBooking(id) {
    if (!confirm('Delete this booking? This cannot be undone.')) return;
    bookings = bookings.filter(b => b.id !== id);
    saveBookingsToStorage();
    renderBookings();
  }

  function updateStatus(id, newStatus) {
    bookings = bookings.map(b => b.id === id ? {...b, status: newStatus, updatedAt: new Date().toISOString()} : b);
    saveBookingsToStorage();
    renderBookings();
  }

  function viewBooking(id) {
    const b = bookings.find(b => b.id === id); if (!b) return;
    const modal = document.getElementById('booking-detail-modal');
    const content = document.getElementById('booking-detail-content');
    const statusColors = { pending:'status-pending', confirmed:'status-confirmed', 'in-progress':'status-in-progress', completed:'status-completed', cancelled:'status-cancelled' };
    content.innerHTML = `
      <div style="display:flex;align-items:flex-start;justify-content:space-between;margin-bottom:20px;gap:12px;flex-wrap:wrap">
        <div>
          <div style="font-family:'Syne',sans-serif;font-size:18px;font-weight:800">${b.name}</div>
          <div style="margin-top:6px"><span class="status-badge ${statusColors[b.status]||''}">${b.status}</span></div>
        </div>
        <div style="font-size:11px;color:var(--muted);text-align:right">ID: ${b.id}<br>${new Date(b.createdAt).toLocaleDateString()}</div>
      </div>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:16px">
        ${[
          ['Phone', b.phone ? `<a href="tel:${b.phone}" style="color:var(--accent)">${b.phone}</a>` : '—'],
          ['✉ Email', b.email || '—'],
          ['Appliance', b.appliance || '—'],
          ['🏷 Brand', b.brand || '—'],
          ['Date', b.date ? `${b.date} · ${b.time||''}` : '—'],
          ['Address', b.address || '—'],
          ['🌐 Site', b.site || '—'],
          ['⏱ Updated', new Date(b.updatedAt).toLocaleString()],
        ].map(([l,v])=>`<div style="background:var(--surface2);border-radius:8px;padding:12px"><div style="font-size:10px;color:var(--muted);text-transform:uppercase;letter-spacing:1px;margin-bottom:4px">${l}</div><div style="font-size:13px">${v}</div></div>`).join('')}
      </div>
      ${b.notes ? `<div style="background:var(--surface2);border-radius:8px;padding:14px;margin-bottom:16px"><div style="font-size:10px;color:var(--muted);text-transform:uppercase;letter-spacing:1px;margin-bottom:6px">Notes</div><div style="font-size:13px;line-height:1.6;color:var(--muted)">${b.notes}</div></div>` : ''}
      <div style="display:flex;gap:8px;flex-wrap:wrap">
        <button class="btn btn-ghost" style="flex:1;font-size:12px" onclick="openBookingModal('${b.id}');document.getElementById('booking-detail-modal').classList.remove('open')">✏ Edit</button>
        <button class="btn btn-primary" style="flex:1;font-size:12px" onclick="updateStatus('${b.id}','confirmed');document.getElementById('booking-detail-modal').classList.remove('open')">✓ Confirm</button>
        <button class="btn btn-ghost" style="font-size:12px" onclick="updateStatus('${b.id}','completed');document.getElementById('booking-detail-modal').classList.remove('open')">✅ Done</button>
      </div>`;
    modal.classList.add('open');
    document.body.style.overflow = 'hidden';
  }

  function renderBookings() {
    const tbody = document.getElementById('crm-tbody'); if (!tbody) return;
    const search  = (document.getElementById('crm-search')||{}).value?.toLowerCase() || '';
    const statusF = (document.getElementById('crm-filter-status')||{}).value || 'all';
    const siteF   = (document.getElementById('crm-filter-site')||{}).value || 'all';
    const statusColors = { pending:'status-pending', confirmed:'status-confirmed', 'in-progress':'status-in-progress', completed:'status-completed', cancelled:'status-cancelled' };

    let filtered = bookings.filter(b => {
      const matchSearch = !search || [b.name,b.phone,b.appliance,b.address].join(' ').toLowerCase().includes(search);
      const matchStatus = statusF === 'all' || b.status === statusF;
      const matchSite   = siteF === 'all' || b.site === siteF;
      return matchSearch && matchStatus && matchSite;
    });

    if (!filtered.length) {
      tbody.innerHTML = `<tr><td colspan="6" style="text-align:center;padding:40px;color:var(--muted)">${bookings.length ? 'No bookings match your filter.' : 'No bookings yet. Click "+ New Booking" to add your first one.'}</td></tr>`;
      return;
    }

    tbody.innerHTML = filtered.map(b => `
      <tr style="cursor:pointer" onclick="viewBooking('${b.id}')">
        <td style="padding-left:16px">
          <div style="font-size:13px;font-weight:600">${b.name}</div>
          <div style="font-size:11px;color:var(--muted)">${b.phone}</div>
        </td>
        <td>
          <div style="font-size:13px">${b.appliance}</div>
          <div style="font-size:11px;color:var(--muted)">${b.brand||''}</div>
        </td>
        <td>
          <div style="font-size:12px">${b.date||'—'}</div>
          <div style="font-size:11px;color:var(--muted)">${b.time||''}</div>
        </td>
        <td style="font-size:12px;color:var(--muted)">${b.site||'—'}</td>
        <td><span class="status-badge ${statusColors[b.status]||''}">${b.status}</span></td>
        <td onclick="event.stopPropagation()">
          <div class="crm-row-actions">
            <button class="btn btn-ghost" style="font-size:10px;padding:4px 8px" onclick="openBookingModal('${b.id}')">Edit</button>
            <button class="btn btn-ghost" style="font-size:10px;padding:4px 8px;color:var(--accent3)" onclick="deleteBooking('${b.id}')">Del</button>
          </div>
        </td>
      </tr>`).join('');
  }

  function exportBookingsCSV() {
    if (!bookings.length) { alert('No bookings to export.'); return; }
    const rows = [['Name','Phone','Email','Appliance','Brand','Site','Date','Time','Address','Status','Notes','Created'],
      ...bookings.map(b=>[b.name,b.phone,b.email,b.appliance,b.brand,b.site,b.date,b.time,b.address,b.status,b.notes,new Date(b.createdAt).toLocaleDateString()])];
    const csv = rows.map(r=>r.map(c=>`"${(c||'').replace(/"/g,'""')}"`).join(',')).join('\n');
    const a = document.createElement('a');
    a.href = URL.createObjectURL(new Blob([csv],{type:'text/csv'}));
    a.download = 'nicheforge-bookings-'+new Date().toISOString().split('T')[0]+'.csv';
    a.click();
  }

  // Close modals on backdrop click
  document.addEventListener('click', e => {
    if (e.target.id === 'booking-modal') closeBookingModal();
    if (e.target.id === 'booking-detail-modal') { e.target.classList.remove('open'); document.body.style.overflow=''; }
  });

  // ── Settings ─────────────────────────────────────────────────
  let nfSettings = JSON.parse(localStorage.getItem('nf_settings') || '{}');
  let globalLogoData = localStorage.getItem('nf_global_logo') || '';
  let siteLogos = JSON.parse(localStorage.getItem('nf_site_logos') || '{}');

  const SITES_LIST = ['FixMyHive Doha','Home Repair Pro','DIY Repair Hub','AC Repair Guide'];

  // ── API Key management ───────────────────────────────────────
  function getApiKey() {
    return localStorage.getItem('nf_api_key') || '';
  }

  function getApiHeaders() {
    // Gemini uses key as query param — headers just need Content-Type
    return { 'Content-Type': 'application/json' };
  }

  function geminiUrl(maxTokens) {
    const key = getApiKey();
    // Use gemini-1.5-flash — free tier, fast, high quality
    return `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${key}`;
  }

  async function geminiCall(prompt, maxTokens) {
    const resp = await fetch(geminiUrl(maxTokens), {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        contents: [{ parts: [{ text: prompt }] }],
        generationConfig: { maxOutputTokens: maxTokens || 4096, temperature: 0.7 }
      })
    });
    if (!resp.ok) {
      const err = await resp.json();
      throw new Error('Gemini API error ' + resp.status + ': ' + (err.error?.message || 'Unknown error'));
    }
    const data = await resp.json();
    const text = data.candidates?.[0]?.content?.parts?.[0]?.text || '';
    return text.trim();
  }

  function saveApiKey() {
    const val = document.getElementById('set-apikey')?.value.trim() || '';
    localStorage.setItem('nf_api_key', val);
    updateApiKeyBadge(val);
  }

  function updateApiKeyBadge(key) {
    const badge = document.getElementById('apikey-status-badge');
    if (!badge) return;
    if (key && key.startsWith('sk-ant')) {
      badge.textContent = '✓ SET';
      badge.style.background = 'rgba(0,212,255,0.12)';
      badge.style.color = 'var(--accent)';
    } else if (key) {
      badge.textContent = 'INVALID?';
      badge.style.background = 'rgba(245,197,66,0.12)';
      badge.style.color = 'var(--gold)';
    } else {
      badge.textContent = 'NOT SET';
      badge.style.background = 'rgba(255,85,85,0.12)';
      badge.style.color = 'var(--accent3)';
    }
  }

  function toggleApiKeyVisibility() {
    const inp = document.getElementById('set-apikey');
    if (!inp) return;
    inp.type = inp.type === 'password' ? 'text' : 'password';
    document.getElementById('eye-icon').innerHTML = inp.type === 'text'
      ? '<path d="M17.94 17.94A10.07 10.07 0 0112 20c-7 0-11-8-11-8a18.45 18.45 0 015.06-5.94M9.9 4.24A9.12 9.12 0 0112 4c7 0 11 8 11 8a18.5 18.5 0 01-2.16 3.19m-6.72-1.07a3 3 0 11-4.24-4.24"/><line x1="1" y1="1" x2="23" y2="23"/>'
      : '<path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/>';
  }

  async function testApiKey() {
    const key = getApiKey();
    const result = document.getElementById('apikey-test-result');
    if (!key) { result.style.display='block'; result.style.color='var(--accent3)'; result.textContent='⚠ No API key saved. Paste your key first.'; return; }
    result.style.display='block'; result.style.color='var(--muted)'; result.textContent='Testing connection...';
    try {
      // Test Gemini key with a minimal call
      const testResp = await fetch(geminiUrl(10), {
        method:'POST', headers:{'Content-Type':'application/json'},
        body: JSON.stringify({contents:[{parts:[{text:'Hi'}]}],generationConfig:{maxOutputTokens:10}})
      });
      if (testResp.ok) { result.style.color='var(--accent)'; result.textContent='✓ Gemini Gemini API key is valid — all AI features are active! (Free tier: 1,500 req/day)'; }
      else { const d=await r.json(); result.style.color='var(--accent3)'; result.textContent='✗ Error '+r.status+': '+(d.error?.message||'Invalid key'); }
    } catch(e) { result.style.color='var(--accent3)'; result.textContent='✗ Network error. Check your connection.'; }
  }

  function requireApiKey(callerName) {
    if (!getApiKey()) {
      const msg = `API key not set.\n\nGo to Settings → paste your Google Gemini API key to use ${callerName}.\n\nGet a FREE key at: aistudio.google.com/app/apikey`;
      alert(msg);
      showPanel('settings', document.getElementById('nav-settings'));
      return false;
    }
    return true;
  }

  function saveSettings() {
    nfSettings = {
      bizname: document.getElementById('set-bizname')?.value || '',
      phone:   document.getElementById('set-phone')?.value || '',
      wa:      document.getElementById('set-wa')?.value || '',
      email:   document.getElementById('set-email')?.value || '',
      city:    document.getElementById('set-city')?.value || '',
      ga4:     document.getElementById('set-ga4')?.value || '',
      adsense: document.getElementById('set-adsense')?.value || '',
      color:   document.getElementById('set-color')?.value || '#00e5a0',
    };
    localStorage.setItem('nf_settings', JSON.stringify(nfSettings));
  }

  function loadSettings() {
    if (nfSettings.bizname) document.getElementById('set-bizname').value = nfSettings.bizname;
    if (nfSettings.phone)   document.getElementById('set-phone').value   = nfSettings.phone;
    if (nfSettings.wa)      document.getElementById('set-wa').value      = nfSettings.wa;
    if (nfSettings.email)   document.getElementById('set-email').value   = nfSettings.email;
    if (nfSettings.city)    document.getElementById('set-city').value    = nfSettings.city;
    if (nfSettings.ga4)     document.getElementById('set-ga4').value     = nfSettings.ga4;
    if (nfSettings.adsense) document.getElementById('set-adsense').value = nfSettings.adsense;
    if (nfSettings.color)   document.getElementById('set-color').value   = nfSettings.color;
    if (globalLogoData) renderGlobalLogoPreview(globalLogoData);
    renderSiteLogoList();
    renderEmbedCode();
  }

  function handleLogoUpload(input, siteKey) {
    const file = input.files[0]; if (!file) return;
    const reader = new FileReader();
    reader.onload = e => {
      const data = e.target.result;
      if (siteKey === 'global') {
        globalLogoData = data;
        localStorage.setItem('nf_global_logo', data);
        renderGlobalLogoPreview(data);
        const meta = document.getElementById('global-logo-meta');
        if (meta) meta.textContent = `${file.name} · ${(file.size/1024).toFixed(1)}KB · ${file.type}`;
      } else {
        siteLogos[siteKey] = data;
        localStorage.setItem('nf_site_logos', JSON.stringify(siteLogos));
        renderSiteLogoList();
      }
    };
    reader.readAsDataURL(file);
  }

  function applyLogoFromCode() {
    const code = document.getElementById('logo-code-input')?.value.trim();
    if (!code) return;
    globalLogoData = code;
    localStorage.setItem('nf_global_logo', code);
    renderGlobalLogoPreview(code);
    document.getElementById('global-logo-meta').textContent = 'Custom SVG/URL applied';
  }

  function renderGlobalLogoPreview(data) {
    const preview = document.getElementById('global-logo-preview'); if (!preview) return;
    if (data.startsWith('data:image') || data.startsWith('http')) {
      preview.innerHTML = `<img src="${data}" style="max-width:100%;max-height:80px;object-fit:contain" alt="Logo preview">`;
    } else if (data.trim().startsWith('<svg')) {
      preview.innerHTML = `<div style="max-height:80px;display:flex;align-items:center;justify-content:center">${data}</div>`;
      // Scale SVG
      const svg = preview.querySelector('svg');
      if (svg) { svg.style.maxWidth='100%'; svg.style.maxHeight='80px'; }
    } else {
      preview.innerHTML = `<img src="${data}" style="max-width:100%;max-height:80px;object-fit:contain" alt="Logo">`;
    }
    const acts = document.getElementById('global-logo-actions');
    if (acts) acts.style.display = 'flex';
  }

  function clearGlobalLogo() {
    if (!confirm('Remove global logo?')) return;
    globalLogoData = '';
    localStorage.removeItem('nf_global_logo');
    const preview = document.getElementById('global-logo-preview');
    if (preview) preview.innerHTML = '<div style="color:var(--muted);font-size:12px;text-align:center">No logo uploaded yet</div>';
    const acts = document.getElementById('global-logo-actions');
    if (acts) acts.style.display = 'none';
    const meta = document.getElementById('global-logo-meta');
    if (meta) meta.textContent = '';
  }

  function copyLogoCode() {
    if (!globalLogoData) return;
    navigator.clipboard.writeText(globalLogoData).then(() => {
      const btn = event.target; const orig = btn.innerHTML;
      btn.innerHTML = '✓ Copied!'; btn.style.color='var(--accent)';
      setTimeout(()=>{btn.innerHTML=orig;btn.style.color=''},2000);
    });
  }

  function renderSiteLogoList() {
    const el = document.getElementById('site-logo-list'); if (!el) return;
    el.innerHTML = SITES_LIST.map(site => {
      const logoData = siteLogos[site] || '';
      const hasLogo = !!logoData;
      return `<div style="display:flex;align-items:center;gap:16px;padding:14px;background:var(--surface2);border:1px solid var(--border);border-radius:10px;flex-wrap:wrap">
        <div style="min-width:140px;font-size:13px;font-weight:600">${site}</div>
        <div style="width:80px;height:40px;background:var(--bg);border:1px solid var(--border);border-radius:6px;display:flex;align-items:center;justify-content:center;overflow:hidden">
          ${hasLogo
            ? (logoData.startsWith('<svg') ? logoData : `<img src="${logoData}" style="max-width:100%;max-height:36px;object-fit:contain">`)
            : `<span style="font-size:10px;color:var(--muted)">Global</span>`}
        </div>
        <label style="cursor:pointer">
          <span class="btn btn-ghost" style="font-size:11px;padding:5px 10px">Upload</span>
          <input type="file" accept=".svg,.png,.jpg,.jpeg,.webp" style="display:none" onchange="handleLogoUpload(this,'${site}')">
        </label>
        ${hasLogo ? `<button class="btn btn-ghost" style="font-size:11px;padding:5px 10px;color:var(--accent3)" onclick="clearSiteLogo('${site}')">✕ Remove</button>` : ''}
        <div style="font-size:11px;color:var(--muted)">${hasLogo ? '✓ Custom logo set' : 'Using global default'}</div>
      </div>`;
    }).join('');
  }

  function clearSiteLogo(site) {
    delete siteLogos[site];
    localStorage.setItem('nf_site_logos', JSON.stringify(siteLogos));
    renderSiteLogoList();
  }

  function renderEmbedCode() {
    const el = document.getElementById('booking-embed-code'); if (!el) return;
    el.textContent = `<!-- NicheForge Booking Form -->
<script src="https://nicheforge.app/booking-widget.js"
  data-site="${nfSettings.bizname||'My Site'}"
  data-phone="${nfSettings.phone||''}"
  data-color="${nfSettings.color||'#00e5a0'}"
><\/script>`;
  }

  function copyEmbedCode() {
    const el = document.getElementById('booking-embed-code'); if (!el) return;
    navigator.clipboard.writeText(el.textContent).then(() => {
      const btn = event.target; const orig = btn.innerHTML;
      btn.innerHTML = '✓ Copied!'; btn.style.color='var(--accent)';
      setTimeout(()=>{btn.innerHTML=orig;btn.style.color=''},2000);
    });
  }

  // Seed demo bookings on first load if empty
  function seedDemoBookings() {
    if (bookings.length > 0) return;
    const demos = [
      { id:'bk_demo1', name:'Ahmed Al-Mansoori', phone:'+974 5511 2233', email:'ahmed@email.com', appliance:'Washing Machine', brand:'Bosch WAX32', site:'FixMyHive Doha', date: new Date(Date.now()+86400000).toISOString().split('T')[0], time:'10:00 – 12:00', address:'The Pearl, Tower C', status:'confirmed', notes:'Not spinning, makes loud noise on spin cycle.', createdAt: new Date().toISOString(), updatedAt: new Date().toISOString() },
      { id:'bk_demo2', name:'Fatima Hassan', phone:'+974 6622 9988', email:'', appliance:'Refrigerator / Freezer', brand:'Siemens iQ500', site:'FixMyHive Doha', date: new Date(Date.now()+172800000).toISOString().split('T')[0], time:'14:00 – 16:00', address:'Lusail Marina', status:'pending', notes:'Not cooling properly, ice forming at back.', createdAt: new Date().toISOString(), updatedAt: new Date().toISOString() },
      { id:'bk_demo3', name:'Mohammed Al-Kuwari', phone:'+974 7733 4455', email:'mk@business.qa', appliance:'Air Conditioner', brand:'Daikin 2.5T', site:'FixMyHive Doha', date: new Date(Date.now()-86400000).toISOString().split('T')[0], time:'08:00 – 10:00', address:'West Bay, Floor 18', status:'completed', notes:'Not cooling at all. Checked gas — refilled and serviced.', createdAt: new Date(Date.now()-172800000).toISOString(), updatedAt: new Date().toISOString() },
    ];
    bookings = demos;
    saveBookingsToStorage();
  }

  // Init on DOM ready
  document.addEventListener('DOMContentLoaded', () => {
    titles['bookings'] = 'Bookings';
    titles['settings'] = 'Settings';
    seedDemoBookings();
    renderBookings();
    updateBookingsBadge();
    updateCrmStats();
    setTimeout(loadSettings, 100);
    // Load API key
    const storedKey = getApiKey();
    const apiInput = document.getElementById('set-apikey');
    if (apiInput && storedKey) apiInput.value = storedKey;
    updateApiKeyBadge(storedKey);
  });
  // ── Content Calendar ─────────────────────────────────────────
  let calPosts = JSON.parse(localStorage.getItem('nf_cal_posts') || '[]');
  let calCurrentDate = new Date();
  let calEditId = null;
  let lpSelectedType = 'squeeze';

  function saveCalPosts() { localStorage.setItem('nf_cal_posts', JSON.stringify(calPosts)); }

  function calNav(dir) {
    calCurrentDate = new Date(calCurrentDate.getFullYear(), calCurrentDate.getMonth() + dir, 1);
    renderCalendar();
  }

  const MONTHS = ['January','February','March','April','May','June','July','August','September','October','November','December'];

  function renderCalendar() {
    const y = calCurrentDate.getFullYear();
    const m = calCurrentDate.getMonth();
    document.getElementById('cal-month-label').textContent = MONTHS[m] + ' ' + y;

    const siteFilter = document.getElementById('cal-site-filter')?.value || 'all';
    const filtered = calPosts.filter(p => {
      const d = new Date(p.date);
      if (d.getFullYear() !== y || d.getMonth() !== m) return false;
      if (siteFilter !== 'all' && p.site !== siteFilter) return false;
      return true;
    });

    // Stats
    document.getElementById('cal-stat-planned').textContent = filtered.filter(p=>p.status==='planned').length;
    document.getElementById('cal-stat-published').textContent = filtered.filter(p=>p.status==='published').length;
    document.getElementById('cal-stat-draft').textContent = filtered.filter(p=>p.status==='draft').length;

    // Build grid
    const firstDay = new Date(y, m, 1);
    let startDow = firstDay.getDay(); // 0=Sun
    // Convert to Mon-start: Mon=0
    startDow = (startDow + 6) % 7;
    const daysInMonth = new Date(y, m + 1, 0).getDate();
    const today = new Date();

    let html = '';
    // Blank cells before first day
    for (let i = 0; i < startDow; i++) {
      html += `<div class="cal-day other-month"></div>`;
    }
    for (let d = 1; d <= daysInMonth; d++) {
      const dateStr = y + '-' + String(m+1).padStart(2,'0') + '-' + String(d).padStart(2,'0');
      const isToday = today.getFullYear()===y && today.getMonth()===m && today.getDate()===d;
      const dayPosts = filtered.filter(p => p.date === dateStr);
      const dotHtml = dayPosts.slice(0,3).map(p =>
        `<div class="cal-post-dot ${p.status}" title="${p.title}" onclick="event.stopPropagation();editCalPost('${p.id}')">${p.title}</div>`
      ).join('');
      const more = dayPosts.length > 3 ? `<div style="font-size:10px;color:var(--muted)">+${dayPosts.length-3} more</div>` : '';
      html += `<div class="cal-day${isToday?' today':''}" onclick="openNewPostModal('${dateStr}')">
        <div class="cal-day-num">${d}</div>
        ${dotHtml}${more}
      </div>`;
    }
    // Fill remaining cells
    const totalCells = startDow + daysInMonth;
    const remaining = (7 - (totalCells % 7)) % 7;
    for (let i = 0; i < remaining; i++) html += `<div class="cal-day other-month"></div>`;

    document.getElementById('cal-grid').innerHTML = html;

    // Post list
    const listEl = document.getElementById('cal-post-list');
    if (filtered.length === 0) {
      listEl.innerHTML = '<div style="color:var(--muted);font-size:13px;text-align:center;padding:24px">No posts scheduled. Click "Add Post" or use "AI Fill Month".</div>';
    } else {
      const typeColors = {planned:'var(--accent2)',draft:'var(--gold)',published:'var(--accent)'};
      listEl.innerHTML = filtered.sort((a,b)=>a.date.localeCompare(b.date)).map(p => `
        <div class="cal-post-row" onclick="editCalPost('${p.id}')">
          <div style="width:8px;height:8px;border-radius:50%;background:${typeColors[p.status]||'var(--muted)'};flex-shrink:0"></div>
          <div style="font-size:12px;font-weight:600;flex:1">${p.title}</div>
          <div style="font-size:11px;color:var(--muted)">${p.site}</div>
          <div style="font-size:11px;color:var(--muted)">${p.date}</div>
          <div style="font-size:10px;padding:2px 8px;border-radius:20px;background:rgba(255,255,255,0.05);color:var(--muted)">${p.status}</div>
          <button onclick="event.stopPropagation();deleteCalPost('${p.id}')" style="background:none;border:none;color:var(--muted);cursor:pointer;padding:2px 4px">
            <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"/><path d="M19 6l-1 14H6L5 6"/><path d="M10 11v6M14 11v6"/></svg>
          </button>
        </div>`).join('');
    }
  }

  function openNewPostModal(prefillDate) {
    calEditId = null;
    document.getElementById('cal-modal-title').textContent = 'Add Post';
    document.getElementById('cal-post-title').value = '';
    document.getElementById('cal-post-keyword').value = '';
    document.getElementById('cal-post-status').value = 'planned';
    document.getElementById('cal-post-type').value = 'how-to';
    document.getElementById('cal-post-date').value = prefillDate || new Date().toISOString().split('T')[0];
    const modal = document.getElementById('cal-modal');
    modal.style.display = 'flex';
  }

  function editCalPost(id) {
    const post = calPosts.find(p => p.id === id);
    if (!post) return;
    calEditId = id;
    document.getElementById('cal-modal-title').textContent = 'Edit Post';
    document.getElementById('cal-post-title').value = post.title;
    document.getElementById('cal-post-site').value = post.site;
    document.getElementById('cal-post-date').value = post.date;
    document.getElementById('cal-post-status').value = post.status;
    document.getElementById('cal-post-type').value = post.type || 'how-to';
    document.getElementById('cal-post-keyword').value = post.keyword || '';
    document.getElementById('cal-modal').style.display = 'flex';
  }

  function closePostModal() { document.getElementById('cal-modal').style.display = 'none'; }

  function saveCalPost() {
    const title = document.getElementById('cal-post-title').value.trim();
    if (!title) { alert('Please enter a post title.'); return; }
    const post = {
      id: calEditId || 'cal_' + Date.now(),
      title,
      site: document.getElementById('cal-post-site').value,
      date: document.getElementById('cal-post-date').value,
      status: document.getElementById('cal-post-status').value,
      type: document.getElementById('cal-post-type').value,
      keyword: document.getElementById('cal-post-keyword').value.trim()
    };
    if (calEditId) {
      const idx = calPosts.findIndex(p => p.id === calEditId);
      if (idx >= 0) calPosts[idx] = post;
    } else {
      calPosts.push(post);
    }
    saveCalPosts();
    closePostModal();
    renderCalendar();
  }

  function deleteCalPost(id) {
    calPosts = calPosts.filter(p => p.id !== id);
    saveCalPosts();
    renderCalendar();
  }

  function writePostNow() {
    const title = document.getElementById('cal-post-title').value.trim();
    const kw = document.getElementById('cal-post-keyword').value.trim();
    saveCalPost();
    // Jump to blog writer pre-filled
    showPanel('blog', document.querySelector('[onclick="showPanel(\'blog\', this)"]'));
    setTimeout(() => {
      if (document.getElementById('blog-keyword')) document.getElementById('blog-keyword').value = kw || title;
    }, 100);
  }

  function exportCalendarCSV() {
    const headers = 'Title,Site,Date,Status,Type,Keyword';
    const rows = calPosts.map(p => `"${p.title}","${p.site}","${p.date}","${p.status}","${p.type||''}","${p.keyword||''}"`);
    const csv = [headers, ...rows].join('\n');
    const blob = new Blob([csv], {type:'text/csv'});
    const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'content-calendar.csv'; a.click();
  }

  async function generateCalendarAI() {
    if (!requireApiKey('AI Fill Month')) return;
    const btn = document.getElementById('cal-ai-btn');
    const origHtml = btn.innerHTML;
    btn.innerHTML = '<svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="1 4 1 10 7 10"/><path d="M3.51 15a9 9 0 1 0 .49-3.95"/></svg> Generating...';
    btn.disabled = true;

    const y = calCurrentDate.getFullYear();
    const m = calCurrentDate.getMonth();
    const daysInMonth = new Date(y, m + 1, 0).getDate();
    const monthName = MONTHS[m] + ' ' + y;
    const sites = ['FixMyHive Doha', 'Home Repair Pro', 'DIY Repair Hub', 'AC Repair Guide'];

    const prompt = `Generate a content calendar for ${monthName} for these home repair/DIY websites: ${sites.join(', ')}.
Create 16 blog post ideas (4 per site, spread across the month).
Return ONLY a JSON array, no markdown fences:
[
  {"title": "post title", "site": "exact site name", "date": "YYYY-MM-DD", "status": "planned", "type": "how-to|listicle|info|local", "keyword": "target keyword"},
  ...
]
Dates must be between ${y}-${String(m+1).padStart(2,'0')}-01 and ${y}-${String(m+1).padStart(2,'0')}-${String(daysInMonth).padStart(2,'0')}.
Spread posts evenly. Make titles specific and practical.`;

    try {
      let raw = await geminiCall(prompt, 2000);
      raw = raw.replace(/^```json\s*/i,'').replace(/^```\s*/,'').replace(/\s*```$/,'');
      const posts = JSON.parse(raw);
      posts.forEach(p => { p.id = 'cal_' + Date.now() + '_' + Math.random().toString(36).slice(2,6); calPosts.push(p); });
      saveCalPosts();
      renderCalendar();
    } catch(e) {
      alert('Failed to generate: ' + e.message);
    }
    btn.innerHTML = origHtml;
    btn.disabled = false;
  }

  // Seed demo calendar posts
  function seedCalendarDemo() {
    if (calPosts.length > 0) return;
    const now = new Date();
    const y = now.getFullYear(); const m = String(now.getMonth()+1).padStart(2,'0');
    const demos = [
      {id:'cal_d1',title:'How to fix a dripping faucet without a plumber',site:'DIY Repair Hub',date:`${y}-${m}-03`,status:'published',type:'how-to',keyword:'fix dripping faucet'},
      {id:'cal_d2',title:'AC not cooling? 7 things to check first',site:'AC Repair Guide',date:`${y}-${m}-07`,status:'published',type:'listicle',keyword:'AC not cooling'},
      {id:'cal_d3',title:'Same-day washing machine repair Doha',site:'FixMyHive Doha',date:`${y}-${m}-10`,status:'draft',type:'local',keyword:'washing machine repair Doha'},
      {id:'cal_d4',title:'How to bleed a radiator yourself',site:'Home Repair Pro',date:`${y}-${m}-14`,status:'planned',type:'how-to',keyword:'bleed radiator'},
      {id:'cal_d5',title:'Best AC brands in Qatar 2025',site:'AC Repair Guide',date:`${y}-${m}-18`,status:'planned',type:'listicle',keyword:'best AC Qatar'},
      {id:'cal_d6',title:'Refrigerator making noise: causes and fixes',site:'DIY Repair Hub',date:`${y}-${m}-22`,status:'planned',type:'info',keyword:'refrigerator noise fix'},
    ];
    calPosts = demos;
    saveCalPosts();
  }

  // Init calendar on DOMContentLoaded
  document.addEventListener('DOMContentLoaded', () => {
    seedCalendarDemo();
    renderCalendar();
  });

  // ── Landing Page Generator ────────────────────────────────────
  let lpCurrentHtml = '';

  function selectLpType(el, type) {
    document.querySelectorAll('.lp-type-card').forEach(c => c.classList.remove('selected'));
    el.classList.add('selected');
    lpSelectedType = type;
  }

  function lpProgressSet(pct, label, activeStep) {
    document.getElementById('lp-progress-bar').style.width = pct + '%';
    document.getElementById('lp-progress-label').textContent = label;
    ['design','copy','seo','code','done'].forEach(s => {
      const el = document.getElementById('lpstep-'+s);
      if (!el) return;
      const order = ['design','copy','seo','code','done'];
      el.className = 'blog-step' + (s === activeStep ? ' active' : (order.indexOf(s) < order.indexOf(activeStep) ? ' done' : ''));
    });
  }

  async function generateLandingPage() {
    if (!requireApiKey('Landing Page Generator')) return;
    const headline = document.getElementById('lp-headline').value.trim();
    if (!headline) { alert('Please enter a headline.'); return; }

    const brand    = document.getElementById('lp-brand').value.trim() || (nfSettings.bizname || 'My Business');
    const keyword  = document.getElementById('lp-keyword').value.trim() || headline;
    const location = document.getElementById('lp-location').value.trim();
    const phone    = document.getElementById('lp-phone').value.trim() || (nfSettings.phone || '');
    const color    = document.getElementById('lp-color').value;
    const benefits = document.getElementById('lp-benefits').value.trim().split('\n').filter(Boolean);
    const wantForm   = document.getElementById('lp-form').checked;
    const wantCta    = document.getElementById('lp-cta').checked;
    const wantSocial = document.getElementById('lp-social').checked;
    const wantFaq    = document.getElementById('lp-faq').checked;
    const wantSchema = document.getElementById('lp-schema').checked;
    const wantWa     = document.getElementById('lp-wa').checked;
    const waNum      = nfSettings.wa || phone.replace(/[^0-9]/g,'');

    const typeLabels = {'squeeze':'Lead Capture','coming-soon':'Coming Soon','service':'Local Service Page','adsense':'AdSense Niche Page'};

    document.getElementById('lp-form').style.display = 'none';
    document.getElementById('lp-output').style.display = 'none';
    document.getElementById('lp-progress').style.display = 'block';
    lpProgressSet(10, 'Designing layout...', 'design');

    const prompt = `Create a complete, modern, high-converting ${typeLabels[lpSelectedType]} as a single HTML file.

DETAILS:
- Headline: ${headline}
- Brand: ${brand}
- Primary Keyword: ${keyword}
${location ? '- Location: ' + location : ''}
${phone ? '- Phone: ' + phone : ''}
- Accent Color: ${color}
- Benefits: ${benefits.join(' | ')}
- Page Type: ${typeLabels[lpSelectedType]}

REQUIREMENTS:
- Dark background theme with ${color} as accent colour
- Modern, professional design — not generic
- Syne bold font for headlines (load from Google Fonts)
- Full mobile responsive
- Hero section with headline, sub-headline, and ${wantForm ? 'a lead capture form (Name, Phone, Service needed)' : 'a strong CTA button'}
- Benefits/features section with icons
${wantSocial ? '- Social proof section with 3 fake-realistic customer reviews (use local-sounding names)' : ''}
${wantFaq ? '- FAQ section with 4 questions relevant to the service' : ''}
- Footer with contact info
${wantCta ? '- Sticky bottom CTA bar on mobile' : ''}
${wantWa && waNum ? `- WhatsApp floating button linking to https://wa.me/${waNum}` : ''}
${wantSchema ? '- JSON-LD LocalBusiness schema in <head>' : ''}
- Smooth scroll animations using IntersectionObserver
- All inline — single .html file, no external CSS files

Return ONLY the complete HTML. No explanation, no markdown fences, just raw HTML starting with <!DOCTYPE html>.`;

    try {
      lpProgressSet(30, 'Writing copy & layout...', 'copy');

      let html = await geminiCall(prompt, 4096);

      lpProgressSet(65, 'Adding SEO tags...', 'seo');
      // Strip any markdown fences if present
      html = html.replace(/^```html\s*/i,'').replace(/^```\s*/,'').replace(/\s*```$/,'').trim();

      lpProgressSet(88, 'Finalising HTML...', 'code');
      await new Promise(r => setTimeout(r, 300));
      lpProgressSet(100, 'Done!', 'done');
      await new Promise(r => setTimeout(r, 400));

      lpCurrentHtml = html;

      document.getElementById('lp-type-badge').textContent = typeLabels[lpSelectedType].toUpperCase();
      document.getElementById('lp-html-source').textContent = html;
      document.getElementById('lp-progress').style.display = 'none';
      document.getElementById('lp-output').style.display = 'block';
      // Auto-show preview
      document.getElementById('lp-preview-wrap').style.display = 'block';
      const iframe = document.getElementById('lp-iframe');
      iframe.srcdoc = html;

    } catch(e) {
      document.getElementById('lp-progress').style.display = 'none';
      document.getElementById('lp-form').style.display = 'block';
      alert('Generation failed: ' + e.message + '\n\nCheck your Gemini API key in Settings. Get a free key at aistudio.google.com/app/apikey');
    }
  }

  function toggleLpPreview() {
    const wrap = document.getElementById('lp-preview-wrap');
    const showing = wrap.style.display !== 'none';
    wrap.style.display = showing ? 'none' : 'block';
    if (!showing) {
      const iframe = document.getElementById('lp-iframe');
      iframe.srcdoc = lpCurrentHtml;
    }
  }

  function copyLpHtml() {
    navigator.clipboard.writeText(lpCurrentHtml).then(() => {
      const btn = document.querySelector('[onclick="copyLpHtml()"]');
      if (btn) { const o = btn.innerHTML; btn.textContent = 'Copied!'; setTimeout(() => btn.innerHTML = o, 1500); }
    });
  }

  function downloadLp() {
    const blob = new Blob([lpCurrentHtml], {type:'text/html'});
    const a = document.createElement('a'); a.href = URL.createObjectURL(blob);
    a.download = 'landing-page.html'; a.click();
  }

  function resetLandingPage() {
    document.getElementById('lp-output').style.display = 'none';
    document.getElementById('lp-form').style.display = 'block';
    lpCurrentHtml = '';
  }

  // ── Blog Post Writer ─────────────────────────────────────────
  let blogData = { html: '', text: '', meta: '', schema: '' };

  function blogProgressSet(pct, label, activeStep) {
    document.getElementById('blog-progress-bar').style.width = pct + '%';
    document.getElementById('blog-progress-label').textContent = label;
    const _stepOrder = ['outline','content','seo','schema','done'];
    const _activeIdx = _stepOrder.indexOf(activeStep);
    _stepOrder.forEach((s, idx) => {
      const el = document.getElementById('bstep-'+s);
      if (!el) return;
      el.className = 'blog-step' + (s === activeStep ? ' active' : (idx < _activeIdx ? ' done' : ''));
    });
  }

  async function generateBlogPost() {
    if (!requireApiKey('Blog Writer')) return;
    const keyword = document.getElementById('blog-keyword').value.trim();
    if (!keyword) { alert('Please enter a keyword or topic.'); return; }

    const type     = document.getElementById('blog-type').value;
    const audience = document.getElementById('blog-audience').value.trim() || 'general readers';
    const brand    = document.getElementById('blog-brand').value.trim() || (nfSettings.bizname || 'My Site');
    const length   = document.getElementById('blog-length').value;
    const tone     = document.getElementById('blog-tone').value;
    const wantFaq  = document.getElementById('blog-faq').checked;
    const wantCta  = document.getElementById('blog-cta').checked;
    const wantMeta = document.getElementById('blog-meta').checked;
    const wantSchema = document.getElementById('blog-schema').checked;
    const notes    = document.getElementById('blog-notes').value.trim();

    // Show progress, hide form & output
    document.getElementById('blog-form').style.display = 'none';
    document.getElementById('blog-output').style.display = 'none';
    document.getElementById('blog-progress').style.display = 'block';
    blogProgressSet(10, 'Planning article structure...', 'outline');

    const typeLabels = {
      'how-to': 'How-To Guide', 'listicle': 'Listicle', 'informational': 'Informational Article',
      'comparison': 'Comparison Article', 'review': 'Review', 'local': 'Local Service Page', 'news': 'News Article'
    };

    const prompt = `Write a complete, high-quality ${typeLabels[type]} blog post for the following:

TOPIC/KEYWORD: ${keyword}
ARTICLE TYPE: ${typeLabels[type]}
TARGET AUDIENCE: ${audience}
BRAND/SITE: ${brand}
WORD COUNT TARGET: ~${length} words
TONE: ${tone}
${notes ? 'ADDITIONAL NOTES: ' + notes : ''}

Requirements:
- Write the FULL article, not a summary or outline
- Use proper H1, H2, H3 heading hierarchy
- Include intro paragraph that hooks the reader and includes the primary keyword
- Include body sections that are detailed and genuinely helpful
- Use natural LSI keywords throughout
- ${wantFaq ? 'Include a FAQ section at the end with 4-6 common questions and detailed answers' : 'No FAQ section needed'}
- ${wantCta ? 'End with a compelling CTA relevant to ' + brand : 'No explicit CTA'}

Return ONLY a JSON object with this exact structure — no markdown fences, no preamble:
{
  "title": "H1 title",
  "metaTitle": "SEO meta title (60 chars max)",
  "metaDescription": "Meta description (155 chars max)",
  "slug": "url-friendly-slug",
  "htmlContent": "Complete article HTML using <h1>, <h2>, <h3>, <p>, <ul>, <ol>, <li> tags. ${wantFaq ? 'Wrap FAQ items in <div class=\\"faq-block\\"><strong>Q:</strong> question<br><p>A: answer</p></div>.' : ''} ${wantCta ? 'End with <div class=\\"cta-block\\"><h3>CTA heading</h3><p>CTA text</p></div>.' : ''}",
  "wordCount": estimated_word_count_number,
  "sections": number_of_h2_sections,
  "faqCount": number_of_faqs_or_0,
  ${wantSchema ? '"schema": "Complete Article JSON-LD schema as a string",' : '"schema": "",'}
  "lsiKeywords": ["keyword1", "keyword2", "keyword3", "keyword4", "keyword5"]
}`;

    try {
      blogProgressSet(30, 'AI writing your article...', 'content');
      // Gemini free API call
      let _geminiRaw = await geminiCall(prompt, 4096);

      blogProgressSet(65, 'Finalising content...', 'seo');

      let raw = _geminiRaw;
      raw = raw.replace(/^```json\s*/i,'').replace(/^```\s*/,'').replace(/\s*```$/,'').trim();

      blogProgressSet(85, 'Building preview...', 'schema');
      const article = JSON.parse(raw);
      await new Promise(r => setTimeout(r, 400));

      blogProgressSet(100, 'Done!', 'done');
      await new Promise(r => setTimeout(r, 500));

      // Build meta tags string
      const metaTags = `<title>${article.metaTitle || article.title}</title>
<meta name="description" content="${article.metaDescription}">
<meta name="keywords" content="${(article.lsiKeywords||[]).join(', ')}">
<link rel="canonical" href="https://yoursite.com/${article.slug}">
<meta property="og:title" content="${article.metaTitle || article.title}">
<meta property="og:description" content="${article.metaDescription}">
<meta property="og:type" content="article">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:title" content="${article.metaTitle || article.title}">
<meta name="twitter:description" content="${article.metaDescription}">`;

      // Store data
      blogData.html = article.htmlContent || '';
      blogData.text = (article.htmlContent||'').replace(/<[^>]*>/g,' ').replace(/\s+/g,' ').trim();
      blogData.meta = metaTags;
      blogData.schema = article.schema || '';

      // Update stats
      const wc = article.wordCount || blogData.text.split(' ').length;
      document.getElementById('blog-stat-words').textContent = wc.toLocaleString();
      document.getElementById('blog-stat-sections').textContent = article.sections || '?';
      document.getElementById('blog-stat-faqs').textContent = article.faqCount || '0';
      document.getElementById('blog-stat-readtime').textContent = Math.max(1, Math.round(wc/200));

      // Render preview
      // Sanitize AI content before injecting to prevent XSS
      const sanitized = (article.htmlContent || '').replace(/<script[\s\S]*?<\/script>/gi, '').replace(/on\w+\s*=/gi, 'data-removed=');
      document.getElementById('blog-article-preview').innerHTML = sanitized;
      document.getElementById('blog-html-source').textContent = article.htmlContent || '';
      document.getElementById('blog-meta-source').textContent = metaTags;
      document.getElementById('blog-schema-source').textContent = article.schema || '(Schema not generated)';

      document.getElementById('blog-progress').style.display = 'none';
      document.getElementById('blog-output').style.display = 'block';

      // Update dashboard counter
      dashState.pagesGenerated++;
      try { localStorage.setItem('nf_pages', dashState.pagesGenerated); } catch(e) {}

    } catch(e) {
      document.getElementById('blog-progress').style.display = 'none';
      document.getElementById('blog-form').style.display = 'block';
      alert('Generation failed: ' + e.message + '\n\nCheck your Gemini API key in Settings. Get a free key at aistudio.google.com/app/apikey');
    }
  }

  function switchBlogTab(tab) {
    ['preview','html','meta','schema'].forEach(t => {
      document.getElementById('blog-pane-'+t).style.display = t===tab ? 'block' : 'none';
      document.getElementById('btab-'+t).className = 'blog-tab' + (t===tab ? ' active' : '');
    });
  }

  function copyBlogContent(type) {
    const text = type==='html' ? blogData.html : blogData.text;
    navigator.clipboard.writeText(text).then(() => {
      const btn = document.querySelector(`[onclick="copyBlogContent('${type}')"]`);
      if(btn){ const orig=btn.textContent; btn.textContent='Copied!'; setTimeout(()=>btn.textContent=orig,1500); }
    });
  }

  function downloadBlogPost() {
    const settings = nfSettings;
    const ga4 = settings.ga4 || '';
    const fullHtml = `<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
${blogData.meta}
${blogData.schema ? '<script type="application/ld+json">' + blogData.schema + '<\/script>' : ''}
${ga4 ? `<script async src="https://www.googletagmanager.com/gtag/js?id=${ga4}"><\/script><script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag('js',new Date());gtag('config','${ga4}');<\/script>` : ''}
<style>
body{max-width:800px;margin:40px auto;padding:0 20px;font-family:Georgia,serif;font-size:17px;line-height:1.8;color:#222}
h1{font-size:2em;margin-bottom:0.5em}h2{font-size:1.4em;margin-top:1.5em}h3{font-size:1.1em;margin-top:1.2em}
.faq-block{background:#f5f5f5;border-radius:8px;padding:16px;margin-bottom:12px;border-left:3px solid #00a86b}
.cta-block{background:#f0fff8;border:1px solid #00a86b;border-radius:10px;padding:24px;text-align:center;margin-top:32px}

  /* Section labels like "HOW IT WORKS" */
  .section-label {
    font-family: 'Syne', sans-serif;
    font-size: 12px;
    font-weight: 700;
    letter-spacing: 3px;
    text-transform: uppercase;
    color: var(--accent);
    margin-bottom: 8px;
    display: flex;
    align-items: center;
    gap: 10px;
  }
  .section-label::after {
    content: '';
    flex: 0 0 40px;
    height: 2px;
    background: linear-gradient(90deg, var(--accent), var(--accent2));
    border-radius: 2px;
  }

  /* Big hero-style headings */
  .hero-heading {
    font-family: 'Syne', sans-serif;
    font-size: clamp(28px, 5vw, 48px);
    font-weight: 900;
    text-transform: uppercase;
    letter-spacing: -0.5px;
    line-height: 1.05;
    color: var(--text);
  }
  .hero-heading .highlight {
    background: var(--grad-text);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
  }

  /* Step number circles like in video */
  .step-circle {
    width: 52px; height: 52px;
    border-radius: 50%;
    border: 2px solid transparent;
    background: linear-gradient(var(--surface2), var(--surface2)) padding-box,
                linear-gradient(135deg, #b44fff, #ec4899) border-box;
    display: flex; align-items: center; justify-content: center;
    font-family: 'Syne', sans-serif;
    font-size: 18px; font-weight: 700;
    color: var(--text);
    flex-shrink: 0;
  }

  /* Feature cards like in video */
  .feature-card {
    background: rgba(13,13,24,0.9);
    border: 1px solid var(--border);
    border-radius: 14px;
    padding: 18px 20px;
    display: flex;
    align-items: center;
    gap: 16px;
    transition: all 0.2s ease;
  }
  .feature-card:hover {
    border-color: rgba(0,212,255,0.25);
    box-shadow: 0 4px 24px rgba(0,212,255,0.08);
    transform: translateY(-2px);
  }
  .feature-card-icon {
    width: 44px; height: 44px;
    border-radius: 10px;
    background: rgba(0,212,255,0.08);
    border: 1px solid rgba(0,212,255,0.15);
    display: flex; align-items: center; justify-content: center;
    flex-shrink: 0;
    color: var(--accent);
  }
  .feature-card-label {
    font-family: 'Syne', sans-serif;
    font-size: 11px;
    font-weight: 700;
    letter-spacing: 2.5px;
    text-transform: uppercase;
    color: var(--accent);
    margin-bottom: 2px;
  }
  .feature-card-title {
    font-family: 'Inter', sans-serif;
    font-size: 14px;
    font-weight: 600;
    color: var(--text);
  }

  /* CTA buttons matching video */
  .btn-cta-purple {
    background: var(--grad-btn);
    color: #fff;
    font-family: 'Syne', sans-serif;
    font-size: 16px;
    font-weight: 700;
    letter-spacing: 1.5px;
    text-transform: uppercase;
    padding: 14px 32px;
    border-radius: 50px;
    border: none;
    cursor: pointer;
    transition: all 0.2s ease;
    box-shadow: 0 4px 20px rgba(139,92,246,0.4);
  }
  .btn-cta-purple:hover {
    filter: brightness(1.15);
    transform: translateY(-2px);
    box-shadow: 0 8px 32px rgba(139,92,246,0.5);
  }
  .btn-cta-green {
    background: var(--grad-btn-green);
    color: #000;
    font-family: 'Syne', sans-serif;
    font-size: 16px;
    font-weight: 700;
    letter-spacing: 1.5px;
    text-transform: uppercase;
    padding: 14px 32px;
    border-radius: 50px;
    border: none;
    cursor: pointer;
    transition: all 0.2s ease;
    box-shadow: 0 4px 20px rgba(0,230,118,0.35);
  }
  .btn-cta-green:hover {
    filter: brightness(1.1);
    transform: translateY(-2px);
  }

  /* Background glow like in video — teal/purple corner glows */
  .mesh-blob-1 {
    background: radial-gradient(circle, rgba(0,188,212,0.12), transparent 70%) !important;
  }
  .mesh-blob-2 {
    background: radial-gradient(circle, rgba(180,79,255,0.1), transparent 70%) !important;
  }
  .mesh-blob-3 {
    background: radial-gradient(circle, rgba(0,150,200,0.06), transparent 70%) !important;
  }

  /* Gradient underline divider */
  .grad-divider {
    width: 60px; height: 3px;
    background: linear-gradient(90deg, var(--accent), var(--accent2));
    border-radius: 3px;
    margin: 8px auto 0;
  }

  /* Theme cards updated with video style */
  .theme-card {
    background: rgba(13,13,24,0.95) !important;
    border: 1px solid rgba(30,30,48,0.8) !important;
  }
  .theme-card:hover {
    border-color: rgba(0,212,255,0.3) !important;
    box-shadow: 0 16px 48px rgba(0,0,0,0.6), 0 0 32px rgba(0,212,255,0.08) !important;
  }
  .theme-name {
    font-family: 'Syne', sans-serif !important;
    font-size: 16px !important;
    font-weight: 700 !important;
    letter-spacing: 0.3px !important;
    text-transform: uppercase !important;
  }
  .theme-category {
    font-family: 'Inter', sans-serif !important;
    font-size: 10px !important;
    letter-spacing: 1.5px !important;
  }

  /* Stat values — Syne */
  .stat-value {
    font-family: 'Syne', sans-serif !important;
    font-weight: 900 !important;
  }

  /* Page title in topbar */
  .page-title {
    font-family: 'Syne', sans-serif !important;
    font-size: 18px !important;
    font-weight: 700 !important;
    letter-spacing: 1px !important;
    text-transform: uppercase !important;
  }

  /* Nav section labels */
  .nav-section {
    font-family: 'Inter', sans-serif !important;
    font-size: 8px !important;
    letter-spacing: 2px !important;
    color: #444466 !important;
  }

  /* Card titles */
  .card-title {
    font-family: 'Syne', sans-serif !important;
    font-size: 15px !important;
    font-weight: 700 !important;
    letter-spacing: 0.5px !important;
    text-transform: uppercase !important;
  }

  /* Quick action titles */
  .quick-title {
    font-family: 'Syne', sans-serif !important;
    font-size: 15px !important;
    font-weight: 700 !important;
    letter-spacing: 0.5px !important;
    text-transform: uppercase !important;
  }

  /* Filter pills */
  .filter-pill {
    font-family: 'Inter', sans-serif !important;
  }
  .filter-pill.active {
    background: rgba(0,212,255,0.08) !important;
    border-color: rgba(0,212,255,0.3) !important;
    color: var(--accent) !important;
  }

  /* Logo mark */
  .logo-mark {
    font-family: 'Syne', sans-serif !important;
    font-size: 20px !important;
    font-weight: 800 !important;
    letter-spacing: 1px !important;
    text-transform: uppercase !important;
  }
  .logo-mark span { color: var(--accent) !important; }

  /* Gradient text utility */
  .grad-text {
    background: var(--grad-text);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
  }

  /* Topbar border glow */
  .topbar {
    border-bottom: 1px solid rgba(0,212,255,0.08) !important;
  }

  /* Active nav left bar — cyan */
  .nav-item::before {
    background: var(--accent) !important;
  }

  /* Scrollbar accent */
  ::-webkit-scrollbar-thumb {
    background: rgba(0,212,255,0.12) !important;
  }
  ::-webkit-scrollbar-thumb:hover {
    background: rgba(0,212,255,0.22) !important;
  }

  /* Theme card accent tag colors updated */
  .theme-tag.accent { background: rgba(0,212,255,0.08) !important; color: var(--accent) !important; border-color: rgba(0,212,255,0.15) !important; }
  .theme-tag.purple { background: rgba(180,79,255,0.08) !important; color: var(--accent2) !important; border-color: rgba(180,79,255,0.15) !important; }

  /* Blog tab active matches video cyan */
  .blog-tab.active { background: var(--grad-btn) !important; color: #fff !important; }

  /* Badge colors */
  .badge-live { background: rgba(0,212,255,0.08) !important; color: var(--accent) !important; border-color: rgba(0,212,255,0.15) !important; }

  /* Btn primary in forms */
  .btn-primary { font-family: 'Inter', sans-serif !important; letter-spacing: 0.5px !important; }

  /* Alert success cyan */
  .alert-success { background: rgba(0,212,255,0.06) !important; border-color: rgba(0,212,255,0.15) !important; color: var(--accent) !important; }

  /* Type/site-type cards selected state */
  .type-card.selected, .site-type-card.selected {
    border-color: var(--accent) !important;
    background: rgba(0,212,255,0.05) !important;
    box-shadow: 0 0 20px rgba(0,212,255,0.1) !important;
  }

  /* Step numbers (wizard) */
  .step.active .step-num {
    border-color: var(--accent) !important;
    color: var(--accent) !important;
    background: rgba(0,212,255,0.08) !important;
  }
  .step.done .step-num {
    background: var(--accent) !important;
    border-color: var(--accent) !important;
    color: #000 !important;
  }

  /* SEO score colors */
  .seo-score-num { font-family: 'Syne', sans-serif !important; }

  /* Insight action links */
  .insight-action { color: var(--accent) !important; }

  /* Status dot */
  .dot { background: var(--accent) !important; }

  /* Mobile logo */
  .mob-logo span { color: var(--accent) !important; }
  .mob-logo { font-family: 'Syne', sans-serif !important; font-size: 20px !important; font-weight: 800 !important; letter-spacing: 1px !important; text-transform: uppercase !important; }

  /* Niche badge glow updated */
  .nav-badge { box-shadow: 0 0 8px rgba(0,212,255,0.4) !important; }

  /* Keyword table diff colors */
  .diff-easy { color: var(--accent) !important; }

  /* Platform tab active */
  .platform-tab.active { border-color: var(--accent) !important; background: rgba(0,212,255,0.04) !important; box-shadow: 0 0 20px rgba(0,212,255,0.1) !important; }

  /* Injector active */
  .injector-card.inj-active { border-color: rgba(0,212,255,0.2) !important; }
  .inj-status-pill.active { background: rgba(0,212,255,0.08) !important; color: var(--accent) !important; border-color: rgba(0,212,255,0.15) !important; }
  .inj-toggle input:checked + .inj-slider { background: rgba(0,212,255,0.12) !important; border-color: var(--accent) !important; }
  .inj-toggle input:checked + .inj-slider:before { background: var(--accent) !important; }

  /* ── Premium Tech Type System: Syne + Inter ── */

  /* Base body */
  body {
    font-family: 'Inter', sans-serif !important;
    font-size: 13.5px !important;
    line-height: 1.6 !important;
    -webkit-font-smoothing: antialiased;
    -moz-osx-font-smoothing: grayscale;
    letter-spacing: -0.01em;
  }

  /* All headings → Syne */
  h1, h2, h3, h4, h5, h6,
  .card-title, .quick-title, .stat-value,
  .page-title, .logo-mark, .mob-logo,
  .theme-name, .hero-heading, .form-section-title,
  .site-name, .niche-card h3, .deploy-step-name {
    font-family: 'Syne', sans-serif !important;
    letter-spacing: -0.02em !important;
  }

  /* Nav items → Inter medium */
  .nav-item {
    font-family: 'Inter', sans-serif !important;
    font-size: 12.5px !important;
    font-weight: 500 !important;
    letter-spacing: -0.01em !important;
  }

  /* Nav sections → Inter uppercase small */
  .nav-section {
    font-family: 'Inter', sans-serif !important;
    font-size: 9px !important;
    font-weight: 700 !important;
    letter-spacing: 0.12em !important;
    text-transform: uppercase !important;
    color: #3a3a55 !important;
  }

  /* Logo */
  .logo-mark {
    font-family: 'Syne', sans-serif !important;
    font-weight: 800 !important;
    font-size: 17px !important;
    letter-spacing: -0.04em !important;
    text-transform: none !important;
  }
  .logo-sub {
    font-family: 'Inter', sans-serif !important;
    font-size: 9px !important;
    font-weight: 500 !important;
    letter-spacing: 0.15em !important;
    text-transform: uppercase !important;
  }

  /* Page title in topbar */
  .page-title {
    font-family: 'Syne', sans-serif !important;
    font-size: 16px !important;
    font-weight: 700 !important;
    letter-spacing: -0.03em !important;
    text-transform: none !important;
  }

  /* Stat cards */
  .stat-value {
    font-family: 'Syne', sans-serif !important;
    font-size: 28px !important;
    font-weight: 800 !important;
    letter-spacing: -0.04em !important;
  }
  .stat-label {
    font-family: 'Inter', sans-serif !important;
    font-size: 10px !important;
    font-weight: 600 !important;
    letter-spacing: 0.08em !important;
    text-transform: uppercase !important;
  }
  .stat-sub {
    font-family: 'Inter', sans-serif !important;
    font-size: 11px !important;
    font-weight: 400 !important;
  }

  /* Card titles */
  .card-title {
    font-family: 'Syne', sans-serif !important;
    font-size: 14px !important;
    font-weight: 700 !important;
    letter-spacing: -0.02em !important;
    text-transform: none !important;
  }

  /* Quick action titles */
  .quick-title {
    font-family: 'Syne', sans-serif !important;
    font-size: 13px !important;
    font-weight: 700 !important;
    letter-spacing: -0.02em !important;
    text-transform: none !important;
  }
  .quick-desc {
    font-family: 'Inter', sans-serif !important;
    font-size: 11.5px !important;
    font-weight: 400 !important;
    line-height: 1.5 !important;
  }

  /* Buttons */
  .btn {
    font-family: 'Inter', sans-serif !important;
    font-size: 12.5px !important;
    font-weight: 600 !important;
    letter-spacing: -0.01em !important;
  }
  .btn-cta-purple, .btn-cta-green {
    font-family: 'Syne', sans-serif !important;
    font-size: 13px !important;
    font-weight: 700 !important;
    letter-spacing: 0.02em !important;
    text-transform: uppercase !important;
  }

  /* Niche cards */
  .niche-card h3 {
    font-family: 'Syne', sans-serif !important;
    font-size: 15px !important;
    font-weight: 700 !important;
    letter-spacing: -0.03em !important;
    margin-bottom: 6px !important;
  }
  .niche-card p, .niche-card div {
    font-family: 'Inter', sans-serif !important;
  }

  /* RPM badge */
  .rpm-badge {
    font-family: 'Syne', sans-serif !important;
    font-weight: 700 !important;
    font-size: 11px !important;
    letter-spacing: 0em !important;
  }

  /* Form labels */
  label, .form-section-title {
    font-family: 'Inter', sans-serif !important;
  }
  .form-section-title {
    font-family: 'Syne', sans-serif !important;
    font-size: 14px !important;
    font-weight: 700 !important;
    letter-spacing: -0.02em !important;
  }

  /* Inputs, selects, textareas */
  input, select, textarea {
    font-family: 'Inter', sans-serif !important;
    font-size: 13px !important;
  }

  /* Table headings */
  .kw-table th {
    font-family: 'Inter', sans-serif !important;
    font-size: 9.5px !important;
    font-weight: 700 !important;
    letter-spacing: 0.1em !important;
  }
  .kw-table td {
    font-family: 'Inter', sans-serif !important;
    font-size: 12.5px !important;
  }

  /* Section labels */
  .section-label {
    font-family: 'Inter', sans-serif !important;
    font-size: 10px !important;
    font-weight: 700 !important;
    letter-spacing: 0.15em !important;
    text-transform: uppercase !important;
  }

  /* Hero headings */
  .hero-heading {
    font-family: 'Syne', sans-serif !important;
    font-weight: 800 !important;
    letter-spacing: -0.04em !important;
    text-transform: none !important;
    line-height: 1.1 !important;
  }

  /* Theme store names */
  .theme-name {
    font-family: 'Syne', sans-serif !important;
    font-size: 14px !important;
    font-weight: 700 !important;
    letter-spacing: -0.02em !important;
    text-transform: none !important;
  }
  .theme-category {
    font-family: 'Inter', sans-serif !important;
    font-size: 10px !important;
    font-weight: 500 !important;
    letter-spacing: 0.08em !important;
    text-transform: uppercase !important;
  }

  /* Filter pills */
  .filter-pill {
    font-family: 'Inter', sans-serif !important;
    font-size: 11.5px !important;
    font-weight: 500 !important;
    letter-spacing: -0.01em !important;
  }

  /* Badges */
  .nav-badge, .site-badge, .status-badge, .tag, .theme-tag {
    font-family: 'Inter', sans-serif !important;
    font-weight: 700 !important;
  }

  /* Activity text */
  .activity-text {
    font-family: 'Inter', sans-serif !important;
    font-size: 12px !important;
    line-height: 1.5 !important;
  }
  .activity-time {
    font-family: 'Inter', sans-serif !important;
    font-size: 10.5px !important;
  }

  /* Code blocks */
  .inj-code-block {
    font-family: 'Syne Mono', 'Courier New', monospace !important;
    font-size: 11px !important;
  }

  /* Step numbers */
  .step-num, .step-circle {
    font-family: 'Syne', sans-serif !important;
    font-weight: 700 !important;
  }

  /* Muted text readability boost */
  .muted, [style*="color:var(--muted)"], [style*="color: var(--muted)"] {
    color: #9999bb !important;
  }
  :root {
    --muted: #9999bb !important;
  }

  /* Dashboard greeting */
  #dash-greeting {
    font-family: 'Syne', sans-serif !important;
    font-weight: 800 !important;
    letter-spacing: -0.04em !important;
  }

  /* Mobile logo */
  .mob-logo {
    font-family: 'Syne', sans-serif !important;
    font-weight: 800 !important;
    font-size: 18px !important;
    letter-spacing: -0.04em !important;
    text-transform: none !important;
  }

  /* Blog tabs */
  .blog-tab {
    font-family: 'Inter', sans-serif !important;
    font-size: 12px !important;
    font-weight: 600 !important;
  }
  .seo-tab {
    font-family: 'Inter', sans-serif !important;
    font-size: 12px !important;
  }

  /* Platform tab text */
  .ptab-name {
    font-family: 'Syne', sans-serif !important;
    font-weight: 700 !important;
    font-size: 13px !important;
    letter-spacing: -0.02em !important;
  }
  .ptab-sub {
    font-family: 'Inter', sans-serif !important;
    font-size: 11px !important;
  }

  /* Insight items */
  .insight-text {
    font-family: 'Inter', sans-serif !important;
    font-size: 12.5px !important;
    line-height: 1.6 !important;
  }
  .insight-action {
    font-family: 'Inter', sans-serif !important;
    font-size: 11px !important;
    font-weight: 600 !important;
  }

  /* Niche search + table readability */
  .diff-easy, .diff-med, .diff-hard {
    font-family: 'Inter', sans-serif !important;
    font-size: 11.5px !important;
    font-weight: 700 !important;
  }

  /* Wizard step labels */
  .step {
    font-family: 'Inter', sans-serif !important;
    font-size: 12.5px !important;
    font-weight: 500 !important;
  }

  /* Deploy step text */
  .deploy-step-name {
    font-family: 'Syne', sans-serif !important;
    font-size: 13px !important;
    font-weight: 600 !important;
    letter-spacing: -0.02em !important;
  }
  .deploy-step-desc {
    font-family: 'Inter', sans-serif !important;
    font-size: 11px !important;
  }

  /* Health items */
  .health-score {
    font-family: 'Syne', sans-serif !important;
    font-weight: 800 !important;
  }

  /* SEO score */
  .seo-score-num {
    font-family: 'Syne', sans-serif !important;
    font-weight: 800 !important;
    letter-spacing: -0.04em !important;
  }
  .seo-score-label {
    font-family: 'Inter', sans-serif !important;
    font-size: 10px !important;
    font-weight: 600 !important;
    letter-spacing: 0.08em !important;
  }

  /* Blog article preview */
  #blog-article-preview h1 { font-family: 'Syne', sans-serif !important; font-size: 24px !important; font-weight: 800 !important; letter-spacing: -0.03em !important; }
  #blog-article-preview h2 { font-family: 'Syne', sans-serif !important; font-size: 18px !important; font-weight: 700 !important; letter-spacing: -0.02em !important; }
  #blog-article-preview h3 { font-family: 'Syne', sans-serif !important; font-size: 15px !important; font-weight: 600 !important; }
  #blog-article-preview p, #blog-article-preview li { font-family: 'Inter', sans-serif !important; font-size: 14px !important; line-height: 1.8 !important; color: #ccccdd !important; }


  /* ── Bebas Neue — ultra-tall display font for theme card previews ── */
  .theme-preview-title {
    font-family: 'Bebas Neue', sans-serif !important;
    font-size: 36px !important;
    font-weight: 400 !important;
    letter-spacing: 4px !important;
    line-height: 1 !important;
    color: #fff !important;
    text-transform: uppercase !important;
  }
  .theme-preview-sub {
    font-family: 'Inter', sans-serif !important;
    font-size: 9px !important;
    font-weight: 600 !important;
    letter-spacing: 4px !important;
    text-transform: uppercase !important;
    color: rgba(255,255,255,0.4) !important;
    margin-top: 6px !important;
  }
  .theme-preview-divider {
    width: 40px;
    height: 2px;
    background: linear-gradient(90deg, var(--accent), var(--accent2));
    border-radius: 2px;
    margin: 8px 0;
  }

  /* ============================================================ */
  /* AI BUILDER + DESIGN STUDIO CSS                               */
  /* ============================================================ */

  /* Builder mode tabs */
  .builder-tab {
    display:flex;align-items:center;gap:7px;
    padding:10px 16px;border-radius:10px;
    background:var(--surface2);border:1px solid var(--border);
    color:var(--muted);font-family:var(--font-body);font-size:12.5px;font-weight:600;
    cursor:pointer;transition:all 0.2s ease;
  }
  .builder-tab:hover { border-color:rgba(0,212,255,0.3);color:var(--text); }
  .builder-tab.active {
    background:rgba(0,212,255,0.08);border-color:rgba(0,212,255,0.35);
    color:var(--accent);box-shadow:0 0 16px rgba(0,212,255,0.08);
  }

  /* Section toggles */
  .section-toggle {
    display:inline-flex;align-items:center;gap:5px;
    padding:5px 10px;border-radius:20px;font-size:11px;font-weight:600;
    background:var(--surface2);border:1px solid var(--border);
    cursor:pointer;transition:all 0.15s ease;color:var(--muted);
  }
  .section-toggle:has(input:checked) {
    background:rgba(0,212,255,0.08);border-color:rgba(0,212,255,0.3);color:var(--accent);
  }
  .section-toggle input { display:none; }

  /* Chat chips */
  .chat-chip {
    padding:5px 11px;border-radius:20px;font-size:11px;font-weight:500;
    background:var(--surface2);border:1px solid var(--border);color:var(--muted);
    cursor:pointer;transition:all 0.15s ease;
  }
  .chat-chip:hover { border-color:var(--accent);color:var(--accent); }

  /* Chat messages */
  .chat-msg-user {
    align-self:flex-end;background:rgba(0,212,255,0.1);border:1px solid rgba(0,212,255,0.2);
    border-radius:10px 10px 2px 10px;padding:8px 12px;font-size:12px;max-width:90%;
  }
  .chat-msg-ai {
    align-self:flex-start;background:var(--surface2);border:1px solid var(--border);
    border-radius:10px 10px 10px 2px;padding:8px 12px;font-size:12px;max-width:90%;
    color:var(--muted);
  }

  /* Preview size buttons */
  .preview-size-btn {
    width:28px;height:28px;border-radius:6px;font-size:13px;
    background:var(--surface);border:1px solid var(--border);cursor:pointer;
    display:flex;align-items:center;justify-content:center;transition:all 0.15s;
  }
  .preview-size-btn.active, .preview-size-btn:hover {
    background:rgba(0,212,255,0.1);border-color:rgba(0,212,255,0.3);
  }

  /* Design Studio option buttons */
  .ds-option-btn {
    padding:8px 10px;border-radius:8px;font-size:11.5px;font-weight:600;text-align:center;
    background:var(--surface2);border:1px solid var(--border);color:var(--muted);
    cursor:pointer;transition:all 0.15s ease;
  }
  .ds-option-btn:hover { border-color:rgba(0,212,255,0.3);color:var(--text); }
  .ds-option-btn.active {
    background:rgba(0,212,255,0.08);border-color:rgba(0,212,255,0.35);color:var(--accent);
  }

  /* Background type buttons */
  .bg-type-btn {
    flex:1;padding:8px;border-radius:8px;font-size:12px;font-weight:600;text-align:center;
    background:var(--surface2);border:1px solid var(--border);color:var(--muted);
    cursor:pointer;transition:all 0.15s ease;
  }
  .bg-type-btn.active { background:rgba(0,212,255,0.08);border-color:rgba(0,212,255,0.35);color:var(--accent); }

  /* Animation option cards */
  .anim-option {
    padding:14px 8px;border-radius:10px;text-align:center;
    background:var(--surface2);border:1px solid var(--border);
    cursor:pointer;transition:all 0.2s ease;
  }
  .anim-option:hover { border-color:rgba(0,212,255,0.25); transform:translateY(-1px); }
  .anim-option.active { background:rgba(0,212,255,0.08);border-color:rgba(0,212,255,0.4); }

  /* Color swatch */
  .color-swatch {
    height:28px;border-radius:6px;cursor:pointer;border:2px solid transparent;
    transition:all 0.15s ease;
  }
  .color-swatch:hover { border-color:rgba(255,255,255,0.4);transform:scale(1.1); }

  /* Gradient presets */
  .grad-preset {
    height:36px;border-radius:8px;cursor:pointer;
    display:flex;align-items:center;justify-content:center;
    font-size:10px;font-weight:700;color:rgba(255,255,255,0.7);
    border:2px solid transparent;transition:all 0.15s ease;
  }
  .grad-preset:hover { border-color:rgba(255,255,255,0.3);transform:scale(1.02); }

  /* Scheme preset swatches */
  .scheme-swatch {
    border-radius:10px;padding:10px 8px;cursor:pointer;text-align:center;
    background:var(--surface2);border:1px solid var(--border);
    transition:all 0.15s ease;
  }
  .scheme-swatch:hover { border-color:rgba(255,255,255,0.2);transform:translateY(-1px); }
  .scheme-swatch.active { border-color:var(--accent); }
  .scheme-dots { display:flex;gap:4px;justify-content:center;margin-bottom:6px; }
  .scheme-dot { width:14px;height:14px;border-radius:50%; }
  .scheme-name { font-size:9px;font-weight:700;color:var(--muted);text-transform:uppercase;letter-spacing:0.5px; }

  /* Saved theme items */
  .saved-theme-item {
    display:flex;align-items:center;justify-content:space-between;
    padding:10px 12px;border-radius:10px;background:var(--surface2);
    border:1px solid var(--border);cursor:pointer;transition:all 0.15s;
  }
  .saved-theme-item:hover { border-color:rgba(0,212,255,0.3); }

  /* Builder generating spinner */
  @keyframes spin { from{transform:rotate(0deg)} to{transform:rotate(360deg)} }

  /* Image drop zone hover */
  #b-img-drop:hover {
    border-color:rgba(0,212,255,0.4);
    background:rgba(0,212,255,0.03);
  }

  /* Canvas for animated backgrounds */
  #bg-canvas {
    position:fixed;top:0;left:0;width:100%;height:100%;
    pointer-events:none;z-index:0;
  }

  /* Builder layout responsive */
  @media (max-width:900px) {
    #builder-layout { grid-template-columns:1fr !important; }
  }
  @media (max-width:700px) {
    #panel-design .card { padding:14px !important; }
  }

  /* ══════════════════════════════════════════════════════════
     CINEMATIC BUILDER + DESIGN STUDIO — MOBILE-FIRST CSS
     ══════════════════════════════════════════════════════════ */

  /* ── Mode cards grid ── */
  #builder-mode-cards {
    display:grid;
    grid-template-columns:repeat(4,1fr);
    gap:10px;
    margin-bottom:24px;
  }
  @media(max-width:600px){
    #builder-mode-cards { grid-template-columns:repeat(2,1fr); gap:8px; }
  }

  .bmode-card {
    position:relative;
    padding:16px 10px;border-radius:14px;text-align:center;
    background:var(--surface2);border:1.5px solid var(--border);
    cursor:pointer;transition:all 0.2s ease;
    display:flex;flex-direction:column;align-items:center;gap:6px;
  }
  .bmode-card:active { transform:scale(0.97); }
  .bmode-card.active {
    background:rgba(0,212,255,0.06);
    border-color:rgba(0,212,255,0.45);
    box-shadow:0 0 20px rgba(0,212,255,0.1),0 4px 16px rgba(0,0,0,0.3);
  }
  .bmode-card-icon {
    width:48px;height:48px;border-radius:12px;
    background:rgba(0,212,255,0.1);border:1px solid rgba(0,212,255,0.15);
    display:flex;align-items:center;justify-content:center;
    color:var(--accent);flex-shrink:0;
  }
  .bmode-card.active .bmode-card-icon { box-shadow:0 0 14px rgba(0,212,255,0.4); }
  .bmode-card-label { font-family:var(--font-heading);font-size:12px;font-weight:700;color:var(--text);line-height:1.2; }
  .bmode-card-sub { font-size:10px;color:var(--muted);line-height:1.3; }
  .bmode-badge {
    position:absolute;top:-7px;right:-4px;
    font-size:8px;font-weight:800;padding:2px 6px;border-radius:20px;color:#fff;
    text-transform:uppercase;letter-spacing:0.5px;white-space:nowrap;
  }

  /* ── Cinematic arena canvas ── */
  .builder-arena { margin-bottom:0; }
  .arena-canvas {
    position:relative;overflow:hidden;border-radius:18px;
    background:linear-gradient(160deg,#06080f 0%,#0d0d20 60%,#080612 100%);
    border:1px solid rgba(0,212,255,0.15);
    box-shadow:0 0 50px rgba(0,212,255,0.04),0 16px 48px rgba(0,0,0,0.5);
  }
  .arena-stars {
    position:absolute;inset:0;width:100%;height:100%;pointer-events:none;
  }
  .arena-inner {
    position:relative;z-index:2;
    padding:36px 20px 32px;
    text-align:center;
    display:flex;flex-direction:column;align-items:center;gap:14px;
  }
  @media(min-width:600px){
    .arena-inner { padding:48px 32px 40px; }
  }
  .arena-badge {
    display:inline-flex;align-items:center;
    padding:5px 14px;border-radius:20px;
    border:1px solid rgba(0,212,255,0.35);
    font-size:9px;font-weight:800;letter-spacing:2px;
    color:var(--accent);text-transform:uppercase;
    background:rgba(0,212,255,0.06);
    backdrop-filter:blur(8px);
  }
  .arena-title {
    font-family:var(--font-heading);
    font-size:clamp(20px,5vw,34px);
    font-weight:800;letter-spacing:-0.5px;
    color:#fff;line-height:1.15;
  }
  .arena-subtitle {
    color:rgba(255,255,255,0.4);
    font-size:12px;
    max-width:420px;
    line-height:1.5;
  }

  /* ── Arena textarea ── */
  .arena-input {
    width:100%;padding:14px 16px;
    background:rgba(255,255,255,0.04);
    border:1px solid rgba(0,212,255,0.22);
    border-radius:12px;
    color:#fff;font-family:var(--font-body);font-size:13px;line-height:1.7;
    resize:vertical;outline:none;transition:border-color 0.2s,box-shadow 0.2s;
    backdrop-filter:blur(8px);
    margin-bottom:10px;
    box-sizing:border-box;
  }
  .arena-input:focus {
    border-color:rgba(0,212,255,0.55);
    box-shadow:0 0 0 3px rgba(0,212,255,0.08),0 0 18px rgba(0,212,255,0.1);
  }
  .arena-input::placeholder { color:rgba(255,255,255,0.22); }

  /* ── URL input row ── */
  .arena-url-input-wrap {
    display:flex;align-items:center;gap:8px;
    background:rgba(255,255,255,0.04);
    border:1.5px solid rgba(180,79,255,0.35);
    border-radius:12px;padding:8px 8px 8px 14px;
    backdrop-filter:blur(8px);transition:border-color 0.2s,box-shadow 0.2s;
    width:100%;box-sizing:border-box;
  }
  .arena-url-input-wrap:focus-within {
    border-color:rgba(180,79,255,0.7);
    box-shadow:0 0 0 3px rgba(180,79,255,0.1),0 0 24px rgba(180,79,255,0.12);
  }
  .arena-url-field {
    flex:1;min-width:0;background:transparent;border:none;outline:none;
    color:#fff;font-family:var(--font-body);font-size:13px;
  }
  .arena-url-field::placeholder { color:rgba(255,255,255,0.25); }
  .arena-url-btn {
    padding:9px 16px;border-radius:9px;white-space:nowrap;
    background:var(--accent2);color:#fff;
    font-family:var(--font-heading);font-size:12px;font-weight:700;
    border:none;cursor:pointer;transition:opacity 0.15s;flex-shrink:0;
  }
  .arena-url-btn:active { opacity:0.8; }

  /* ── Options row (dropdowns) ── */
  .arena-options-row {
    display:flex;gap:7px;flex-wrap:wrap;justify-content:center;
    margin-bottom:14px;width:100%;
  }
  .arena-select {
    padding:9px 10px;border-radius:10px;
    font-size:12px;font-family:var(--font-body);
    background:rgba(255,255,255,0.06);
    border:1px solid rgba(0,212,255,0.18);
    color:#fff;outline:none;cursor:pointer;
    backdrop-filter:blur(4px);
    flex:1 1 140px;min-width:120px;max-width:220px;
    -webkit-appearance:none;appearance:none;
    background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='10' height='6'%3E%3Cpath d='M0 0l5 6 5-6z' fill='rgba(255,255,255,0.3)'/%3E%3C/svg%3E");
    background-repeat:no-repeat;background-position:right 10px center;
    padding-right:28px;
  }
  .arena-select option { background:#0d0d18;color:#fff; }

  /* ── Section toggles ── */
  #b-sections {
    display:flex;flex-wrap:wrap;gap:6px;
    justify-content:center;margin-bottom:18px;
  }
  .section-toggle {
    display:inline-flex;align-items:center;gap:4px;
    padding:6px 12px;border-radius:20px;font-size:11px;font-weight:600;
    background:rgba(255,255,255,0.05);border:1px solid rgba(255,255,255,0.1);
    cursor:pointer;transition:all 0.15s ease;color:rgba(255,255,255,0.5);
    -webkit-user-select:none;user-select:none;
  }
  .section-toggle:has(input:checked) {
    background:rgba(0,212,255,0.1);
    border-color:rgba(0,212,255,0.4);
    color:var(--accent);
  }
  .section-toggle input { display:none; }

  /* ── BIG GENERATE BUTTON ── */
  .arena-generate-btn {
    display:flex;align-items:center;justify-content:center;gap:10px;
    width:100%;max-width:420px;
    padding:15px 28px;border-radius:14px;
    background:linear-gradient(135deg,var(--accent),var(--accent2));
    color:#fff;font-family:var(--font-heading);font-size:15px;font-weight:800;
    border:none;cursor:pointer;letter-spacing:0.3px;
    box-shadow:0 0 28px rgba(0,212,255,0.25),0 6px 20px rgba(0,0,0,0.3);
    transition:all 0.2s ease;
  }
  .arena-generate-btn:hover {
    transform:translateY(-2px);
    box-shadow:0 0 40px rgba(0,212,255,0.35),0 10px 28px rgba(0,0,0,0.4);
  }
  .arena-generate-btn:active { transform:translateY(1px);box-shadow:none; }
  .arena-generate-btn:disabled { opacity:0.5;cursor:not-allowed;transform:none; }

  /* ── Design Studio — single column on mobile ── */
  #panel-design > div > div[style*="grid-template-columns:1fr 1fr"] {
    display:flex !important;
    flex-direction:column !important;
    gap:16px !important;
  }
  @media(min-width:720px){
    #panel-design > div > div[style*="grid-template-columns:1fr 1fr"] {
      display:grid !important;
      grid-template-columns:1fr 1fr !important;
    }
  }

  /* ── Color scheme presets — fix wrapping names ── */
  #ds-scheme-presets {
    grid-template-columns:repeat(4,1fr) !important;
  }
  @media(max-width:500px){
    #ds-scheme-presets { grid-template-columns:repeat(4,1fr) !important; }
  }
  .scheme-swatch { padding:8px 4px !important; }
  .scheme-name { font-size:8px !important; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }

  /* ── Pulse animation ── */
  @keyframes pulse {
    0%,100% { opacity:1;transform:scale(1); }
    50% { opacity:0.5;transform:scale(1.3); }
  }
</style>
</head>
<body>
${blogData.html}
</body>
</html>`;
    const blob = new Blob([fullHtml], {type:'text/html'});
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = 'blog-post.html';
    a.click();
  }

  function resetBlogWriter() {
    document.getElementById('blog-output').style.display = 'none';
    document.getElementById('blog-form').style.display = 'block';
    document.getElementById('blog-keyword').value = '';
    blogData = {html:'',text:'',meta:'',schema:''};
  }



  // ── Theme Store ─────────────────────────────────────────────
  let currentThemeFilter = 'all';
  let currentThemeSearch = '';

  function setThemeFilter(filter, btn) {
    currentThemeFilter = filter;
    document.querySelectorAll('.filter-pill').forEach(p => p.classList.remove('active'));
    if (btn) btn.classList.add('active');
    renderThemeGrid();
  }

  function filterThemes(query) {
    currentThemeSearch = query.toLowerCase();
    renderThemeGrid();
  }

  function renderThemeGrid() {
    const cards = document.querySelectorAll('#theme-grid .theme-card');
    cards.forEach(card => {
      const cat = card.dataset.category || '';
      const name = (card.dataset.name || '').toLowerCase();
      const matchFilter = currentThemeFilter === 'all' || cat === currentThemeFilter;
      const matchSearch = !currentThemeSearch || name.includes(currentThemeSearch);
      card.style.display = (matchFilter && matchSearch) ? '' : 'none';
    });
  }

  function buildWithTheme(themeName, category) {
    // Pre-populate the create site form and navigate there
    showPanel('create', null);
    setTimeout(() => {
      const notesFields = document.querySelectorAll('#panel-create textarea, #panel-create input[type="text"]');
      if (notesFields.length > 0) {
        notesFields[0].value = themeName + ' style site';
      }
      // Flash a notice
      const notice = document.createElement('div');
      notice.className = 'alert alert-success';
      notice.innerHTML = `<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><polyline points="20 6 9 17 4 12"/></svg> Theme "<strong>${themeName}</strong>" loaded — fill in your site details below`;
      notice.style.marginBottom = '16px';
      const firstSection = document.querySelector('#panel-create .form-section');
      if (firstSection) firstSection.insertAdjacentElement('beforebegin', notice);
      setTimeout(() => notice.remove(), 4000);
    }, 150);
  }

  /* ============================================================ */
  /* AI BUILDER JAVASCRIPT                                         */
  /* ============================================================ */

  let builderCurrentMode = 'prompt';
  let builderCurrentHTML = '';
  let builderChatHistory = [];

  // Arena stars animation
  function initArenaStars(canvasId, color1, color2, count) {
    const canvas = document.getElementById(canvasId);
    if (!canvas) return;
    const ctx = canvas.getContext('2d');
    function resize() {
      canvas.width = canvas.offsetWidth;
      canvas.height = canvas.offsetHeight;
    }
    resize();
    new ResizeObserver(resize).observe(canvas.parentElement);

    const stars = Array.from({length: count || 120}, () => ({
      x: Math.random(), y: Math.random(),
      r: Math.random() * 1.5 + 0.3,
      opacity: Math.random() * 0.7 + 0.1,
      twinkleSpeed: 0.005 + Math.random() * 0.015,
      twinklePhase: Math.random() * Math.PI * 2,
      color: Math.random() > 0.7 ? (color1 || '#00d4ff') : (Math.random() > 0.5 ? (color2 || '#b44fff') : '#ffffff')
    }));

    function draw() {
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      const t = Date.now() * 0.001;
      stars.forEach(s => {
        const op = s.opacity * (0.5 + 0.5 * Math.sin(t * s.twinkleSpeed * 60 + s.twinklePhase));
        ctx.beginPath();
        ctx.arc(s.x * canvas.width, s.y * canvas.height, s.r, 0, Math.PI * 2);
        ctx.fillStyle = s.color + Math.floor(op * 255).toString(16).padStart(2, '0');
        ctx.fill();
      });
      requestAnimationFrame(draw);
    }
    draw();
  }

  function switchBuilderMode(mode, btn) {
    builderCurrentMode = mode;
    document.querySelectorAll('.bmode-card').forEach(b => b.classList.remove('active'));
    if (btn) btn.classList.add('active');
    ['prompt','url','image','template'].forEach(m => {
      const a = document.getElementById('arena-' + m);
      if (a) a.style.display = m === mode ? 'block' : 'none';
    });
    if (mode === 'template') renderTemplateGrid();
    // Ensure stars are running for active arena
    setTimeout(() => {
      if (mode === 'prompt') initArenaStars('stars-prompt', '#00d4ff', '#b44fff');
      if (mode === 'url') initArenaStars('stars-url', '#b44fff', '#7c3aed');
      if (mode === 'image') initArenaStars('stars-image', '#ff5580', '#b44fff');
      if (mode === 'template') initArenaStars('stars-template', '#f5c542', '#ff9500');
    }, 50);
  }

  // Init stars on load
  setTimeout(() => initArenaStars('stars-prompt', '#00d4ff', '#b44fff'), 100);

  const BUILDER_TEMPLATES = [
    { name:'Plumber Pro', type:'Local Service', icon:'🔧', color:'#0066cc' },
    { name:'Roofing Elite', type:'Local Service', icon:'🏠', color:'#cc3300' },
    { name:'Fitness Studio', type:'Gym / Fitness', icon:'💪', color:'#ff6b00' },
    { name:'Dental Clinic', type:'Medical', icon:'🦷', color:'#00aaff' },
    { name:'Law Office', type:'Legal', icon:'⚖️', color:'#1a1a40' },
    { name:'Restaurant', type:'Food & Dining', icon:'🍽️', color:'#8b0000' },
    { name:'Real Estate', type:'Property', icon:'🏡', color:'#006633' },
    { name:'SaaS Startup', type:'Tech / SaaS', icon:'🚀', color:'#4a00e0' },
    { name:'Photography', type:'Portfolio', icon:'📷', color:'#1a1a1a' },
    { name:'E-Commerce', type:'Online Store', icon:'🛒', color:'#ff9900' },
    { name:'Wedding', type:'Event', icon:'💍', color:'#c9a96e' },
    { name:'Consulting', type:'Business', icon:'📊', color:'#003366' },
  ];

  function renderTemplateGrid() {
    const grid = document.getElementById('template-grid');
    if (!grid || grid.children.length > 0) return;
    grid.innerHTML = BUILDER_TEMPLATES.map((t, i) => `
      <div onclick="selectBuilderTemplate(${i},this)" style="padding:10px;border-radius:10px;background:var(--surface2);border:1px solid var(--border);cursor:pointer;transition:all 0.15s;text-align:center" class="tmpl-card">
        <div style="font-size:22px;margin-bottom:4px">${t.icon}</div>
        <div style="font-size:11px;font-weight:700;color:var(--text)">${t.name}</div>
        <div style="font-size:9px;color:var(--muted)">${t.type}</div>
      </div>
    `).join('');
  }

  let selectedBuilderTemplate = 0;
  function selectBuilderTemplate(idx, el) {
    selectedBuilderTemplate = idx;
    document.querySelectorAll('.tmpl-card').forEach(c => {
      c.style.borderColor = 'var(--border)';
      c.style.background = 'var(--surface2)';
    });
    el.style.borderColor = 'rgba(0,212,255,0.4)';
    el.style.background = 'rgba(0,212,255,0.06)';
  }

  function handleBuilderImage(input) {
    const file = input.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = e => {
      document.getElementById('b-img-thumb').src = e.target.result;
      document.getElementById('b-img-name').textContent = file.name;
      document.getElementById('b-img-drop').style.display = 'none';
      document.getElementById('b-img-preview').style.display = 'block';
    };
    reader.readAsDataURL(file);
  }

  function handleImgDrop(e) {
    e.preventDefault();
    const file = e.dataTransfer?.files?.[0];
    if (!file || !file.type.startsWith('image/')) return;
    const dt = new DataTransfer();
    dt.items.add(file);
    document.getElementById('b-img-input').files = dt.files;
    handleBuilderImage(document.getElementById('b-img-input'));
  }

  function clearBuilderImage() {
    document.getElementById('b-img-input').value = '';
    document.getElementById('b-img-thumb').src = '';
    document.getElementById('b-img-name').textContent = '';
    document.getElementById('b-img-drop').style.display = 'block';
    document.getElementById('b-img-preview').style.display = 'none';
  }

  async function runBuilder() {
    if (!requireApiKey('AI Builder')) return;
    const btn = document.getElementById('b-generate-btn');
    btn.disabled = true;
    btn.innerHTML = '⏳ Generating...';
    showBuilderState('generating');
    setGenProgress(0, 'Reading your inputs...', 'Connecting to AI engine');

    try {
      let html = '';
      const engine = document.getElementById('b-engine')?.value || 'claude';
      const apiKey = getClaudeKey() || getApiKey(); // prefer Claude, fallback Gemini
      const openaiKey = getOpenAIKey();

      if (builderCurrentMode === 'prompt') {
        html = await buildFromPrompt(apiKey, engine);
      } else if (builderCurrentMode === 'url') {
        html = await buildFromURL(apiKey);
      } else if (builderCurrentMode === 'image') {
        html = await buildFromImage(openaiKey, apiKey);
      } else if (builderCurrentMode === 'template') {
        html = await buildFromTemplate(apiKey);
      }

      if (html) {
        builderCurrentHTML = html;
        builderChatHistory = [];
        renderBuilderPreview(html);
        showBuilderState('preview');
        addChatMsg('ai', '✅ Site generated! Use the chat below to make any changes.');
      }
    } catch(e) {
      showBuilderState('empty');
      alert('Generation failed: ' + e.message);
    }

    btn.disabled = false;
    btn.innerHTML = '⚡ Generate Site';
  }

  async function buildFromPrompt(apiKey, engine) {
    // Extract business name from prompt text (first sentence or use generic)
    const promptText = document.getElementById('b-prompt-main')?.value || '';
    const nameMatch = promptText.match(/called?\s+(["']?)([A-Z][^.!?,"']{2,30})/i) || promptText.match(/^([A-Z][^.!?,]{2,30})/);
    const name = nameMatch ? nameMatch[2] || nameMatch[1] : 'My Business';
    const desc = document.getElementById('b-prompt-main')?.value || document.getElementById('b-desc')?.value || 'A professional website';
    const type = document.getElementById('b-type')?.value || 'Local Service';
    const lang = document.getElementById('b-lang')?.value || 'English';
    const color = document.getElementById('b-color')?.value || 'professional dark';
    const sections = [...document.querySelectorAll('#b-sections input:checked')].map(i=>i.value);

    setGenProgress(20, 'Crafting your site...', 'AI writing HTML, CSS and content');

    const prompt = `You are an expert web designer and developer. Create a complete, beautiful, professional HTML website.

BUSINESS: ${name}
DESCRIPTION: ${desc}
TYPE: ${type}
LANGUAGE: ${lang}
COLOR SCHEME: ${color}
SECTIONS TO INCLUDE: ${sections.join(', ')}

CRITICAL REQUIREMENTS:
- Output ONLY the complete HTML file — nothing else, no explanation, no markdown fences
- Self-contained: all CSS inline in <style> tag, no external dependencies except Google Fonts
- Professional and modern design — looks like a $5,000 custom website
- Mobile responsive with proper viewport meta tag
- SEO optimized: proper title, meta description, H1/H2 hierarchy, semantic HTML5 tags
- Include proper navigation with anchor links to each section
- Hero section: compelling headline, subheadline, and 2 CTA buttons
- Add realistic, detailed content (not lorem ipsum) — business name, services, phone placeholder, address placeholder
- Include smooth scroll behavior
- Footer with copyright, contact info, social placeholders
- Add subtle CSS animations (fade-in on scroll, button hover effects)
- Include Open Graph meta tags for social sharing
- Color scheme: ${color} — make it visually stunning with proper contrast
- Font: Use Google Fonts — pick appropriate fonts for the business type
- Brand logo: text-based logo using business name with styled CSS
- NEVER include placeholder images that require external URLs — use CSS gradient backgrounds instead
- If language is not English, ALL text content must be in ${lang}

Generate the complete HTML now:`;

    setGenProgress(50, 'AI writing your site...', 'Building sections: ' + sections.join(' · '));
    const html = await callBestAI(prompt, apiKey, engine, 8000);
    setGenProgress(90, 'Finalising...', 'Cleaning up code');
    return html.replace(/^```html\s*/i,'').replace(/^```\s*/,'').replace(/\s*```$/,'').trim();
  }

  async function buildFromURL(apiKey) {
    const url = document.getElementById('b-url')?.value;
    if (!url) throw new Error('Please enter a URL to redesign');
    setGenProgress(15, 'Fetching page...', 'Connecting via proxy');

    // Fetch via CORS proxy
    const proxyUrl = `https://api.allorigins.win/get?url=${encodeURIComponent(url)}`;
    let pageContent = '';
    try {
      const resp = await fetch(proxyUrl);
      const data = await resp.json();
      const parser = new DOMParser();
      const doc = parser.parseFromString(data.contents, 'text/html');
      // Extract meaningful content
      const title = doc.title || '';
      const body = doc.body?.innerText?.slice(0, 4000) || '';
      const h1s = [...doc.querySelectorAll('h1,h2,h3')].map(h=>h.textContent.trim()).slice(0,10).join(' | ');
      const metas = [...doc.querySelectorAll('meta[name="description"],meta[property="og:description"]')]
        .map(m=>m.getAttribute('content')).filter(Boolean).join(' ');
      pageContent = `Title: ${title}\nHeadings: ${h1s}\nMeta: ${metas}\nContent: ${body}`;
    } catch(e) {
      pageContent = `URL: ${url} — Could not fetch, use URL context only`;
    }

    setGenProgress(40, 'AI analysing content...', 'Extracting business info');
    const style = document.getElementById('b-url-style')?.value || 'Modern Dark Premium';
    const preserve = document.getElementById('b-url-preserve')?.value || 'All content';
    const lang = document.getElementById('b-url-lang')?.value || 'English';

    const prompt = `You are an expert web designer. Redesign a website based on the following extracted content.

ORIGINAL URL: ${url}
EXTRACTED CONTENT: ${pageContent}
DESIGN STYLE: ${style}
PRESERVE: ${preserve}
LANGUAGE: ${lang}

Create a complete, modern, professional HTML website that:
- Preserves the business identity, name, and key information
- Applies a completely fresh modern design in ${style} style
- Is fully self-contained (all CSS in <style> tag, no external dependencies except Google Fonts)
- Is mobile responsive
- Looks like a premium $5,000+ custom design
- Includes all standard sections: hero, services/features, about, contact, footer
- Has proper SEO meta tags
- Output ONLY the complete HTML, no explanation, no markdown

Generate now:`;

    setGenProgress(60, 'Rebuilding with AI...', 'Applying ' + style + ' design');
    const html = await callBestAI(prompt, apiKey, 'claude', 8000);
    setGenProgress(95, 'Done!', 'Rendering preview');
    return html.replace(/^```html\s*/i,'').replace(/^```\s*/,'').replace(/\s*```$/,'').trim();
  }

  async function buildFromImage(openaiKey, claudeKey) {
    const imgInput = document.getElementById('b-img-input');
    if (!imgInput.files[0]) throw new Error('Please upload a screenshot first');

    setGenProgress(15, 'Reading image...', 'GPT-4o Vision analysing screenshot');

    // Convert image to base64
    const base64 = await new Promise((res, rej) => {
      const r = new FileReader();
      r.onload = () => res(r.result.split(',')[1]);
      r.onerror = rej;
      r.readAsDataURL(imgInput.files[0]);
    });
    const mimeType = imgInput.files[0].type || 'image/jpeg';
    const style = document.getElementById('b-img-style')?.value || 'Same layout, modern redesign';
    const notes = document.getElementById('b-img-notes')?.value || '';

    setGenProgress(30, 'GPT-4o Vision reading screenshot...', 'Identifying layout, fonts, colors');

    // Step 1: GPT-4o Vision analyses the image
    let visionAnalysis = '';
    if (openaiKey) {
      try {
        const visionResp = await fetch('https://api.openai.com/v1/chat/completions', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + openaiKey },
          body: JSON.stringify({
            model: 'gpt-4o',
            max_tokens: 2000,
            messages: [{
              role: 'user',
              content: [
                { type: 'image_url', image_url: { url: `data:${mimeType};base64,${base64}` } },
                { type: 'text', text: 'Analyse this website screenshot in detail. Describe: 1) Layout structure and sections 2) Color scheme (exact colors) 3) Typography style 4) Content and copy 5) Key elements (buttons, cards, icons) 6) Overall aesthetic. Be very specific and detailed.' }
              ]
            }]
          })
        });
        const vd = await visionResp.json();
        visionAnalysis = vd.choices?.[0]?.message?.content || '';
      } catch(e) { visionAnalysis = 'Could not analyse image - proceeding with Claude vision'; }
    }

    setGenProgress(60, 'Claude building HTML...', 'Converting analysis to clean code');

    const prompt = `You are an expert web developer. Build a complete HTML website based on this website screenshot analysis.

SCREENSHOT ANALYSIS:
${visionAnalysis || 'Screenshot provided - recreate as a professional website'}

RECREATION MODE: ${style}
ADDITIONAL NOTES: ${notes}

Requirements:
- Create a complete, professional HTML website
- Self-contained (all CSS inline, no external files except Google Fonts)
- Mobile responsive
- Match the design aesthetic from the screenshot
- Apply modern improvements where appropriate
- Proper SEO meta tags
- Output ONLY the HTML, nothing else

Generate the complete HTML:`;

    const html = await callBestAI(prompt, claudeKey, 'claude', 8000);
    setGenProgress(95, 'Done!', 'Rendering preview');
    return html.replace(/^```html\s*/i,'').replace(/^```\s*/,'').replace(/\s*```$/,'').trim();
  }

  async function buildFromTemplate(apiKey) {
    const tmpl = BUILDER_TEMPLATES[selectedBuilderTemplate];
    const brand = document.getElementById('b-tmpl-brand')?.value || tmpl.name;
    const lang = document.getElementById('b-tmpl-lang')?.value || 'English';

    setGenProgress(20, 'Loading template...', tmpl.name + ' · ' + tmpl.type);

    const prompt = `Create a complete, professional HTML website using the "${tmpl.name}" template style for "${brand}".

TYPE: ${tmpl.type}
BRAND NAME: ${brand}
LANGUAGE: ${lang}
TEMPLATE AESTHETIC: Professional ${tmpl.type} website

Requirements:
- Complete self-contained HTML with all CSS in <style> tag
- Mobile responsive
- Modern professional design appropriate for ${tmpl.type}
- Primary color theme: ${tmpl.color}
- Include: Hero, Services/Features, About, Testimonials, Contact, Footer
- Realistic, compelling content (not lorem ipsum) for ${brand}
- Smooth animations and professional micro-interactions
- Proper SEO meta tags and semantic HTML
- Output ONLY the complete HTML

Generate now:`;

    setGenProgress(50, 'AI crafting template...', 'Writing content and design');
    const html = await callBestAI(prompt, apiKey, 'claude', 8000);
    setGenProgress(95, 'Done!', 'Loading preview');
    return html.replace(/^```html\s*/i,'').replace(/^```\s*/,'').replace(/\s*```$/,'').trim();
  }

  async function callBestAI(prompt, apiKey, engine, maxTokens) {
    if (engine === 'openai' && getOpenAIKey()) {
      const r = await fetch('https://api.openai.com/v1/chat/completions', {
        method:'POST',
        headers:{'Content-Type':'application/json','Authorization':'Bearer '+getOpenAIKey()},
        body:JSON.stringify({ model:'gpt-4o', max_tokens:maxTokens||4096, messages:[{role:'user',content:prompt}] })
      });
      if(!r.ok) throw new Error('OpenAI error '+r.status);
      const d = await r.json();
      return d.choices?.[0]?.message?.content || '';
    } else if (engine === 'gemini' || (!apiKey && !getOpenAIKey())) {
      return await geminiCall(prompt, maxTokens||4096);
    } else {
      // Claude (default, best quality)
      const r = await fetch('https://api.anthropic.com/v1/messages', {
        method:'POST',
        headers:{
          'Content-Type':'application/json',
          'x-api-key': apiKey,
          'anthropic-version':'2023-06-01',
          'anthropic-dangerous-direct-browser-access':'true'
        },
        body:JSON.stringify({ model:'claude-sonnet-4-5', max_tokens:maxTokens||8000, messages:[{role:'user',content:prompt}] })
      });
      if(!r.ok){ const e=await r.json(); throw new Error('Claude error: '+(e.error?.message||r.status)); }
      const d = await r.json();
      return d.content?.map(b=>b.text||'').join('').trim() || '';
    }
  }

  async function runChatEdit() {
    const input = document.getElementById('b-chat-input');
    const instruction = input.value.trim();
    if (!instruction || !builderCurrentHTML) return;
    input.value = '';
    addChatMsg('user', instruction);
    addChatMsg('ai', '⏳ Editing your site...');

    try {
      const prompt = `You are editing an existing website. Make ONLY the requested change. Return the COMPLETE updated HTML.

CURRENT HTML (first 6000 chars):
${builderCurrentHTML.slice(0, 6000)}

INSTRUCTION: ${instruction}

Rules:
- Make exactly the requested change
- Keep all existing sections and content unless told to remove them
- Return ONLY the complete HTML file, no explanation
- Ensure the result is still valid, self-contained HTML

Return the complete updated HTML:`;

      const apiKey = getApiKey();
      const engine = document.getElementById('b-engine')?.value || 'claude';
      const newHTML = await callBestAI(prompt, apiKey, engine, 8000);
      const cleaned = newHTML.replace(/^```html\s*/i,'').replace(/^```\s*/,'').replace(/\s*```$/,'').trim();

      if (cleaned.includes('<!DOCTYPE') || cleaned.includes('<html')) {
        builderCurrentHTML = cleaned;
        renderBuilderPreview(cleaned);
        // Update last AI message
        const msgs = document.querySelectorAll('.chat-msg-ai');
        if(msgs.length) msgs[msgs.length-1].textContent = '✅ Done! Site updated.';
      } else {
        const msgs = document.querySelectorAll('.chat-msg-ai');
        if(msgs.length) msgs[msgs.length-1].textContent = '⚠️ Could not apply change — try rephrasing';
      }
    } catch(e) {
      const msgs = document.querySelectorAll('.chat-msg-ai');
      if(msgs.length) msgs[msgs.length-1].textContent = '❌ Error: ' + e.message;
    }
  }

  function quickEdit(instruction) {
    document.getElementById('b-chat-input').value = instruction;
    runChatEdit();
  }

  function addChatMsg(role, text) {
    const hist = document.getElementById('b-chat-history');
    const div = document.createElement('div');
    div.className = role === 'user' ? 'chat-msg-user' : 'chat-msg-ai';
    div.textContent = text;
    hist.appendChild(div);
    hist.scrollTop = hist.scrollHeight;
  }

  // Allow Enter key in chat
  document.getElementById('b-chat-input')?.addEventListener('keydown', e => {
    if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); runChatEdit(); }
  });

  function renderBuilderPreview(html) {
    const frame = document.getElementById('b-preview-frame');
    if (frame) frame.srcdoc = html;
    const urlEl = document.getElementById('b-preview-url');
    if (urlEl) urlEl.textContent = 'preview://generated-site.html';
    document.getElementById('b-preview-wrap').style.display = 'block';
    const gen = document.getElementById('b-generating');
    if (gen) gen.style.display = 'none';
    // Scroll to preview
    document.getElementById('builder-output')?.scrollIntoView({ behavior:'smooth', block:'start' });
  }

  function showBuilderState(state) {
    const gen = document.getElementById('b-generating');
    const prev = document.getElementById('b-preview-wrap');
    if (gen) gen.style.display = state === 'generating' ? 'block' : 'none';
    if (prev) prev.style.display = state === 'preview' ? 'block' : 'none';
    if (state === 'empty') {
      const out = document.getElementById('builder-output');
      if (out) out.style.display = 'none';
    }
  }

  function setGenProgress(pct, status, sub) {
    const bar = document.getElementById('b-gen-bar');
    const stat = document.getElementById('b-gen-status');
    const subEl = document.getElementById('b-gen-sub');
    if(bar) bar.style.width = pct + '%';
    if(stat) stat.textContent = status;
    if(subEl) subEl.textContent = sub;
  }

  function setPreviewSize(size, btn) {
    const frame = document.getElementById('b-preview-frame');
    document.querySelectorAll('.preview-size-btn').forEach(b=>b.classList.remove('active'));
    if (btn) btn.classList.add('active');
    if(size === 'desktop') { frame.style.width = '100%'; frame.style.height = '620px'; }
    else if(size === 'tablet') { frame.style.width = '768px'; frame.style.height = '620px'; frame.style.margin = '0 auto'; }
    else { frame.style.width = '375px'; frame.style.height = '620px'; frame.style.margin = '0 auto'; }
  }

  function downloadBuilderHTML() {
    if (!builderCurrentHTML) return;
    const blob = new Blob([builderCurrentHTML], {type:'text/html'});
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = 'nicheforge-site.html';
    a.click();
  }

  function copyBuilderHTML() {
    navigator.clipboard.writeText(builderCurrentHTML).then(() => {
      const btn = document.getElementById('b-copy-btn');
      btn.innerHTML = '✅ Copied!';
      setTimeout(()=>btn.innerHTML='📋 Copy Code',2000);
    });
  }

  function clearBuilder() {
    builderCurrentHTML = '';
    builderChatHistory = [];
    document.getElementById('b-chat-history').innerHTML = '';
    showBuilderState('empty');
  }

  function getOpenAIKey() { return localStorage.getItem('nf_openai_key') || ''; }

  /* AI Image Generator */
  async function generateAIImage() {
    const prompt = document.getElementById('img-gen-prompt').value.trim();
    if (!prompt) { alert('Please describe the image you want'); return; }
    const style = document.getElementById('img-gen-style').value;
    const size = document.getElementById('img-gen-size').value;
    const [w, h] = size.split('x').map(Number);
    const btn = document.getElementById('img-gen-btn');
    btn.innerHTML = '⏳ Generating...';
    btn.disabled = true;

    const fullPrompt = encodeURIComponent(`${prompt}, ${style}, highly detailed, professional quality`);
    const imgUrl = `https://image.pollinations.ai/prompt/${fullPrompt}?width=${w}&height=${h}&nologo=true&seed=${Date.now()}`;

    const out = document.getElementById('img-gen-out');
    out.onload = () => {
      document.getElementById('img-gen-result').style.display = 'block';
      document.getElementById('img-gen-dl').href = imgUrl;
      btn.innerHTML = '✨ Generate Image';
      btn.disabled = false;
    };
    out.onerror = () => {
      btn.innerHTML = '✨ Generate Image';
      btn.disabled = false;
      alert('Image generation failed — try a different prompt');
    };
    out.src = imgUrl;
    document.getElementById('img-gen-result').style.display = 'block';
  }

  function copyImageUrl() {
    const url = document.getElementById('img-gen-out').src;
    navigator.clipboard.writeText(url).then(()=>alert('Image URL copied!'));
  }

  /* ============================================================ */
  /* DESIGN STUDIO JAVASCRIPT                                      */
  /* ============================================================ */

  const COLOR_SCHEMES = [
    { name:'Cyber Neon', c1:'#00d4ff', c2:'#b44fff', c3:'#ff4fa3' },
    { name:'Solar Forge', c1:'#ff6b35', c2:'#ffd93d', c3:'#ff3355' },
    { name:'Matrix', c1:'#00ff88', c2:'#00d4aa', c3:'#aaff00' },
    { name:'Royal', c1:'#7c3aed', c2:'#4f46e5', c3:'#3b82f6' },
    { name:'Rose Gold', c1:'#fb7185', c2:'#f472b6', c3:'#ff6b6b' },
    { name:'Arctic', c1:'#67e8f9', c2:'#3b82f6', c3:'#1e3a5f' },
    { name:'Lava', c1:'#ff4500', c2:'#ff8c00', c3:'#ffd700' },
    { name:'Mint', c1:'#00e5cc', c2:'#00bfa5', c3:'#1de9b6' },
  ];

  function initDesignStudio() {
    // Render scheme presets
    const presets = document.getElementById('ds-scheme-presets');
    if (!presets || presets.children.length > 0) return;
    presets.innerHTML = COLOR_SCHEMES.map((s,i) => `
      <div class="scheme-swatch ${i===0?'active':''}" onclick="applyScheme(${i},this)">
        <div class="scheme-dots">
          <div class="scheme-dot" style="background:${s.c1}"></div>
          <div class="scheme-dot" style="background:${s.c2}"></div>
          <div class="scheme-dot" style="background:${s.c3}"></div>
        </div>
        <div class="scheme-name">${s.name}</div>
      </div>
    `).join('');

    // Load saved theme
    const saved = localStorage.getItem('nf_design_theme');
    if (saved) {
      try { applyThemeObject(JSON.parse(saved)); } catch(e){}
    }
    loadSavedThemesList();
  }

  function applyScheme(idx, el) {
    document.querySelectorAll('.scheme-swatch').forEach(s=>s.classList.remove('active'));
    if(el) el.classList.add('active');
    const s = COLOR_SCHEMES[idx];
    document.getElementById('ds-c1').value = s.c1;
    document.getElementById('ds-c1-hex').value = s.c1;
    document.getElementById('ds-c2').value = s.c2;
    document.getElementById('ds-c2-hex').value = s.c2;
    document.getElementById('ds-c3').value = s.c3;
    document.getElementById('ds-c3-hex').value = s.c3;
    applyDesignSetting();
  }

  function syncColorFromHex(colorId, hexId) {
    const hex = document.getElementById(hexId)?.value;
    if (/^#[0-9a-f]{6}$/i.test(hex)) {
      document.getElementById(colorId).value = hex;
      applyDesignSetting();
    }
  }

  function applyDesignSetting() {
    const c1 = document.getElementById('ds-c1')?.value || '#00d4ff';
    const c2 = document.getElementById('ds-c2')?.value || '#b44fff';
    const c3 = document.getElementById('ds-c3')?.value || '#ff5580';
    const textColor = document.getElementById('ds-text')?.value || '#ffffff';
    const mutedColor = document.getElementById('ds-muted')?.value || '#9999bb';
    const fontH = document.getElementById('ds-font-heading')?.value || "'Syne',sans-serif";
    const fontB = document.getElementById('ds-font-body')?.value || "'Inter',sans-serif";
    const glowVal = parseInt(document.getElementById('ds-glow')?.value || '2');
    const glowMap = [0, 0.06, 0.12, 0.2, 0.35];
    const glow = glowMap[glowVal] || 0.12;

    const root = document.documentElement;
    root.style.setProperty('--accent', c1);
    root.style.setProperty('--accent2', c2);
    root.style.setProperty('--accent3', c3);
    root.style.setProperty('--text', textColor);
    root.style.setProperty('--muted', mutedColor);
    root.style.setProperty('--font-heading', fontH);
    root.style.setProperty('--font-body', fontB);
    root.style.setProperty('--glow-intensity', glow);
    root.style.setProperty('--grad-btn', `linear-gradient(135deg, ${c1}, ${c2})`);
    root.style.setProperty('--grad-text', `linear-gradient(90deg, ${c1}, ${c2})`);
    root.style.setProperty('--accent-glow', hexToRgba(c1, glow));
    root.style.setProperty('--accent2-glow', hexToRgba(c2, glow));

    // Update font previews
    const fhPrev = document.getElementById('ds-font-h-preview');
    const fbPrev = document.getElementById('ds-font-b-preview');
    if(fhPrev) fhPrev.style.fontFamily = fontH;
    if(fbPrev) fbPrev.style.fontFamily = fontB;

    // Apply font-family to body elements via style tag
    let dynStyle = document.getElementById('ds-dynamic-style');
    if (!dynStyle) {
      dynStyle = document.createElement('style');
      dynStyle.id = 'ds-dynamic-style';
      document.head.appendChild(dynStyle);
    }
    dynStyle.textContent = `
      h1,h2,h3,h4,h5,h6,.card-title,.quick-title,.stat-value,.page-title,.logo-mark,.hero-heading,.theme-name,.form-section-title { font-family: ${fontH} !important; }
      body, p, span, div, input, select, textarea, button, label, a { font-family: ${fontB}; }
      .btn-cta-purple, .btn-cta-green { font-family: ${fontH} !important; }
    `;

    // Save to localStorage for persistence
    try {
      localStorage.setItem('nf_design_live', JSON.stringify({ c1, c2, c3, textColor, mutedColor, fontH, fontB, glow }));
    } catch(e){}
  }

  function setBgType(type, btn) {
    document.querySelectorAll('.bg-type-btn').forEach(b=>b.classList.remove('active'));
    if(btn) btn.classList.add('active');
    ['solid','gradient','animated','3d'].forEach(t => {
      const p = document.getElementById('bg-panel-'+t);
      if(p) p.style.display = t === type ? 'block' : 'none';
    });
    if (type === 'animated') {
      setAnimBg(currentAnimBg || 'stars', null);
    } else if (type === '3d') {
      set3dBg(current3dBg || 'mesh', null);
    } else {
      stopAnimBackground();
    }
  }

  function setBgSolid(color) {
    document.getElementById('ds-bg-solid').value = color;
    document.getElementById('ds-bg-solid-hex').value = color;
    document.documentElement.style.setProperty('--bg', color);
    document.body.style.background = color;
    stopAnimBackground();
  }

  function setGradientPreset(c1, c2, dir) {
    document.getElementById('ds-bg-g1').value = c1;
    document.getElementById('ds-bg-g2').value = c2;
    document.getElementById('ds-bg-gdir').value = dir;
    applyGradientBg();
  }

  function applyGradientBg() {
    const c1 = document.getElementById('ds-bg-g1')?.value || '#080810';
    const c2 = document.getElementById('ds-bg-g2')?.value || '#1a0a2e';
    const dir = document.getElementById('ds-bg-gdir')?.value || '135deg';
    const grad = dir === 'radial' ? `radial-gradient(ellipse at center, ${c1}, ${c2})` : `linear-gradient(${dir}, ${c1}, ${c2})`;
    document.body.style.background = grad;
    document.documentElement.style.setProperty('--bg', c1);
    stopAnimBackground();
  }

  let currentAnimBg = 'stars';
  let current3dBg = 'mesh';
  let animFrame = null;
  let bgCanvas = null;
  let bgCtx = null;

  function stopAnimBackground() {
    if (animFrame) { cancelAnimationFrame(animFrame); animFrame = null; }
    const existing = document.getElementById('bg-canvas');
    if (existing) existing.remove(); // canvas is dynamically created
    bgCanvas = null; bgCtx = null;
  }

  function initCanvas() {
    stopAnimBackground();
    bgCanvas = document.createElement('canvas');
    bgCanvas.id = 'bg-canvas';
    document.body.insertBefore(bgCanvas, document.body.firstChild);
    bgCtx = bgCanvas.getContext('2d');
    bgCanvas.width = window.innerWidth;
    bgCanvas.height = window.innerHeight;
    window.onresize = () => { if(bgCanvas){ bgCanvas.width=window.innerWidth; bgCanvas.height=window.innerHeight; }};
    return bgCtx;
  }

  function setAnimBg(type, btn) {
    currentAnimBg = type;
    if (btn) {
      document.querySelectorAll('.anim-option').forEach(b=>b.classList.remove('active'));
      btn.classList.add('active');
    }
    const speed = parseFloat(document.getElementById('ds-anim-speed')?.value || '1');
    const count = parseInt(document.getElementById('ds-anim-count')?.value || '100');
    const c1 = document.getElementById('ds-c1')?.value || '#00d4ff';
    const c2 = document.getElementById('ds-c2')?.value || '#b44fff';

    document.body.style.background = 'var(--bg)';
    const ctx = initCanvas();

    if (type === 'stars') animStars(ctx, count, speed, c1, c2);
    else if (type === 'matrix') animMatrix(ctx, speed);
    else if (type === 'particles') animParticles(ctx, count, speed, c1, c2);
    else if (type === 'aurora') animAurora(ctx, speed, c1, c2);
    else if (type === 'waves') animWaves(ctx, speed, c1, c2);
    else if (type === 'clouds') animClouds(ctx, speed);
    else if (type === 'lightning') animLightning(ctx, speed, c1);
    else if (type === 'bubbles') animBubbles(ctx, count, speed, c1, c2);
    else if (type === 'snow') animSnow(ctx, count, speed);
    else if (type === 'fireflies') animFireflies(ctx, count, speed, c1, c2);
  }

  function animStars(ctx, count, speed, c1, c2) {
    const stars = Array.from({length:count}, () => ({
      x: Math.random() * bgCanvas.width,
      y: Math.random() * bgCanvas.height,
      r: Math.random() * 2 + 0.5,
      vy: (Math.random() * 1.5 + 0.5) * speed,
      opacity: Math.random(),
      color: Math.random() > 0.5 ? c1 : c2
    }));
    function draw() {
      ctx.fillStyle = 'rgba(8,8,16,0.15)';
      ctx.fillRect(0,0,bgCanvas.width,bgCanvas.height);
      stars.forEach(s => {
        s.y += s.vy; s.opacity = 0.4 + 0.6*Math.sin(Date.now()*0.001 + s.x);
        if (s.y > bgCanvas.height) { s.y = -5; s.x = Math.random()*bgCanvas.width; }
        ctx.beginPath();
        ctx.arc(s.x, s.y, s.r, 0, Math.PI*2);
        ctx.fillStyle = s.color + Math.floor(s.opacity*255).toString(16).padStart(2,'0');
        ctx.fill();
      });
      animFrame = requestAnimationFrame(draw);
    }
    draw();
  }

  function animMatrix(ctx, speed) {
    const cols = Math.floor(bgCanvas.width / 16);
    const drops = Array(cols).fill(1);
    const chars = '01アイウエオカキクケコNICHEFORGEABCDEF∑∆∇∫';
    function draw() {
      ctx.fillStyle = 'rgba(0,0,0,0.05)';
      ctx.fillRect(0,0,bgCanvas.width,bgCanvas.height);
      ctx.fillStyle = '#00ff41';
      ctx.font = '14px Syne Mono, monospace';
      drops.forEach((y, i) => {
        const char = chars[Math.floor(Math.random()*chars.length)];
        ctx.fillStyle = Math.random() > 0.95 ? '#fff' : '#00ff41';
        ctx.fillText(char, i*16, y*16);
        if (y*16 > bgCanvas.height && Math.random() > 0.975) drops[i] = 0;
        drops[i] += speed;
      });
      animFrame = requestAnimationFrame(draw);
    }
    draw();
  }

  function animParticles(ctx, count, speed, c1, c2) {
    const particles = Array.from({length:count}, () => ({
      x:Math.random()*bgCanvas.width, y:Math.random()*bgCanvas.height,
      vx:(Math.random()-0.5)*speed, vy:(Math.random()-0.5)*speed,
      r:Math.random()*3+1, color:Math.random()>0.5?c1:c2, opacity:Math.random()*0.8+0.2
    }));
    function draw() {
      ctx.fillStyle='rgba(8,8,16,0.1)';ctx.fillRect(0,0,bgCanvas.width,bgCanvas.height);
      particles.forEach(p=>{
        p.x+=p.vx; p.y+=p.vy;
        if(p.x<0||p.x>bgCanvas.width) p.vx*=-1;
        if(p.y<0||p.y>bgCanvas.height) p.vy*=-1;
        ctx.beginPath(); ctx.arc(p.x,p.y,p.r,0,Math.PI*2);
        ctx.fillStyle=p.color+(Math.floor(p.opacity*200)).toString(16).padStart(2,'0');
        ctx.fill();
        // Draw connections
        particles.forEach(p2=>{
          const dx=p.x-p2.x, dy=p.y-p2.y, dist=Math.sqrt(dx*dx+dy*dy);
          if(dist<100){ ctx.beginPath(); ctx.moveTo(p.x,p.y); ctx.lineTo(p2.x,p2.y);
            ctx.strokeStyle=c1+'22'; ctx.lineWidth=0.5; ctx.stroke(); }
        });
      });
      animFrame=requestAnimationFrame(draw);
    }
    draw();
  }

  function animAurora(ctx, speed, c1, c2) {
    let t=0;
    function draw(){
      t+=0.005*speed;
      ctx.fillStyle='rgba(8,8,16,0.08)';ctx.fillRect(0,0,bgCanvas.width,bgCanvas.height);
      for(let i=0;i<3;i++){
        const grad=ctx.createLinearGradient(0,bgCanvas.height*0.3,bgCanvas.width,bgCanvas.height*0.7);
        grad.addColorStop(0,'transparent');
        grad.addColorStop(0.3+i*0.1, c1+(i===0?'40':'20'));
        grad.addColorStop(0.6+i*0.1, c2+(i===1?'40':'20'));
        grad.addColorStop(1,'transparent');
        ctx.fillStyle=grad;
        ctx.beginPath();
        ctx.moveTo(0,bgCanvas.height*0.5);
        for(let x=0;x<=bgCanvas.width;x+=10){
          const y=bgCanvas.height*(0.4+0.2*Math.sin(x*0.005+t+i*1.2)+0.1*Math.sin(x*0.01-t*0.7+i));
          ctx.lineTo(x,y);
        }
        ctx.lineTo(bgCanvas.width,bgCanvas.height);ctx.lineTo(0,bgCanvas.height);ctx.closePath();
        ctx.fill();
      }
      animFrame=requestAnimationFrame(draw);
    }
    draw();
  }

  function animWaves(ctx, speed, c1, c2) {
    let t=0;
    function draw(){
      t+=0.02*speed;
      ctx.fillStyle='rgba(8,8,16,0.2)';ctx.fillRect(0,0,bgCanvas.width,bgCanvas.height);
      [[c1,0],[c2,Math.PI/2]].forEach(([color,offset],wi)=>{
        ctx.beginPath();ctx.moveTo(0,bgCanvas.height);
        for(let x=0;x<=bgCanvas.width;x+=5){
          const y=bgCanvas.height*0.6+50*Math.sin(x*0.01+t+offset)+30*Math.sin(x*0.02-t*0.7+offset);
          ctx.lineTo(x,y);
        }
        ctx.lineTo(bgCanvas.width,bgCanvas.height);ctx.lineTo(0,bgCanvas.height);ctx.closePath();
        ctx.fillStyle=color+'30'; ctx.fill();
        ctx.strokeStyle=color+'80'; ctx.lineWidth=1.5; ctx.stroke();
      });
      animFrame=requestAnimationFrame(draw);
    }
    draw();
  }

  function animClouds(ctx, speed) {
    const clouds=Array.from({length:8},()=>({x:Math.random()*bgCanvas.width,y:Math.random()*bgCanvas.height*0.7,w:100+Math.random()*200,h:40+Math.random()*60,vx:(Math.random()*0.5+0.1)*speed*(Math.random()>0.5?1:-1),opacity:0.03+Math.random()*0.08}));
    function draw(){
      ctx.fillStyle='rgba(8,8,16,0.05)';ctx.fillRect(0,0,bgCanvas.width,bgCanvas.height);
      clouds.forEach(c=>{
        c.x+=c.vx;
        if(c.x>bgCanvas.width+c.w) c.x=-c.w;
        if(c.x<-c.w) c.x=bgCanvas.width+c.w;
        const grad=ctx.createRadialGradient(c.x,c.y,0,c.x,c.y,c.w/2);
        grad.addColorStop(0,`rgba(200,220,255,${c.opacity})`);
        grad.addColorStop(1,'transparent');
        ctx.fillStyle=grad; ctx.fillRect(c.x-c.w/2,c.y-c.h/2,c.w,c.h);
      });
      animFrame=requestAnimationFrame(draw);
    }
    draw();
  }

  function animLightning(ctx, speed, c1) {
    function bolt(x1,y1,x2,y2,depth){
      if(depth<=0){ctx.beginPath();ctx.moveTo(x1,y1);ctx.lineTo(x2,y2);ctx.stroke();return;}
      const mx=(x1+x2)/2+(Math.random()-0.5)*(y2-y1)*0.5;
      const my=(y1+y2)/2+(Math.random()-0.5)*(x2-x1)*0.5;
      bolt(x1,y1,mx,my,depth-1); bolt(mx,my,x2,y2,depth-1);
    }
    function draw(){
      ctx.fillStyle='rgba(8,8,16,0.15)';ctx.fillRect(0,0,bgCanvas.width,bgCanvas.height);
      if(Math.random()<0.02*speed){
        ctx.strokeStyle=c1+'cc'; ctx.lineWidth=1+Math.random()*2; ctx.shadowColor=c1; ctx.shadowBlur=10;
        const x=Math.random()*bgCanvas.width;
        bolt(x,0,x+(Math.random()-0.5)*200,bgCanvas.height*0.7,5);
        ctx.shadowBlur=0;
      }
      animFrame=requestAnimationFrame(draw);
    }
    draw();
  }

  function animBubbles(ctx, count, speed, c1, c2) {
    const bubbles=Array.from({length:count},()=>({x:Math.random()*bgCanvas.width,y:bgCanvas.height+Math.random()*200,r:3+Math.random()*20,vy:-(0.3+Math.random()*1.5)*speed,vx:(Math.random()-0.5)*0.5,color:Math.random()>0.5?c1:c2,opacity:0.1+Math.random()*0.3}));
    function draw(){
      ctx.fillStyle='rgba(8,8,16,0.1)';ctx.fillRect(0,0,bgCanvas.width,bgCanvas.height);
      bubbles.forEach(b=>{
        b.y+=b.vy; b.x+=b.vx;
        if(b.y<-b.r*2){b.y=bgCanvas.height+b.r;b.x=Math.random()*bgCanvas.width;}
        ctx.beginPath(); ctx.arc(b.x,b.y,b.r,0,Math.PI*2);
        ctx.strokeStyle=b.color+(Math.floor(b.opacity*255)).toString(16).padStart(2,'0');
        ctx.lineWidth=1.5; ctx.stroke();
        const grad=ctx.createRadialGradient(b.x-b.r*0.3,b.y-b.r*0.3,0,b.x,b.y,b.r);
        grad.addColorStop(0,b.color+'20'); grad.addColorStop(1,'transparent');
        ctx.fillStyle=grad; ctx.fill();
      });
      animFrame=requestAnimationFrame(draw);
    }
    draw();
  }

  function animSnow(ctx, count, speed) {
    const flakes=Array.from({length:count},()=>({x:Math.random()*bgCanvas.width,y:Math.random()*bgCanvas.height,r:1+Math.random()*3,vy:(0.5+Math.random()*2)*speed,vx:(Math.random()-0.5)*0.5,wobble:Math.random()*Math.PI*2}));
    function draw(){
      ctx.fillStyle='rgba(8,8,16,0.1)';ctx.fillRect(0,0,bgCanvas.width,bgCanvas.height);
      ctx.fillStyle='rgba(220,240,255,0.7)';
      flakes.forEach(f=>{
        f.y+=f.vy; f.wobble+=0.03; f.x+=f.vx+Math.sin(f.wobble)*0.5;
        if(f.y>bgCanvas.height){f.y=-5;f.x=Math.random()*bgCanvas.width;}
        ctx.beginPath(); ctx.arc(f.x,f.y,f.r,0,Math.PI*2); ctx.fill();
      });
      animFrame=requestAnimationFrame(draw);
    }
    draw();
  }

  function animFireflies(ctx, count, speed, c1, c2) {
    const flies=Array.from({length:count},()=>({x:Math.random()*bgCanvas.width,y:Math.random()*bgCanvas.height,vx:(Math.random()-0.5)*speed,vy:(Math.random()-0.5)*speed,phase:Math.random()*Math.PI*2,color:Math.random()>0.5?c1:c2}));
    function draw(){
      ctx.fillStyle='rgba(8,8,16,0.12)';ctx.fillRect(0,0,bgCanvas.width,bgCanvas.height);
      const t=Date.now()*0.002;
      flies.forEach(f=>{
        f.x+=f.vx+Math.sin(t+f.phase)*0.5; f.y+=f.vy+Math.cos(t+f.phase*1.3)*0.5;
        if(f.x<0)f.x=bgCanvas.width; if(f.x>bgCanvas.width)f.x=0;
        if(f.y<0)f.y=bgCanvas.height; if(f.y>bgCanvas.height)f.y=0;
        const pulse=0.3+0.7*((1+Math.sin(t*3+f.phase))/2);
        ctx.beginPath(); ctx.arc(f.x,f.y,2,0,Math.PI*2);
        ctx.shadowColor=f.color; ctx.shadowBlur=8*pulse;
        ctx.fillStyle=f.color+(Math.floor(pulse*255)).toString(16).padStart(2,'0');
        ctx.fill(); ctx.shadowBlur=0;
      });
      animFrame=requestAnimationFrame(draw);
    }
    draw();
  }

  function set3dBg(type, btn) {
    current3dBg = type;
    if(btn){
      document.querySelectorAll('#bg-panel-3d .anim-option').forEach(b=>b.classList.remove('active'));
      btn.classList.add('active');
    }
    const c1 = document.getElementById('ds-c1')?.value || '#00d4ff';
    const c2 = document.getElementById('ds-c2')?.value || '#b44fff';
    document.body.style.background = '#080810';
    const ctx = initCanvas();

    if (type === 'mesh') anim3dMesh(ctx, c1, c2);
    else if (type === 'shapes') anim3dShapes(ctx, c1, c2);
    else if (type === 'vortex') animVortex(ctx, c1, c2);
    else if (type === 'terrain') animTerrain(ctx, c1, c2);
    else if (type === 'nebula') animNebula(ctx, c1, c2);
    else if (type === 'globe') animGlobe(ctx, c1, c2);
  }

  function anim3dMesh(ctx, c1, c2) {
    let t=0;
    function draw(){
      t+=0.01;
      ctx.fillStyle='rgba(8,8,16,0.15)';ctx.fillRect(0,0,bgCanvas.width,bgCanvas.height);
      const grid=20, spacing=bgCanvas.width/grid;
      ctx.strokeStyle=c1+'40'; ctx.lineWidth=1;
      for(let i=0;i<=grid;i++){
        for(let j=0;j<=grid;j++){
          const x=i*spacing, y=j*(bgCanvas.height/grid);
          const wave=20*Math.sin(i*0.3+t)*Math.cos(j*0.3+t*0.7);
          if(i<grid){
            ctx.beginPath();ctx.moveTo(x,y+wave);
            const nx=(i+1)*spacing, ny=j*(bgCanvas.height/grid), nw=20*Math.sin((i+1)*0.3+t)*Math.cos(j*0.3+t*0.7);
            ctx.lineTo(nx,ny+nw);ctx.stroke();
          }
          if(j<grid){
            ctx.beginPath();ctx.moveTo(x,y+wave);
            const ny2=(j+1)*(bgCanvas.height/grid), nw2=20*Math.sin(i*0.3+t)*Math.cos((j+1)*0.3+t*0.7);
            ctx.lineTo(x,ny2+nw2);ctx.stroke();
          }
        }
      }
      animFrame=requestAnimationFrame(draw);
    }
    draw();
  }

  function anim3dShapes(ctx, c1, c2) {
    const shapes=Array.from({length:12},()=>({x:Math.random()*bgCanvas.width,y:Math.random()*bgCanvas.height,r:20+Math.random()*60,rot:Math.random()*Math.PI*2,vrot:(Math.random()-0.5)*0.02,vx:(Math.random()-0.5)*0.5,vy:(Math.random()-0.5)*0.5,sides:3+Math.floor(Math.random()*5),color:Math.random()>0.5?c1:c2,opacity:0.1+Math.random()*0.2}));
    function draw(){
      ctx.fillStyle='rgba(8,8,16,0.12)';ctx.fillRect(0,0,bgCanvas.width,bgCanvas.height);
      shapes.forEach(s=>{
        s.x+=s.vx;s.y+=s.vy;s.rot+=s.vrot;
        if(s.x<-s.r||s.x>bgCanvas.width+s.r)s.vx*=-1;
        if(s.y<-s.r||s.y>bgCanvas.height+s.r)s.vy*=-1;
        ctx.beginPath();
        for(let i=0;i<s.sides;i++){
          const angle=s.rot+i*Math.PI*2/s.sides;
          i===0?ctx.moveTo(s.x+s.r*Math.cos(angle),s.y+s.r*Math.sin(angle)):ctx.lineTo(s.x+s.r*Math.cos(angle),s.y+s.r*Math.sin(angle));
        }
        ctx.closePath();
        ctx.strokeStyle=s.color+(Math.floor(s.opacity*255)).toString(16).padStart(2,'0');
        ctx.lineWidth=1.5;ctx.stroke();
        ctx.fillStyle=s.color+'0a';ctx.fill();
      });
      animFrame=requestAnimationFrame(draw);
    }
    draw();
  }

  function animVortex(ctx, c1, c2) {
    let t=0;
    function draw(){
      t+=0.02;
      ctx.fillStyle='rgba(8,8,16,0.08)';ctx.fillRect(0,0,bgCanvas.width,bgCanvas.height);
      const cx=bgCanvas.width/2,cy=bgCanvas.height/2;
      for(let i=0;i<200;i++){
        const angle=i*0.1+t, r=i*2.5, x=cx+r*Math.cos(angle), y=cy+r*Math.sin(angle);
        const ratio=i/200;
        ctx.beginPath();ctx.arc(x,y,1.5,0,Math.PI*2);
        ctx.fillStyle=ratio>0.5?c2+(Math.floor((1-ratio)*255)).toString(16).padStart(2,'0'):c1+(Math.floor(ratio*255)).toString(16).padStart(2,'0');
        ctx.fill();
      }
      animFrame=requestAnimationFrame(draw);
    }
    draw();
  }

  function animTerrain(ctx, c1, c2) {
    let t=0;
    function draw(){
      t+=0.008;
      ctx.fillStyle='rgba(8,8,16,0.1)';ctx.fillRect(0,0,bgCanvas.width,bgCanvas.height);
      for(let layer=3;layer>=0;layer--){
        ctx.beginPath();ctx.moveTo(0,bgCanvas.height);
        const offset=layer*80;
        for(let x=0;x<=bgCanvas.width;x+=5){
          const y=bgCanvas.height-(offset+80*Math.sin(x*0.005+t+layer)*Math.cos(x*0.003-t*0.5+layer*0.5));
          x===0?ctx.moveTo(x,y):ctx.lineTo(x,y);
        }
        ctx.lineTo(bgCanvas.width,bgCanvas.height);ctx.closePath();
        const ratio=layer/3;
        const mixedColor=ratio>0.5?c2:c1;
        ctx.fillStyle=mixedColor+(Math.floor(0.08*255)).toString(16).padStart(2,'0');
        ctx.strokeStyle=mixedColor+'60';ctx.lineWidth=1;
        ctx.fill();ctx.stroke();
      }
      animFrame=requestAnimationFrame(draw);
    }
    draw();
  }

  function animNebula(ctx, c1, c2) {
    let t=0;
    function draw(){
      t+=0.003;
      ctx.fillStyle='rgba(8,8,16,0.04)';ctx.fillRect(0,0,bgCanvas.width,bgCanvas.height);
      for(let i=0;i<5;i++){
        const x=bgCanvas.width*(0.2+0.6*Math.sin(t*0.7+i*1.2)), y=bgCanvas.height*(0.2+0.6*Math.cos(t*0.5+i*0.9));
        const r=100+80*Math.sin(t+i);
        const grad=ctx.createRadialGradient(x,y,0,x,y,r);
        const color=i%2===0?c1:c2;
        grad.addColorStop(0,color+'30');grad.addColorStop(0.5,color+'10');grad.addColorStop(1,'transparent');
        ctx.fillStyle=grad;ctx.fillRect(x-r,y-r,r*2,r*2);
      }
      animFrame=requestAnimationFrame(draw);
    }
    draw();
  }

  function animGlobe(ctx, c1, c2) {
    let t=0;
    const cx=bgCanvas.width/2, cy=bgCanvas.height/2, R=Math.min(bgCanvas.width,bgCanvas.height)*0.35;
    function draw(){
      t+=0.008;
      ctx.fillStyle='rgba(8,8,16,0.15)';ctx.fillRect(0,0,bgCanvas.width,bgCanvas.height);
      // Latitude lines
      for(let lat=-80;lat<=80;lat+=20){
        const ry=R*Math.sin(lat*Math.PI/180);
        const rx=Math.sqrt(Math.max(0,R*R-ry*ry));
        ctx.beginPath();ctx.ellipse(cx,cy+ry,rx,rx*0.3,0,0,Math.PI*2);
        ctx.strokeStyle=c1+'30';ctx.lineWidth=0.8;ctx.stroke();
      }
      // Longitude lines
      for(let lon=0;lon<180;lon+=20){
        const angle=lon*Math.PI/180+t;
        ctx.beginPath();
        ctx.save();ctx.translate(cx,cy);ctx.rotate(angle);
        ctx.scale(Math.abs(Math.cos(angle)),1);
        ctx.arc(0,0,R,0,Math.PI*2);
        ctx.strokeStyle=c2+'30';ctx.lineWidth=0.8;ctx.stroke();ctx.restore();
      }
      // Glow
      const grad=ctx.createRadialGradient(cx,cy,R*0.6,cx,cy,R);
      grad.addColorStop(0,'transparent');grad.addColorStop(1,c1+'30');
      ctx.fillStyle=grad;ctx.beginPath();ctx.arc(cx,cy,R,0,Math.PI*2);ctx.fill();
      animFrame=requestAnimationFrame(draw);
    }
    draw();
  }

  function setButtonStyle(style, btn) {
    document.querySelectorAll('#ds-btn-styles .ds-option-btn').forEach(b=>b.classList.remove('active'));
    if(btn) btn.classList.add('active');
    const c1 = document.getElementById('ds-c1')?.value || '#00d4ff';
    const c2 = document.getElementById('ds-c2')?.value || '#b44fff';
    let dynStyle = document.getElementById('ds-dynamic-style') || document.createElement('style');
    const existing = dynStyle.textContent;
    let btnCss = '';
    if (style==='gradient') btnCss = `.btn-primary{background:linear-gradient(135deg,${c1},${c2})!important;color:#fff!important;border:none!important;}`;
    else if (style==='flat') btnCss = `.btn-primary{background:${c1}!important;color:#000!important;border:none!important;}`;
    else if (style==='outline') btnCss = `.btn-primary{background:transparent!important;border:2px solid ${c1}!important;color:${c1}!important;}`;
    else if (style==='glow') btnCss = `.btn-primary{background:${c1}!important;color:#000!important;box-shadow:0 0 20px ${c1},0 0 40px ${c1}66!important;}`;
    else if (style==='3d') btnCss = `.btn-primary{background:${c1}!important;color:#000!important;box-shadow:0 6px 0 ${c2}!important;transform:none!important;} .btn-primary:active{transform:translateY(4px)!important;box-shadow:0 2px 0 ${c2}!important;}`;
    else if (style==='glass') btnCss = `.btn-primary{background:rgba(255,255,255,0.08)!important;border:1px solid rgba(255,255,255,0.15)!important;backdrop-filter:blur(10px)!important;color:#fff!important;}`;
    dynStyle.textContent = existing + btnCss;
    if (!document.getElementById('ds-dynamic-style')) { dynStyle.id='ds-dynamic-style'; document.head.appendChild(dynStyle); }
  }

  function setBorderRadius(radius, btn) {
    document.querySelectorAll('#ds-btn-styles').forEach(()=>{});
    const siblings = btn?.parentElement?.querySelectorAll('.ds-option-btn');
    siblings?.forEach(b=>b.classList.remove('active'));
    btn?.classList.add('active');
    document.documentElement.style.setProperty('--btn-radius', radius);
    document.documentElement.style.setProperty('--card-radius', radius==='50px'?'20px':radius==='4px'?'6px':'14px');
  }

  function setCardStyle(style, btn) {
    const parent = btn?.parentElement;
    parent?.querySelectorAll('.ds-option-btn').forEach(b=>b.classList.remove('active'));
    btn?.classList.add('active');
    const c1 = document.getElementById('ds-c1')?.value || '#00d4ff';
    let dynStyle = document.getElementById('ds-dynamic-style') || document.createElement('style');
    let cardCss = '';
    if(style==='glass') cardCss=`.card{background:rgba(13,13,24,0.7)!important;backdrop-filter:blur(12px)!important;}`;
    else if(style==='solid') cardCss=`.card{background:var(--surface2)!important;backdrop-filter:none!important;}`;
    else if(style==='bordered') cardCss=`.card{background:transparent!important;border-color:rgba(255,255,255,0.15)!important;}`;
    else if(style==='neumorphic') cardCss=`.card{background:#0d0d18!important;box-shadow:6px 6px 12px #060610,-6px -6px 12px #141426!important;border:none!important;}`;
    else if(style==='neon') cardCss=`.card{background:rgba(13,13,24,0.9)!important;border-color:${c1}!important;box-shadow:0 0 20px ${c1}33!important;}`;
    else if(style==='flat') cardCss=`.card{background:#12121f!important;border:none!important;border-radius:4px!important;}`;
    dynStyle.textContent = (dynStyle.textContent||'') + cardCss;
    if(!document.getElementById('ds-dynamic-style')){dynStyle.id='ds-dynamic-style';document.head.appendChild(dynStyle);}
  }

  function setIconPack(pack, btn) {
    btn?.parentElement?.querySelectorAll('.ds-option-btn').forEach(b=>b.classList.remove('active'));
    btn?.classList.add('active');
    // Note: full icon pack swap would require reloading icon SVGs — stored for future implementation
    localStorage.setItem('nf_icon_pack', pack);
  }

  function saveDesignTheme() {
    const name = prompt('Name this theme:', 'My Theme ' + (Date.now()%1000));
    if (!name) return;
    const theme = {
      name, timestamp: Date.now(),
      c1: document.getElementById('ds-c1')?.value,
      c2: document.getElementById('ds-c2')?.value,
      c3: document.getElementById('ds-c3')?.value,
      textColor: document.getElementById('ds-text')?.value,
      mutedColor: document.getElementById('ds-muted')?.value,
      fontH: document.getElementById('ds-font-heading')?.value,
      fontB: document.getElementById('ds-font-body')?.value,
      glow: document.getElementById('ds-glow')?.value,
      bg: document.getElementById('ds-bg-solid')?.value,
    };
    try {
      const saved = JSON.parse(localStorage.getItem('nf_saved_themes') || '[]');
      saved.push(theme);
      localStorage.setItem('nf_saved_themes', JSON.stringify(saved));
      localStorage.setItem('nf_design_theme', JSON.stringify(theme));
      loadSavedThemesList();
      alert('✅ Theme "' + name + '" saved!');
    } catch(e) { alert('Could not save: ' + e.message); }
  }

  function loadSavedThemesList() {
    const container = document.getElementById('ds-saved-themes');
    if (!container) return;
    try {
      const saved = JSON.parse(localStorage.getItem('nf_saved_themes') || '[]');
      if (!saved.length) {
        container.innerHTML = '<div style="color:var(--muted);font-size:12px;text-align:center;padding:16px">No saved themes yet.</div>';
        return;
      }
      container.innerHTML = saved.map((t,i) => `
        <div class="saved-theme-item" onclick="applyThemeObject(${JSON.stringify(t).replace(/"/g,'&quot;')})">
          <div style="display:flex;align-items:center;gap:8px">
            <div style="display:flex;gap:3px">
              <div style="width:12px;height:12px;border-radius:50%;background:${t.c1}"></div>
              <div style="width:12px;height:12px;border-radius:50%;background:${t.c2}"></div>
              <div style="width:12px;height:12px;border-radius:50%;background:${t.c3}"></div>
            </div>
            <span style="font-size:12px;font-weight:600">${t.name}</span>
          </div>
          <div style="display:flex;gap:6px">
            <button onclick="event.stopPropagation();applyThemeObject(${JSON.stringify(t).replace(/"/g,'&quot;')})" style="font-size:10px;padding:3px 8px" class="btn btn-sm">Apply</button>
            <button onclick="event.stopPropagation();deleteTheme(${i})" style="font-size:10px;padding:3px 8px;color:var(--accent3)" class="btn btn-sm">✕</button>
          </div>
        </div>
      `).join('');
    } catch(e){}
  }

  function applyThemeObject(t) {
    if(document.getElementById('ds-c1')) document.getElementById('ds-c1').value = t.c1||'#00d4ff';
    if(document.getElementById('ds-c1-hex')) document.getElementById('ds-c1-hex').value = t.c1||'#00d4ff';
    if(document.getElementById('ds-c2')) document.getElementById('ds-c2').value = t.c2||'#b44fff';
    if(document.getElementById('ds-c2-hex')) document.getElementById('ds-c2-hex').value = t.c2||'#b44fff';
    if(document.getElementById('ds-c3')) document.getElementById('ds-c3').value = t.c3||'#ff5580';
    if(document.getElementById('ds-c3-hex')) document.getElementById('ds-c3-hex').value = t.c3||'#ff5580';
    if(document.getElementById('ds-font-heading')) document.getElementById('ds-font-heading').value = t.fontH||"'Syne',sans-serif";
    if(document.getElementById('ds-font-body')) document.getElementById('ds-font-body').value = t.fontB||"'Inter',sans-serif";
    if(document.getElementById('ds-glow')) document.getElementById('ds-glow').value = t.glow||2;
    if(t.bg && document.getElementById('ds-bg-solid')) { document.getElementById('ds-bg-solid').value = t.bg; document.getElementById('ds-bg-solid-hex').value = t.bg; }
    applyDesignSetting();
  }

  function deleteTheme(idx) {
    try {
      const saved = JSON.parse(localStorage.getItem('nf_saved_themes') || '[]');
      saved.splice(idx, 1);
      localStorage.setItem('nf_saved_themes', JSON.stringify(saved));
      loadSavedThemesList();
    } catch(e){}
  }

  function resetDesignToDefault() {
    if (!confirm('Reset to default NicheForge theme?')) return;
    document.documentElement.style.cssText = '';
    const dynStyle = document.getElementById('ds-dynamic-style');
    if(dynStyle) dynStyle.textContent = '';
    stopAnimBackground();
    document.body.style.background = '';
  }

  function hexToRgba(hex, alpha) {
    const r = parseInt(hex.slice(1,3),16);
    const g = parseInt(hex.slice(3,5),16);
    const b = parseInt(hex.slice(5,7),16);
    return `rgba(${r},${g},${b},${alpha})`;
  }

  // OpenAI key is now in the main Settings panel (no dynamic injection needed)

  // ── API Key helpers ──────────────────────────────────────────
  function getClaudeKey() {
    return localStorage.getItem('nf_claude_key') || '';
  }

  function saveClaudeKey() {
    const val = document.getElementById('set-claude-key')?.value?.trim();
    if (val) {
      try {
        localStorage.setItem('nf_claude_key', val);
        const badge = document.getElementById('claude-key-badge');
        if (badge) { badge.textContent = 'SET ✓'; badge.style.background = 'rgba(0,230,118,0.12)'; badge.style.color = '#00e676'; }
      } catch(e){}
    }
  }

  function toggleClaudeKeyVisibility() {
    const inp = document.getElementById('set-claude-key');
    if (inp) inp.type = inp.type === 'password' ? 'text' : 'password';
  }

  function saveOpenAIKeyFromSettings() {
    const val = document.getElementById('set-openai-key')?.value?.trim();
    if (val) {
      try {
        localStorage.setItem('nf_openai_key', val);
        const badge = document.getElementById('openai-key-badge');
        if (badge) { badge.textContent = 'SET ✓'; badge.style.background = 'rgba(0,230,118,0.12)'; badge.style.color = '#00e676'; }
      } catch(e){}
    }
  }

  function toggleOpenAIKeyVisibility() {
    const inp = document.getElementById('set-openai-key');
    if (inp) inp.type = inp.type === 'password' ? 'text' : 'password';
  }

  function saveOpenAIKey() { saveOpenAIKeyFromSettings(); } // legacy alias

  // Load all saved keys into Settings fields on panel show
  function loadSavedKeysIntoSettings() {
    const claudeKey = getClaudeKey();
    const openaiKey = getOpenAIKey();
    const geminiKey = localStorage.getItem('nf_gemini_key') || localStorage.getItem('nicheforge_apikey') || '';

    const claudeInp = document.getElementById('set-claude-key');
    if (claudeInp && claudeKey) { claudeInp.value = claudeKey; }
    const openaiInp = document.getElementById('set-openai-key');
    if (openaiInp && openaiKey) { openaiInp.value = openaiKey; }

    // Pre-fill Railway URL
    const railwayInp = document.getElementById('set-railway-url');
    const savedRailway = localStorage.getItem(RAILWAY_URL_KEY);
    if (railwayInp) { railwayInp.value = savedRailway || DEFAULT_RAILWAY_URL; }
    if (savedRailway) updateRailwayBadge(true);

    const claudeBadge = document.getElementById('claude-key-badge');
    if (claudeBadge && claudeKey) { claudeBadge.textContent = 'SET ✓'; claudeBadge.style.background = 'rgba(0,230,118,0.12)'; claudeBadge.style.color = '#00e676'; }
    const oaiBadge = document.getElementById('openai-key-badge');
    if (oaiBadge && openaiKey) { oaiBadge.textContent = 'SET ✓'; oaiBadge.style.background = 'rgba(0,230,118,0.12)'; oaiBadge.style.color = '#00e676'; }
  }

  // Extend showPanel with Design Studio + Builder init
  const _origShowPanel = showPanel;
  window.showPanel = function(panelId, navEl) {
    _origShowPanel(panelId, navEl);
    if (panelId === 'design') { setTimeout(initDesignStudio, 50); }
    if (panelId === 'settings') { setTimeout(loadSavedKeysIntoSettings, 50); }
    if (panelId === 'builder') {
      setTimeout(() => {
        initArenaStars('stars-prompt', '#00d4ff', '#b44fff');
        const activeCard = document.querySelector('.bmode-card.active');
        if (!activeCard) {
          const firstCard = document.querySelector('.bmode-card');
          if (firstCard) firstCard.classList.add('active');
        }
      }, 100);
    }
  };


  // ══════════════════════════════════════════════════════════════
  // MARKETING OS — Supabase Integration + Dashboard
  // ══════════════════════════════════════════════════════════════

  // ── Railway Backend Config ───────────────────────────────────
  const RAILWAY_URL_KEY = 'nf_railway_url';
  const DEFAULT_RAILWAY_URL = 'https://nicheforge-production.up.railway.app';

  function getRailwayUrl() {
    return localStorage.getItem(RAILWAY_URL_KEY) || DEFAULT_RAILWAY_URL;
  }

  function saveRailwayUrl() {
    const val = document.getElementById('set-railway-url')?.value?.trim();
    if (val) {
      localStorage.setItem(RAILWAY_URL_KEY, val);
      updateRailwayBadge(false); // will re-check on test
    }
  }

  function updateRailwayBadge(connected) {
    const badge = document.getElementById('railway-badge');
    if (!badge) return;
    if (connected) {
      badge.textContent = 'LIVE ✓';
      badge.style.background = 'rgba(0,230,118,0.12)';
      badge.style.color = '#00e676';
    } else {
      badge.textContent = 'NOT SET';
      badge.style.background = 'rgba(255,85,85,0.12)';
      badge.style.color = 'var(--accent3)';
    }
  }

  async function testRailwayConnection() {
    const btn = event.target;
    btn.textContent = '⏳ Testing...';
    const url = getRailwayUrl();
    const el = document.getElementById('railway-test-result');
    el.style.display = 'block';
    try {
      const res = await fetch(url + '/', { signal: AbortSignal.timeout(8000) });
      const data = await res.json();
      if (data.status && data.status.includes('NicheForge')) {
        el.innerHTML = `<span style="color:#00e676">✅ Backend live! Services: ${data.services?.length || 0} active · ${data.timestamp?.split('T')[0]}</span>`;
        updateRailwayBadge(true);
        mosUpdateBackendStatus(true);
      } else {
        el.innerHTML = '<span style="color:var(--accent3)">❌ Connected but unexpected response</span>';
      }
    } catch(e) {
      el.innerHTML = `<span style="color:var(--accent3)">❌ Cannot reach backend: ${e.message}</span>`;
    }
    btn.textContent = '🔌 Test Backend';
  }

  async function callBackend(endpoint, method = 'GET', body = null) {
    const url = getRailwayUrl();
    try {
      const opts = {
        method,
        headers: { 'Content-Type': 'application/json' },
        signal: AbortSignal.timeout(10000)
      };
      if (body) opts.body = JSON.stringify(body);
      const res = await fetch(url + endpoint, opts);
      return await res.json();
    } catch(e) {
      console.error('Backend call failed:', endpoint, e);
      return null;
    }
  }

  function mosUpdateBackendStatus(connected) {
    const el = document.getElementById('mos-backend-status');
    if (!el) return;
    if (connected) {
      el.innerHTML = '<div style="width:7px;height:7px;border-radius:50%;background:#b44fff;box-shadow:0 0 6px #b44fff;animation:pulse 2s infinite"></div> Backend Live ✓';
      el.style.background = 'rgba(180,79,255,0.08)';
      el.style.border = '1px solid rgba(180,79,255,0.2)';
      el.style.color = '#b44fff';
    }
  }

  const SUPABASE_URL_KEY = 'nf_supabase_url';
  const SUPABASE_KEY_KEY = 'nf_supabase_key';

  function getSupabaseConfig() {
    return {
      url: localStorage.getItem(SUPABASE_URL_KEY) || '',
      key: localStorage.getItem(SUPABASE_KEY_KEY) || ''
    };
  }

  function saveSupabaseConfig() {
    const url = document.getElementById('set-supabase-url')?.value?.trim();
    const key = document.getElementById('set-supabase-key')?.value?.trim();
    if (url) localStorage.setItem(SUPABASE_URL_KEY, url);
    if (key) localStorage.setItem(SUPABASE_KEY_KEY, key);
    updateSupabaseBadge();
  }

  function updateSupabaseBadge() {
    const { url, key } = getSupabaseConfig();
    const badge = document.getElementById('supabase-badge');
    if (!badge) return;
    if (url && key) {
      badge.textContent = 'CONNECTED ✓';
      badge.style.background = 'rgba(0,230,118,0.12)';
      badge.style.color = '#00e676';
    } else {
      badge.textContent = 'NOT SET';
      badge.style.background = 'rgba(255,85,85,0.12)';
      badge.style.color = 'var(--accent3)';
    }
  }

  async function supabaseQuery(table, options = {}) {
    const { url, key } = getSupabaseConfig();
    if (!url || !key) return null;
    const { select='*', order='created_at.desc', limit=50, insert=null, filter='' } = options;
    try {
      let endpoint = `${url}/rest/v1/${table}`;
      if (insert) {
        const res = await fetch(endpoint, {
          method: 'POST',
          headers: { 'apikey': key, 'Authorization': `Bearer ${key}`, 'Content-Type': 'application/json', 'Prefer': 'return=representation' },
          body: JSON.stringify(insert)
        });
        return await res.json();
      } else {
        endpoint += `?select=${select}&order=${order}&limit=${limit}${filter ? '&' + filter : ''}`;
        const res = await fetch(endpoint, { headers: { 'apikey': key, 'Authorization': `Bearer ${key}` } });
        return await res.json();
      }
    } catch(e) {
      console.error('Supabase error:', e);
      return null;
    }
  }

  async function testSupabaseConnection() {
    const btn = event.target;
    btn.textContent = '⏳ Testing...';
    const { url, key } = getSupabaseConfig();
    if (!url || !key) {
      document.getElementById('supabase-test-result').style.display = 'block';
      document.getElementById('supabase-test-result').innerHTML = '<span style="color:var(--accent3)">❌ Please enter URL and key first</span>';
      btn.textContent = '🔌 Test Connection';
      return;
    }
    const result = await supabaseQuery('sites', { limit: 1 });
    const el = document.getElementById('supabase-test-result');
    el.style.display = 'block';
    if (result !== null && !result.error) {
      el.innerHTML = '<span style="color:#00e676">✅ Connected! Database is live and ready.</span>';
      updateSupabaseBadge();
      mosUpdateDBStatus(true);
    } else {
      el.innerHTML = `<span style="color:var(--accent3)">❌ Connection failed: ${result?.message || 'Check URL and key'}</span>`;
    }
    btn.textContent = '🔌 Test Connection';
  }

  function mosUpdateDBStatus(connected) {
    const el = document.getElementById('mos-db-status');
    if (!el) return;
    if (connected) {
      el.innerHTML = '<div style="width:7px;height:7px;border-radius:50%;background:#00e676;box-shadow:0 0 6px #00e676;animation:pulse 2s infinite"></div> DB Live ✓';
      el.style.background = 'rgba(0,230,118,0.08)';
      el.style.border = '1px solid rgba(0,230,118,0.2)';
      el.style.color = '#00e676';
    }
  }

  // ── Load all dashboard data ──────────────────────────────────
  async function mosRefresh() {
    const { url, key } = getSupabaseConfig();
    if (!url || !key) return;
    mosUpdateDBStatus(true);
    await Promise.all([
      mosLoadStats(),
      mosLoadVisitorFeed(),
      mosLoadIntentScores(),
      mosLoadContentQueue(),
      mosLoadDecisionLog()
    ]);
    mosRenderTrackingScript();
  }

  async function mosLoadStats() {
    // Try backend first (faster, server-side counts), fall back to direct Supabase
    const backendStats = await callBackend('/api/stats');
    if (backendStats && !backendStats.error) {
      const set = (id, val) => { const el = document.getElementById(id); if (el) el.textContent = val ?? '0'; };
      set('mos-stat-sessions', backendStats.total_sessions);
      set('mos-stat-highintent', backendStats.high_intent_sessions);
      set('mos-stat-queue', backendStats.pending_content);
      set('mos-stat-decisions', backendStats.total_decisions);
      mosUpdateBackendStatus(true);
      return;
    }
    // Fallback: direct Supabase queries
    const [sessions, highIntent, queue, decisions] = await Promise.all([
      supabaseQuery('visitor_sessions', { select: 'id', limit: 1000 }),
      supabaseQuery('visitor_sessions', { select: 'id', filter: 'or=(clicked_whatsapp.eq.true,clicked_call.eq.true)', limit: 1000 }),
      supabaseQuery('content_queue', { select: 'id', filter: 'status=eq.pending', limit: 1000 }),
      supabaseQuery('decision_log', { select: 'id', limit: 1000 })
    ]);
    const set = (id, val) => { const el = document.getElementById(id); if (el) el.textContent = Array.isArray(val) ? val.length : '0'; };
    set('mos-stat-sessions', sessions);
    set('mos-stat-highintent', highIntent);
    set('mos-stat-queue', queue);
    set('mos-stat-decisions', decisions);
  }

  async function mosLoadVisitorFeed() {
    const sessions = await supabaseQuery('visitor_sessions', { limit: 30 });
    const el = document.getElementById('mos-visitor-feed');
    const countEl = document.getElementById('mos-feed-count');
    if (!el) return;
    if (!sessions || !sessions.length) {
      el.innerHTML = '<div style="text-align:center;padding:30px;color:var(--muted);font-size:12px"><div style="font-size:28px;margin-bottom:8px">📡</div>No sessions yet — embed the tracking script on your site</div>';
      return;
    }
    if (countEl) countEl.textContent = sessions.length + ' sessions';
    el.innerHTML = sessions.map(s => {
      const intent = s.clicked_whatsapp || s.clicked_call ? '🔥 HIGH' : s.scroll_depth > 60 ? '⚡ MED' : '◦ LOW';
      const intentColor = s.clicked_whatsapp || s.clicked_call ? '#ff4444' : s.scroll_depth > 60 ? '#f5c542' : 'var(--muted)';
      const time = new Date(s.created_at).toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'});
      return `<div style="display:flex;align-items:center;gap:10px;padding:10px 12px;border-radius:10px;background:var(--surface2);border:1px solid var(--border)">
        <div style="font-size:18px">${s.device === 'mobile' ? '📱' : '🖥'}</div>
        <div style="flex:1;min-width:0">
          <div style="font-size:11px;font-weight:600;white-space:nowrap;overflow:hidden;text-overflow:ellipsis">${s.page_url || 'Unknown page'}</div>
          <div style="font-size:10px;color:var(--muted)">${s.country || '?'} · ${s.referrer ? s.referrer.replace('https://','').substring(0,20) : 'Direct'} · ${s.time_on_page || 0}s · Scroll ${s.scroll_depth || 0}%</div>
        </div>
        <div style="font-size:10px;font-weight:700;color:${intentColor};white-space:nowrap">${intent}</div>
        <div style="font-size:10px;color:var(--muted);white-space:nowrap">${time}</div>
      </div>`;
    }).join('');
  }

  async function mosLoadIntentScores() {
    const scores = await supabaseQuery('intent_scores', { limit: 20 });
    const el = document.getElementById('mos-intent-list');
    if (!el) return;
    if (!scores || !scores.length) {
      el.innerHTML = '<div style="text-align:center;padding:30px;color:var(--muted);font-size:12px"><div style="font-size:28px;margin-bottom:8px">🎯</div>Intent scores appear as visitors engage</div>';
      return;
    }
    el.innerHTML = scores.map(s => {
      const barColor = s.level === 'HIGH' ? '#ff4444' : s.level === 'MEDIUM' ? '#f5c542' : 'var(--accent)';
      const pct = Math.min(100, s.score);
      return `<div style="padding:10px 12px;border-radius:10px;background:var(--surface2);border:1px solid var(--border)">
        <div style="display:flex;justify-content:space-between;margin-bottom:6px">
          <div style="font-size:11px;font-weight:600">${s.session_id?.substring(0,12) || 'Unknown'}...</div>
          <div style="font-size:11px;font-weight:800;color:${barColor}">${s.level} · ${s.score}/100</div>
        </div>
        <div style="height:4px;background:var(--border);border-radius:2px;overflow:hidden">
          <div style="height:100%;width:${pct}%;background:${barColor};border-radius:2px;transition:width 0.5s"></div>
        </div>
      </div>`;
    }).join('');
  }

  async function mosLoadContentQueue() {
    const items = await supabaseQuery('content_queue', { order: 'priority.desc,created_at.desc', limit: 20 });
    const el = document.getElementById('mos-content-queue');
    if (!el) return;
    if (!items || !items.length) {
      el.innerHTML = '<div style="text-align:center;padding:30px;color:var(--muted);font-size:12px"><div style="font-size:28px;margin-bottom:8px">📝</div>Content opportunities will appear here</div>';
      return;
    }
    el.innerHTML = items.map(item => {
      const modeColor = item.mode === 'DISCOVER_MODE' ? '#b44fff' : 'var(--accent)';
      const statusColor = item.status === 'published' ? '#00e676' : item.status === 'generating' ? '#f5c542' : 'var(--muted)';
      return `<div style="padding:10px 12px;border-radius:10px;background:var(--surface2);border:1px solid var(--border)">
        <div style="display:flex;align-items:start;gap:8px;margin-bottom:4px">
          <div style="flex:1">
            <div style="font-size:12px;font-weight:600;margin-bottom:2px">${item.title || item.keyword}</div>
            <div style="font-size:10px;color:var(--muted)">${item.keyword || ''} · <span style="color:${modeColor};font-weight:700">${item.mode}</span></div>
          </div>
          <div style="display:flex;align-items:center;gap:6px;flex-shrink:0">
            <span style="font-size:9px;font-weight:700;color:${statusColor};text-transform:uppercase">${item.status}</span>
            ${item.status === 'pending' ? `<button onclick="mosGenerateContent('${item.id}','${(item.keyword||'').replace(/'/g,"\'")}','${item.mode}')" class="btn btn-sm" style="font-size:9px;padding:3px 8px">Generate</button>` : ''}
          </div>
        </div>
      </div>`;
    }).join('');
  }

  async function mosLoadDecisionLog() {
    const items = await supabaseQuery('decision_log', { limit: 20 });
    const el = document.getElementById('mos-decision-log');
    if (!el) return;
    if (!items || !items.length) {
      el.innerHTML = '<div style="text-align:center;padding:30px;color:var(--muted);font-size:12px"><div style="font-size:28px;margin-bottom:8px">📋</div>Automated decisions logged here</div>';
      return;
    }
    el.innerHTML = items.map(item => {
      const time = new Date(item.created_at).toLocaleDateString([], {month:'short',day:'numeric',hour:'2-digit',minute:'2-digit'});
      return `<div style="padding:10px 12px;border-radius:10px;background:var(--surface2);border:1px solid var(--border)">
        <div style="display:flex;justify-content:space-between;margin-bottom:2px">
          <div style="font-size:11px;font-weight:700">${item.service || 'System'}</div>
          <div style="font-size:10px;color:var(--muted)">${time}</div>
        </div>
        <div style="font-size:11px;color:var(--text);margin-bottom:2px">${item.action || '—'}</div>
        <div style="font-size:10px;color:var(--muted)">${item.reason || ''}</div>
        ${item.outcome ? `<div style="font-size:10px;color:var(--accent);margin-top:3px">↳ ${item.outcome}</div>` : ''}
      </div>`;
    }).join('');
  }

  // ── Add to content queue ─────────────────────────────────────
  async function mosSubmitQueue() {
    const kw = document.getElementById('mos-kw-input')?.value?.trim();
    const mode = document.getElementById('mos-mode-input')?.value || 'SEARCH_MODE';
    if (!kw) return alert('Enter a keyword first');
    const result = await supabaseQuery('content_queue', {
      insert: { keyword: kw, title: kw, mode, status: 'pending', priority: 5, source: 'manual' }
    });
    if (result) {
      document.getElementById('mos-kw-input').value = '';
      await mosLoadContentQueue();
      await mosLoadStats();
      alert('✅ Added to content queue!');
    }
  }

  function mosAddToQueue() {
    document.getElementById('mos-kw-input')?.focus();
  }

  async function mosDetectTrend() {
    const topic = prompt('Enter a trending topic to add to the intelligence pipeline:');
    if (!topic) return;
    const strength = parseInt(prompt('Signal strength 1-10 (7+ triggers DISCOVER_MODE):') || '7');
    const result = await callBackend('/api/detect-trend', 'POST', {
      topic, source: 'manual', signal_strength: strength
    });
    if (result?.success) {
      alert(`✅ Trend "${topic}" logged! ${result.queued ? 'Auto-added to content queue.' : 'Saved as signal.'}`);
      await mosRefresh();
    } else {
      alert('⚠️ Could not reach backend. Make sure Railway URL is set in Settings.');
    }
  }

  // ── Generate content from queue item ────────────────────────
  async function mosGenerateContent(id, keyword, mode) {
    const apiKey = getClaudeKey() || getApiKey();
    if (!apiKey) return alert('Add your Claude API key in Settings first');
    const prompt = mode === 'DISCOVER_MODE'
      ? `Write a complete HTML blog post for Google Discover about "${keyword}". Use awareness/lifestyle tone, curiosity-based headline, preventive tips. Include proper H1, H2s, meta description. Full HTML with inline CSS, professional design.`
      : `Write a complete HTML blog post for Google Search about "${keyword}". Use troubleshooting/DIY tone, step-by-step format, FAQ section. Include proper H1, H2s, schema markup, meta description. Full HTML with inline CSS, professional design.`;
    try {
      const res = await fetch('https://api.anthropic.com/v1/messages', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', 'x-api-key': apiKey, 'anthropic-version': '2023-06-01', 'anthropic-dangerous-direct-browser-access': 'true' },
        body: JSON.stringify({ model: 'claude-sonnet-4-5', max_tokens: 4096, messages: [{ role: 'user', content: prompt }] })
      });
      const data = await res.json();
      const html = data.content?.[0]?.text || '';
      await supabaseQuery('content_queue', { insert: {} }); // update via patch workaround
      // Log the decision
      await supabaseQuery('decision_log', {
        insert: { service: 'Content Generation', trigger_event: 'MANUAL_REQUEST', action: `Generated ${mode} article: "${keyword}"`, reason: `Manual queue trigger`, outcome: 'Content ready for review', approved: true }
      });
      await mosRefresh();
    } catch(e) { console.error(e); }
  }

  // ── Tracking script generator ────────────────────────────────
  function mosRenderTrackingScript() {
    const { url, key } = getSupabaseConfig();
    const el = document.getElementById('mos-tracking-code');
    if (!el) return;
    if (!url || !key) {
      el.textContent = '// Connect Supabase in Settings first to generate your tracking script';
      return;
    }
    el.textContent = `<script>
(function(){
  const SB_URL='${url}';
  const SB_KEY='${key}';
  const sid='sess_'+Math.random().toString(36).substr(2,9);
  let scroll=0,start=Date.now(),wa=false,call=false,email=false;

  // Track scroll depth
  window.addEventListener('scroll',function(){
    const pct=Math.round((window.scrollY/(document.body.scrollHeight-window.innerHeight))*100);
    if(pct>scroll) scroll=pct;
  });

  // Track WhatsApp / Call / Email clicks
  document.addEventListener('click',function(e){
    const a=e.target.closest('a');
    if(!a) return;
    if(a.href.includes('wa.me')||a.href.includes('whatsapp')) wa=true;
    if(a.href.startsWith('tel:')) call=true;
    if(a.href.startsWith('mailto:')) email=true;
  });

  // Send session on page unload
  window.addEventListener('beforeunload',function(){
    const payload={
      site_id:'SITE_ID_HERE',
      session_id:sid,
      page_url:location.href,
      referrer:document.referrer,
      device:(/Mobi/i.test(navigator.userAgent)?'mobile':'desktop'),
      scroll_depth:scroll,
      time_on_page:Math.round((Date.now()-start)/1000),
      clicked_whatsapp:wa,
      clicked_call:call,
      clicked_email:email,
      utm_source:new URLSearchParams(location.search).get('utm_source'),
      utm_medium:new URLSearchParams(location.search).get('utm_medium'),
      utm_campaign:new URLSearchParams(location.search).get('utm_campaign')
    };
    navigator.sendBeacon(
      SB_URL+'/rest/v1/visitor_sessions',
      new Blob([JSON.stringify(payload)],{type:'application/json'})
    );
  });
})();
<\/script>`;
  }

  function copyTrackingScript() {
    const el = document.getElementById('mos-tracking-code');
    if (!el) return;
    navigator.clipboard.writeText(el.textContent)
      .then(() => alert('✅ Tracking script copied! Paste it before </body> on your website.'))
      .catch(() => alert('Select and copy the code manually'));
  }

  // ── Load saved keys into settings ────────────────────────────
  const _origLoadKeys = loadSavedKeysIntoSettings;
  loadSavedKeysIntoSettings = function() {
    _origLoadKeys();
    const { url, key } = getSupabaseConfig();
    const urlEl = document.getElementById('set-supabase-url');
    const keyEl = document.getElementById('set-supabase-key');
    if (urlEl && url) urlEl.value = url;
    if (keyEl && key) keyEl.value = key;
    updateSupabaseBadge();
  };

  // ── Auto-refresh when Marketing OS panel opens ───────────────
  const _prevShowPanel = window.showPanel;
  window.showPanel = function(panelId, navEl) {
    _prevShowPanel(panelId, navEl);
    if (panelId === 'marketing') {
      mosRenderTrackingScript();
      const { url, key } = getSupabaseConfig();
      if (url && key) setTimeout(mosRefresh, 100);
      setTimeout(async () => {
        const health = await callBackend('/');
        if (health && health.status) mosUpdateBackendStatus(true);
      }, 300);
    }
  };

  // ── Pre-fill Supabase if already saved ───────────────────────
  setTimeout(() => {
    updateSupabaseBadge();
    mosRenderTrackingScript();
  }, 500);

  // Load saved Supabase on startup
  // ══════════════════════════════════════════════════════════════

  // Load saved design theme on startup
  try {
    const savedLive = localStorage.getItem('nf_design_live');
    if (savedLive) { setTimeout(()=>{ try{ applyThemeObject(JSON.parse(savedLive)); }catch(e){} }, 300); }
  } catch(e) {}

</script>
</body>
</html>
